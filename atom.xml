<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[mk-mode BLOG]]></title>
  <link href="http://komasaru.github.io/atom.xml" rel="self"/>
  <link href="http://komasaru.github.io/"/>
  <updated>2015-09-22T00:37:03+09:00</updated>
  <id>http://komasaru.github.io/</id>
  <author>
    <name><![CDATA[mk-mode.com]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Ruby - Nokogiri による XML 解析の速度検証！]]></title>
    <link href="http://komasaru.github.io/blog/2015/09/22/ruby-verify-xml-parsing-by-nokogiri/"/>
    <updated>2015-09-22T00:20:00+09:00</updated>
    <id>http://komasaru.github.io/blog/2015/09/22/ruby-verify-xml-parsing-by-nokogiri</id>
    <content type="html"><![CDATA[<p>こんばんは。</p>

<p>Ruby で HTML/XML パーサの Nokogiri を使用して XML を解析する際、名前空間(Namespace)が宣言されている場合は厳密に指定する必要があるものだと考えております。</p>

<p>しかし、実際は名前空間を指定せずに解析することも可能です。<br/>
（実際、 XML 内の名前空間を削除するメソッドも用意されています。しかし、そのメソッドは名前空間について理解していない人のためのものであり、一般的には使用すべきではありません）</p>

<p>今回は、各種方法で解析し、どの方法が高速であるかを検証してみました。</p>

<!--more-->


<h3>0. 前提条件</h3>

<ul>
<li>Ruby 2.2.3-p173 での作業を想定。</li>
<li>以下で紹介する検証結果は、使用する XML の構造等により若干異なることもあるかもしれない、ということに留意。</li>
</ul>


<h3>1. 検証に使用する XML ファイル</h3>

<p>以下のような XML を使用する。（実際の「気象庁防災情報 XML」通知用 Atom フィードを流用。情報の内容は24時間以内に <code>link</code> タグ内の URL にアクセスして得ることになっている）</p>

<figure class='code'><figcaption><span>test_nokogiri.xml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;feed</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.w3.org/2005/Atom&quot;</span> <span class="na">xml:lang=</span><span class="s">&quot;ja&quot;</span><span class="nt">&gt;</span>
</span><span class='line'><span class="nt">&lt;title&gt;</span>JMAXML publishing feed<span class="nt">&lt;/title&gt;</span>
</span><span class='line'><span class="nt">&lt;subtitle&gt;</span>this feed is published by JMA<span class="nt">&lt;/subtitle&gt;</span>
</span><span class='line'><span class="nt">&lt;updated&gt;</span>2015-08-27T17:28:02+09:00<span class="nt">&lt;/updated&gt;</span>
</span><span class='line'><span class="nt">&lt;id&gt;</span>urn:uuid:d38e0e80-12ba-3236-b10f-256b78a08995<span class="nt">&lt;/id&gt;</span>
</span><span class='line'><span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;http://www.jma.go.jp/&quot;</span> <span class="na">rel=</span><span class="s">&quot;related&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;http://xml.kishou.go.jp/feed/other.xml&quot;</span> <span class="na">rel=</span><span class="s">&quot;self&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;rights&gt;</span>Published by Japan Meteorological Agency<span class="nt">&lt;/rights&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;entry&gt;</span>
</span><span class='line'><span class="nt">&lt;title&gt;</span>地方海上警報<span class="nt">&lt;/title&gt;</span>
</span><span class='line'><span class="nt">&lt;id&gt;</span>urn:uuid:ac97395c-e388-33a9-922f-ab2a32e61bb1<span class="nt">&lt;/id&gt;</span>
</span><span class='line'><span class="nt">&lt;updated&gt;</span>2015-08-27T08:27:18Z<span class="nt">&lt;/updated&gt;</span>
</span><span class='line'><span class="nt">&lt;author&gt;&lt;name&gt;</span>新潟地方気象台<span class="nt">&lt;/name&gt;&lt;/author&gt;</span>
</span><span class='line'><span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;http://xml.kishou.go.jp/data/ac97395c-e388-33a9-922f-ab2a32e61bb1.xml&quot;</span> <span class="na">type=</span><span class="s">&quot;application/xml&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;content</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span><span class="nt">&gt;</span>【新潟海上気象】<span class="nt">&lt;/content&gt;</span>
</span><span class='line'><span class="nt">&lt;/entry&gt;</span>
</span><span class='line'><span class="nt">&lt;entry&gt;</span>
</span><span class='line'><span class="nt">&lt;title&gt;</span>地方海上警報<span class="nt">&lt;/title&gt;</span>
</span><span class='line'><span class="nt">&lt;id&gt;</span>urn:uuid:b42a06f2-a6f0-351a-a8c4-3619a847f66d<span class="nt">&lt;/id&gt;</span>
</span><span class='line'><span class="nt">&lt;updated&gt;</span>2015-08-27T08:27:02Z<span class="nt">&lt;/updated&gt;</span>
</span><span class='line'><span class="nt">&lt;author&gt;&lt;name&gt;</span>仙台管区気象台<span class="nt">&lt;/name&gt;&lt;/author&gt;</span>
</span><span class='line'><span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;http://xml.kishou.go.jp/data/b42a06f2-a6f0-351a-a8c4-3619a847f66d.xml&quot;</span> <span class="na">type=</span><span class="s">&quot;application/xml&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;content</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span><span class="nt">&gt;</span>【仙台海上気象】<span class="nt">&lt;/content&gt;</span>
</span><span class='line'><span class="nt">&lt;/entry&gt;</span>
</span><span class='line'><span class="nt">&lt;entry&gt;</span>
</span><span class='line'><span class="nt">&lt;title&gt;</span>紫外線観測データ<span class="nt">&lt;/title&gt;</span>
</span><span class='line'><span class="nt">&lt;id&gt;</span>urn:uuid:f27e93c8-ff97-376d-b3b0-5307d07e4a24<span class="nt">&lt;/id&gt;</span>
</span><span class='line'><span class="nt">&lt;updated&gt;</span>2015-08-27T08:27:10Z<span class="nt">&lt;/updated&gt;</span>
</span><span class='line'><span class="nt">&lt;author&gt;&lt;name&gt;</span>気象庁地球環境・海洋部<span class="nt">&lt;/name&gt;&lt;/author&gt;</span>
</span><span class='line'><span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;http://xml.kishou.go.jp/data/f27e93c8-ff97-376d-b3b0-5307d07e4a24.xml&quot;</span> <span class="na">type=</span><span class="s">&quot;application/xml&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;content</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span><span class="nt">&gt;</span>【紫外線観測データ】<span class="nt">&lt;/content&gt;</span>
</span><span class='line'><span class="nt">&lt;/entry&gt;</span>
</span><span class='line'><span class="nt">&lt;/feed&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>2. 検証用 Ruby スクリプトの作成</h3>

<ul>
<li>以下のスクリプト内で指定する名前空間は、 &ldquo;text_nokogiri.xml&rdquo; 内で宣言されているものと同じ。</li>
<li><code>entry</code> ノードをループし、各 <code>title</code> ノードのテキストを取得するだけの簡単な処理を 10,000 回繰り返す。</li>
<li>今回は７種類（スクリプト内コメント参照）の解析方法で検証する。</li>
<li>以下のスクリプト内の XPath での「Namespace 指定なし」とは、 Nokogiri での厳密な指定をしないという意味。</li>
</ul>


<figure class='code'><figcaption><span>test_nokogiri_xml.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#! /usr/local/bin/ruby</span>
</span><span class='line'><span class="c1"># coding: utf-8</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># Ruby script to verify the speed of xml parsing by Nokogiri.</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1">#++</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;benchmark&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;nokogiri&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">TestNokogiriXml</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span>
</span><span class='line'>    <span class="vi">@xml</span>  <span class="o">=</span> <span class="no">Nokogiri</span><span class="o">::</span><span class="no">XML</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;test_nokogiri.xml&quot;</span><span class="p">))</span>
</span><span class='line'>    <span class="vi">@secs</span> <span class="o">=</span> <span class="mi">10000</span>
</span><span class='line'>    <span class="vi">@ns</span>   <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;http://www.w3.org/2005/Atom&quot;</span><span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">exec</span>
</span><span class='line'>    <span class="c1"># 1. css メソッド(CSS セレクタ)による解析</span>
</span><span class='line'>    <span class="nb">printf</span><span class="p">(</span><span class="s2">&quot;CASE-1: %.4f secs.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">case_1</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># 2. search メソッド(CSS セレクタ)による解析</span>
</span><span class='line'>    <span class="nb">printf</span><span class="p">(</span><span class="s2">&quot;CASE-2: %.4f secs.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">case_2</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># 3. search メソッド(XPath, Namespace 指定なし)による解析</span>
</span><span class='line'>    <span class="nb">printf</span><span class="p">(</span><span class="s2">&quot;CASE-3: %.4f secs.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">case_3</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># 4. / メソッド(CSS セレクタ)による解析</span>
</span><span class='line'>    <span class="nb">printf</span><span class="p">(</span><span class="s2">&quot;CASE-4: %.4f secs.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">case_4</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># 5. / メソッド(XPath, Namespace 指定なし)による解析</span>
</span><span class='line'>    <span class="nb">printf</span><span class="p">(</span><span class="s2">&quot;CASE-5: %.4f secs.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">case_5</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># 6. xpath メソッド(XPath, Namespace 指定なし)による解析</span>
</span><span class='line'>    <span class="nb">printf</span><span class="p">(</span><span class="s2">&quot;CASE-6: %.4f secs.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">case_6</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># 7. xpath メソッド(XPath, Namespace 指定あり)による解析</span>
</span><span class='line'>    <span class="nb">printf</span><span class="p">(</span><span class="s2">&quot;CASE-7: %.4f secs.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">case_7</span><span class="p">)</span>
</span><span class='line'>  <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>    <span class="vg">$stderr</span><span class="o">.</span><span class="n">puts</span> <span class="s2">&quot;[</span><span class="si">#{</span><span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.</span><span class="si">#{</span><span class="n">__method__</span><span class="si">}</span><span class="s2">] </span><span class="si">#{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="n">e</span><span class="o">.</span><span class="n">backtrace</span><span class="o">.</span><span class="n">each</span><span class="p">{</span> <span class="o">|</span><span class="n">tr</span><span class="o">|</span> <span class="vg">$stderr</span><span class="o">.</span><span class="n">puts</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="si">#{</span><span class="n">tr</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span>
</span><span class='line'>    <span class="nb">exit</span> <span class="mi">1</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">case_1</span>
</span><span class='line'>    <span class="k">return</span> <span class="no">Benchmark</span><span class="o">.</span><span class="n">realtime</span> <span class="k">do</span>
</span><span class='line'>      <span class="vi">@secs</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>        <span class="vi">@xml</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s2">&quot;entry&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
</span><span class='line'>          <span class="n">title</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">text</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>        <span class="nb">exit</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>    <span class="k">raise</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">case_2</span>
</span><span class='line'>    <span class="k">return</span> <span class="no">Benchmark</span><span class="o">.</span><span class="n">realtime</span> <span class="k">do</span>
</span><span class='line'>      <span class="vi">@secs</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>        <span class="vi">@xml</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;entry&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
</span><span class='line'>          <span class="n">title</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">text</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>    <span class="k">raise</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">case_3</span>
</span><span class='line'>    <span class="k">return</span> <span class="no">Benchmark</span><span class="o">.</span><span class="n">realtime</span> <span class="k">do</span>
</span><span class='line'>      <span class="vi">@secs</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>        <span class="vi">@xml</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;//xmlns:entry&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
</span><span class='line'>          <span class="n">title</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;./xmlns:title&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">text</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>    <span class="k">raise</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">case_4</span>
</span><span class='line'>    <span class="k">return</span> <span class="no">Benchmark</span><span class="o">.</span><span class="n">realtime</span> <span class="k">do</span>
</span><span class='line'>      <span class="vi">@secs</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>        <span class="p">(</span><span class="vi">@xml</span><span class="o">/</span><span class="s2">&quot;entry&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
</span><span class='line'>          <span class="n">title</span> <span class="o">=</span> <span class="p">(</span><span class="n">e</span><span class="o">/</span><span class="s2">&quot;title&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">text</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>        <span class="c1"># 以下でも同様。しかし、ごく少し遅い。</span>
</span><span class='line'>        <span class="c1">#(@xml/:entry).each do |e|</span>
</span><span class='line'>        <span class="c1">#  title = (e/:title).first.text</span>
</span><span class='line'>        <span class="c1">#end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>    <span class="k">raise</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">case_5</span>
</span><span class='line'>    <span class="k">return</span> <span class="no">Benchmark</span><span class="o">.</span><span class="n">realtime</span> <span class="k">do</span>
</span><span class='line'>      <span class="vi">@secs</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>        <span class="p">(</span><span class="vi">@xml</span><span class="o">/</span><span class="s2">&quot;//xmlns:entry&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
</span><span class='line'>          <span class="n">title</span> <span class="o">=</span> <span class="p">(</span><span class="n">e</span><span class="o">/</span><span class="s2">&quot;./xmlns:title&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">text</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>    <span class="k">raise</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">case_6</span>
</span><span class='line'>    <span class="k">return</span> <span class="no">Benchmark</span><span class="o">.</span><span class="n">realtime</span> <span class="k">do</span>
</span><span class='line'>      <span class="vi">@secs</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>        <span class="vi">@xml</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&quot;//xmlns:entry&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
</span><span class='line'>          <span class="n">title</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&quot;xmlns:title&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">text</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>    <span class="k">raise</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">case_7</span>
</span><span class='line'>    <span class="k">return</span> <span class="no">Benchmark</span><span class="o">.</span><span class="n">realtime</span> <span class="k">do</span>
</span><span class='line'>      <span class="vi">@secs</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>        <span class="vi">@xml</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&quot;//a:entry&quot;</span><span class="p">,</span> <span class="vi">@ns</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
</span><span class='line'>          <span class="n">title</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&quot;a:title&quot;</span><span class="p">,</span> <span class="vi">@ns</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">text</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>    <span class="k">raise</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">TestNokogiriXml</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">exec</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><a href="https://gist.github.com/komasaru/1f737b67baba38213570" title="Gist - Ruby script to verify the speed of xml parsing by Nokogiri. ">Gist - Ruby script to verify the speed of xml parsing by Nokogiri. </a></li>
</ul>


<h3>3. Ruby スクリプトの実行</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ ./test.rb
</span><span class='line'>CASE-1: 2.3432 secs.
</span><span class='line'>CASE-2: 2.4821 secs.
</span><span class='line'>CASE-3: 2.0588 secs.
</span><span class='line'>CASE-4: 2.4949 secs.
</span><span class='line'>CASE-5: 2.0672 secs.
</span><span class='line'>CASE-6: 1.7549 secs.
</span><span class='line'>CASE-7: 1.5359 secs.
</span></code></pre></td></tr></table></div></figure>


<h3>4. 検証結果について</h3>

<ul>
<li>何回か実行してみたが、全て同じような結果となった。</li>
<li><code>xpath</code> メソッドは <code>css</code>, <code>search</code>, <code>/</code> メソッドより高速に解析することができる。</li>
<li><code>xpath</code> メソッドで厳密に名前空間を指定した方が、指定せずに解析するより高速である。</li>
<li>要は、XML を解析する際は <code>xpath</code> メソッドで名前空間を指定しましょう、ということ。</li>
<li>今回の検証結果が全てという訳ではない（場合によっては「一概には言えない」ということがあるかもしれない）</li>
</ul>


<hr />

<p>当方、以前は CSS セレクタを使用して XML 解析を行なっていた時期もありましたが、現在は XPath で厳密に名前空間を指定して解析を行うようにしています。</p>

<p>以上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Postfix - メールキューの管理！]]></title>
    <link href="http://komasaru.github.io/blog/2015/09/17/postfix-management-of-mail-queue/"/>
    <updated>2015-09-17T00:20:00+09:00</updated>
    <id>http://komasaru.github.io/blog/2015/09/17/postfix-management-of-mail-queue</id>
    <content type="html"><![CDATA[<p>こんばんは。</p>

<p>SMTP サーバ Postfix でのメールキュー管理についての備忘録です。</p>

<!--more-->


<h3>0. 前提条件</h3>

<ul>
<li>Debian GNU/Linux 8.0(64bit) 上の Postfix 2.11.3-1,<br/>
CentOS 6.7(32bit) 上の Postfix 2.6.6.-2<br/>
での作業を想定。</li>
</ul>


<h3>1. 各種コマンド</h3>

<h4>1-1. メールキューの確認</h4>

<p>配送されずに溜まっているメールキューは &ldquo;/var/spool/postfix/deferred&rdquo; ディレクトリ内にある。<br/>
それらを確認するには以下のようにする。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ postqueue -p
</span><span class='line'>-Queue ID- --Size-- ----Arrival Time---- -Sender/Recipient-------
</span><span class='line'>AF70A2C009D*    1504 Sat Aug 22 23:57:39 hoge@xxxxxxxxxx.com
</span><span class='line'>                                         fuga@yyyyyyyyyy.com
</span><span class='line'>
</span><span class='line'>-- 2 Kbytes in 1 Request.
</span></code></pre></td></tr></table></div></figure>


<p>もしくは、</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ mailq
</span></code></pre></td></tr></table></div></figure>


<h4>1-2. メール内容の確認</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ postcat -q &lt;QueueID&gt;
</span></code></pre></td></tr></table></div></figure>


<h4>1-3. メールキュー配送の停止</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ postsuper -h &lt;QueueID&gt;|ALL
</span></code></pre></td></tr></table></div></figure>


<h4>1-4. メールキューの削除</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ postsuper -d &lt;QueueID&gt;|ALL
</span></code></pre></td></tr></table></div></figure>


<p>配送が遅れいているキュー全てを削除する場合は、</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ postsuper -d ALL deferred
</span></code></pre></td></tr></table></div></figure>


<h4>1-5. メールキューの再送</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ postsuper -r &lt;QueueID&gt;|ALL
</span></code></pre></td></tr></table></div></figure>


<p>もしくは、</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ postfix flush
</span></code></pre></td></tr></table></div></figure>


<p>もしくは、</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>postqueue -f
</span></code></pre></td></tr></table></div></figure>


<p>もしくは、</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>sendmail -q
</span></code></pre></td></tr></table></div></figure>


<hr />

<p>時々使用するコマンドなので、忘れたときのために記録しておいた次第です。</p>

<p>以上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[MariaDB(MySQL) - XML ダンプ出力から HTML テーブル定義書生成！]]></title>
    <link href="http://komasaru.github.io/blog/2015/09/12/mariadb-table-definition-from-xmldump-to-html/"/>
    <updated>2015-09-12T00:20:00+09:00</updated>
    <id>http://komasaru.github.io/blog/2015/09/12/mariadb-table-definition-from-xmldump-to-html</id>
    <content type="html"><![CDATA[<p>こんばんは。</p>

<p>MariaDB(MySQL) のテーブル定義書を HTML で生成する方法についての記録です。</p>

<p>実際には、スキーマ（テーブル定義）を XML 出力し、それに XSL テンプレートを適用します。</p>

<p>（テーブル定義を行なってからテーブルを作成するのが本来の手順でしょうが）</p>

<!--more-->


<h3>0. 前提条件</h3>

<ul>
<li>Linux Mint 17.2(64bit) での作業を想定。</li>
<li>MariaDB 10.0.21 サーバでの作業を想定。</li>
<li>HTML 生成に <code>xsltproc</code> コマンドを使用するので、未インストールならインストールしておく。</li>
</ul>


<h3>1. XML ダンプ出力</h3>

<p><code>mysqldump</code> コマンドを使用してスキーマ（テーブル定義）のみを XML フォーマットで出力する。<br/>
（以下は <code>test</code> というデータベースの <code>towns</code> というテーブルを &ldquo;test_towns.xml&rdquo; という XML ファイルに出力する例）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ mysqldump -u username -p --xml --no-data test towns &gt; test_towns.xml
</span></code></pre></td></tr></table></div></figure>


<p>参考までに、今回出力された XML ファイルの内容は以下のとおり。</p>

<figure class='code'><figcaption><span>text.xml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;mysqldump</span> <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><span class="nt">&gt;</span>
</span><span class='line'><span class="nt">&lt;database</span> <span class="na">name=</span><span class="s">&quot;test&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;table_structure</span> <span class="na">name=</span><span class="s">&quot;towns&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;field</span> <span class="na">Field=</span><span class="s">&quot;id&quot;</span> <span class="na">Type=</span><span class="s">&quot;int(11)&quot;</span> <span class="na">Null=</span><span class="s">&quot;NO&quot;</span> <span class="na">Key=</span><span class="s">&quot;PRI&quot;</span> <span class="na">Extra=</span><span class="s">&quot;auto_increment&quot;</span> <span class="na">Comment=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;field</span> <span class="na">Field=</span><span class="s">&quot;pref_code&quot;</span> <span class="na">Type=</span><span class="s">&quot;varchar(2)&quot;</span> <span class="na">Null=</span><span class="s">&quot;NO&quot;</span> <span class="na">Key=</span><span class="s">&quot;MUL&quot;</span> <span class="na">Default=</span><span class="s">&quot;&quot;</span> <span class="na">Extra=</span><span class="s">&quot;&quot;</span> <span class="na">Comment=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;field</span> <span class="na">Field=</span><span class="s">&quot;city_code&quot;</span> <span class="na">Type=</span><span class="s">&quot;varchar(5)&quot;</span> <span class="na">Null=</span><span class="s">&quot;NO&quot;</span> <span class="na">Key=</span><span class="s">&quot;MUL&quot;</span> <span class="na">Default=</span><span class="s">&quot;&quot;</span> <span class="na">Extra=</span><span class="s">&quot;&quot;</span> <span class="na">Comment=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;field</span> <span class="na">Field=</span><span class="s">&quot;town_code&quot;</span> <span class="na">Type=</span><span class="s">&quot;varchar(12)&quot;</span> <span class="na">Null=</span><span class="s">&quot;NO&quot;</span> <span class="na">Key=</span><span class="s">&quot;MUL&quot;</span> <span class="na">Default=</span><span class="s">&quot;&quot;</span> <span class="na">Extra=</span><span class="s">&quot;&quot;</span> <span class="na">Comment=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;field</span> <span class="na">Field=</span><span class="s">&quot;latitude&quot;</span> <span class="na">Type=</span><span class="s">&quot;double&quot;</span> <span class="na">Null=</span><span class="s">&quot;YES&quot;</span> <span class="na">Key=</span><span class="s">&quot;&quot;</span> <span class="na">Default=</span><span class="s">&quot;0&quot;</span> <span class="na">Extra=</span><span class="s">&quot;&quot;</span> <span class="na">Comment=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;field</span> <span class="na">Field=</span><span class="s">&quot;longitude&quot;</span> <span class="na">Type=</span><span class="s">&quot;double&quot;</span> <span class="na">Null=</span><span class="s">&quot;YES&quot;</span> <span class="na">Key=</span><span class="s">&quot;&quot;</span> <span class="na">Default=</span><span class="s">&quot;0&quot;</span> <span class="na">Extra=</span><span class="s">&quot;&quot;</span> <span class="na">Comment=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;field</span> <span class="na">Field=</span><span class="s">&quot;upd_datetime&quot;</span> <span class="na">Type=</span><span class="s">&quot;datetime&quot;</span> <span class="na">Null=</span><span class="s">&quot;YES&quot;</span> <span class="na">Key=</span><span class="s">&quot;&quot;</span> <span class="na">Default=</span><span class="s">&quot;0000-00-00 00:00:00&quot;</span> <span class="na">Extra=</span><span class="s">&quot;&quot;</span> <span class="na">Comment=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;key</span> <span class="na">Table=</span><span class="s">&quot;towns&quot;</span> <span class="na">Non_unique=</span><span class="s">&quot;0&quot;</span> <span class="na">Key_name=</span><span class="s">&quot;PRIMARY&quot;</span> <span class="na">Seq_in_index=</span><span class="s">&quot;1&quot;</span> <span class="na">Column_name=</span><span class="s">&quot;id&quot;</span> <span class="na">Collation=</span><span class="s">&quot;A&quot;</span> <span class="na">Cardinality=</span><span class="s">&quot;0&quot;</span> <span class="na">Null=</span><span class="s">&quot;&quot;</span> <span class="na">Index_type=</span><span class="s">&quot;BTREE&quot;</span> <span class="na">Comment=</span><span class="s">&quot;&quot;</span> <span class="na">Index_comment=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;key</span> <span class="na">Table=</span><span class="s">&quot;towns&quot;</span> <span class="na">Non_unique=</span><span class="s">&quot;1&quot;</span> <span class="na">Key_name=</span><span class="s">&quot;idx_1&quot;</span> <span class="na">Seq_in_index=</span><span class="s">&quot;1&quot;</span> <span class="na">Column_name=</span><span class="s">&quot;pref_code&quot;</span> <span class="na">Collation=</span><span class="s">&quot;A&quot;</span> <span class="na">Cardinality=</span><span class="s">&quot;0&quot;</span> <span class="na">Null=</span><span class="s">&quot;&quot;</span> <span class="na">Index_type=</span><span class="s">&quot;BTREE&quot;</span> <span class="na">Comment=</span><span class="s">&quot;&quot;</span> <span class="na">Index_comment=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;key</span> <span class="na">Table=</span><span class="s">&quot;towns&quot;</span> <span class="na">Non_unique=</span><span class="s">&quot;1&quot;</span> <span class="na">Key_name=</span><span class="s">&quot;idx_1&quot;</span> <span class="na">Seq_in_index=</span><span class="s">&quot;2&quot;</span> <span class="na">Column_name=</span><span class="s">&quot;city_code&quot;</span> <span class="na">Collation=</span><span class="s">&quot;A&quot;</span> <span class="na">Cardinality=</span><span class="s">&quot;0&quot;</span> <span class="na">Null=</span><span class="s">&quot;&quot;</span> <span class="na">Index_type=</span><span class="s">&quot;BTREE&quot;</span> <span class="na">Comment=</span><span class="s">&quot;&quot;</span> <span class="na">Index_comment=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;key</span> <span class="na">Table=</span><span class="s">&quot;towns&quot;</span> <span class="na">Non_unique=</span><span class="s">&quot;1&quot;</span> <span class="na">Key_name=</span><span class="s">&quot;idx_1&quot;</span> <span class="na">Seq_in_index=</span><span class="s">&quot;3&quot;</span> <span class="na">Column_name=</span><span class="s">&quot;town_code&quot;</span> <span class="na">Collation=</span><span class="s">&quot;A&quot;</span> <span class="na">Cardinality=</span><span class="s">&quot;0&quot;</span> <span class="na">Null=</span><span class="s">&quot;&quot;</span> <span class="na">Index_type=</span><span class="s">&quot;BTREE&quot;</span> <span class="na">Comment=</span><span class="s">&quot;&quot;</span> <span class="na">Index_comment=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;key</span> <span class="na">Table=</span><span class="s">&quot;towns&quot;</span> <span class="na">Non_unique=</span><span class="s">&quot;1&quot;</span> <span class="na">Key_name=</span><span class="s">&quot;idx_2&quot;</span> <span class="na">Seq_in_index=</span><span class="s">&quot;1&quot;</span> <span class="na">Column_name=</span><span class="s">&quot;city_code&quot;</span> <span class="na">Collation=</span><span class="s">&quot;A&quot;</span> <span class="na">Cardinality=</span><span class="s">&quot;0&quot;</span> <span class="na">Null=</span><span class="s">&quot;&quot;</span> <span class="na">Index_type=</span><span class="s">&quot;BTREE&quot;</span> <span class="na">Comment=</span><span class="s">&quot;&quot;</span> <span class="na">Index_comment=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;key</span> <span class="na">Table=</span><span class="s">&quot;towns&quot;</span> <span class="na">Non_unique=</span><span class="s">&quot;1&quot;</span> <span class="na">Key_name=</span><span class="s">&quot;idx_2&quot;</span> <span class="na">Seq_in_index=</span><span class="s">&quot;2&quot;</span> <span class="na">Column_name=</span><span class="s">&quot;town_code&quot;</span> <span class="na">Collation=</span><span class="s">&quot;A&quot;</span> <span class="na">Cardinality=</span><span class="s">&quot;0&quot;</span> <span class="na">Null=</span><span class="s">&quot;&quot;</span> <span class="na">Index_type=</span><span class="s">&quot;BTREE&quot;</span> <span class="na">Comment=</span><span class="s">&quot;&quot;</span> <span class="na">Index_comment=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;key</span> <span class="na">Table=</span><span class="s">&quot;towns&quot;</span> <span class="na">Non_unique=</span><span class="s">&quot;1&quot;</span> <span class="na">Key_name=</span><span class="s">&quot;idx_3&quot;</span> <span class="na">Seq_in_index=</span><span class="s">&quot;1&quot;</span> <span class="na">Column_name=</span><span class="s">&quot;town_code&quot;</span> <span class="na">Collation=</span><span class="s">&quot;A&quot;</span> <span class="na">Cardinality=</span><span class="s">&quot;0&quot;</span> <span class="na">Null=</span><span class="s">&quot;&quot;</span> <span class="na">Index_type=</span><span class="s">&quot;BTREE&quot;</span> <span class="na">Comment=</span><span class="s">&quot;&quot;</span> <span class="na">Index_comment=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;options</span> <span class="na">Name=</span><span class="s">&quot;towns&quot;</span> <span class="na">Engine=</span><span class="s">&quot;InnoDB&quot;</span> <span class="na">Version=</span><span class="s">&quot;10&quot;</span> <span class="na">Row_format=</span><span class="s">&quot;Compact&quot;</span> <span class="na">Rows=</span><span class="s">&quot;0&quot;</span> <span class="na">Avg_row_length=</span><span class="s">&quot;0&quot;</span> <span class="na">Data_length=</span><span class="s">&quot;16384&quot;</span> <span class="na">Max_data_length=</span><span class="s">&quot;0&quot;</span> <span class="na">Index_length=</span><span class="s">&quot;49152&quot;</span> <span class="na">Data_free=</span><span class="s">&quot;0&quot;</span> <span class="na">Auto_increment=</span><span class="s">&quot;1&quot;</span> <span class="na">Create_time=</span><span class="s">&quot;2015-08-18 14:06:07&quot;</span> <span class="na">Collation=</span><span class="s">&quot;utf8_general_ci&quot;</span> <span class="na">Create_options=</span><span class="s">&quot;&quot;</span> <span class="na">Comment=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/table_structure&gt;</span>
</span><span class='line'><span class="nt">&lt;/database&gt;</span>
</span><span class='line'><span class="nt">&lt;/mysqldump&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>ちなみに、今回使用しているテーブルの CREATE 文は以下のようになっている。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">towns</span><span class="o">`</span> <span class="p">(</span>
</span><span class='line'>  <span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">pref_code</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">city_code</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">town_code</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">latitude</span><span class="o">`</span> <span class="n">double</span> <span class="k">DEFAULT</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">longitude</span><span class="o">`</span> <span class="n">double</span> <span class="k">DEFAULT</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">upd_datetime</span><span class="o">`</span> <span class="n">datetime</span> <span class="k">DEFAULT</span> <span class="s1">&#39;0000-00-00 00:00:00&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">),</span>
</span><span class='line'>  <span class="k">KEY</span> <span class="o">`</span><span class="n">idx_1</span><span class="o">`</span> <span class="p">(</span><span class="o">`</span><span class="n">pref_code</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">city_code</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">town_code</span><span class="o">`</span><span class="p">),</span>
</span><span class='line'>  <span class="k">KEY</span> <span class="o">`</span><span class="n">idx_2</span><span class="o">`</span> <span class="p">(</span><span class="o">`</span><span class="n">city_code</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">town_code</span><span class="o">`</span><span class="p">),</span>
</span><span class='line'>  <span class="k">KEY</span> <span class="o">`</span><span class="n">idx_3</span><span class="o">`</span> <span class="p">(</span><span class="o">`</span><span class="n">town_code</span><span class="o">`</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>2. XSL テンプレートの作成</h3>

<p>以下のように XSL テンプレートを作成する。（あくまで一例。必要であれば適宜編集）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;xsl:stylesheet</span>
</span><span class='line'>  <span class="na">xmlns:xsl=</span><span class="s">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span>
</span><span class='line'>  <span class="na">version=</span><span class="s">&quot;1.0&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;xsl:output</span> <span class="na">method=</span><span class="s">&quot;html&quot;</span> <span class="na">encoding=</span><span class="s">&quot;utf-8&quot;</span> <span class="na">version=</span><span class="s">&quot;1.0&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;xsl:template</span> <span class="na">match=</span><span class="s">&quot;mysqldump&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;html&gt;</span>
</span><span class='line'>    <span class="nt">&lt;head&gt;</span>
</span><span class='line'>      <span class="nt">&lt;title&gt;</span>データベース・テーブル定義<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>      <span class="nt">&lt;style</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        h2 {
</span><span class='line'>          background-color: #8fbc8f;
</span><span class='line'>          padding:          5px;
</span><span class='line'>        }
</span><span class='line'>        h4 {
</span><span class='line'>          color:            #666;
</span><span class='line'>          margin-top:       5px;
</span><span class='line'>          margin-bottom:    5px;
</span><span class='line'>        }
</span><span class='line'>        table {
</span><span class='line'>          border-collapse:  separate;
</span><span class='line'>          border-spacing:   0px;
</span><span class='line'>          border-top:       1px solid #ccc;
</span><span class='line'>          border-left:      1px solid #ccc;
</span><span class='line'>          margin-bottom:    5px;
</span><span class='line'>        }
</span><span class='line'>        table th {
</span><span class='line'>          text-align:       left;
</span><span class='line'>          vertical-align:   top;
</span><span class='line'>          color:            #444;
</span><span class='line'>          background-color: #ccc;
</span><span class='line'>          border-top:       1px solid #fff;
</span><span class='line'>          border-left:      1px solid #fff;
</span><span class='line'>          border-right:     1px solid #ccc;
</span><span class='line'>          border-bottom:    1px solid #ccc;
</span><span class='line'>          padding:          4px;
</span><span class='line'>          white-space:      nowrap;
</span><span class='line'>        }
</span><span class='line'>        table td {
</span><span class='line'>          background-color: #fafafa;
</span><span class='line'>          border-right:     1px solid #ccc;
</span><span class='line'>          border-bottom:    1px solid #ccc;
</span><span class='line'>          padding:          4px;
</span><span class='line'>          white-space:      nowrap;
</span><span class='line'>        }
</span><span class='line'>        .tbl-db-name {
</span><span class='line'>          margin-bottom:    10px;
</span><span class='line'>        }
</span><span class='line'>        .th-db-title {
</span><span class='line'>          background-color: #bdb76b;
</span><span class='line'>          width:            200px;
</span><span class='line'>        }
</span><span class='line'>        .th-tbl-title {
</span><span class='line'>          width:            200px;
</span><span class='line'>        }
</span><span class='line'>        .td-name {
</span><span class='line'>          width:            200px;
</span><span class='line'>        }
</span><span class='line'>        .th-no {
</span><span class='line'>          width:            50px;
</span><span class='line'>          text-align:       right;
</span><span class='line'>        }
</span><span class='line'>        .th-field,
</span><span class='line'>        .th-type,
</span><span class='line'>        .th-extra,
</span><span class='line'>        .th-default,
</span><span class='line'>        .th-comment,
</span><span class='line'>        .th-keyname {
</span><span class='line'>          width:            200px;
</span><span class='line'>        }
</span><span class='line'>        .th-null,
</span><span class='line'>        .th-key {
</span><span class='line'>          width:            50px;
</span><span class='line'>        }
</span><span class='line'>        .th-columns {
</span><span class='line'>          width:            400px;
</span><span class='line'>        }
</span><span class='line'>        .th-nonunique {
</span><span class='line'>          width:            100px;
</span><span class='line'>        }
</span><span class='line'>        .td-no {
</span><span class='line'>          text-align:       right;
</span><span class='line'>        }
</span><span class='line'>      <span class="nt">&lt;/style&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/head&gt;</span>
</span><span class='line'>    <span class="nt">&lt;body&gt;</span>
</span><span class='line'>      <span class="nt">&lt;h2&gt;</span>データベース・テーブル定義書<span class="nt">&lt;/h2&gt;</span>
</span><span class='line'>      <span class="nt">&lt;xsl:apply-templates</span> <span class="na">select=</span><span class="s">&quot;database&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/body&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/html&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/xsl:template&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;xsl:template</span> <span class="na">match=</span><span class="s">&quot;database&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">&quot;tbl-db-name&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;tr&gt;</span>
</span><span class='line'>        <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-db-title&quot;</span><span class="nt">&gt;</span>データベース名<span class="nt">&lt;/th&gt;</span>
</span><span class='line'>        <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;td-name&quot;</span><span class="nt">&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&quot;@name&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/tr&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/table&gt;</span>
</span><span class='line'>    <span class="nt">&lt;xsl:apply-templates</span> <span class="na">select=</span><span class="s">&quot;table_structure&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/xsl:template&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;xsl:template</span> <span class="na">match=</span><span class="s">&quot;table_structure&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;table&gt;</span>
</span><span class='line'>      <span class="nt">&lt;tr&gt;</span>
</span><span class='line'>        <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-tbl-title&quot;</span><span class="nt">&gt;</span>テーブル名<span class="nt">&lt;/th&gt;</span>
</span><span class='line'>        <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;td-name&quot;</span><span class="nt">&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&quot;@name&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/tr&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/table&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;h4&gt;</span>カラム情報<span class="nt">&lt;/h4&gt;</span>
</span><span class='line'>    <span class="nt">&lt;table&gt;</span>
</span><span class='line'>      <span class="nt">&lt;thead&gt;</span>
</span><span class='line'>        <span class="nt">&lt;tr&gt;</span>
</span><span class='line'>          <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-no&quot;</span>     <span class="nt">&gt;</span>#<span class="nt">&lt;/th&gt;</span>
</span><span class='line'>          <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-field&quot;</span>  <span class="nt">&gt;</span>フィールド名<span class="nt">&lt;/th&gt;</span>
</span><span class='line'>          <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-type&quot;</span>   <span class="nt">&gt;</span>データ型<span class="nt">&lt;/th&gt;</span>
</span><span class='line'>          <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-null&quot;</span>   <span class="nt">&gt;</span>Null<span class="nt">&lt;/th&gt;</span>
</span><span class='line'>          <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-key&quot;</span>    <span class="nt">&gt;</span>キー<span class="nt">&lt;/th&gt;</span>
</span><span class='line'>          <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-extra&quot;</span>  <span class="nt">&gt;</span>Extra<span class="nt">&lt;/th&gt;</span>
</span><span class='line'>          <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-default&quot;</span><span class="nt">&gt;</span>デフォルト<span class="nt">&lt;/th&gt;</span>
</span><span class='line'>          <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-comment&quot;</span><span class="nt">&gt;</span>備考<span class="nt">&lt;/th&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/tr&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/thead&gt;</span>
</span><span class='line'>      <span class="nt">&lt;tbody&gt;</span>
</span><span class='line'>        <span class="nt">&lt;xsl:for-each</span> <span class="na">select=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;tr&gt;</span>
</span><span class='line'>          <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;td-no&quot;</span><span class="nt">&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&quot;position()&quot;</span><span class="nt">/&gt;&lt;/td&gt;</span>
</span><span class='line'>          <span class="nt">&lt;td&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&quot;@Field&quot;</span>   <span class="nt">/&gt;&lt;/td&gt;</span>
</span><span class='line'>          <span class="nt">&lt;td&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&quot;@Type&quot;</span>    <span class="nt">/&gt;&lt;/td&gt;</span>
</span><span class='line'>          <span class="nt">&lt;td&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&quot;@Null&quot;</span>    <span class="nt">/&gt;&lt;/td&gt;</span>
</span><span class='line'>          <span class="nt">&lt;td&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&quot;@Key&quot;</span>     <span class="nt">/&gt;&lt;/td&gt;</span>
</span><span class='line'>          <span class="nt">&lt;td&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&quot;@Extra&quot;</span>   <span class="nt">/&gt;&lt;/td&gt;</span>
</span><span class='line'>          <span class="nt">&lt;td&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&quot;@Default&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
</span><span class='line'>          <span class="nt">&lt;td&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&quot;@Comment&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/tr&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/xsl:for-each&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/tbody&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/table&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;h4&gt;</span>インデックス情報<span class="nt">&lt;/h4&gt;</span>
</span><span class='line'>    <span class="nt">&lt;table&gt;</span>
</span><span class='line'>      <span class="nt">&lt;thead&gt;</span>
</span><span class='line'>        <span class="nt">&lt;tr&gt;</span>
</span><span class='line'>          <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-keyname&quot;</span>  <span class="nt">&gt;</span>インデックス名<span class="nt">&lt;/th&gt;</span>
</span><span class='line'>          <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-columns&quot;</span>  <span class="nt">&gt;</span>カラムリスト<span class="nt">&lt;/th&gt;</span>
</span><span class='line'>          <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-nonunique&quot;</span><span class="nt">&gt;</span>ユニーク<span class="nt">&lt;/th&gt;</span>
</span><span class='line'>          <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-comment&quot;</span>  <span class="nt">&gt;</span>備考<span class="nt">&lt;/th&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/tr&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/thead&gt;</span>
</span><span class='line'>      <span class="nt">&lt;tbody&gt;</span>
</span><span class='line'>        <span class="nt">&lt;xsl:for-each</span> <span class="na">select=</span><span class="s">&quot;key&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>          <span class="nt">&lt;xsl:variable</span> <span class="na">name=</span><span class="s">&quot;key_name&quot;</span> <span class="na">select=</span><span class="s">&quot;@Key_name&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>          <span class="nt">&lt;xsl:if</span> <span class="na">test=</span><span class="s">&quot;not(preceding-sibling::key[@Key_name=$key_name])&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>          <span class="nt">&lt;tr&gt;</span>
</span><span class='line'>            <span class="nt">&lt;td&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&quot;$key_name&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
</span><span class='line'>            <span class="nt">&lt;td&gt;</span>
</span><span class='line'>              <span class="nt">&lt;xsl:for-each</span> <span class="na">select=</span><span class="s">&quot;../key[@Key_name=$key_name]&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>                <span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&quot;@Column_name&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>                <span class="nt">&lt;xsl:if</span> <span class="na">test=</span><span class="s">&quot;position()!=last()&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>                  <span class="nt">&lt;xsl:text&gt;</span>, <span class="nt">&lt;/xsl:text&gt;</span>
</span><span class='line'>                <span class="nt">&lt;/xsl:if&gt;</span>
</span><span class='line'>              <span class="nt">&lt;/xsl:for-each&gt;</span>
</span><span class='line'>            <span class="nt">&lt;/td&gt;</span>
</span><span class='line'>            <span class="nt">&lt;td&gt;</span>
</span><span class='line'>              <span class="nt">&lt;xsl:choose&gt;</span>
</span><span class='line'>                <span class="nt">&lt;xsl:when</span> <span class="na">test=</span><span class="s">&quot;@Non_unique=&#39;0&#39;&quot;</span><span class="nt">&gt;</span>1<span class="nt">&lt;/xsl:when&gt;</span>
</span><span class='line'>                <span class="nt">&lt;xsl:otherwise&gt;</span>0<span class="nt">&lt;/xsl:otherwise&gt;</span>
</span><span class='line'>              <span class="nt">&lt;/xsl:choose&gt;</span>
</span><span class='line'>            <span class="nt">&lt;/td&gt;</span>
</span><span class='line'>            <span class="nt">&lt;td&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&quot;@Comment&quot;</span>    <span class="nt">/&gt;&lt;/td&gt;</span>
</span><span class='line'>          <span class="nt">&lt;/tr&gt;</span>
</span><span class='line'>          <span class="nt">&lt;/xsl:if&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/xsl:for-each&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/tbody&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/table&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/xsl:template&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;xsl:template</span> <span class="na">name=</span><span class="s">&quot;no_increment&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;xsl:param</span> <span class="na">name=</span><span class="s">&quot;no&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&quot;$no + 1&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/xsl:template&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/xsl:stylesheet&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><a href="https://gist.github.com/komasaru/ecce393eb6056d4c92a7" title="Gist - XSL template to generate a HTML from a XML of MariaDB(MySQL)'s table definition.">Gist - XSL template to generate a HTML from a XML of MariaDB(MySQL)&rsquo;s table definition.</a></li>
</ul>


<h3>3. HTML の生成</h3>

<p><code>xsltproc</code> コマンドを使用して HTML を生成する。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ xsltproc --output test_towns.html table_definition.xsl test_towns.xml
</span></code></pre></td></tr></table></div></figure>


<h3>4. HTML の確認</h3>

<p>生成された HTML を確認してみる。</p>

<figure class='code'><figcaption><span>test_towns.html</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="cp">&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD HTML 4.0 Transitional//EN&quot; &quot;http://www.w3.org/TR/REC-html40/loose.dtd&quot;&gt;</span>
</span><span class='line'><span class="nt">&lt;html&gt;</span>
</span><span class='line'><span class="nt">&lt;head&gt;</span>
</span><span class='line'><span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;Content-Type&quot;</span> <span class="na">content=</span><span class="s">&quot;text/html; charset=utf-8&quot;</span><span class="nt">&gt;</span>
</span><span class='line'><span class="nt">&lt;title&gt;</span>データベース・テーブル定義<span class="nt">&lt;/title&gt;</span>
</span><span class='line'><span class="nt">&lt;style </span><span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">h2</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">background-color</span><span class="o">:</span> <span class="m">#8fbc8f</span><span class="p">;</span>
</span><span class='line'>          <span class="k">padding</span><span class="o">:</span>          <span class="m">5px</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nt">h4</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">color</span><span class="o">:</span>            <span class="m">#666</span><span class="p">;</span>
</span><span class='line'>          <span class="k">margin-top</span><span class="o">:</span>       <span class="m">5px</span><span class="p">;</span>
</span><span class='line'>          <span class="k">margin-bottom</span><span class="o">:</span>    <span class="m">5px</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nt">table</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">border-collapse</span><span class="o">:</span>  <span class="k">separate</span><span class="p">;</span>
</span><span class='line'>          <span class="k">border-spacing</span><span class="o">:</span>   <span class="m">0px</span><span class="p">;</span>
</span><span class='line'>          <span class="k">border-top</span><span class="o">:</span>       <span class="m">1px</span> <span class="k">solid</span> <span class="m">#ccc</span><span class="p">;</span>
</span><span class='line'>          <span class="k">border-left</span><span class="o">:</span>      <span class="m">1px</span> <span class="k">solid</span> <span class="m">#ccc</span><span class="p">;</span>
</span><span class='line'>          <span class="k">margin-bottom</span><span class="o">:</span>    <span class="m">5px</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nt">table</span> <span class="nt">th</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">text-align</span><span class="o">:</span>       <span class="k">left</span><span class="p">;</span>
</span><span class='line'>          <span class="k">vertical-align</span><span class="o">:</span>   <span class="k">top</span><span class="p">;</span>
</span><span class='line'>          <span class="k">color</span><span class="o">:</span>            <span class="m">#444</span><span class="p">;</span>
</span><span class='line'>          <span class="k">background-color</span><span class="o">:</span> <span class="m">#ccc</span><span class="p">;</span>
</span><span class='line'>          <span class="k">border-top</span><span class="o">:</span>       <span class="m">1px</span> <span class="k">solid</span> <span class="m">#fff</span><span class="p">;</span>
</span><span class='line'>          <span class="k">border-left</span><span class="o">:</span>      <span class="m">1px</span> <span class="k">solid</span> <span class="m">#fff</span><span class="p">;</span>
</span><span class='line'>          <span class="k">border-right</span><span class="o">:</span>     <span class="m">1px</span> <span class="k">solid</span> <span class="m">#ccc</span><span class="p">;</span>
</span><span class='line'>          <span class="k">border-bottom</span><span class="o">:</span>    <span class="m">1px</span> <span class="k">solid</span> <span class="m">#ccc</span><span class="p">;</span>
</span><span class='line'>          <span class="k">padding</span><span class="o">:</span>          <span class="m">4px</span><span class="p">;</span>
</span><span class='line'>          <span class="k">white-space</span><span class="o">:</span>      <span class="k">nowrap</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nt">table</span> <span class="nt">td</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">background-color</span><span class="o">:</span> <span class="m">#fafafa</span><span class="p">;</span>
</span><span class='line'>          <span class="k">border-right</span><span class="o">:</span>     <span class="m">1px</span> <span class="k">solid</span> <span class="m">#ccc</span><span class="p">;</span>
</span><span class='line'>          <span class="k">border-bottom</span><span class="o">:</span>    <span class="m">1px</span> <span class="k">solid</span> <span class="m">#ccc</span><span class="p">;</span>
</span><span class='line'>          <span class="k">padding</span><span class="o">:</span>          <span class="m">4px</span><span class="p">;</span>
</span><span class='line'>          <span class="k">white-space</span><span class="o">:</span>      <span class="k">nowrap</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nc">.tbl-db-name</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">margin-bottom</span><span class="o">:</span>    <span class="m">10px</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nc">.th-db-title</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">background-color</span><span class="o">:</span> <span class="m">#bdb76b</span><span class="p">;</span>
</span><span class='line'>          <span class="k">width</span><span class="o">:</span>            <span class="m">200px</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nc">.th-tbl-title</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">width</span><span class="o">:</span>            <span class="m">200px</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nc">.td-name</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">width</span><span class="o">:</span>            <span class="m">200px</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nc">.th-no</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">width</span><span class="o">:</span>            <span class="m">50px</span><span class="p">;</span>
</span><span class='line'>          <span class="k">text-align</span><span class="o">:</span>       <span class="k">right</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nc">.th-field</span><span class="o">,</span>
</span><span class='line'>        <span class="nc">.th-type</span><span class="o">,</span>
</span><span class='line'>        <span class="nc">.th-extra</span><span class="o">,</span>
</span><span class='line'>        <span class="nc">.th-default</span><span class="o">,</span>
</span><span class='line'>        <span class="nc">.th-comment</span><span class="o">,</span>
</span><span class='line'>        <span class="nc">.th-keyname</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">width</span><span class="o">:</span>            <span class="m">200px</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nc">.th-null</span><span class="o">,</span>
</span><span class='line'>        <span class="nc">.th-key</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">width</span><span class="o">:</span>            <span class="m">50px</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nc">.th-columns</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">width</span><span class="o">:</span>            <span class="m">400px</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nc">.th-nonunique</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">width</span><span class="o">:</span>            <span class="m">100px</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nc">.td-no</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">text-align</span><span class="o">:</span>       <span class="k">right</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="nt">&lt;/style&gt;</span>
</span><span class='line'><span class="nt">&lt;/head&gt;</span>
</span><span class='line'><span class="nt">&lt;body&gt;</span>
</span><span class='line'><span class="nt">&lt;h2&gt;</span>データベース・テーブル定義書<span class="nt">&lt;/h2&gt;</span>
</span><span class='line'><span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">&quot;tbl-db-name&quot;</span><span class="nt">&gt;&lt;tr&gt;</span>
</span><span class='line'><span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-db-title&quot;</span><span class="nt">&gt;</span>データベース名<span class="nt">&lt;/th&gt;</span>
</span><span class='line'><span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;td-name&quot;</span><span class="nt">&gt;</span>test<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;/tr&gt;&lt;/table&gt;</span>
</span><span class='line'><span class="nt">&lt;table&gt;&lt;tr&gt;</span>
</span><span class='line'><span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-tbl-title&quot;</span><span class="nt">&gt;</span>テーブル名<span class="nt">&lt;/th&gt;</span>
</span><span class='line'><span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;td-name&quot;</span><span class="nt">&gt;</span>towns<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;/tr&gt;&lt;/table&gt;</span>
</span><span class='line'><span class="nt">&lt;h4&gt;</span>カラム情報<span class="nt">&lt;/h4&gt;</span>
</span><span class='line'><span class="nt">&lt;table&gt;</span>
</span><span class='line'><span class="nt">&lt;thead&gt;&lt;tr&gt;</span>
</span><span class='line'><span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-no&quot;</span><span class="nt">&gt;</span>#<span class="nt">&lt;/th&gt;</span>
</span><span class='line'><span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-field&quot;</span><span class="nt">&gt;</span>フィールド名<span class="nt">&lt;/th&gt;</span>
</span><span class='line'><span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-type&quot;</span><span class="nt">&gt;</span>データ型<span class="nt">&lt;/th&gt;</span>
</span><span class='line'><span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-null&quot;</span><span class="nt">&gt;</span>Null<span class="nt">&lt;/th&gt;</span>
</span><span class='line'><span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-key&quot;</span><span class="nt">&gt;</span>キー<span class="nt">&lt;/th&gt;</span>
</span><span class='line'><span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-extra&quot;</span><span class="nt">&gt;</span>Extra<span class="nt">&lt;/th&gt;</span>
</span><span class='line'><span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-default&quot;</span><span class="nt">&gt;</span>デフォルト<span class="nt">&lt;/th&gt;</span>
</span><span class='line'><span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-comment&quot;</span><span class="nt">&gt;</span>備考<span class="nt">&lt;/th&gt;</span>
</span><span class='line'><span class="nt">&lt;/tr&gt;&lt;/thead&gt;</span>
</span><span class='line'><span class="nt">&lt;tbody&gt;</span>
</span><span class='line'><span class="nt">&lt;tr&gt;</span>
</span><span class='line'><span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;td-no&quot;</span><span class="nt">&gt;</span>1<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>id<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>int(11)<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>NO<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>PRI<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>auto_increment<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;/tr&gt;</span>
</span><span class='line'><span class="nt">&lt;tr&gt;</span>
</span><span class='line'><span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;td-no&quot;</span><span class="nt">&gt;</span>2<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>pref_code<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>varchar(2)<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>NO<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>MUL<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;/tr&gt;</span>
</span><span class='line'><span class="nt">&lt;tr&gt;</span>
</span><span class='line'><span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;td-no&quot;</span><span class="nt">&gt;</span>3<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>city_code<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>varchar(5)<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>NO<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>MUL<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;/tr&gt;</span>
</span><span class='line'><span class="nt">&lt;tr&gt;</span>
</span><span class='line'><span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;td-no&quot;</span><span class="nt">&gt;</span>4<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>town_code<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>varchar(12)<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>NO<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>MUL<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;/tr&gt;</span>
</span><span class='line'><span class="nt">&lt;tr&gt;</span>
</span><span class='line'><span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;td-no&quot;</span><span class="nt">&gt;</span>5<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>latitude<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>double<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>YES<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>0<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;/tr&gt;</span>
</span><span class='line'><span class="nt">&lt;tr&gt;</span>
</span><span class='line'><span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;td-no&quot;</span><span class="nt">&gt;</span>6<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>longitude<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>double<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>YES<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>0<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;/tr&gt;</span>
</span><span class='line'><span class="nt">&lt;tr&gt;</span>
</span><span class='line'><span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;td-no&quot;</span><span class="nt">&gt;</span>7<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>upd_datetime<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>datetime<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>YES<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>0000-00-00 00:00:00<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;/tr&gt;</span>
</span><span class='line'><span class="nt">&lt;/tbody&gt;</span>
</span><span class='line'><span class="nt">&lt;/table&gt;</span>
</span><span class='line'><span class="nt">&lt;h4&gt;</span>インデックス情報<span class="nt">&lt;/h4&gt;</span>
</span><span class='line'><span class="nt">&lt;table&gt;</span>
</span><span class='line'><span class="nt">&lt;thead&gt;&lt;tr&gt;</span>
</span><span class='line'><span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-keyname&quot;</span><span class="nt">&gt;</span>インデックス名<span class="nt">&lt;/th&gt;</span>
</span><span class='line'><span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-columns&quot;</span><span class="nt">&gt;</span>カラムリスト<span class="nt">&lt;/th&gt;</span>
</span><span class='line'><span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-nonunique&quot;</span><span class="nt">&gt;</span>ユニーク<span class="nt">&lt;/th&gt;</span>
</span><span class='line'><span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-comment&quot;</span><span class="nt">&gt;</span>備考<span class="nt">&lt;/th&gt;</span>
</span><span class='line'><span class="nt">&lt;/tr&gt;&lt;/thead&gt;</span>
</span><span class='line'><span class="nt">&lt;tbody&gt;</span>
</span><span class='line'><span class="nt">&lt;tr&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>PRIMARY<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>id<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>1<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;/tr&gt;</span>
</span><span class='line'><span class="nt">&lt;tr&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>idx_1<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>pref_code, city_code, town_code<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>0<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;/tr&gt;</span>
</span><span class='line'><span class="nt">&lt;tr&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>idx_2<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>city_code, town_code<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>0<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;/tr&gt;</span>
</span><span class='line'><span class="nt">&lt;tr&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>idx_3<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>town_code<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>0<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;/tr&gt;</span>
</span><span class='line'><span class="nt">&lt;/tbody&gt;</span>
</span><span class='line'><span class="nt">&lt;/table&gt;</span>
</span><span class='line'><span class="nt">&lt;/body&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>さらに、 HTML ファイルをブラウザで開いて確認してみる。</p>

<p><img src="http://komasaru.github.io/images/2015/09/12/TABLE_DEF_HTML.png" title="TABLE_DEF_HTML" alt="TABLE_DEF_HTML" /></p>

<hr />

<p>大量にテーブル定義書を生成したければシェル化するのもよいでしょう。</p>

<p>以上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Linux - XML に XSLT を適用して HTML 生成！]]></title>
    <link href="http://komasaru.github.io/blog/2015/09/07/linux-apply-xslt-to-xml-by-xsltproc/"/>
    <updated>2015-09-07T00:20:00+09:00</updated>
    <id>http://komasaru.github.io/blog/2015/09/07/linux-apply-xslt-to-xml-by-xsltproc</id>
    <content type="html"><![CDATA[<p>こんばんは。</p>

<p>以前、 Ruby で XML ファイルに XSL テンプレートを適用して HTML を生成する方法を紹介しました。</p>

<ul>
<li><a href="http://komasaru.github.io/2013/12/04/ruby-apply-xslt-to-xml/" title="Ruby - XML に XSLT を適用して HTML 生成！">Ruby - XML に XSLT を適用して HTML 生成！</a></li>
</ul>


<p>ただ、 Linux ディストリビューションによってはデフォルトで XML に XSL テンプレートを適用するコマンドがインストールされています。<br/>
わざわざ Ruby を使用しなくてもよいということです。</p>

<p>以下、その使用方法についての備忘録です。</p>

<!--more-->


<h3>0. 前提条件</h3>

<ul>
<li>Linux Mint 17.2(64bit) での作業を想定。</li>
<li>XML に XSL テンプレート適用して HTML ファイルを生成するのに <code>xsltproc</code> コマンドを使用する。</li>
</ul>


<h3>1. xsltproc コマンドのインストール</h3>

<p><code>xsltproc</code> コマンドが未インストールならインストールしておく。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ sudo apt-get install xsltproc
</span></code></pre></td></tr></table></div></figure>


<h3>2. XML ファイルの準備</h3>

<p>試験的に使用する XML ファイルを以下のように作成する。（あくまで一例）</p>

<figure class='code'><figcaption><span>test.xml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
</span><span class='line'><span class="cp">&lt;?xml-stylesheet type=&quot;text/xsl&quot; href=&quot;test.xsl&quot; ?&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;Office&gt;</span>
</span><span class='line'>  <span class="nt">&lt;People&gt;</span>
</span><span class='line'>    <span class="nt">&lt;Person&gt;</span>
</span><span class='line'>      <span class="nt">&lt;No&gt;</span>1234<span class="nt">&lt;/No&gt;</span>
</span><span class='line'>      <span class="nt">&lt;Name&gt;</span>Ruby 太郎<span class="nt">&lt;/Name&gt;</span>
</span><span class='line'>      <span class="nt">&lt;Birthday&gt;</span>1980-01-01<span class="nt">&lt;/Birthday&gt;</span>
</span><span class='line'>      <span class="nt">&lt;Age&gt;</span>33<span class="nt">&lt;/Age&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/Person&gt;</span>
</span><span class='line'>    <span class="nt">&lt;Person&gt;</span>
</span><span class='line'>      <span class="nt">&lt;No&gt;</span>2345<span class="nt">&lt;/No&gt;</span>
</span><span class='line'>      <span class="nt">&lt;Name&gt;</span>XML 二郎<span class="nt">&lt;/Name&gt;</span>
</span><span class='line'>      <span class="nt">&lt;Birthday&gt;</span>1985-04-15<span class="nt">&lt;/Birthday&gt;</span>
</span><span class='line'>      <span class="nt">&lt;Age&gt;</span>28<span class="nt">&lt;/Age&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/Person&gt;</span>
</span><span class='line'>    <span class="nt">&lt;Person&gt;</span>
</span><span class='line'>      <span class="nt">&lt;No&gt;</span>3456<span class="nt">&lt;/No&gt;</span>
</span><span class='line'>      <span class="nt">&lt;Name&gt;</span>XSL 花子<span class="nt">&lt;/Name&gt;</span>
</span><span class='line'>      <span class="nt">&lt;Birthday&gt;</span>1990-09-30<span class="nt">&lt;/Birthday&gt;</span>
</span><span class='line'>      <span class="nt">&lt;Age&gt;</span>23<span class="nt">&lt;/Age&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/Person&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/People&gt;</span>
</span><span class='line'><span class="nt">&lt;/Office&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>3. XSL テンプレートファイルの準備</h3>

<p>試験的に使用する XSL テンプレートファイルを以下のように作成する。（あくまで一例）</p>

<figure class='code'><figcaption><span>test.xsl</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;xsl:stylesheet</span> <span class="na">xmlns:xsl=</span><span class="s">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span> <span class="na">version=</span><span class="s">&quot;1.0&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>   <span class="nt">&lt;xsl:output</span> <span class="na">method=</span><span class="s">&quot;html&quot;</span> <span class="na">encoding=</span><span class="s">&quot;UTF-8&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;xsl:template</span> <span class="na">match=</span><span class="s">&quot;/&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;xsl:apply-templates/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/xsl:template&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;xsl:template</span> <span class="na">match=</span><span class="s">&quot;Office&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;ja&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;body&gt;</span>
</span><span class='line'>    <span class="nt">&lt;xsl:apply-templates/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/body&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/html&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/xsl:template&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;xsl:template</span> <span class="na">match=</span><span class="s">&quot;People&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;table&gt;</span>
</span><span class='line'>    <span class="nt">&lt;xsl:apply-templates/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/table&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/xsl:template&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;xsl:template</span> <span class="na">match=</span><span class="s">&quot;Person&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;tr&gt;</span>
</span><span class='line'>      <span class="nt">&lt;td&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&quot;No&quot;</span><span class="nt">/&gt;&lt;/td&gt;</span>
</span><span class='line'>      <span class="nt">&lt;td&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&quot;Name&quot;</span><span class="nt">/&gt;&lt;/td&gt;</span>
</span><span class='line'>      <span class="nt">&lt;td&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&quot;Birthday&quot;</span><span class="nt">/&gt;&lt;/td&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/tr&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/xsl:template&gt;</span>
</span><span class='line'><span class="nt">&lt;/xsl:stylesheet&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>4. HTML ファイルの生成</h3>

<p>準備しておいた XML ファイルに XSL テンプレートを適用して HTML ファイルを生成する。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ xsltproc --output test.html test.xsl test.xml
</span></code></pre></td></tr></table></div></figure>


<p>※オプションは他にも多数あるので、 <code>xsltproc --help</code> や <code>man xsltproc</code> で確認する。</p>

<h3>5. HTML ファイルの確認</h3>

<p>&ldquo;test.html&rdquo; というファイルが作成されているはずなので、確認してみる。</p>

<figure class='code'><figcaption><span>test.html</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;ja&quot;</span><span class="nt">&gt;&lt;body&gt;</span>
</span><span class='line'>  <span class="nt">&lt;table&gt;</span>
</span><span class='line'>    <span class="nt">&lt;tr&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>1234<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>Ruby 太郎<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>1980-01-01<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;/tr&gt;</span>
</span><span class='line'>    <span class="nt">&lt;tr&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>2345<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>XML 二郎<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>1985-04-15<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;/tr&gt;</span>
</span><span class='line'>    <span class="nt">&lt;tr&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>3456<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>XSL 花子<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>1990-09-30<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;/tr&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/table&gt;</span>
</span><span class='line'><span class="nt">&lt;/body&gt;&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>さらに、この HTML ファイルをブラウザで開いて確認してみる。</p>

<p><img src="http://komasaru.github.io/images/2015/09/07/XSLTPROC.png" title="XSLTPROC" alt="XSLTPROC" /></p>

<hr />

<p>単に XML ファイルに XSL テンプレートを適用して HTML ファイルを作成するだけなら、今回の方法が楽でいいかもしれませんね。</p>

<p>以上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[MariaDB(MySQL) - インデックス名一覧取得！]]></title>
    <link href="http://komasaru.github.io/blog/2015/09/03/mariadb-index-list/"/>
    <updated>2015-09-03T00:20:00+09:00</updated>
    <id>http://komasaru.github.io/blog/2015/09/03/mariadb-index-list</id>
    <content type="html"><![CDATA[<p>こんばんは。</p>

<p>MariaDB(MySQL) で作成済みのインデックスの名称を確認したい場合、 <code>SHOW INDEX FROM table_name</code> を使用することが多いと思います。</p>

<p>しかし、一度に多数のテーブルについて確認したい場合に、テーブル単位で <code>SHOW INDEX FROM table_name</code> を実行するのは大変面倒です。</p>

<p>以下で、指定データベース内の全テーブルに作成済みのインデックスを一覧表示する SQL 等を紹介します。</p>

<!--more-->


<h3>0. 前提条件</h3>

<ul>
<li>MariaDB 10.0.21 での作業を想定。（MySQL でも同様のはず）</li>
</ul>


<h3>1. SQL 作成</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'>  <span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="n">TABLE_SCHEMA</span><span class="p">,</span> <span class="k">TABLE_NAME</span><span class="p">,</span> <span class="n">INDEX_NAME</span>
</span><span class='line'>    <span class="k">FROM</span> <span class="n">information_schema</span><span class="p">.</span><span class="k">STATISTICS</span>
</span><span class='line'>   <span class="k">WHERE</span> <span class="n">TABLE_SCHEMA</span> <span class="o">=</span> <span class="s1">&#39;scheme_name&#39;</span> <span class="c1">-- &lt;= 対象のデータベース名</span>
</span><span class='line'>     <span class="k">AND</span> <span class="n">INDEX_NAME</span> <span class="o">&lt;&gt;</span> <span class="s1">&#39;PRIMARY&#39;</span>
</span><span class='line'><span class="k">ORDER</span> <span class="k">BY</span> <span class="n">TABLE_SCHEMA</span><span class="p">,</span> <span class="k">TABLE_NAME</span><span class="p">,</span> <span class="n">INDEX_NAME</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>ちなみに、インデックスに設定されているカラム名やその順番も確認したければ、以下のような SQL となる。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'>  <span class="k">SELECT</span> <span class="n">TABLE_SCHEMA</span><span class="p">,</span> <span class="k">TABLE_NAME</span><span class="p">,</span> <span class="n">INDEX_NAME</span><span class="p">,</span> <span class="k">COLUMN_NAME</span><span class="p">,</span> <span class="n">SEQ_IN_INDEX</span>
</span><span class='line'>    <span class="k">FROM</span> <span class="n">information_schema</span><span class="p">.</span><span class="k">STATISTICS</span>
</span><span class='line'>   <span class="k">WHERE</span> <span class="n">TABLE_SCHEMA</span> <span class="o">=</span> <span class="s1">&#39;scheme_name&#39;</span> <span class="c1">-- &lt;= 対象のデータベース名</span>
</span><span class='line'>     <span class="k">AND</span> <span class="n">INDEX_NAME</span> <span class="o">&lt;&gt;</span> <span class="s1">&#39;PRIMARY&#39;</span>
</span><span class='line'><span class="k">ORDER</span> <span class="k">BY</span> <span class="n">TABLE_SCHEMA</span><span class="p">,</span> <span class="k">TABLE_NAME</span><span class="p">,</span> <span class="n">INDEX_NAME</span><span class="p">,</span> <span class="n">SEQ_IN_INDEX</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>2. 応用</h3>

<p>参考までに、前項で紹介した SQL を利用して、データベース内の全テーブルの全インデックス（プライマリキーを除く）を削除するストアドプロシージャを作成する。<br/>
※当方が過去に必要に迫られて作成したストアドプロシージャで、実際はこのストアドプロシージャ実行後にインデックスを一括作成するストアドプロシージャも実行している。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">CREATE</span> <span class="k">DEFINER</span><span class="o">=`</span><span class="n">root</span><span class="o">`@`</span><span class="n">localhost</span><span class="o">`</span> <span class="k">PROCEDURE</span> <span class="o">`</span><span class="n">del_index_all</span><span class="o">`</span><span class="p">()</span>
</span><span class='line'><span class="k">BEGIN</span>
</span><span class='line'>    <span class="c1">-- 変数宣言</span>
</span><span class='line'>    <span class="k">DECLARE</span> <span class="n">v_tbl_name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">DECLARE</span> <span class="n">v_idx_name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">DECLARE</span> <span class="n">v_done</span> <span class="nb">INT</span> <span class="k">DEFAULT</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">-- カーソル宣言</span>
</span><span class='line'>    <span class="k">DECLARE</span> <span class="n">v_cur</span> <span class="k">CURSOR</span> <span class="k">FOR</span>
</span><span class='line'>        <span class="k">SELECT</span>
</span><span class='line'>            <span class="k">DISTINCT</span> <span class="k">TABLE_NAME</span><span class="p">,</span> <span class="n">INDEX_NAME</span>
</span><span class='line'>        <span class="k">FROM</span>
</span><span class='line'>            <span class="n">information_schema</span><span class="p">.</span><span class="k">STATISTICS</span>
</span><span class='line'>        <span class="k">WHERE</span>
</span><span class='line'>            <span class="n">TABLE_SCHEMA</span> <span class="o">=</span> <span class="s1">&#39;jmx&#39;</span>
</span><span class='line'>        <span class="k">AND</span> <span class="n">INDEX_NAME</span> <span class="o">&lt;&gt;</span> <span class="s1">&#39;PRIMARY&#39;</span>
</span><span class='line'>        <span class="k">ORDER</span> <span class="k">BY</span>
</span><span class='line'>            <span class="n">TABLE_SCHEMA</span><span class="p">,</span> <span class="k">TABLE_NAME</span><span class="p">,</span> <span class="n">INDEX_NAME</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">-- 終了ステータス宣言</span>
</span><span class='line'>    <span class="k">DECLARE</span> <span class="n">EXIT</span> <span class="k">HANDLER</span> <span class="k">FOR</span> <span class="k">NOT</span> <span class="k">FOUND</span> <span class="k">SET</span> <span class="n">v_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">-- カーソル OPEN</span>
</span><span class='line'>    <span class="k">OPEN</span> <span class="n">v_cur</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">-- LOOP 処理</span>
</span><span class='line'>    <span class="n">WHILE</span> <span class="n">v_done</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">DO</span>
</span><span class='line'>        <span class="c1">-- カーソル FETCH</span>
</span><span class='line'>        <span class="k">FETCH</span> <span class="n">v_cur</span> <span class="k">INTO</span> <span class="n">v_tbl_name</span><span class="p">,</span> <span class="n">v_idx_name</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">-- 動的 SQL 実行</span>
</span><span class='line'>        <span class="k">SET</span> <span class="o">@</span><span class="n">s</span> <span class="o">=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;ALTER TABLE &#39;</span><span class="p">,</span> <span class="n">v_tbl_name</span><span class="p">,</span> <span class="s1">&#39; DROP INDEX &#39;</span><span class="p">,</span> <span class="n">v_idx_name</span><span class="p">);</span>
</span><span class='line'>        <span class="k">PREPARE</span> <span class="n">stmt</span> <span class="k">FROM</span> <span class="o">@</span><span class="n">s</span><span class="p">;</span>
</span><span class='line'>        <span class="k">EXECUTE</span> <span class="n">stmt</span><span class="p">;</span>
</span><span class='line'>    <span class="k">END</span> <span class="n">WHILE</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">-- PREPARED STATEMENT 解放</span>
</span><span class='line'>    <span class="k">DEALLOCATE</span> <span class="k">PREPARE</span> <span class="n">stmt</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">-- カーソル CLOSE</span>
</span><span class='line'>    <span class="k">CLOSE</span> <span class="n">v_cur</span><span class="p">;</span>
</span><span class='line'><span class="k">END</span>
</span></code></pre></td></tr></table></div></figure>


<p>本当は、動的に SQL を実行する(PREPARED STATEMENT)部分を以下のようにしたかったが、 <code>?</code> は MariaDB のストアドではサポートされてない模様。（<a href="https://mariadb.com/kb/en/mariadb/prepare-statement/" title="PREPARE Statement - MariaDB Knowledge Base">参考</a>）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="c1">--  :</span>
</span><span class='line'><span class="c1">-- 省略</span>
</span><span class='line'><span class="c1">--  :</span>
</span><span class='line'>
</span><span class='line'><span class="k">SET</span> <span class="o">@</span><span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;ALTER TABLE ? DROP INDEX ?&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">PREPARE</span> <span class="n">stmt</span> <span class="k">FROM</span> <span class="o">@</span><span class="n">s</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">OPEN</span> <span class="n">v_cur</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">WHILE</span> <span class="n">v_done</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">DO</span>
</span><span class='line'>    <span class="k">FETCH</span> <span class="n">v_cur</span> <span class="k">INTO</span> <span class="n">v_tbl_name</span><span class="p">,</span> <span class="n">v_idx_name</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">SET</span> <span class="o">@</span><span class="n">tbl_name</span> <span class="o">=</span> <span class="n">v_tbl_name</span><span class="p">;</span>
</span><span class='line'>    <span class="k">SET</span> <span class="o">@</span><span class="n">idx_name</span> <span class="o">=</span> <span class="n">v_idx_name</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">EXECUTE</span> <span class="n">stmt</span> <span class="k">USING</span> <span class="o">@</span><span class="n">tbl_name</span><span class="p">,</span> <span class="o">@</span><span class="n">idx_name</span><span class="p">;</span>
</span><span class='line'><span class="k">END</span> <span class="n">WHILE</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">DEALLOCATE</span> <span class="k">PREPARE</span> <span class="n">stmt</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">CLOSE</span> <span class="n">v_cur</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<hr />

<p>普段はあまり使用する機会はありませんが、大量のテーブルを再設計する際には有益でしょう。</p>

<p>以上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[2015年08月 - OS・ブラウザ別アクセス状況！【自動集計】]]></title>
    <link href="http://komasaru.github.io/blog/2015/09/01/blog-access/"/>
    <updated>2015-09-01T00:20:00+09:00</updated>
    <id>http://komasaru.github.io/blog/2015/09/01/blog-access</id>
    <content type="html"><![CDATA[<p>こんばんは。</p>

<p>09月になりましたので、先月08月分の当ブログアクセス状況を公開します。</p>

<!--more-->


<h4>1. アクセスをOS別に集計</h4>

<table class="blog-access">
  <tr>
    <th>OS</th>
    <th>PageViews</th>
    <th>比率(%)</th>
  </tr>
  <tr>
    <td>Mac OS</td>
    <td class="blog-access-pv">16,753</td>
    <td class="blog-access-rate">58.5524</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td class="blog-access-pv">9,973</td>
    <td class="blog-access-rate">34.8560</td>
  </tr>
  <tr>
    <td>Linux</td>
    <td class="blog-access-pv">867</td>
    <td class="blog-access-rate">3.0302</td>
  </tr>
  <tr>
    <td>Ubuntu Linux</td>
    <td class="blog-access-pv">761</td>
    <td class="blog-access-rate">2.6597</td>
  </tr>
  <tr>
    <td>unknown</td>
    <td class="blog-access-pv">110</td>
    <td class="blog-access-rate">0.3845</td>
  </tr>
  <tr>
    <td>Fedora Linux</td>
    <td class="blog-access-pv">78</td>
    <td class="blog-access-rate">0.2726</td>
  </tr>
  <tr>
    <td>FreeBSD</td>
    <td class="blog-access-pv">37</td>
    <td class="blog-access-rate">0.1293</td>
  </tr>
  <tr>
    <td>Android</td>
    <td class="blog-access-pv">8</td>
    <td class="blog-access-rate">0.0280</td>
  </tr>
  <tr>
    <td>RedHat Linux</td>
    <td class="blog-access-pv">7</td>
    <td class="blog-access-rate">0.0245</td>
  </tr>
  <tr>
    <td>iPhone OS</td>
    <td class="blog-access-pv">6</td>
    <td class="blog-access-rate">0.0210</td>
  </tr>
  <tr>
    <td>Solaris</td>
    <td class="blog-access-pv">5</td>
    <td class="blog-access-rate">0.0175</td>
  </tr>
  <tr>
    <td>CentOS Linux</td>
    <td class="blog-access-pv">3</td>
    <td class="blog-access-rate">0.0105</td>
  </tr>
  <tr>
    <td>Debian GNU/Linux</td>
    <td class="blog-access-pv">3</td>
    <td class="blog-access-rate">0.0105</td>
  </tr>
  <tr>
    <td>NetBSD</td>
    <td class="blog-access-pv">1</td>
    <td class="blog-access-rate">0.0035</td>
  </tr>
  <tr>
    <td class="blog-access-total-label">合　計</td>
    <td class="blog-access-pv">28,612</td>
    <td class="blog-access-rate">100.0000</td>
  </tr>
</table>


<h4>2. アクセスをOS・バージョン別に集計（上位20件）</h4>

<table class="blog-access">
  <tr>
    <th>OS</th>
    <th>Version</th>
    <th>PageViews</th>
    <th>比率(%)</th>
  </tr>
  <tr>
    <td>Mac OS</td>
    <td>X</td>
    <td class="blog-access-pv">16,751</td>
    <td class="blog-access-rate">58.5454</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>NT</td>
    <td class="blog-access-pv">8,184</td>
    <td class="blog-access-rate">28.6034</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>7</td>
    <td class="blog-access-pv">883</td>
    <td class="blog-access-rate">3.0861</td>
  </tr>
  <tr>
    <td>Linux</td>
    <td>unknown</td>
    <td class="blog-access-pv">851</td>
    <td class="blog-access-rate">2.9743</td>
  </tr>
  <tr>
    <td>Ubuntu Linux</td>
    <td>unknown</td>
    <td class="blog-access-pv">758</td>
    <td class="blog-access-rate">2.6492</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>7 64 bit</td>
    <td class="blog-access-pv">462</td>
    <td class="blog-access-rate">1.6147</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>XP</td>
    <td class="blog-access-pv">280</td>
    <td class="blog-access-rate">0.9786</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>Vista</td>
    <td class="blog-access-pv">118</td>
    <td class="blog-access-rate">0.4124</td>
  </tr>
  <tr>
    <td>unknown</td>
    <td>unknown</td>
    <td class="blog-access-pv">110</td>
    <td class="blog-access-rate">0.3845</td>
  </tr>
  <tr>
    <td>Fedora Linux</td>
    <td>unknown</td>
    <td class="blog-access-pv">77</td>
    <td class="blog-access-rate">0.2691</td>
  </tr>
  <tr>
    <td>FreeBSD</td>
    <td>unknown</td>
    <td class="blog-access-pv">33</td>
    <td class="blog-access-rate">0.1153</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>8 64 bit</td>
    <td class="blog-access-pv">33</td>
    <td class="blog-access-rate">0.1153</td>
  </tr>
  <tr>
    <td>Linux</td>
    <td></td>
    <td class="blog-access-pv">10</td>
    <td class="blog-access-rate">0.0350</td>
  </tr>
  <tr>
    <td>Linux</td>
    <td>64 bit</td>
    <td class="blog-access-pv">6</td>
    <td class="blog-access-rate">0.0210</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>Vista 64 bit</td>
    <td class="blog-access-pv">6</td>
    <td class="blog-access-rate">0.0210</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>Server 2003</td>
    <td class="blog-access-pv">6</td>
    <td class="blog-access-rate">0.0210</td>
  </tr>
  <tr>
    <td>Solaris</td>
    <td>unknown</td>
    <td class="blog-access-pv">4</td>
    <td class="blog-access-rate">0.0140</td>
  </tr>
  <tr>
    <td>RedHat Linux</td>
    <td>3.6.24-3.el6 64 bit</td>
    <td class="blog-access-pv">4</td>
    <td class="blog-access-rate">0.0140</td>
  </tr>
  <tr>
    <td>FreeBSD</td>
    <td>64 bit</td>
    <td class="blog-access-pv">4</td>
    <td class="blog-access-rate">0.0140</td>
  </tr>
  <tr>
    <td>iPhone OS</td>
    <td>4_3_5</td>
    <td class="blog-access-pv">4</td>
    <td class="blog-access-rate">0.0140</td>
  </tr>
  <tr>
    <td class="blog-access-dot">:</td>
    <td class="blog-access-dot">:</td>
    <td class="blog-access-dot">:</td>
    <td class="blog-access-dot">:</td>
  </tr>
  <tr>
    <td class="blog-access-total-label">合　計</td>
    <td> </td>
    <td class="blog-access-pv">28,612</td>
    <td class="blog-access-rate">100.0000</td>
  </tr>
</table>


<h4>3. アクセスをブラウザ別に集計</h4>

<table class="blog-access">
  <tr>
    <th>ブラウザ</th>
    <th>PageViews</th>
    <th>比率(%)</th>
  </tr>
  <tr>
    <td>Safari</td>
    <td class="blog-access-pv">16,267</td>
    <td class="blog-access-rate">56.8538</td>
  </tr>
  <tr>
    <td>Mozilla Firefox</td>
    <td class="blog-access-pv">6,938</td>
    <td class="blog-access-rate">24.2486</td>
  </tr>
  <tr>
    <td>Mozilla</td>
    <td class="blog-access-pv">3,045</td>
    <td class="blog-access-rate">10.6424</td>
  </tr>
  <tr>
    <td>Internet Explorer</td>
    <td class="blog-access-pv">1,943</td>
    <td class="blog-access-rate">6.7909</td>
  </tr>
  <tr>
    <td>Debian IceWeasel</td>
    <td class="blog-access-pv">226</td>
    <td class="blog-access-rate">0.7899</td>
  </tr>
  <tr>
    <td>Opera</td>
    <td class="blog-access-pv">97</td>
    <td class="blog-access-rate">0.3390</td>
  </tr>
  <tr>
    <td>Netscape Navigator</td>
    <td class="blog-access-pv">46</td>
    <td class="blog-access-rate">0.1608</td>
  </tr>
  <tr>
    <td>Chrome</td>
    <td class="blog-access-pv">16</td>
    <td class="blog-access-rate">0.0559</td>
  </tr>
  <tr>
    <td>Mozilla SeaMonkey</td>
    <td class="blog-access-pv">9</td>
    <td class="blog-access-rate">0.0315</td>
  </tr>
  <tr>
    <td>Epiphany</td>
    <td class="blog-access-pv">7</td>
    <td class="blog-access-rate">0.0245</td>
  </tr>
  <tr>
    <td>Unknown</td>
    <td class="blog-access-pv">5</td>
    <td class="blog-access-rate">0.0175</td>
  </tr>
  <tr>
    <td>iPod</td>
    <td class="blog-access-pv">4</td>
    <td class="blog-access-rate">0.0140</td>
  </tr>
  <tr>
    <td>PHP</td>
    <td class="blog-access-pv">2</td>
    <td class="blog-access-rate">0.0070</td>
  </tr>
  <tr>
    <td>Konqueror</td>
    <td class="blog-access-pv">2</td>
    <td class="blog-access-rate">0.0070</td>
  </tr>
  <tr>
    <td>iPhone</td>
    <td class="blog-access-pv">2</td>
    <td class="blog-access-rate">0.0070</td>
  </tr>
  <tr>
    <td>Chromium</td>
    <td class="blog-access-pv">1</td>
    <td class="blog-access-rate">0.0035</td>
  </tr>
  <tr>
    <td>Sleipnir</td>
    <td class="blog-access-pv">1</td>
    <td class="blog-access-rate">0.0035</td>
  </tr>
  <tr>
    <td>SRWare Iron</td>
    <td class="blog-access-pv">1</td>
    <td class="blog-access-rate">0.0035</td>
  </tr>
  <tr>
    <td class="blog-access-total-label">合　計</td>
    <td class="blog-access-pv">28,612</td>
    <td class="blog-access-rate">100.0000</td>
  </tr>
</table>


<h4>4. アクセスをブラウザ・バージョン別に集計（上位20件）</h4>

<table class="blog-access">
  <tr>
    <th>ブラウザ</th>
    <th>Version</th>
    <th>PageViews</th>
    <th>比率(%)</th>
  </tr>
  <tr>
    <td>Safari</td>
    <td>537.36</td>
    <td class="blog-access-pv">12,364</td>
    <td class="blog-access-rate">43.2126</td>
  </tr>
  <tr>
    <td>Mozilla Firefox</td>
    <td>39.0</td>
    <td class="blog-access-pv">4,251</td>
    <td class="blog-access-rate">14.8574</td>
  </tr>
  <tr>
    <td>Mozilla</td>
    <td>11.0</td>
    <td class="blog-access-pv">3,043</td>
    <td class="blog-access-rate">10.6354</td>
  </tr>
  <tr>
    <td>Safari</td>
    <td>9537.53</td>
    <td class="blog-access-pv">1,927</td>
    <td class="blog-access-rate">6.7349</td>
  </tr>
  <tr>
    <td>Mozilla Firefox</td>
    <td>40.0</td>
    <td class="blog-access-pv">1,318</td>
    <td class="blog-access-rate">4.6065</td>
  </tr>
  <tr>
    <td>Safari</td>
    <td>600.1.4</td>
    <td class="blog-access-pv">804</td>
    <td class="blog-access-rate">2.8100</td>
  </tr>
  <tr>
    <td>Internet Explorer</td>
    <td>8.0</td>
    <td class="blog-access-pv">796</td>
    <td class="blog-access-rate">2.7820</td>
  </tr>
  <tr>
    <td>Safari</td>
    <td>600.7.12</td>
    <td class="blog-access-pv">587</td>
    <td class="blog-access-rate">2.0516</td>
  </tr>
  <tr>
    <td>Mozilla Firefox</td>
    <td>38.0</td>
    <td class="blog-access-pv">558</td>
    <td class="blog-access-rate">1.9502</td>
  </tr>
  <tr>
    <td>Internet Explorer</td>
    <td>10.0</td>
    <td class="blog-access-pv">447</td>
    <td class="blog-access-rate">1.5623</td>
  </tr>
  <tr>
    <td>Internet Explorer</td>
    <td>9.0</td>
    <td class="blog-access-pv">443</td>
    <td class="blog-access-rate">1.5483</td>
  </tr>
  <tr>
    <td>Internet Explorer</td>
    <td>7.0</td>
    <td class="blog-access-pv">256</td>
    <td class="blog-access-rate">0.8947</td>
  </tr>
  <tr>
    <td>Mozilla Firefox</td>
    <td>31.0</td>
    <td class="blog-access-pv">225</td>
    <td class="blog-access-rate">0.7864</td>
  </tr>
  <tr>
    <td>Safari</td>
    <td>534.30</td>
    <td class="blog-access-pv">176</td>
    <td class="blog-access-rate">0.6151</td>
  </tr>
  <tr>
    <td>Mozilla Firefox</td>
    <td>41.0</td>
    <td class="blog-access-pv">127</td>
    <td class="blog-access-rate">0.4439</td>
  </tr>
  <tr>
    <td>Debian IceWeasel</td>
    <td>31.8.0</td>
    <td class="blog-access-pv">105</td>
    <td class="blog-access-rate">0.3670</td>
  </tr>
  <tr>
    <td>Opera</td>
    <td>9.80</td>
    <td class="blog-access-pv">97</td>
    <td class="blog-access-rate">0.3390</td>
  </tr>
  <tr>
    <td>Mozilla Firefox</td>
    <td>37.0</td>
    <td class="blog-access-pv">71</td>
    <td class="blog-access-rate">0.2481</td>
  </tr>
  <tr>
    <td>Safari</td>
    <td>537.85.16</td>
    <td class="blog-access-pv">71</td>
    <td class="blog-access-rate">0.2481</td>
  </tr>
  <tr>
    <td>Safari</td>
    <td>600.8.9</td>
    <td class="blog-access-pv">58</td>
    <td class="blog-access-rate">0.2027</td>
  </tr>
  <tr>
    <td class="blog-access-dot">:</td>
    <td class="blog-access-dot">:</td>
    <td class="blog-access-dot">:</td>
    <td class="blog-access-dot">:</td>
  </tr>
  <tr>
    <td class="blog-access-total-label">合　計</td>
    <td> </td>
    <td class="blog-access-pv">28,612</td>
    <td class="blog-access-rate">100.0000</td>
  </tr>
</table>


<hr />

<p>以上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ruby - dRuby でジョブキューサーバ構築！]]></title>
    <link href="http://komasaru.github.io/blog/2015/08/29/ruby-job-queue-server-construction-by-druby/"/>
    <updated>2015-08-29T00:20:00+09:00</updated>
    <id>http://komasaru.github.io/blog/2015/08/29/ruby-job-queue-server-construction-by-druby</id>
    <content type="html"><![CDATA[<p>こんばんは。</p>

<p>前回に引き続き、Ruby の分散オブジェクトプログラミングするためのライブラリ dRuby についての内容です。</p>

<p>今回は、 dRuby を利用してジョブキューサーバ＆クライアントを構築してみました。</p>

<p>要は、キューに順次プッシュした内容をクライアント側から順次ポップする仕組みのことです。</p>

<!--more-->


<h3>0. 前提条件</h3>

<ul>
<li>Linux Mint 17.2(64bit) での作業を想定。</li>
<li>Ruby 2.2.3-p173 での作業を想定。</li>
<li>本来は複数のマシンで実行することが多いと思うが、今回は１つのマシンでテストする。</li>
<li>dRuby の簡単な使用例は「<a href="http://komasaru.github.io/2015/08/25/ruby-distributed-processing-by-druby" title="Ruby - dRuby で分散処理！">Ruby - dRuby で分散処理！</a>」を参照。</li>
</ul>


<h3>1. サーバ側スクリプトの作成例</h3>

<p>Queue オブジェクトを生成して待ち受けるのみの簡単なスクリプト。</p>

<figure class='code'><figcaption><span>queue_server.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/local/bin/ruby</span>
</span><span class='line'><span class="c1"># codeing: utf-8</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;drb/drb&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">q</span> <span class="o">=</span> <span class="no">Queue</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="no">DRb</span><span class="o">.</span><span class="n">start_service</span><span class="p">(</span><span class="s2">&quot;druby://localhost:8787&quot;</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="ss">safe_level</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="no">DRb</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">join</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>start_service</code> の <code>safe_level</code> を <code>1</code> に設定しているのは、 <code>instance_eval</code> による危険性を防ぐための処置。</li>
</ul>


<h3>2. クライアント側 Pop スクリプトの作成例</h3>

<p>キューサーバから順次ポップして5秒後にコンソール出力するのみの簡単なスクリプト。（キューに溜め込まれるデータは時刻文字列を想定している）</p>

<figure class='code'><figcaption><span>pop_client.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/local/bin/ruby</span>
</span><span class='line'><span class="c1"># coding: utf-8</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;drb/drb&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">obj</span> <span class="o">=</span> <span class="no">DRbObject</span><span class="o">.</span><span class="n">new_with_uri</span><span class="p">(</span><span class="s2">&quot;druby://localhost:8787&quot;</span><span class="p">)</span>
</span><span class='line'><span class="kp">loop</span> <span class="k">do</span> <span class="o">|</span><span class="n">a</span><span class="o">|</span>
</span><span class='line'>  <span class="n">tm</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">pop</span>
</span><span class='line'>  <span class="nb">sleep</span> <span class="mi">5</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Received at </span><span class="si">#{</span><span class="n">tm</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>3. クライアント側 Push スクリプトの作成例</h3>

<p>キューサーバへ現在時刻の文字列をプッシュするのみの簡単なスクリプト。</p>

<figure class='code'><figcaption><span>push_client.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#! /usr/local/bin/ruby</span>
</span><span class='line'><span class="c1"># coding: utf-8</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;drb/drb&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">obj</span> <span class="o">=</span> <span class="no">DRbObject</span><span class="o">.</span><span class="n">new_with_uri</span><span class="p">(</span><span class="s2">&quot;druby://localhost:8787&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">tm</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-%d %H:%M:%S&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">obj</span><span class="o">.</span><span class="n">push</span> <span class="n">tm</span>
</span><span class='line'><span class="nb">puts</span> <span class="s2">&quot;Sended at </span><span class="si">#{</span><span class="n">tm</span><span class="si">}</span><span class="s2">.&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>4. 動作確認</h3>

<p>まず、１つ目の端末を立ち上げて、サーバ側スクリプトを実行する。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ ./queue_server.rb
</span></code></pre></td></tr></table></div></figure>


<p>次に、２つ目の端末を立ち上げて、クライアント側 Pop スクリプトを実行する。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ ./pop_client.rb
</span></code></pre></td></tr></table></div></figure>


<p>最後に、３つ目の端末を立ち上げて、クライアント側 Push スクリプトを何度も連続して実行してみる。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ ./push_client.rb
</span><span class='line'>Sended at 2015-07-28 23:34:02.
</span><span class='line'>$ ./push_client.rb
</span><span class='line'>Sended at 2015-07-28 23:34:03.
</span><span class='line'>$ ./push_client.rb
</span><span class='line'>Sended at 2015-07-28 23:34:03.
</span><span class='line'>$ ./push_client.rb
</span><span class='line'>Sended at 2015-07-28 23:34:04.
</span><span class='line'>$ ./push_client.rb
</span><span class='line'>Sended at 2015-07-28 23:34:04.
</span></code></pre></td></tr></table></div></figure>


<p>すると、２つ目の Pop クライアントの端末に５秒間隔で出力がなされるはずである。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ ./pop_client.rb
</span><span class='line'>Received at 2015-07-28 23:34:02.
</span><span class='line'>Received at 2015-07-28 23:34:03.
</span><span class='line'>Received at 2015-07-28 23:34:03.
</span><span class='line'>Received at 2015-07-28 23:34:04.
</span><span class='line'>Received at 2015-07-28 23:34:04.
</span></code></pre></td></tr></table></div></figure>


<h3>5. 注意</h3>

<ul>
<li>dRuby で構築したサーバをインターネットで外部に公開すべきではない。</li>
<li>ローカルで使用する際もセキュリティ面に注意する。</li>
</ul>


<h3>6. 参考サイト</h3>

<ul>
<li><a href="http://docs.ruby-lang.org/ja/2.2.0/library/drb.html" title="library drb(Ruby2.2.0)">library drb(Ruby2.2.0)</a></li>
</ul>


<hr />

<p>当方、一度に並列で処理をされては困るような場合に、この仕組みを応用して順次処理を行うようにしています。<br/>
（インターネット上からデータが配信されたら処理を行うようなシステムの場合に、データが集中的に配信されてもマシンに負荷をかけないようにするため）</p>

<p>以上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ruby - dRuby で分散処理！]]></title>
    <link href="http://komasaru.github.io/blog/2015/08/25/ruby-distributed-processing-by-druby/"/>
    <updated>2015-08-25T00:20:00+09:00</updated>
    <id>http://komasaru.github.io/blog/2015/08/25/ruby-distributed-processing-by-druby</id>
    <content type="html"><![CDATA[<p>こんばんは。</p>

<p>dRuby とは、 Ruby で分散オブジェクトプログラミングするためのライブラリです。</p>

<!--more-->


<h3>0. 前提条件</h3>

<ul>
<li>Linux Mint 17.2(64bit) での作業を想定。</li>
<li>Ruby 2.2.3-p173 での作業を想定。</li>
<li>本来は複数のマシンで実行することが多いと思うが、今回は１つのマシンでテストする。</li>
<li>特に別途インストールの必要なライブラリ等はない。</li>
</ul>


<h3>1. サーバ側スクリプトの作成例</h3>

<p>日付・時刻の文字列を返すだけの簡単な例。</p>

<figure class='code'><figcaption><span>druby_server.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/local/bin/ruby</span>
</span><span class='line'><span class="c1"># coding: utf-8</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;drb/drb&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 通信を待ち受ける URI</span>
</span><span class='line'><span class="no">URI</span><span class="o">=</span><span class="s2">&quot;druby://localhost:8787&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">DrubyServer</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">get_cur_time</span>
</span><span class='line'>    <span class="n">cur_time</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y年%m月%d日 %H時%M分%S秒&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;ただいま </span><span class="si">#{</span><span class="n">cur_time</span><span class="si">}</span><span class="s2"> です。&quot;</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="n">msg</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">msg</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># リクエストを受け付けるオブジェクト</span>
</span><span class='line'><span class="n">obj</span> <span class="o">=</span> <span class="no">DrubyServer</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="c1"># サーバの起動</span>
</span><span class='line'><span class="no">DRb</span><span class="o">.</span><span class="n">start_service</span><span class="p">(</span><span class="no">URI</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="ss">safe_level</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="c1"># DRb スレッド終了の待ち受け</span>
</span><span class='line'><span class="no">DRb</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">join</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>start_service</code> の <code>safe_level</code> を <code>1</code> に設定しているのは、 <code>instance_eval</code> による危険性を防ぐための処置。</li>
</ul>


<h3>2. クライアント側スクリプトの作成例</h3>

<p>サーバのメソットを呼び出す簡単な例。</p>

<figure class='code'><figcaption><span>druby_client.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/local/bin/ruby</span>
</span><span class='line'><span class="c1"># coding: utf-8</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;drb/drb&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 接続先 URI</span>
</span><span class='line'><span class="no">URI</span><span class="o">=</span><span class="s2">&quot;druby://localhost:8787&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># リモートオブジェクトの取得</span>
</span><span class='line'><span class="n">obj</span> <span class="o">=</span> <span class="no">DRbObject</span><span class="o">.</span><span class="n">new_with_uri</span><span class="p">(</span><span class="no">URI</span><span class="p">)</span>
</span><span class='line'><span class="c1"># リモートメソッドの呼び出し</span>
</span><span class='line'><span class="nb">puts</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_cur_time</span>
</span></code></pre></td></tr></table></div></figure>


<h3>3. 動作確認</h3>

<p>まず、１つ目の端末を立ち上げて、サーバ側スクリプトを実行する。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ ./druby_server.rb
</span></code></pre></td></tr></table></div></figure>


<p>そして、もう１つ端末を立ち上げて、クライアント側スクリプトを実行する。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ ./druby_client.rb
</span><span class='line'>ただいま 2015年07月22日 24時31分16秒 です。
</span><span class='line'>$ ./druby_client.rb
</span><span class='line'>ただいま 2015年07月22日 24時32分30秒 です。
</span></code></pre></td></tr></table></div></figure>


<p>クライアント側スクリプトを実行する度にサーバ側で処理した結果が出力されるはずである。<br/>
また、この時サーバ側の端末にも同じ出力がされるはずである。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ ./druby_server.rb
</span><span class='line'>ただいま 2015年07月22日 24時31分16秒 です。
</span><span class='line'>ただいま 2015年07月22日 24時32分30秒 です。
</span></code></pre></td></tr></table></div></figure>


<h3>4. 注意</h3>

<ul>
<li>dRuby で構築したサーバをインターネットで外部に公開すべきではない。</li>
<li>ローカルで使用する際もセキュリティ面に注意する。</li>
</ul>


<h3>5. 参考サイト</h3>

<ul>
<li><a href="http://docs.ruby-lang.org/ja/2.2.0/library/drb.html" title="library drb (Ruby 2.2.0)">library drb (Ruby 2.2.0)</a></li>
</ul>


<hr />

<p>この dRuby による分散処理をいろいろ応用できそうです。</p>

<p>実際、目論んでいることもありますし。</p>

<p>以上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[MariaDB 10.0.x - Mroonga プラグインの有効化！]]></title>
    <link href="http://komasaru.github.io/blog/2015/08/21/mariadb-mroonga-installation/"/>
    <updated>2015-08-21T00:20:00+09:00</updated>
    <id>http://komasaru.github.io/blog/2015/08/21/mariadb-mroonga-installation</id>
    <content type="html"><![CDATA[<p>こんばんは。</p>

<p>全文検索エンジン Groonga をベースとした MySQL のストレージエンジン Mroonga を MariaDB で使用する方法についての簡単な記録です。</p>

<p>MariaDB 10.0.x では Mroonga のプラグインがバンドルされているので、 Mroonga を別途インストールする必要はありません。<br/>
プラグインを有効にすればすぐに使用できるようになります。（但し、バンドルされている Mroonga はバージョンが少し古いようなので、最新バージョンを使用したければ別途インストールする必要があります）</p>

<p>（Groonga, Mroonga については不勉強で疎いため、乱文ご容赦ください）</p>

<!--more-->


<h3>0. 前提条件</h3>

<ul>
<li>MariaDB 10.0.21 (on Linux Mint 17.2) での作業を想定。</li>
</ul>


<h3>1. プラグインの有効化</h3>

<p>以下の SQL を実行して、プラグインを有効にする。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt; INSTALL PLUGIN Mroonga SONAME &#39;ha_mroonga.so&#39;;
</span><span class='line'>&gt; CREATE FUNCTION last_insert_grn_id RETURNS INTEGER SONAME &#39;ha_mroonga.so&#39;;
</span><span class='line'>&gt; CREATE FUNCTION mroonga_snippet RETURNS STRING SONAME &#39;ha_mroonga.so&#39;;
</span><span class='line'>&gt; CREATE FUNCTION mroonga_command RETURNS STRING SONAME &#39;ha_mroonga.so&#39;;
</span><span class='line'>&gt; CREATE FUNCTION mroonga_escape RETURNS STRING SONAME &#39;ha_mroonga.so&#39;;
</span></code></pre></td></tr></table></div></figure>


<h3>2. プラグイン有効化の確認</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt; SHOW ENGINES;
</span><span class='line'>+--------------------+---------+----------------------------------------------------------------------------+--------------+------+------------+
</span><span class='line'>| Engine             | Support | Comment                                                                    | Transactions | XA   | Savepoints |
</span><span class='line'>+--------------------+---------+----------------------------------------------------------------------------+--------------+------+------------+
</span><span class='line'>| MEMORY             | YES     | Hash based, stored in memory, useful for temporary tables                  | NO           | NO   | NO         |
</span><span class='line'>| CSV                | YES     | CSV storage engine                                                         | NO           | NO   | NO         |
</span><span class='line'>| PERFORMANCE_SCHEMA | YES     | Performance Schema                                                         | NO           | NO   | NO         |
</span><span class='line'>| BLACKHOLE          | YES     | /dev/null storage engine (anything you write to it disappears)             | NO           | NO   | NO         |
</span><span class='line'>| MyISAM             | YES     | MyISAM storage engine                                                      | NO           | NO   | NO         |
</span><span class='line'>| MRG_MyISAM         | YES     | Collection of identical MyISAM tables                                      | NO           | NO   | NO         |
</span><span class='line'>| Mroonga            | YES     | CJK-ready fulltext search, column store                                    | NO           | NO   | NO         |
</span><span class='line'>| FEDERATED          | YES     | FederatedX pluggable storage engine                                        | YES          | NO   | YES        |
</span><span class='line'>| InnoDB             | DEFAULT | Percona-XtraDB, Supports transactions, row-level locking, and foreign keys | YES          | YES  | YES        |
</span><span class='line'>| Aria               | YES     | Crash-safe tables with MyISAM heritage                                     | NO           | NO   | NO         |
</span><span class='line'>| ARCHIVE            | YES     | Archive storage engine                                                     | NO           | NO   | NO         |
</span><span class='line'>+--------------------+---------+----------------------------------------------------------------------------+--------------+------+------------+
</span><span class='line'>11 rows in set (0.00 sec)
</span></code></pre></td></tr></table></div></figure>


<h3>3. テーブルの作成方法</h3>

<p>以下は、ストレージモードでテーブルを作成する場合で、 <code>col_name_2</code> に全文検索インデックスを張る例（トークナイザはデフォルトの &ldquo;TokenBigram"）。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt; CREATE TABLE table_name(
</span><span class='line'>&gt;   id INT PRIMARY KEY AUTO_INCREMENT,
</span><span class='line'>&gt;   col_name_1 VARCHAR(255),
</span><span class='line'>&gt;   col_name_2 VARCHAR(255),
</span><span class='line'>&gt;   FULLTEXT INDEX (col_name_2)
</span><span class='line'>&gt; ) ENGINE = Mroonga DEFAULT CHARSET utf8;
</span></code></pre></td></tr></table></div></figure>


<p>以下は、ラッパーモード（元のストレージエンジンは InnoDB）でテーブルを作成する場合で、 <code>col_name_2</code> に全文検索インデックスを張る例（トークナイザはデフォルトの &ldquo;TokenBigram"）。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt; CREATE TABLE table_name (
</span><span class='line'>&gt;   id INT PRIMARY KEY AUTO_INCREMENT,
</span><span class='line'>&gt;   col_name_1 VARCHAR(255),
</span><span class='line'>&gt;   col_name_2 VARCHAR(255),
</span><span class='line'>&gt;   FULLTEXT INDEX (col_name_2)
</span><span class='line'>&gt; ) ENGINE = Mroonga COMMENT = &#39;engine &quot;InnoDB&quot;&#39; DEFAULT CHARSET utf8;
</span></code></pre></td></tr></table></div></figure>


<p>※但し、 MariaDB では <code>FULLTEXT INDEX</code> で設定しても <code>FULLTEXT KEY</code> で登録される。</p>

<p>ちなみに、テーブルデフォルトのトークナイザを MeCab に変更したい場合は以下のようにする。（設定ファイルで指定することも可能）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt; ) ENGINE = Mroonga COMMENT=&#39;default_tokenizer &quot;TokenMecab&quot;&#39; DEFAULT CHARSET utf8;
</span></code></pre></td></tr></table></div></figure>


<p>FULLTEXT INDEX のパーサのみ変更したい場合は以下のようにする。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt;   FULLTEXT INDEX (col_name_2) COMMENT=&#39;parser &quot;TokenMecab&quot;&#39;
</span></code></pre></td></tr></table></div></figure>


<h3>4. 検索例</h3>

<p>以下は、テーブル table_name の col_name_2 に「松江」を含み「出雲」を含まないレコードを検索する例。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="o">*</span><span class="p">,</span> <span class="k">MATCH</span> <span class="p">(</span><span class="n">col_name_2</span><span class="p">)</span> <span class="n">AGAINST</span><span class="p">(</span><span class="ss">&quot;+松江 -出雲&quot;</span> <span class="k">IN</span> <span class="nb">BOOLEAN</span> <span class="k">MODE</span><span class="p">)</span>
</span><span class='line'><span class="o">&gt;</span>   <span class="k">FROM</span> <span class="k">table_name</span>
</span><span class='line'><span class="o">&gt;</span>  <span class="k">WHERE</span> <span class="k">MATCH</span> <span class="p">(</span><span class="n">col_name_2</span><span class="p">)</span> <span class="n">AGAINST</span><span class="p">(</span><span class="ss">&quot;+松江 -出雲&quot;</span> <span class="k">IN</span> <span class="nb">BOOLEAN</span> <span class="k">MODE</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>SELECT</code> 句内の <code>MATCH ... AGAINST ...</code> は、検索スコア。</li>
<li><code>IN BOOLEAN MODE</code> は、マッチ率の概念を省いて、単純にかつ機械的に検索するモード。</li>
</ul>


<p>ちなみに、当方で 30 万件ほどレコードのあるテーブルで同様に検索してみた結果、 <code>WHERE</code> 句を</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">WHERE</span> <span class="n">col_name_2</span> <span class="k">LIKE</span> <span class="s1">&#39;%松江%&#39;</span> <span class="k">AND</span> <span class="n">col_name_2</span> <span class="k">NOT</span> <span class="k">LIKE</span> <span class="s1">&#39;%出雲%&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>にして検索するより約 100 倍高速に検索できました。さらに、レコード約 1,300 万件では 約 500 倍高速に検索できました。<br/>
（テーブルレイアウト、レコード数等にもよるでしょうが）</p>

<h3>5. 参考サイト</h3>

<ul>
<li><a href="http://mroonga.org/ja/" title="Mroonga - MySQLで高速全文検索">Mroonga - MySQLで高速全文検索</a></li>
</ul>


<p>中でも、Mroonga プラグインの有効については以下を参照。</p>

<ul>
<li><a href="http://mroonga.org/ja/blog/2015/04/29/release.html" title="Mroonga - Mroonga 5.02リリース！">Mroonga - Mroonga 5.02リリース！</a></li>
</ul>


<hr />

<p>検索の高速化を図るには必須の機能でしょう。</p>

<p>当方も InnoDB で構築している既存の DB の高速化を図ってみたいところです。</p>

<p>以上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ruby - Rroonga で全文検索！]]></title>
    <link href="http://komasaru.github.io/blog/2015/08/17/ruby-rroonga-fulltext-searching/"/>
    <updated>2015-08-17T00:20:00+09:00</updated>
    <id>http://komasaru.github.io/blog/2015/08/17/ruby-rroonga-fulltext-searching</id>
    <content type="html"><![CDATA[<p>こんばんは。</p>

<p>Ruby でカラムストア機能付き全文検索エンジン Groonga の機能を容易に使用できる Rroonga を使用してみました。</p>

<!--more-->


<h3>0. 前提条件</h3>

<ul>
<li>Linux Mint 17.2(64bit) での作業を想定。</li>
<li>Ruby 2.2.2-p95 での作業を想定。</li>
<li>カラムストア機能付き全文検索エンジン Groonga がインストール済みであること。</li>
</ul>


<h3>1. Rroonga のインストール</h3>

<p>以下のようにしてインストールする。<br/>
（ちなみ、 Groonga 未インストールなら、ここでインストールされるはず。（当方 Groonga インストール済みなので、未確認））</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ sudo gem install rroonga
</span></code></pre></td></tr></table></div></figure>


<h3>2. データベースの作成</h3>

<p>簡単な都道府県名データベースを作成してみる。</p>

<p>取り急ぎ対話形式で作業を行いたいので、 pry(or irb) に入る。（プロンプトを簡易表示。 <code>groonga</code> を <code>require</code> して）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ pry --simple-prompt -r groonga
</span></code></pre></td></tr></table></div></figure>


<p>まず、エンコーディングの設定を行う。（今回は Linux なので UTF-8 に設定）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt;&gt; Groonga::Context.default_options = {:encoding =&gt; :utf8}
</span><span class='line'>=&gt; {:encoding=&gt;:utf8}
</span></code></pre></td></tr></table></div></figure>


<p>そして、データベースを作成する。（データベースファイル名を指定）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt;&gt; Groonga::Database.create(:path =&gt; &quot;/path/to/prefs.db&quot;)
</span><span class='line'>=&gt; #&lt;Groonga::Database id: &lt;nil&gt;, name: (anonymous), path: &lt;/path/to/prefs.db&gt;, domain: (nil), range: (nil), flags: &lt;&gt;&gt;
</span></code></pre></td></tr></table></div></figure>


<h3>3. テーブルの作成</h3>

<p>都道府県名テーブルを作成してみる。（テーブル名、テーブルタイプを指定）<br/>
（テーブルタイプには <code>hash</code>, <code>patricia_trie</code>, <code>double_array_trie</code>, <code>array</code> が指定可能）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt;&gt; Groonga::Schema.create_table(&quot;Prefs&quot;, :type =&gt; :hash) do |tbl|
</span><span class='line'> |   tbl.text(&quot;pref_name&quot;)
</span><span class='line'> | end
</span><span class='line'>=&gt; [#&lt;Groonga::Schema::TableDefinition:0x007f9fe62cef60
</span><span class='line'>  @definitions=
</span><span class='line'>   [#&lt;Groonga::Schema::ColumnDefinition:0x007f9fe62ce1f0
</span><span class='line'>     @name=&quot;pref_name&quot;,
</span><span class='line'>     @options={:persistent=&gt;true, :named_path=&gt;nil},
</span><span class='line'>     @type=&quot;Text&quot;&gt;],
</span><span class='line'>  @name=&quot;Prefs&quot;,
</span><span class='line'>  @options=
</span><span class='line'>   {:context=&gt;
</span><span class='line'>     #&lt;Groonga::Context encoding: &lt;:utf8&gt;, database: &lt;#&lt;Groonga::Database id: &lt;nil&gt;, name: (anonymous), path: &lt;/path/to/prefs.db&gt;, domain: (nil), range: (nil), flags: &lt;&gt;&gt;&gt;&gt;,
</span><span class='line'>    :type=&gt;:hash},
</span><span class='line'>  @table_type=Groonga::Hash&gt;]
</span></code></pre></td></tr></table></div></figure>


<p>テーブルが作成されたか確認してみる。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt;&gt; prefs = Groonga[&quot;Prefs&quot;]
</span><span class='line'>=&gt; #&lt;Groonga::Hash id: &lt;256&gt;, name: &lt;Prefs&gt;, path: &lt;/path/to/prefs.db.0000100&gt;, domain: &lt;ShortText&gt;, range: (nil), flags: &lt;&gt;, size: &lt;0&gt;, encoding: &lt;:utf8&gt;, default_tokenizer: (nil), token_filters: [], normalizer: (nil)&gt;
</span><span class='line'>&gt;&gt; prefs.size
</span><span class='line'>=&gt; 0
</span></code></pre></td></tr></table></div></figure>


<h3>4. レコードの追加</h3>

<p>以下のようにして、テーブルにレコードを追加していく。（47都道府県分。別途作成しておいた配列をループさせて登録するのがよいだろう）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt;&gt; prefs.add(&quot;Hokkaido&quot;, :pref_name =&gt; &quot;北海道&quot;)
</span><span class='line'>=&gt; #&lt;Groonga::Record:0x007f9fe69e4480 ..., attributes: {&quot;_id&quot;=&gt;1, &quot;_key&quot;=&gt;&quot;Hokkaido&quot;, &quot;pref_name&quot;=&gt;&quot;北海道&quot;}&gt;
</span></code></pre></td></tr></table></div></figure>


<p>以下のような方法で追加することも可能。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt;&gt; prefs.add(&quot;Aomoriken&quot;)
</span><span class='line'>=&gt; #&lt;Groonga::Record:0x007f9fe6755020 ..., attributes: {&quot;_id&quot;=&gt;3, &quot;_key&quot;=&gt;&quot;Aomoriken&quot;, &quot;pref_name&quot;=&gt;nil}&gt;
</span><span class='line'>&gt;&gt; prefs[&quot;Aomoriken&quot;].pref_name = &quot;青森県&quot;
</span><span class='line'>=&gt; &quot;青森県&quot;
</span></code></pre></td></tr></table></div></figure>


<p>ちなみに、削除するには以下のようにする。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt;&gt; prefs.delete(&quot;Aomoriken&quot;)
</span><span class='line'>=&gt; nil
</span></code></pre></td></tr></table></div></figure>


<h3>5. レコードの参照</h3>

<p>登録したレコードを参照してみる。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt;&gt; prefs[&quot;Shimaneken&quot;]
</span><span class='line'>=&gt; #&lt;Groonga::Record:0x007f9fe671a1f0 ..., attributes: {&quot;_id&quot;=&gt;32, &quot;_key&quot;=&gt;&quot;Shimaneken&quot;, &quot;pref_name&quot;=&gt;&quot;島根県&quot;}&gt;
</span><span class='line'>
</span><span class='line'>&gt;&gt; prefs[&quot;Shimaneken&quot;].id
</span><span class='line'>=&gt; 32
</span><span class='line'>
</span><span class='line'>&gt;&gt; prefs[&quot;Shimaneken&quot;].key
</span><span class='line'>=&gt; &quot;Shimaneken&quot;
</span><span class='line'>
</span><span class='line'>&gt;&gt; prefs[&quot;Shimaneken&quot;].pref_name
</span><span class='line'>=&gt; &quot;島根県&quot;
</span><span class='line'>
</span><span class='line'>&gt;&gt; prefs.size
</span><span class='line'>=&gt; 47
</span></code></pre></td></tr></table></div></figure>


<h3>6. 全文検索用語彙テーブルの作成</h3>

<p>全文検索用語彙テーブルを作成する。（以下は、テーブルタイプを PatriciaTrie に、ノーマライザを大文字小文字の区別をしない NormalizerAuto に、デフォルトトークナイザを N-gram の一種バイグラムに設定する例）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt;&gt; Groonga::Schema.create_table(&quot;Terms&quot;,
</span><span class='line'> |   :type =&gt; :patricia_trie,
</span><span class='line'> |   :normalizer =&gt; :NormalizerAuto,
</span><span class='line'> | :default_tokenizer =&gt; &quot;TokenBigram&quot;)
</span><span class='line'>=&gt; [#&lt;Groonga::Schema::TableDefinition:0x007f9fe6bb9cb0
</span><span class='line'>  @definitions=[],
</span><span class='line'>  @name=&quot;Terms&quot;,
</span><span class='line'>  @options=
</span><span class='line'>   {:context=&gt;
</span><span class='line'>     #&lt;Groonga::Context encoding: &lt;:utf8&gt;, database: &lt;#&lt;Groonga::Database id: &lt;nil&gt;, name: (anonymous), path: &lt;/path/to/prefs.db&gt;, domain: (nil), range: (nil), flags: &lt;&gt;&gt;&gt;&gt;,
</span><span class='line'>    :type=&gt;:patricia_trie,
</span><span class='line'>    :normalizer=&gt;:NormalizerAuto,
</span><span class='line'>    :default_tokenizer=&gt;&quot;TokenBigram&quot;},
</span><span class='line'>  @table_type=Groonga::PatriciaTrie&gt;]
</span></code></pre></td></tr></table></div></figure>


<h3>7. 全文検索用語彙テーブルのインデックス定義</h3>

<p>今回は都道府県名ローマ字で検索してみることにする。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt;&gt; Groonga::Schema.change_table(&quot;Terms&quot;) do |tbl|
</span><span class='line'> |   tbl.index(&quot;Prefs.pref_name&quot;)
</span><span class='line'> | end
</span><span class='line'>=&gt; [#&lt;Groonga::Schema::TableDefinition:0x007f9fe6a823d8
</span><span class='line'>  @definitions=
</span><span class='line'>   [#&lt;Groonga::Schema::IndexColumnDefinition:0x007f9fe6a81d48
</span><span class='line'>     @name=nil,
</span><span class='line'>     @options={:persistent=&gt;true, :named_path=&gt;nil},
</span><span class='line'>     @target_columns=[&quot;pref_name&quot;],
</span><span class='line'>     @target_table=&quot;Prefs&quot;&gt;],
</span><span class='line'>  @name=&quot;Terms&quot;,
</span><span class='line'>  @options=
</span><span class='line'>   {:context=&gt;
</span><span class='line'>     #&lt;Groonga::Context encoding: &lt;:utf8&gt;, database: &lt;#&lt;Groonga::Database id: &lt;nil&gt;, name: (anonymous), path: &lt;/path/to/prefs.db&gt;, domain: (nil), range: (nil), flags: &lt;&gt;&gt;&gt;&gt;,
</span><span class='line'>    :change=&gt;true},
</span><span class='line'>  @table_type=Groonga::Array&gt;]
</span></code></pre></td></tr></table></div></figure>


<h3>8. 検索の確認</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt;&gt; prefs_shimane = prefs.select { |rec| rec.pref_name =~ &quot;島根県&quot; }    =&gt; #&lt;Groonga::Hash id: &lt;2147483655&gt;, name: (anonymous), path: (temporary), domain: &lt;Prefs&gt;, range: (nil), flags: &lt;WITH_SUBREC&gt;, size: &lt;1&gt;, encoding: &lt;:utf8&gt;, default_tokenizer: (nil), token_filters: [], normalizer: (nil)&gt;
</span><span class='line'>
</span><span class='line'>&gt;&gt; prefs_shimane.size
</span><span class='line'>=&gt; 1
</span><span class='line'>
</span><span class='line'>&gt;&gt; prefs_shimane.collect { |rec| rec.key.key }
</span><span class='line'>=&gt; [&quot;Shimaneken&quot;]
</span><span class='line'>
</span><span class='line'>&gt;&gt; prefs_shimane.collect { |rec| rec[&quot;_key&quot;] }
</span><span class='line'>=&gt; [&quot;Shimaneken&quot;]
</span></code></pre></td></tr></table></div></figure>


<h3>9. 参考サイト</h3>

<ul>
<li><a href="http://groonga.org/ja/" title="Groonga - カラムストア機能付き全文検索エンジン">Groonga - カラムストア機能付き全文検索エンジン</a></li>
<li><a href="http://ranguba.org/ja/" title="RubyでGroonga使って全文検索 - ラングバ">RubyでGroonga使って全文検索 - ラングバ</a></li>
</ul>


<hr />

<p>その他の詳細な使用方法は実際に Ruby コーディングしながら覚えることになるでしょう。</p>

<p>以上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ruby - gnuplot でグラフ描画！]]></title>
    <link href="http://komasaru.github.io/blog/2015/08/13/ruby-graph-drawing-by-gnuplot/"/>
    <updated>2015-08-13T00:20:00+09:00</updated>
    <id>http://komasaru.github.io/blog/2015/08/13/ruby-graph-drawing-by-gnuplot</id>
    <content type="html"><![CDATA[<p>こんばんは。</p>

<p>Ruby で容易にグラフを描画できる RubyGems ライブラリ gnuplot を使用してみました。</p>

<p>RubyGems ライブラリ gnuplot は、2次元や3次元のグラフを描画するためのコマンドラインツール Gnuplot を Ruby で使用できるようにラップしたものです。</p>

<!--more-->


<h3>0. 前提条件</h3>

<ul>
<li>Linux Mint 17.1(64bit) 一般ユーザでの作業を想定。</li>
<li>Ruby 2.2.2-p95 での作業を想定。</li>
<li>Gnuplot インストール済みであること。（<a href="http://komasaru.github.io/2015/07/30/linux-mint-installation-gnuplot/" title="Linux Mint - Gnuplot でグラフ描画！">Linux Mint - Gnuplot でグラフ描画！</a>）</li>
</ul>


<h3>1. RubyGems パッケージのインストール</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ sudo gem install gnuplot
</span></code></pre></td></tr></table></div></figure>


<h3>2. 動作確認</h3>

<h4>2-1. 作成例・１</h4>

<p>単純な<script type="math/tex">sin</script>曲線・<script type="math/tex">cos</script>曲線を描画する例。</p>

<figure class='code'><figcaption><span>gnuplot_1.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#! /usr/local/bin/ruby</span>
</span><span class='line'><span class="c1">#-----------------------------------------------</span>
</span><span class='line'><span class="c1"># Ruby script to draw a graph by gnuplot.(Ex.1)</span>
</span><span class='line'><span class="c1">#-----------------------------------------------</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;gnuplot&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">Gnuplot</span><span class="o">.</span><span class="n">open</span> <span class="k">do</span> <span class="o">|</span><span class="n">gp</span><span class="o">|</span>
</span><span class='line'>  <span class="no">Gnuplot</span><span class="o">::</span><span class="no">Plot</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">gp</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">plot</span><span class="o">|</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">xrange</span> <span class="s2">&quot;[-10:10]&quot;</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">title</span>  <span class="s2">&quot;作成例１&quot;</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">xlabel</span> <span class="s2">&quot;x&quot;</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">ylabel</span> <span class="s2">&quot;y&quot;</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">grid</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="no">Gnuplot</span><span class="o">::</span><span class="no">DataSet</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;sin(x)&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">ds</span><span class="o">|</span>
</span><span class='line'>      <span class="n">ds</span><span class="o">.</span><span class="n">with</span>      <span class="o">=</span> <span class="s2">&quot;lines&quot;</span>
</span><span class='line'>      <span class="n">ds</span><span class="o">.</span><span class="n">linewidth</span> <span class="o">=</span> <span class="mi">2</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="no">Gnuplot</span><span class="o">::</span><span class="no">DataSet</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;cos(x)&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">ds</span><span class="o">|</span>
</span><span class='line'>      <span class="n">ds</span><span class="o">.</span><span class="n">with</span>      <span class="o">=</span> <span class="s2">&quot;lines&quot;</span>
</span><span class='line'>      <span class="n">ds</span><span class="o">.</span><span class="n">linewidth</span> <span class="o">=</span> <span class="mi">2</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><a href="https://gist.github.com/komasaru/18575f0245952cae7d02" title="Gist - Ruby script to draw a graph by gnuplot.(Ex.1)">Gist - Ruby script to draw a graph by gnuplot.(Ex.1)</a></li>
</ul>


<p>そして、実行権限を付与して実行。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ sudo chmod +x gnuplot_1.rb
</span><span class='line'>
</span><span class='line'>$ ./gnuplot_1.rb
</span></code></pre></td></tr></table></div></figure>


<p>Gnuplot ウィンドウが開き、グラフが描画される。</p>

<p><img src="http://komasaru.github.io/images/2015/08/13/GNUPLOT_1.png" title="GNUPLOT_1" alt="GNUPLOT_1" /></p>

<p>但し、環境によってはこのウィンドウを閉じようとしてもうまく閉じれないかもしれない。（termnal が &ldquo;wxt&rdquo; の場合。 terminal が &ldquo;x11&rdquo; 等なら閉じれるが、日本語は使用できない）<br/>
ちなみに、本家の gnuplot では、この問題は &ldquo;Close&rdquo; を &ldquo;exit&rdquo; でなく &ldquo;exit gnuplot&rdquo; にバインドすれば解決するようだが、今回の RubyGems ライブラリでは通用しない模様。（試行してみた結果）</p>

<h4>2-2. 作成例・２</h4>

<script type="math/tex">y=x^3 - 2x + 2 \ (x={-2.0,-1.9,\cdots,1.9,2.0})</script>


<p>のグラフを PNG ファイルに描画・出力する例。</p>

<figure class='code'><figcaption><span>gnuplot_2.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#! /usr/local/bin/ruby</span>
</span><span class='line'><span class="c1">#-----------------------------------------------</span>
</span><span class='line'><span class="c1"># Ruby script to draw a graph by gnuplot.(Ex.2)</span>
</span><span class='line'><span class="c1">#-----------------------------------------------</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;gnuplot&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">Gnuplot</span><span class="o">.</span><span class="n">open</span> <span class="k">do</span> <span class="o">|</span><span class="n">gp</span><span class="o">|</span>
</span><span class='line'>  <span class="no">Gnuplot</span><span class="o">::</span><span class="no">Plot</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">gp</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">plot</span><span class="o">|</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">terminal</span> <span class="s2">&quot;png enhanced font &#39;IPA P ゴシック&#39; fontscale 1.2&quot;</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">output</span>   <span class="s2">&quot;gnuplot_2.png&quot;</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">title</span>    <span class="s2">&quot;作成例２&quot;</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">xlabel</span>   <span class="s2">&quot;x&quot;</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">ylabel</span>   <span class="s2">&quot;y=x^3-2x+2&quot;</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">grid</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="o">.</span><span class="n">.</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span> <span class="p">{</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span><span class="o">.</span><span class="n">to_f</span> <span class="o">/</span> <span class="mi">10</span><span class="o">.</span><span class="mi">0</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">collect</span> <span class="p">{</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">v</span> <span class="o">+</span> <span class="mi">2</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="no">Gnuplot</span><span class="o">::</span><span class="no">DataSet</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">]</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">ds</span><span class="o">|</span>
</span><span class='line'>      <span class="n">ds</span><span class="o">.</span><span class="n">with</span>      <span class="o">=</span> <span class="s2">&quot;linespoints&quot;</span>  <span class="c1"># 点のみなら &quot;points&quot;</span>
</span><span class='line'>      <span class="n">ds</span><span class="o">.</span><span class="n">linewidth</span> <span class="o">=</span> <span class="mi">2</span>
</span><span class='line'>      <span class="n">ds</span><span class="o">.</span><span class="n">linecolor</span> <span class="o">=</span> <span class="mi">3</span>
</span><span class='line'>      <span class="n">ds</span><span class="o">.</span><span class="n">notitle</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><a href="https://gist.github.com/komasaru/27e65a70d4681dd73370" title="Gist - Ruby script to draw a graph by gnuplot.(Ex.2)">Gist - Ruby script to draw a graph by gnuplot.(Ex.2)</a></li>
</ul>


<p>そして、実行権限を付与して実行。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ sudo chmod +x gnuplot_2.rb
</span><span class='line'>
</span><span class='line'>$ ./gnuplot_2.rb
</span></code></pre></td></tr></table></div></figure>


<p>&ldquo;gnuplot_2.png&rdquo; というファイルが出力される。</p>

<p><img src="http://komasaru.github.io/images/2015/08/13/GNUPLOT_2.png" title="GNUPLOT_2" alt="GNUPLOT_2" /></p>

<h4>2-3. 作成例・３</h4>

<script type="math/tex">z=sin(x)cos(x)</script>


<p>の三次元グラフを PNG ファイルに描画・出力する例。</p>

<figure class='code'><figcaption><span>gnuplot_3.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#! /usr/local/bin/ruby</span>
</span><span class='line'><span class="c1">#-----------------------------------------------</span>
</span><span class='line'><span class="c1"># Ruby script to draw a graph by gnuplot.(Ex.3)</span>
</span><span class='line'><span class="c1">#-----------------------------------------------</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;gnuplot&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">Gnuplot</span><span class="o">.</span><span class="n">open</span> <span class="k">do</span> <span class="o">|</span><span class="n">gp</span><span class="o">|</span>
</span><span class='line'>  <span class="no">Gnuplot</span><span class="o">::</span><span class="no">SPlot</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">gp</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">plot</span><span class="o">|</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">terminal</span> <span class="s2">&quot;png enhanced font &#39;IPA P ゴシック&#39; fontscale 1.2&quot;</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">output</span>   <span class="s2">&quot;gnuplot_3.png&quot;</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">set</span>      <span class="s2">&quot;object 1 rect from screen 0,0 to screen 1,1 fc rgb &#39;#D0D0E0&#39; fillstyle solid 1.0 behind&quot;</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">title</span>    <span class="s2">&quot;作成例３&quot;</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">xrange</span>   <span class="s2">&quot;[-10:10]&quot;</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">yrange</span>   <span class="s2">&quot;[-10:10]&quot;</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">xlabel</span>   <span class="s2">&quot;x&quot;</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">ylabel</span>   <span class="s2">&quot;y&quot;</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">zlabel</span>   <span class="s2">&quot;z&quot;</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">pm3d</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">grid</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="no">Gnuplot</span><span class="o">::</span><span class="no">DataSet</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;sin(x)*cos(y)&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">ds</span><span class="o">|</span>
</span><span class='line'>      <span class="n">ds</span><span class="o">.</span><span class="n">with</span>      <span class="o">=</span> <span class="s2">&quot;lines&quot;</span>
</span><span class='line'>      <span class="n">ds</span><span class="o">.</span><span class="n">linecolor</span> <span class="o">=</span> <span class="mi">6</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><a href="https://gist.github.com/komasaru/1395add506fd9a1a4bd6" title="Gist - Ruby script to draw a graph by gnuplot.(Ex.3)">Gist - Ruby script to draw a graph by gnuplot.(Ex.3)</a></li>
</ul>


<p>そして、実行権限を付与して実行。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ sudo chmod +x gnuplot_3.rb
</span><span class='line'>
</span><span class='line'>$ ./gnuplot_3.rb
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://komasaru.github.io/images/2015/08/13/GNUPLOT_3.png" title="GNUPLOT_3" alt="GNUPLOT_3" /></p>

<h3>参考サイト</h3>

<ul>
<li><a href="http://www.gnuplot.info/" title="gnuplot">gnuplot</a></li>
<li><a href="https://rubygems.org/gems/gnuplot" title="gnuplot - RubyGems.org - your community gem host">gnuplot - RubyGems.org - your community gem host</a></li>
</ul>


<hr />

<p>Ruby で処理した得た数値をグラフ化することが多い場合は重宝するでしょう。</p>

<p>以上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Linux Mint - Groonga インストール（by ソースビルド）！]]></title>
    <link href="http://komasaru.github.io/blog/2015/08/09/linux-mint-groonga-installation-by-src/"/>
    <updated>2015-08-09T00:20:00+09:00</updated>
    <id>http://komasaru.github.io/blog/2015/08/09/linux-mint-groonga-installation-by-src</id>
    <content type="html"><![CDATA[<p>こんばんは。</p>

<p>オープンソースのカラムストア機能付き全文検索エンジン <a href="http://groonga.org/ja/" title="Groonga - カラムストア機能付き全文検索エンジン">Groonga</a> を、ソースをビルドしてインストールする方法についての記録です。（最後に簡単な使用例も紹介）</p>

<!--more-->


<h3>0. 前提条件</h3>

<ul>
<li>Linux Mint 17.2(64bit) での作業を想定。</li>
<li>当記事執筆時点で最新の Groonga 5.0.5 をインストールする。</li>
<li>トークナイザは、デフォルトの N-gram 方式ではなく形態素解析器 MeCab を使用することを想定。</li>
<li>ここでは、全文検索がどういうものかという説明はしない。</li>
<li>以下の説明内で出力するデータは、可読性を考慮して整形している。</li>
</ul>


<h3>1. 依存パッケージのインストール</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ sudo apt-get -y install wget tar build-essential \
</span><span class='line'>&gt; zlib1g-dev liblzo2-dev libmsgpack-dev \
</span><span class='line'>&gt; libzmq-dev libevent-dev libmecab-dev
</span></code></pre></td></tr></table></div></figure>


<h3>2. アーカーブソースの取得</h3>

<p>アーカイブファイルをダウンロード後、展開する。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ wget http://packages.groonga.org/source/groonga/groonga-5.0.5.tar.gz
</span><span class='line'>$ tar zxvf groonga-5.0.5.tar.gz
</span></code></pre></td></tr></table></div></figure>


<h3>3. ビルド＆インストール</h3>

<p><code>configure</code>, <code>make</code>, <code>make install</code> する。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ cd groonga-5.0.5
</span><span class='line'>$ ./configure
</span><span class='line'>$ make -j$(grep &#39;^processor&#39; /proc/cpuinfo | wc -l)
</span><span class='line'>$ sudo make install
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>make</code> の <code>-j$(grep '^processor' /proc/cpuinfo | wc -l)</code> の部分はプロセッサ数が明確なら <code>-j4</code> のように指定してもよいし、速度を気にしないのなら単に <code>make</code> のみでもよい。</li>
<li><code>configure</code> オプションについては <a href="http://groonga.org/ja/docs/install/others.html#source-configure">configure</a> を参照。</li>
</ul>


<p>そして、インストールされたかバージョンを表示して確認してみる。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ groonga --version
</span><span class='line'>groonga 5.0.5 [linux-gnu,x86_64,utf8,match-escalation-threshold=0,nfkc,mecab,msgpack,onigmo,zlib,epoll]
</span><span class='line'>
</span><span class='line'>configure options: &lt;&gt;
</span></code></pre></td></tr></table></div></figure>


<h3>4. 動作確認</h3>

<p>簡単に動作確認してみる。（パスは適宜変更）<br/>
以下は、都道府県名のローマ字表記を <code>_key</code>、都道府県名の漢字表記を <code>name</code> として登録する例。（簡易都道府県名データベース）</p>

<h4>4-1. データベースの作成</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ mkdir ~/groonga-db
</span><span class='line'>$ groonga -n ~/groonga-db/test.db
</span></code></pre></td></tr></table></div></figure>


<p>データベース作成後は自動で対話モードに入るが、手動で対話モードへ入るには以下のようにする。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ groonga ~/groonga-db/test.db
</span></code></pre></td></tr></table></div></figure>


<h4>4-2. テーブルの作成</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt; table_create --name Prefs --flags TABLE_HASH_KEY --key_type ShortText
</span><span class='line'>[
</span><span class='line'>  [0,1436411689.75983,0.0292973518371582],
</span><span class='line'>  true
</span><span class='line'>]
</span></code></pre></td></tr></table></div></figure>


<h4>4-3. テーブルの表示</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt; select --table Prefs
</span><span class='line'>[
</span><span class='line'>  [0,1436411701.50367,0.000922203063964844],
</span><span class='line'>  [
</span><span class='line'>    [
</span><span class='line'>      [0],
</span><span class='line'>      [
</span><span class='line'>        [&quot;_id&quot;,&quot;UInt32&quot;],
</span><span class='line'>        [&quot;_key&quot;,&quot;ShortText&quot;]
</span><span class='line'>      ]
</span><span class='line'>    ]
</span><span class='line'>  ]
</span><span class='line'>]
</span></code></pre></td></tr></table></div></figure>


<h4>4-4. カラムの作成</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt; column_create --table Prefs --name name --type ShortText
</span><span class='line'>[
</span><span class='line'>  [0,1436411764.36768,0.0517301559448242],
</span><span class='line'>  true
</span><span class='line'>]
</span><span class='line'>
</span><span class='line'>&gt; select --table Prefs
</span><span class='line'>[
</span><span class='line'>  [0,1436411783.16738,0.000133037567138672],
</span><span class='line'>  [
</span><span class='line'>    [
</span><span class='line'>      [0],
</span><span class='line'>      [
</span><span class='line'>        [&quot;_id&quot;,&quot;UInt32&quot;],
</span><span class='line'>        [&quot;_key&quot;,&quot;ShortText&quot;],
</span><span class='line'>        [&quot;name&quot;,&quot;ShortText&quot;]
</span><span class='line'>      ]
</span><span class='line'>    ]
</span><span class='line'>  ]
</span><span class='line'>]
</span></code></pre></td></tr></table></div></figure>


<h4>4-5. データのロード</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt; load --table Prefs
</span><span class='line'>[
</span><span class='line'>  {&quot;_key&quot;:&quot;Hokkaido&quot;,&quot;name&quot;:&quot;北海道&quot;},
</span><span class='line'>  {&quot;_key&quot;:&quot;Aomoriken&quot;,&quot;name&quot;:&quot;青森県&quot;},
</span><span class='line'>           :
</span><span class='line'>  ====&lt; 途中省略 &gt;====
</span><span class='line'>           :
</span><span class='line'>  {&quot;_key&quot;:&quot;Kagoshimaken&quot;,&quot;name&quot;:&quot;鹿児島県&quot;},
</span><span class='line'>  {&quot;_key&quot;:&quot;Okinawaken&quot;,&quot;name&quot;:&quot;沖縄県&quot;},
</span><span class='line'>]
</span></code></pre></td></tr></table></div></figure>


<p>もしくは、以下のようにコマンドラインから JSON 形式で作成したファイルを取り込んでもよい。</p>

<figure class='code'><figcaption><span>load.grn</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>load --table Prefs
</span><span class='line'>[
</span><span class='line'>  {&quot;_key&quot;:&quot;Hokkaido&quot;,&quot;name&quot;:&quot;北海道&quot;},
</span><span class='line'>  {&quot;_key&quot;:&quot;Aomoriken&quot;,&quot;name&quot;:&quot;青森県&quot;},
</span><span class='line'>           :
</span><span class='line'>  ====&lt; 途中省略 &gt;====
</span><span class='line'>           :
</span><span class='line'>  {&quot;_key&quot;:&quot;Kagoshimaken&quot;,&quot;name&quot;:&quot;鹿児島県&quot;},
</span><span class='line'>  {&quot;_key&quot;:&quot;Okinawaken&quot;,&quot;name&quot;:&quot;沖縄県&quot;},
</span><span class='line'>]
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ groonga ~/groonga-db/test.db &lt; load.grn
</span><span class='line'>[[0,1436415458.66362,0.00340938568115234],47]
</span></code></pre></td></tr></table></div></figure>


<h4>4-6. レコードの取得</h4>

<figure class='code'><figcaption><span>"全レコードを取得（但し、先頭10件）"</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>select --table Prefs
</span><span class='line'>[
</span><span class='line'>  [0,1436415521.50463,0.00343823432922363],
</span><span class='line'>  [
</span><span class='line'>    [
</span><span class='line'>      [47],
</span><span class='line'>      [
</span><span class='line'>        [&quot;_id&quot;,&quot;UInt32&quot;],
</span><span class='line'>        [&quot;_key&quot;,&quot;ShortText&quot;],
</span><span class='line'>        [&quot;name&quot;,&quot;ShortText&quot;]
</span><span class='line'>      ],
</span><span class='line'>      [1,&quot;Hokkaido&quot;,&quot;北海道&quot;],
</span><span class='line'>      [2,&quot;Aomoriken&quot;,&quot;青森県&quot;],
</span><span class='line'>      [3,&quot;Iwateken&quot;,&quot;岩手県&quot;],
</span><span class='line'>      [4,&quot;Miyagiken&quot;,&quot;宮城県&quot;],
</span><span class='line'>      [5,&quot;Akitaken&quot;,&quot;秋田県&quot;],
</span><span class='line'>      [6,&quot;Yamagataken&quot;,&quot;山形県&quot;],
</span><span class='line'>      [7,&quot;Fukushimaken&quot;,&quot;福島県&quot;],
</span><span class='line'>      [8,&quot;Ibarakiken&quot;,&quot;茨城県&quot;],
</span><span class='line'>      [9,&quot;Tochigiken&quot;,&quot;栃木県&quot;],
</span><span class='line'>      [10,&quot;Gunmaken&quot;,&quot;群馬県&quot;]
</span><span class='line'>    ]
</span><span class='line'>  ]
</span><span class='line'>]
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>"ID が 32 のレコードを取得"</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt; select --table Prefs --query _id:32
</span><span class='line'>[
</span><span class='line'>  [0,1436415572.03281,0.0471560955047607],
</span><span class='line'>  [
</span><span class='line'>    [
</span><span class='line'>      [1],
</span><span class='line'>      [
</span><span class='line'>        [&quot;_id&quot;,&quot;UInt32&quot;],
</span><span class='line'>        [&quot;_key&quot;,&quot;ShortText&quot;],
</span><span class='line'>        [&quot;name&quot;,&quot;ShortText&quot;]
</span><span class='line'>      ],
</span><span class='line'>      [32,&quot;Shimaneken&quot;,&quot;島根県&quot;]
</span><span class='line'>    ]
</span><span class='line'>  ]
</span><span class='line'>]
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>"KEY が shimaneken のレコードを取得"</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt; select --table Prefs --query &#39;_key:&quot;Shimaneken&quot;&#39;
</span><span class='line'>[
</span><span class='line'>  [0,1436415572.03281,0.0471560955047607],
</span><span class='line'>  [
</span><span class='line'>    [
</span><span class='line'>      [1],
</span><span class='line'>      [
</span><span class='line'>        [&quot;_id&quot;,&quot;UInt32&quot;],
</span><span class='line'>        [&quot;_key&quot;,&quot;ShortText&quot;],
</span><span class='line'>        [&quot;name&quot;,&quot;ShortText&quot;]
</span><span class='line'>      ],
</span><span class='line'>      [32,&quot;Shimaneken&quot;,&quot;島根県&quot;]
</span><span class='line'>    ]
</span><span class='line'>  ]
</span></code></pre></td></tr></table></div></figure>


<h4>4-7. 全文検索用の語彙表の作成</h4>

<p>高速な全文検索を実現するためには転置インデックスが必要であるので、転置インデックスとして使用するテーブルを作成する。（トークナイザとして MeCab を使用する）</p>

<p>辞書テーブルの作成は以下のようにする。</p>

<figure class='code'><figcaption><span>辞書テーブルの作成</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt; table_create --name Terms --flags TABLE_PAT_KEY|KEY_NORMALIZE --key_type ShortText --default_tokenizer TokenMecab
</span><span class='line'>[[0,1436416480.43314,0.0687055587768555],true]
</span></code></pre></td></tr></table></div></figure>


<p>辞書テーブルへのカラムの作成は以下のようにする。</p>

<figure class='code'><figcaption><span>辞書テーブルへのカラムの作成</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt; column_create --table Terms --name pref_name --flags COLUMN_INDEX|WITH_POSITION --type Prefs --source name
</span><span class='line'>[[0,1436416570.78517,0.964933156967163],true]
</span></code></pre></td></tr></table></div></figure>


<p>辞書テーブルの確認は以下のようにする。</p>

<figure class='code'><figcaption><span>辞書テーブルの確認</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt; select --table Terms
</span><span class='line'>[
</span><span class='line'>  [0,1436416592.4811,0.000155210494995117],
</span><span class='line'>  [
</span><span class='line'>    [
</span><span class='line'>      [50],
</span><span class='line'>      [
</span><span class='line'>        [&quot;_id&quot;,&quot;UInt32&quot;],
</span><span class='line'>        [&quot;_key&quot;,&quot;ShortText&quot;],
</span><span class='line'>        [&quot;pref_name&quot;,&quot;UInt32&quot;]
</span><span class='line'>      ],
</span><span class='line'>      [1,&quot;三重&quot;,1],
</span><span class='line'>      [2,&quot;京都&quot;,1],
</span><span class='line'>      [3,&quot;佐賀&quot;,1],
</span><span class='line'>      [4,&quot;兵庫&quot;,1],
</span><span class='line'>      [5,&quot;北海道&quot;,1],
</span><span class='line'>      [6,&quot;千葉&quot;,1],
</span><span class='line'>      [7,&quot;和歌山&quot;,1],
</span><span class='line'>      [8,&quot;埼玉&quot;,1],
</span><span class='line'>      [9,&quot;大分&quot;,1],
</span><span class='line'>      [10,&quot;大阪&quot;,1]
</span><span class='line'>    ]
</span><span class='line'>  ]
</span><span class='line'>]
</span></code></pre></td></tr></table></div></figure>


<p>テーブルの検索は以下のようにする。</p>

<figure class='code'><figcaption><span>テーブルの検索</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt; select --table Prefs --query name:@府
</span><span class='line'>[
</span><span class='line'>  [0,1436416671.28152,0.000936269760131836],
</span><span class='line'>  [
</span><span class='line'>    [
</span><span class='line'>      [2],
</span><span class='line'>      [
</span><span class='line'>        [&quot;_id&quot;,&quot;UInt32&quot;],
</span><span class='line'>        [&quot;_key&quot;,&quot;ShortText&quot;],
</span><span class='line'>        [&quot;name&quot;,&quot;ShortText&quot;]
</span><span class='line'>      ],
</span><span class='line'>      [26,&quot;Kyotofu&quot;,&quot;京都府&quot;],
</span><span class='line'>      [27,&quot;Osakafu&quot;,&quot;大阪府&quot;]
</span><span class='line'>    ]
</span><span class='line'>  ]
</span><span class='line'>]
</span></code></pre></td></tr></table></div></figure>


<h4>4-8. 対話モードの終了</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt; quit
</span></code></pre></td></tr></table></div></figure>


<h3>5. 参考サイト</h3>

<ul>
<li><a href="http://groonga.org/ja/" title="Groonga - カラムストア機能付き全文検索エンジン">Groonga - カラムストア機能付き全文検索エンジン</a></li>
</ul>


<hr />

<p>慣れないうちは Groonga を単体で扱うのは若干面倒に感じます。</p>

<p>当方は、Rroonga（Groonga の機能を Ruby から利用するためのライブラリ）や Mroonga（Groonga をベースとした MySQL のストレージエンジン）を使用することも考えています。</p>

<p>以上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[tmux - Window, Pane, Session 自動保存プラグイン！]]></title>
    <link href="http://komasaru.github.io/blog/2015/08/06/tmux-automatic-session-preservation/"/>
    <updated>2015-08-06T00:20:00+09:00</updated>
    <id>http://komasaru.github.io/blog/2015/08/06/tmux-automatic-session-preservation</id>
    <content type="html"><![CDATA[<p>こんばんは。</p>

<p>ターミナルマルチプレクサ（仮想端末マネージャ） tmux の Window, Pane, Session 等を保存（自動保存）するプラグインをインストールする方法についての記録です。</p>

<p>Window, Pane, Session 等を保存するプラグインは tmux-resurrect で、それを自動化するプラグインは tmux-continuum です。<br/>
また、プラグインの管理には tpm(Tmux Plugin Manager)を使用します。<br/>
（以前は tmux-resurrect を自動化するプラグインは tmux-resurrect-auto でしたが、現在は tmux-continuum に改名されています。tmux-resurrect-auto も使用できますが）</p>

<!--more-->


<h3>0. 前提条件</h3>

<ul>
<li>Linux Mint 17.2(64bit) での作業を想定。</li>
<li>tmux 2.1 での作業を想定。</li>
<li>Git がインストール済みであること。</li>
<li>tpm(Tmux Plugin Manager) で tmux プラグインを管理することを想定。<br/>
（tpm を使用せず手動でインストールすることも可能）</li>
</ul>


<h3>1. tpm のインストール</h3>

<p>tmux プラグインの管理に tpm(Tmux Plugin Manager) を使用するのでインストールする。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
</span></code></pre></td></tr></table></div></figure>


<h3>2. tmux.conf の編集</h3>

<p>&ldquo;~/.tmux.conf&rdquo; に以下の記述を追記する。</p>

<figure class='code'><figcaption><span>~/.tmux.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">set</span>-option -g @tpm_plugins <span class="s1">&#39;  \</span>
</span><span class='line'><span class="s1">  tmux-plugins/tpm            \</span>
</span><span class='line'><span class="s1">  tmux-plugins/tmux-resurrect \</span>
</span><span class='line'><span class="s1">  tmux-plugins/tmux-continuum \</span>
</span><span class='line'><span class="s1">&#39;</span>
</span><span class='line'><span class="nb">set</span>-option -g @continuum-save-interval <span class="s1">&#39;60&#39;</span>
</span><span class='line'><span class="nb">set</span>-option -g @resurrect-processes <span class="s1">&#39;ssh -p 9999 hoge&#39;</span>
</span><span class='line'><span class="nb">set</span>-option -g @resurrect-strategy-vim <span class="s1">&#39;session&#39;</span>
</span><span class='line'>
</span><span class='line'>run-shell <span class="s1">&#39;~/.tmux/plugins/tpm/tpm&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>set-option</code> は <code>set</code> で代用可。</li>
<li><code>set-option -g @continuum-save-interval</code> でセッションを自動保存する間隔を指定する。<br/>
 非指定時のデフォルトは <code>15</code> 分。 <code>0</code> で自動保存の無効化。</li>
<li><code>set-option -g @resurrect-processes</code> で保存したいセッションを指定する。<br/>
（上記の例は &ldquo;hoge&rdquo; ホストへポート 9999 で SSH 接続したセッションを保存する例）</li>
<li><code>set-option -g @resurrect-strategy-vim 'session'</code> で Vim のセッションを保存する。</li>
</ul>


<h3>3. プラグインのインストール</h3>

<p>tmux 上で Prefix 押下後に <code>I</code> を押下する。（<code>i</code> ではなく <code>I</code>）</p>

<h3>4. 動作確認</h3>

<p>Prefix + CTRL-s で Window, Pane, Session 等の状態を保存、Prefix + CTLR-r でWindow, Pane, Session 等の状態を復元できるので、「保存→マシン再行動→復元」と試してみる。</p>

<p>tmux-continuum はデフォルトでは 60 分間隔で状態を保存するようなので、その辺りの動作も確認しておく。</p>

<p>ちなみに、状態は &ldquo;~/.tmux/resurrect&rdquo; ディレクトリ配下にテキストファイルで保存される。</p>

<hr />

<p>これで、マシンを起動する度に Window, Pane, Session 等を手動で復元する手間が省けます。</p>

<p>以上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Linux Mint - tmux 2.1 のインストール（by ソースビルド）！]]></title>
    <link href="http://komasaru.github.io/blog/2015/08/03/linux-mint-tmux-installation-by-src/"/>
    <updated>2015-08-03T00:20:00+09:00</updated>
    <id>http://komasaru.github.io/blog/2015/08/03/linux-mint-tmux-installation-by-src</id>
    <content type="html"><![CDATA[<p>こんばんは。</p>

<p>ターミナルマルチプレクサ（仮想端末マネージャ）である tmux(Terminal MUltipleXer) の最新版を Linux Mint へインストールする方法についての記録です。</p>

<p>これまで Apt パッケージでインストールした tmux 1.8 を使用していました。<br/>
しかし、使用したいプラグインが tmux 1.9 未満ではインストールできないため、最新版の 2.1 をソースビルドでインストールすることとしました。</p>

<!--more-->


<h3>0. 前提条件</h3>

<ul>
<li>Linux Mint 17.2(64bit) での作業を想定。</li>
<li>Git でソースを取得するため Git がインストール済みであること。</li>
<li>当記事執筆時点で最新の tmux 2.1 をインストールする。</li>
<li>Apt でインストールしていた tmux 1.8 はアンインストールしておく。</li>
</ul>


<h3>1. libevent-dev のインストール</h3>

<p>libevent-dev 2.x のパッケージが必要なので未インストールならインストールする。<br/>
（以前は Apt では 2.x はインストールできずソースをビルドしてインストールする必要があったが、今は Apt で 2.x がインストール可能）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ sudo apt-get install libevent-dev
</span></code></pre></td></tr></table></div></figure>


<h3>2. tmux のインストール</h3>

<p>Git でソースを <code>clone</code> して、 <code>configure</code>, <code>make</code>, <code>make install</code> する。<br/>
（但し、<code>configure</code> 実行前に <code>autogen.sh</code> の実行が必要）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ git clone https://github.com/tmux/tmux.git
</span><span class='line'>$ cd tmux
</span><span class='line'>$ autogen.sh
</span><span class='line'>$ ./configure
</span><span class='line'>$ make
</span><span class='line'>$ sudo make install
</span></code></pre></td></tr></table></div></figure>


<h3>3. tmux インストールの確認</h3>

<p>端末から <code>tmux</code> と入力・実行して tmux が起動すればよい。<br/>
また、tmux コンソールが起動後にバージョンも確認してみる。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ tmux -V
</span><span class='line'>tmux 2.1
</span></code></pre></td></tr></table></div></figure>


<p>もしも、 tmux 起動時に以下のようなメッセージが出力されて起動しない場合は、</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>protocol version mismatch (client 8, server 7)
</span></code></pre></td></tr></table></div></figure>


<p>古いバージョンの tmux サーバのセッションが残っているため。<br/>
その場合は、以下のように起動中の tmux プロセスを kill すればよい。（厳密に PID をチェックして <code>kill</code> してもよい）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ killall tmux
</span></code></pre></td></tr></table></div></figure>


<h3>4. その他</h3>

<p>その他、各種設定を行う。</p>

<p>当ブログ過去記事も参照。</p>

<ul>
<li><a href="http://www.mk-mode.com/octopress/tags/tmux/" title="Tag:tmux - mk-mode BLOG">Tag:tmux - mk-mode BLOG</a></li>
</ul>


<p>一つだけ注意するとするなら、マウスモードの指定方法。<br/>
古いバージョンでは &ldquo;~/.tmux.conf&rdquo; で以下のように指定していたが、</p>

<figure class='code'><figcaption><span>~/.tmux.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">set</span>-option -g mode-mouse on
</span><span class='line'><span class="nb">set</span>-option -g mouse-select-pane on
</span><span class='line'><span class="nb">set</span>-option -g mouse-select-window on
</span><span class='line'><span class="nb">set</span>-option -g mouse-resize-pane on
</span></code></pre></td></tr></table></div></figure>


<p>今のバージョンでは以下のように１行のみ指定すればよい。</p>

<figure class='code'><figcaption><span>~/.tmux.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">set</span>-option -g mouse on
</span></code></pre></td></tr></table></div></figure>


<p>但し、これだけではマウスでのスクロールができないので、以下のような記述も追加する。</p>

<figure class='code'><figcaption><span>~/.tmux.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">bind</span>-key -n WheelUpPane <span class="k">if</span>-shell -Ft<span class="o">=</span> <span class="s2">&quot;#{?pane_in_mode,1,#{alternate_on}}&quot;</span> <span class="s2">&quot;send-keys -M&quot;</span> <span class="s2">&quot;copy-mode&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>（<code>set-option</code> = <code>set</code>, <code>bind-key</code> = <code>bind</code>, <code>send-keys</code> = <code>send</code> とエイリアスされているので、置き換えてもよい）</p>

<h3>参考サイト</h3>

<ul>
<li><a href="http://tmux.github.io/" title="tmux">tmux</a></li>
</ul>


<hr />

<p>これで、使用したかった tmux プラグインが使用できるでしょう。</p>

<p>以上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[2015年07月 - OS・ブラウザ別アクセス状況！【自動集計】]]></title>
    <link href="http://komasaru.github.io/blog/2015/08/01/blog-access/"/>
    <updated>2015-08-01T00:20:00+09:00</updated>
    <id>http://komasaru.github.io/blog/2015/08/01/blog-access</id>
    <content type="html"><![CDATA[<p>こんばんは。</p>

<p>08月になりましたので、先月07月分の当ブログアクセス状況を公開します。</p>

<!--more-->


<h4>1. アクセスをOS別に集計</h4>

<table class="blog-access">
  <tr>
    <th>OS</th>
    <th>PageViews</th>
    <th>比率(%)</th>
  </tr>
  <tr>
    <td>Mac OS</td>
    <td class="blog-access-pv">12,261</td>
    <td class="blog-access-rate">56.9035</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td class="blog-access-pv">7,658</td>
    <td class="blog-access-rate">35.5409</td>
  </tr>
  <tr>
    <td>Linux</td>
    <td class="blog-access-pv">906</td>
    <td class="blog-access-rate">4.2048</td>
  </tr>
  <tr>
    <td>Ubuntu Linux</td>
    <td class="blog-access-pv">554</td>
    <td class="blog-access-rate">2.5711</td>
  </tr>
  <tr>
    <td>unknown</td>
    <td class="blog-access-pv">60</td>
    <td class="blog-access-rate">0.2785</td>
  </tr>
  <tr>
    <td>Fedora Linux</td>
    <td class="blog-access-pv">51</td>
    <td class="blog-access-rate">0.2367</td>
  </tr>
  <tr>
    <td>FreeBSD</td>
    <td class="blog-access-pv">23</td>
    <td class="blog-access-rate">0.1067</td>
  </tr>
  <tr>
    <td>Android</td>
    <td class="blog-access-pv">11</td>
    <td class="blog-access-rate">0.0511</td>
  </tr>
  <tr>
    <td>RedHat Linux</td>
    <td class="blog-access-pv">7</td>
    <td class="blog-access-rate">0.0325</td>
  </tr>
  <tr>
    <td>Solaris</td>
    <td class="blog-access-pv">6</td>
    <td class="blog-access-rate">0.0278</td>
  </tr>
  <tr>
    <td>CentOS Linux</td>
    <td class="blog-access-pv">5</td>
    <td class="blog-access-rate">0.0232</td>
  </tr>
  <tr>
    <td>Debian GNU/Linux</td>
    <td class="blog-access-pv">3</td>
    <td class="blog-access-rate">0.0139</td>
  </tr>
  <tr>
    <td>NetBSD</td>
    <td class="blog-access-pv">2</td>
    <td class="blog-access-rate">0.0093</td>
  </tr>
  <tr>
    <td class="blog-access-total-label">合　計</td>
    <td class="blog-access-pv">21,547</td>
    <td class="blog-access-rate">100.0000</td>
  </tr>
</table>


<h4>2. アクセスをOS・バージョン別に集計（上位20件）</h4>

<table class="blog-access">
  <tr>
    <th>OS</th>
    <th>Version</th>
    <th>PageViews</th>
    <th>比率(%)</th>
  </tr>
  <tr>
    <td>Mac OS</td>
    <td>X</td>
    <td class="blog-access-pv">12,259</td>
    <td class="blog-access-rate">56.8942</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>NT</td>
    <td class="blog-access-pv">6,149</td>
    <td class="blog-access-rate">28.5376</td>
  </tr>
  <tr>
    <td>Linux</td>
    <td>unknown</td>
    <td class="blog-access-pv">898</td>
    <td class="blog-access-rate">4.1676</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>7</td>
    <td class="blog-access-pv">708</td>
    <td class="blog-access-rate">3.2858</td>
  </tr>
  <tr>
    <td>Ubuntu Linux</td>
    <td>unknown</td>
    <td class="blog-access-pv">547</td>
    <td class="blog-access-rate">2.5386</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>7 64 bit</td>
    <td class="blog-access-pv">408</td>
    <td class="blog-access-rate">1.8935</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>XP</td>
    <td class="blog-access-pv">266</td>
    <td class="blog-access-rate">1.2345</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>Vista</td>
    <td class="blog-access-pv">76</td>
    <td class="blog-access-rate">0.3527</td>
  </tr>
  <tr>
    <td>unknown</td>
    <td>unknown</td>
    <td class="blog-access-pv">60</td>
    <td class="blog-access-rate">0.2785</td>
  </tr>
  <tr>
    <td>Fedora Linux</td>
    <td>unknown</td>
    <td class="blog-access-pv">50</td>
    <td class="blog-access-rate">0.2321</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>8 64 bit</td>
    <td class="blog-access-pv">23</td>
    <td class="blog-access-rate">0.1067</td>
  </tr>
  <tr>
    <td>FreeBSD</td>
    <td>unknown</td>
    <td class="blog-access-pv">23</td>
    <td class="blog-access-rate">0.1067</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>Server 2003</td>
    <td class="blog-access-pv">14</td>
    <td class="blog-access-rate">0.0650</td>
  </tr>
  <tr>
    <td>Linux</td>
    <td>64 bit</td>
    <td class="blog-access-pv">6</td>
    <td class="blog-access-rate">0.0278</td>
  </tr>
  <tr>
    <td>Solaris</td>
    <td>unknown</td>
    <td class="blog-access-pv">6</td>
    <td class="blog-access-rate">0.0278</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>Vista 64 bit</td>
    <td class="blog-access-pv">6</td>
    <td class="blog-access-rate">0.0278</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>2000</td>
    <td class="blog-access-pv">5</td>
    <td class="blog-access-rate">0.0232</td>
  </tr>
  <tr>
    <td>RedHat Linux</td>
    <td>3.6.9-2.el6 64 bit</td>
    <td class="blog-access-pv">5</td>
    <td class="blog-access-rate">0.0232</td>
  </tr>
  <tr>
    <td>Ubuntu Linux</td>
    <td>10.04</td>
    <td class="blog-access-pv">4</td>
    <td class="blog-access-rate">0.0186</td>
  </tr>
  <tr>
    <td>Android</td>
    <td>4.0.1</td>
    <td class="blog-access-pv">4</td>
    <td class="blog-access-rate">0.0186</td>
  </tr>
  <tr>
    <td class="blog-access-dot">:</td>
    <td class="blog-access-dot">:</td>
    <td class="blog-access-dot">:</td>
    <td class="blog-access-dot">:</td>
  </tr>
  <tr>
    <td class="blog-access-total-label">合　計</td>
    <td> </td>
    <td class="blog-access-pv">21,547</td>
    <td class="blog-access-rate">100.0000</td>
  </tr>
</table>


<h4>3. アクセスをブラウザ別に集計</h4>

<table class="blog-access">
  <tr>
    <th>ブラウザ</th>
    <th>PageViews</th>
    <th>比率(%)</th>
  </tr>
  <tr>
    <td>Safari</td>
    <td class="blog-access-pv">11,842</td>
    <td class="blog-access-rate">54.9589</td>
  </tr>
  <tr>
    <td>Mozilla Firefox</td>
    <td class="blog-access-pv">5,146</td>
    <td class="blog-access-rate">23.8827</td>
  </tr>
  <tr>
    <td>Mozilla</td>
    <td class="blog-access-pv">2,544</td>
    <td class="blog-access-rate">11.8067</td>
  </tr>
  <tr>
    <td>Internet Explorer</td>
    <td class="blog-access-pv">1,654</td>
    <td class="blog-access-rate">7.6762</td>
  </tr>
  <tr>
    <td>Debian IceWeasel</td>
    <td class="blog-access-pv">203</td>
    <td class="blog-access-rate">0.9421</td>
  </tr>
  <tr>
    <td>Opera</td>
    <td class="blog-access-pv">65</td>
    <td class="blog-access-rate">0.3017</td>
  </tr>
  <tr>
    <td>Netscape Navigator</td>
    <td class="blog-access-pv">60</td>
    <td class="blog-access-rate">0.2785</td>
  </tr>
  <tr>
    <td>Epiphany</td>
    <td class="blog-access-pv">7</td>
    <td class="blog-access-rate">0.0325</td>
  </tr>
  <tr>
    <td>Konqueror</td>
    <td class="blog-access-pv">7</td>
    <td class="blog-access-rate">0.0325</td>
  </tr>
  <tr>
    <td>Unknown</td>
    <td class="blog-access-pv">6</td>
    <td class="blog-access-rate">0.0278</td>
  </tr>
  <tr>
    <td>Chrome</td>
    <td class="blog-access-pv">6</td>
    <td class="blog-access-rate">0.0278</td>
  </tr>
  <tr>
    <td>Mozilla SeaMonkey</td>
    <td class="blog-access-pv">5</td>
    <td class="blog-access-rate">0.0232</td>
  </tr>
  <tr>
    <td>Sleipnir</td>
    <td class="blog-access-pv">2</td>
    <td class="blog-access-rate">0.0093</td>
  </tr>
  <tr>
    <td class="blog-access-total-label">合　計</td>
    <td class="blog-access-pv">21,547</td>
    <td class="blog-access-rate">100.0000</td>
  </tr>
</table>


<h4>4. アクセスをブラウザ・バージョン別に集計（上位20件）</h4>

<table class="blog-access">
  <tr>
    <th>ブラウザ</th>
    <th>Version</th>
    <th>PageViews</th>
    <th>比率(%)</th>
  </tr>
  <tr>
    <td>Safari</td>
    <td>537.36</td>
    <td class="blog-access-pv">9,053</td>
    <td class="blog-access-rate">42.0151</td>
  </tr>
  <tr>
    <td>Mozilla Firefox</td>
    <td>38.0</td>
    <td class="blog-access-pv">2,725</td>
    <td class="blog-access-rate">12.6468</td>
  </tr>
  <tr>
    <td>Mozilla</td>
    <td>11.0</td>
    <td class="blog-access-pv">2,543</td>
    <td class="blog-access-rate">11.8021</td>
  </tr>
  <tr>
    <td>Mozilla Firefox</td>
    <td>39.0</td>
    <td class="blog-access-pv">1,590</td>
    <td class="blog-access-rate">7.3792</td>
  </tr>
  <tr>
    <td>Safari</td>
    <td>9537.53</td>
    <td class="blog-access-pv">957</td>
    <td class="blog-access-rate">4.4415</td>
  </tr>
  <tr>
    <td>Safari</td>
    <td>600.1.4</td>
    <td class="blog-access-pv">796</td>
    <td class="blog-access-rate">3.6942</td>
  </tr>
  <tr>
    <td>Internet Explorer</td>
    <td>8.0</td>
    <td class="blog-access-pv">580</td>
    <td class="blog-access-rate">2.6918</td>
  </tr>
  <tr>
    <td>Internet Explorer</td>
    <td>9.0</td>
    <td class="blog-access-pv">391</td>
    <td class="blog-access-rate">1.8146</td>
  </tr>
  <tr>
    <td>Internet Explorer</td>
    <td>10.0</td>
    <td class="blog-access-pv">370</td>
    <td class="blog-access-rate">1.7172</td>
  </tr>
  <tr>
    <td>Internet Explorer</td>
    <td>7.0</td>
    <td class="blog-access-pv">312</td>
    <td class="blog-access-rate">1.4480</td>
  </tr>
  <tr>
    <td>Safari</td>
    <td>600.7.12</td>
    <td class="blog-access-pv">307</td>
    <td class="blog-access-rate">1.4248</td>
  </tr>
  <tr>
    <td>Mozilla Firefox</td>
    <td>31.0</td>
    <td class="blog-access-pv">278</td>
    <td class="blog-access-rate">1.2902</td>
  </tr>
  <tr>
    <td>Safari</td>
    <td>600.6.3</td>
    <td class="blog-access-pv">209</td>
    <td class="blog-access-rate">0.9700</td>
  </tr>
  <tr>
    <td>Safari</td>
    <td>534.30</td>
    <td class="blog-access-pv">161</td>
    <td class="blog-access-rate">0.7472</td>
  </tr>
  <tr>
    <td>Debian IceWeasel</td>
    <td>31.8.0</td>
    <td class="blog-access-pv">97</td>
    <td class="blog-access-rate">0.4502</td>
  </tr>
  <tr>
    <td>Opera</td>
    <td>9.80</td>
    <td class="blog-access-pv">62</td>
    <td class="blog-access-rate">0.2877</td>
  </tr>
  <tr>
    <td>Netscape Navigator</td>
    <td>5.0</td>
    <td class="blog-access-pv">60</td>
    <td class="blog-access-rate">0.2785</td>
  </tr>
  <tr>
    <td>Mozilla Firefox</td>
    <td>37.0</td>
    <td class="blog-access-pv">60</td>
    <td class="blog-access-rate">0.2785</td>
  </tr>
  <tr>
    <td>Debian IceWeasel</td>
    <td>31.7.0</td>
    <td class="blog-access-pv">57</td>
    <td class="blog-access-rate">0.2645</td>
  </tr>
  <tr>
    <td>Mozilla Firefox</td>
    <td>24.0</td>
    <td class="blog-access-pv">52</td>
    <td class="blog-access-rate">0.2413</td>
  </tr>
  <tr>
    <td class="blog-access-dot">:</td>
    <td class="blog-access-dot">:</td>
    <td class="blog-access-dot">:</td>
    <td class="blog-access-dot">:</td>
  </tr>
  <tr>
    <td class="blog-access-total-label">合　計</td>
    <td> </td>
    <td class="blog-access-pv">21,547</td>
    <td class="blog-access-rate">100.0000</td>
  </tr>
</table>


<hr />

<p>以上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Linux Mint - Gnuplot でグラフ描画！]]></title>
    <link href="http://komasaru.github.io/blog/2015/07/30/linux-mint-installation-gnuplot/"/>
    <updated>2015-07-30T00:20:00+09:00</updated>
    <id>http://komasaru.github.io/blog/2015/07/30/linux-mint-installation-gnuplot</id>
    <content type="html"><![CDATA[<p>こんばんは。</p>

<p>Linux Mint で、2次元や3次元のグラフを描画するためのコマンドラインツール Gnuplot を使用してみました。</p>

<!--more-->


<h3>0. 前提条件</h3>

<ul>
<li>Linux Mint 17.1(64bit) での作業を想定。</li>
<li>Apt パッケージを使用して 4.6.4 をインストールする。</li>
</ul>


<h3>1. Gnuplot のインストール</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ sudo apt-get install gnuplot-x11
</span></code></pre></td></tr></table></div></figure>


<p>注意するのは <code>gnuplot</code> でなく <code>gnuplot-x11</code> をインストールするということ。<br/>
（こうしないと、 Gnuplot を起動してコマンドを入力してもグラフウィンドウが開かない）</p>

<p>ちなみに、最新バージョンの Gnuplot をインストールしたければ、以下のようにしてインストールすればよい。（但し、環境によってはスムーズ（or 綺麗）にインストールできないかもしれない）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ wget http://sourceforge.net/projects/gnuplot/files/gnuplot/5.0.1/gnuplot-5.0.1.tar.gz
</span><span class='line'>$ tar zxvf gnuplot-5.0.1.tar.gz
</span><span class='line'>$ cd gnuplot-5.0.1
</span><span class='line'>$ ./configure
</span><span class='line'>$ make
</span><span class='line'>$ sudo make install
</span></code></pre></td></tr></table></div></figure>


<h3>2. インストールの確認</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ gnuplot --version
</span><span class='line'>gnuplot 4.6 patchlevel 4
</span></code></pre></td></tr></table></div></figure>


<p>もしくは、以下のように Gnuplot を起動してみる。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ gnuplot
</span><span class='line'>
</span><span class='line'>        G N U P L O T
</span><span class='line'>        Version 4.6 patchlevel 4    last modified 2013-10-02
</span><span class='line'>        Build System: Linux x86_64
</span><span class='line'>
</span><span class='line'>        Copyright (C) 1986-1993, 1998, 2004, 2007-2013
</span><span class='line'>        Thomas Williams, Colin Kelley and many others
</span><span class='line'>
</span><span class='line'>        gnuplot home:     http://www.gnuplot.info
</span><span class='line'>        faq, bugs, etc:   type &quot;help FAQ&quot;
</span><span class='line'>        immediate help:   type &quot;help&quot;  (plot window: hit &#39;h&#39;)
</span><span class='line'>
</span><span class='line'>Terminal type set to &#39;wxt&#39;
</span><span class='line'>gnuplot&gt;
</span></code></pre></td></tr></table></div></figure>


<p>使用するターミナルが <code>wxt</code> or <code>x11</code> であることを確認する。<code>unknown</code> だと、コマンドを入力してもグラフウィンドウが立ち上がらない。<br/>
<code>unknown</code> なら <code>set terminal wxt</code> or <code>set terminal x11</code> で設定する。</p>

<h3>3. 動作確認</h3>

<h3>3-1. 動作確認・その１</h3>

<p>Gnuplot を起動後、テストコマンドを入力してグラフを描画してみる。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>gnuplot&gt; test
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://komasaru.github.io/images/2015/07/30/GNUPLOT_1.png" title="GNUPLOT_1" alt="GNUPLOT_1" /></p>

<h3>3-2. 動作確認・その２</h3>

<p>Gnuplot を起動後、コマンドを順次入力してグラフを描画してみる。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>gnuplot&gt; plot sin(x)
</span><span class='line'>gnuplot&gt; replot cos(x)
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://komasaru.github.io/images/2015/07/30/GNUPLOT_2.png" title="GNUPLOT_2" alt="GNUPLOT_2" /></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>gnuplot&gt; splot x**2 + y**2
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://komasaru.github.io/images/2015/07/30/GNUPLOT_3.png" title="GNUPLOT_3" alt="GNUPLOT_3" /></p>

<h4>3-3. 動作確認・その３</h4>

<p>予め作成しておいたスクリプトを呼び出してグラフを描画してみる。</p>

<p>まず、例として以下のようなスクリプトを作成する。</p>

<figure class='code'><figcaption><span>gnuplot_sample.plt</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>set dummy u,v
</span><span class='line'>set key bmargin center horizontal Right noreverse enhanced autotitles nobox
</span><span class='line'>set parametric
</span><span class='line'>set view 50, 30, 1, 1
</span><span class='line'>set isosamples 50, 20
</span><span class='line'>set hidden3d back offset 1 trianglepattern 3 undefined 1 altdiagonal bentover
</span><span class='line'>set ticslevel 0
</span><span class='line'>set title &quot;Interlocking Tori&quot;
</span><span class='line'>set urange [ -3.14159 : 3.14159 ] noreverse nowriteback
</span><span class='line'>set vrange [ -3.14159 : 3.14159 ] noreverse nowriteback
</span><span class='line'>splot cos(u)+.5*cos(u)*cos(v),sin(u)+.5*sin(u)*cos(v),.5*sin(v) with lines, \
</span><span class='line'>    1+cos(u)+.5*cos(u)*cos(v),.5*sin(v),sin(u)+.5*sin(u)*cos(v) with lines
</span></code></pre></td></tr></table></div></figure>


<p>そして、Gnuplot を起動後に呼び出してみる。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>gnuplot&gt; load &quot;gnuplot_sample.plt&quot;
</span></code></pre></td></tr></table></div></figure>


<p>もしくは、以下のように呼び出してみる。（<code>call</code> は <code>load</code> と異なり引数も渡せる）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>gnuplot&gt; call &quot;gnuplot_sample.plt&quot;
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://komasaru.github.io/images/2015/07/30/GNUPLOT_4.png" title="GNUPLOT_4" alt="GNUPLOT_4" /></p>

<p>ちなみに、３次元グラフの場合はマウスで視点を移動できる。</p>

<h4>3-4. 動作確認・その４</h4>

<p>前項の Gnuplot スクリプトをそのままシェルスクリプト(Bash)に記述し、それを実行してグラフを描画してみる。</p>

<figure class='code'><figcaption><span>gnuplot_sample.sh</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'>
</span><span class='line'>gnuplot -p <span class="s">&lt;&lt; EOS</span>
</span><span class='line'><span class="s">set terminal pngcairo enhanced font &quot;arial,10&quot; fontscale 1.0 size 500, 350</span>
</span><span class='line'><span class="s">set output &#39;gnuplot_sample.png&#39;</span>
</span><span class='line'><span class="s">set dummy u,v</span>
</span><span class='line'><span class="s">set key bmargin center horizontal Right noreverse enhanced autotitles nobox</span>
</span><span class='line'><span class="s">set parametric</span>
</span><span class='line'><span class="s">set view 50, 30, 1, 1</span>
</span><span class='line'><span class="s">set isosamples 50, 20</span>
</span><span class='line'><span class="s">set hidden3d back offset 1 trianglepattern 3 undefined 1 altdiagonal bentover</span>
</span><span class='line'><span class="s">set ticslevel 0</span>
</span><span class='line'><span class="s">set title &quot;Interlocking Tori&quot;</span>
</span><span class='line'><span class="s">set urange [ -3.14159 : 3.14159 ] noreverse nowriteback</span>
</span><span class='line'><span class="s">set vrange [ -3.14159 : 3.14159 ] noreverse nowriteback</span>
</span><span class='line'><span class="s">splot cos(u)+.5*cos(u)*cos(v),sin(u)+.5*sin(u)*cos(v),.5*sin(v) with lines, \</span>
</span><span class='line'><span class="s">    1+cos(u)+.5*cos(u)*cos(v),.5*sin(v),sin(u)+.5*sin(u)*cos(v) with lines</span>
</span><span class='line'><span class="s">EOS</span>
</span></code></pre></td></tr></table></div></figure>


<p>この &ldquo;gnuplot_sample.sh&rdquo; は以下のようにしてもよい。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/usr/bin/gnuplot -p</span>
</span><span class='line'>
</span><span class='line'><span class="nb">set </span>terminal pngcairo enhanced font <span class="s2">&quot;arial,10&quot;</span> fontscale 1.0 size 500, 350
</span><span class='line'><span class="nb">set </span>output <span class="s1">&#39;gnuplot_sample.png&#39;</span>
</span><span class='line'><span class="nb">set </span>dummy u,v
</span><span class='line'><span class="nb">set </span>key bmargin center horizontal Right noreverse enhanced autotitles nobox
</span><span class='line'><span class="nb">set </span>parametric
</span><span class='line'><span class="nb">set </span>view 50, 30, 1, 1
</span><span class='line'><span class="nb">set </span>isosamples 50, 20
</span><span class='line'><span class="nb">set </span>hidden3d back offset <span class="m">1</span> trianglepattern <span class="m">3</span> undefined <span class="m">1</span> altdiagonal bentover
</span><span class='line'><span class="nb">set </span>ticslevel 0
</span><span class='line'><span class="nb">set </span>title <span class="s2">&quot;Interlocking Tori&quot;</span>
</span><span class='line'><span class="nb">set </span>urange <span class="o">[</span> -3.14159 : 3.14159 <span class="o">]</span> noreverse nowriteback
</span><span class='line'><span class="nb">set </span>vrange <span class="o">[</span> -3.14159 : 3.14159 <span class="o">]</span> noreverse nowriteback
</span><span class='line'>splot cos<span class="o">(</span>u<span class="o">)</span>+.5*cos<span class="o">(</span>u<span class="o">)</span>*cos<span class="o">(</span>v<span class="o">)</span>,sin<span class="o">(</span>u<span class="o">)</span>+.5*sin<span class="o">(</span>u<span class="o">)</span>*cos<span class="o">(</span>v<span class="o">)</span>,.5*sin<span class="o">(</span>v<span class="o">)</span> with lines, <span class="se">\</span>
</span><span class='line'>    1+cos<span class="o">(</span>u<span class="o">)</span>+.5*cos<span class="o">(</span>u<span class="o">)</span>*cos<span class="o">(</span>v<span class="o">)</span>,.5*sin<span class="o">(</span>v<span class="o">)</span>,sin<span class="o">(</span>u<span class="o">)</span>+.5*sin<span class="o">(</span>u<span class="o">)</span>*cos<span class="o">(</span>v<span class="o">)</span> with lines
</span></code></pre></td></tr></table></div></figure>


<p>実行権限を付与して、実行。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ chmod +x gnuplot_sample.sh
</span><span class='line'>$ ./gnuplot_sample.sh
</span></code></pre></td></tr></table></div></figure>


<p>以下のような PNG 画像が作成される。</p>

<p><img src="http://komasaru.github.io/images/2015/07/30/GNUPLOT_SAMPLE.png" title="GNUPLOT_SAMPLE" alt="GNUPLOT_SAMPLE" /></p>

<h3>参考サイト</h3>

<ul>
<li><a href="http://www.gnuplot.info/" title="gnuplot homepage">gnuplot homepage</a></li>
</ul>


<hr />

<p>高機能な上に手軽に使用できるのが良いところでしょうか。</p>

<p>今回紹介した使用例はごく一部の機能に限定していましたが、使いこなすうちになれるでしょう。</p>

<p>また、統計解析用プログラミン言語 R でグラフを描画する場合と使い勝手等を比較してみたいとも思っています。</p>

<p>以上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[AMaViS - エラー(on Debian 8 Jessie)！]]></title>
    <link href="http://komasaru.github.io/blog/2015/07/27/debian-8-amavis-error/"/>
    <updated>2015-07-27T00:20:00+09:00</updated>
    <id>http://komasaru.github.io/blog/2015/07/27/debian-8-amavis-error</id>
    <content type="html"><![CDATA[<p>こんばんは。</p>

<p>Debian GNU/Linux 8 Jessie で Postfix と AMaViS を連携してメールのウイルスチェックを行うようにしているのですが、メールログにエラーメッセージが出力されていたので、調査して対策を施しました。</p>

<!--more-->


<h3>0. 前提条件</h3>

<ul>
<li>Debian GNU/Linux 8.1 Jessie での作業を想定。</li>
<li>アンチウィルスソフト ClamAV を「<a href="http://komasaru.github.io/2015/05/29/debian-8-anti-virus-installation/" title="Debian 8 (Jessie) - アンチウィルスソフト導入！">Debian 8 (Jessie) - アンチウィルスソフト導入！</a>」の方法でインストールしていることを想定。</li>
<li>SMTP サーバ Postfix を「<a href="http://komasaru.github.io/2015/06/12/debian-8-postfix-installation/" title="Debian 8 (Jessie) - SMTP サーバ Postfix 構築！">Debian 8 (Jessie) - SMTP サーバ Postfix 構築！</a>」の方法でインストールしていることを想定。</li>
<li>Postfix と ClamAV の連携を「<a href="http://komasaru.github.io/2015/06/15/debian-8-postfix-cooperation-with-clamav/" title="Debian 8 (Jessie) - Postfix と ClamAV の連携！">Debian 8 (Jessie) - Postfix と ClamAV の連携！</a>」の方法で行なっていることを想定。</li>
</ul>


<h3>1. 現象</h3>

<p>メールログに以下のようなエラーメッセージが出力される。</p>

<figure class='code'><figcaption><span>/var/log/mail.log</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>Jun  1 10:57:36 noah amavis[28256]: (28256-04-7) (!)run_av (ClamAV-clamd) FAILED - unexpected , output=&quot;/var/lib/amavis/tmp/amavis-20150601T105343-28256-JUnFx0XC/parts: lstat() failed: Permission denied. ERROR\n&quot;
</span><span class='line'>Jun  1 10:57:36 noah amavis[28256]: (28256-04-7) (!)ClamAV-clamd av-scanner FAILED: CODE(0x29c09b0) unexpected , output=&quot;/var/lib/amavis/tmp/amavis-20150601T105343-28256-JUnFx0XC/parts: lstat() failed: Permission denied. ERROR\n&quot; at (eval 96) line 905.
</span><span class='line'>Jun  1 10:57:36 noah amavis[28256]: (28256-04-7) (!)WARN: all primary virus scanners failed, considering backups
</span><span class='line'>Jun  1 10:57:36 noah amavis[28256]: (28256-04-7) (!)run_av (ClamAV-clamscan) FAILED - unexpected exit 2, output=&quot;WARNING: Ignoring unsupported option --recursive (-r)\nWARNING: Ignoring unsupported option --tempdir\n/var/lib/amavis/tmp/amavis-20150601T105343-28256-JUnFx0XC/parts: lstat() failed: Permission denied. ERROR&quot;
</span><span class='line'>Jun  1 10:57:36 noah amavis[28256]: (28256-04-7) (!)ClamAV-clamscan av-scanner FAILED: /usr/bin/clamdscan unexpected exit 2, output=&quot;WARNING: Ignoring unsupported option --recursive (-r)\nWARNING: Ignoring unsupported option --tempdir\n/var/lib/amavis/tmp/amavis-20150601T105343-28256-JUnFx0XC/parts: lstat() failed: Permission denied. ERROR&quot; at (eval 96) line 905.
</span><span class='line'>Jun  1 10:57:36 noah amavis[28256]: (28256-04-7) (!!)AV: ALL VIRUS SCANNERS FAILED
</span></code></pre></td></tr></table></div></figure>


<h3>2. 原因</h3>

<p>エラーメッセージに出ているとおり、権限がおかしい。</p>

<h3>3. 対策</h3>

<p>3-1 の方法はよくある方法だが、今回注目したかったのは 3-2 の方法。</p>

<h4>3-1. ユーザ ID, グループ ID の確認</h4>

<p><code>id</code> コマンドで clamav, amavis のユーザ ID, グループ ID を確認する。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'># id clamav
</span><span class='line'>uid=108(clamav) gid=113(clamav) groups=113(clamav),123(amavis)
</span><span class='line'>
</span><span class='line'># id amavis
</span><span class='line'>uid=115(amavis) gid=123(amavis) groups=123(amavis)
</span></code></pre></td></tr></table></div></figure>


<p>clamav ユーザが amavis グループに属していれば、それでよい。</p>

<p>clamav ユーザが amavis グループに属していなければ、以下のようにして amavis グループに追加する。（<code>-a</code> オプションは重要。このオプションを付け忘れると clamav ユーザが既に属していたグループから外れてしまう）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'># usermod -a -G amavis clamav
</span></code></pre></td></tr></table></div></figure>


<p>clamav ユーザを amavis グループに追加した場合は、 clamav-daemon, amavis, postfix を再起動する。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'># systemctl restart clamav-daemon
</span><span class='line'># systemctl restart amavis
</span><span class='line'># systemctl restart postfix
</span></code></pre></td></tr></table></div></figure>


<h4>3-2. clamd.conf の編集</h4>

<p>前項 3-1 の方法でもエラーが解消しない場合は、 ClamAV Daemon 設定ファイル &ldquo;clamd.conf&rdquo; の <code>AllowSupplementaryGroups</code> を確認してみる。</p>

<p><code>false</code> になっていた場合は <code>true</code>（グループ権限も移譲）に変更する。</p>

<figure class='code'><figcaption><span>/etc/clamav/clamd.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>AllowSupplementaryGroups <span class="nb">true</span>  <span class="c"># &lt;= false を true に変更</span>
</span></code></pre></td></tr></table></div></figure>


<p>そして、 clamav-daemon, amavis, postfix を再起動する。（起動順に注意すべき旨を紹介しているサイトもあるが、起動順が影響しているか否かは当方未確認）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'># systemctl restart clamav-daemon
</span><span class='line'># systemctl restart amavis
</span><span class='line'># systemctl restart postfix
</span></code></pre></td></tr></table></div></figure>


<hr />

<p>以上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ruby - Array クラス拡張で配列要素にランク付け（同順位考慮）！]]></title>
    <link href="http://komasaru.github.io/blog/2015/07/24/ruby-ranking-simultaneous-arrival-by-array-class/"/>
    <updated>2015-07-24T00:20:00+09:00</updated>
    <id>http://komasaru.github.io/blog/2015/07/24/ruby-ranking-simultaneous-arrival-by-array-class</id>
    <content type="html"><![CDATA[<p>こんばんは。</p>

<p>Ruby で配列内の数値をランク付け（同順位を考慮）する方法を、 Array クラスを拡張して実装してみました。</p>

<!--more-->


<h3>0. 前提条件</h3>

<ul>
<li>Ruby 2.2.2-p95 での作業を想定。</li>
<li>配列内の数値が大きい順に順位を付ける。</li>
<li>同順位を考慮する。（例：要素が 3, 1, 3, 2 で、大きい順に順位付ける場合の順位を 1, 4, 1, 3 とする）</li>
</ul>


<h3>1. Ruby スクリプトの作成</h3>

<p>実質、配列の順位付を行なっているのは１行のみで、数値が自分より大きい要素の個数 +1 を順位とするアルゴリズム。</p>

<figure class='code'><figcaption><span>array_rank.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#! /usr/local/bin/ruby</span>
</span><span class='line'><span class="c1"># coding: utf-8</span>
</span><span class='line'><span class="c1">#**********************************************************</span>
</span><span class='line'><span class="c1"># Ruby script to rank array items, considering same ranks.</span>
</span><span class='line'><span class="c1">#**********************************************************</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Array</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">rank</span>
</span><span class='line'>    <span class="c1"># 以下の場合は例外スロー</span>
</span><span class='line'>    <span class="c1"># - 自身配列が空</span>
</span><span class='line'>    <span class="c1"># - 自身配列に数値以外の値を含む</span>
</span><span class='line'>    <span class="k">raise</span> <span class="s2">&quot;Self array is nil!&quot;</span> <span class="k">if</span> <span class="nb">self</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span>
</span><span class='line'>      <span class="k">raise</span> <span class="s2">&quot;Items except numerical values exist!&quot;</span> <span class="k">unless</span> <span class="n">v</span><span class="o">.</span><span class="n">to_s</span> <span class="o">=~</span> <span class="sr">/[\d\.]+/</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># ランク付け</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="nb">self</span><span class="o">.</span><span class="n">count</span> <span class="p">{</span> <span class="o">|</span><span class="n">a</span><span class="o">|</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="n">v</span> <span class="p">}</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">a</span> <span class="o">=</span> <span class="o">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="o">]</span>
</span><span class='line'><span class="n">b</span> <span class="o">=</span> <span class="o">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="o">]</span>
</span><span class='line'><span class="n">c</span> <span class="o">=</span> <span class="o">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="o">.</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="o">.</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="o">.</span><span class="mi">2</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span>
</span><span class='line'><span class="n">d</span> <span class="o">=</span> <span class="o">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="s2">&quot;abc&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="o">]</span>
</span><span class='line'><span class="nb">puts</span> <span class="s2">&quot;a = </span><span class="si">#{</span><span class="n">a</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="nb">puts</span> <span class="s2">&quot;--&gt; </span><span class="si">#{</span><span class="n">a</span><span class="o">.</span><span class="n">rank</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="nb">puts</span>
</span><span class='line'><span class="nb">puts</span> <span class="s2">&quot;b = </span><span class="si">#{</span><span class="n">b</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="nb">puts</span> <span class="s2">&quot;--&gt; </span><span class="si">#{</span><span class="n">b</span><span class="o">.</span><span class="n">rank</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="nb">puts</span>
</span><span class='line'><span class="nb">puts</span> <span class="s2">&quot;c = </span><span class="si">#{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="nb">puts</span> <span class="s2">&quot;--&gt; </span><span class="si">#{</span><span class="n">c</span><span class="o">.</span><span class="n">rank</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="nb">puts</span>
</span><span class='line'><span class="nb">puts</span> <span class="s2">&quot;d = </span><span class="si">#{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="nb">puts</span> <span class="s2">&quot;--&gt; </span><span class="si">#{</span><span class="n">d</span><span class="o">.</span><span class="n">rank</span><span class="si">}</span><span class="s2">&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><a href="https://gist.github.com/komasaru/0a58f9027edbc148399e" title="Gist - Ruby script to rank array items, considering same ranks.">Gist - Ruby script to rank array items, considering same ranks.</a></li>
</ul>


<h3>2. Ruby スクリプトの実行</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ ./array_rank.rb
</span><span class='line'>a = [9, 3, 2, 7, 1, 6, 8, 5, 10, 4]
</span><span class='line'>--&gt; [2, 8, 9, 4, 10, 5, 3, 6, 1, 7]
</span><span class='line'>
</span><span class='line'>b = [6, 8, 5, 8, 4, 9, 3, 3, 7, 1]
</span><span class='line'>--&gt; [5, 2, 6, 2, 7, 1, 8, 8, 4, 10]
</span><span class='line'>
</span><span class='line'>c = [6, 8.5, 5, 3.2, 7, 1, 8.1, 3.2, 9, 3]
</span><span class='line'>--&gt; [5, 2, 6, 7, 4, 10, 3, 7, 1, 9]
</span><span class='line'>
</span><span class='line'>d = [9, 3, 2, 7, &quot;abc&quot;, 6, 8, 5, 10, 4]
</span><span class='line'>./array_rank.rb:14:in `block in rank&#39;: Exist items except numerical values! (RuntimeError)
</span><span class='line'>        from ./array_rank.rb:13:in `each&#39;
</span><span class='line'>        from ./array_rank.rb:13:in `rank&#39;
</span><span class='line'>        from ./array_rank.rb:33:in `&lt;main&gt;&#39;
</span></code></pre></td></tr></table></div></figure>


<hr />

<p>当方の場合、意外と利用頻度が高いので、単純な処理とは言えど結構重宝しています。</p>

<p>以上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Linux & Ruby - メール受信時の処理！]]></title>
    <link href="http://komasaru.github.io/blog/2015/07/21/linux-ruby-process-when-mail-received/"/>
    <updated>2015-07-21T00:20:00+09:00</updated>
    <id>http://komasaru.github.io/blog/2015/07/21/linux-ruby-process-when-mail-received</id>
    <content type="html"><![CDATA[<p>こんばんは。</p>

<p>Linux 上に構築したメールサーバで、メール受信をトリガにして処理を実行する手順等についての記録です。<br/>
処理は Ruby で行うことを想定しています。（多くのサイト等では Perl や PHP での処理がよく紹介されてます）</p>

<!--more-->


<h3>0. 前提条件</h3>

<ul>
<li>Debian GNU/Linux 8.1 での作業を想定。</li>
<li>Ruby 2.2.2-95 での作業を想定。</li>
<li>SMTP サーバ Postfix 構築済み。

<ul>
<li>参考「<a href="http://komasaru.github.io/2015/06/12/debian-8-postfix-installation/" title="Debian 8 (Jessie) - SMTP サーバ Postfix 構築！">Debian 8 (Jessie) - SMTP サーバ Postfix 構築！</a>」</li>
</ul>
</li>
<li>POP/IMAP サーバ Dovecot 構築済み。

<ul>
<li>参考「<a href="http://komasaru.github.io/2015/06/13/debian-8-dovecot-installation/" title="Debian 8 (Jessie) - POP/IMAP サーバ Dovecot 構築！">Debian 8 (Jessie) - POP/IMAP サーバ Dovecot 構築！</a>」</li>
</ul>
</li>
<li>Postfix の aliases （メール転送機能）と連携をとる方法を想定。</li>
<li>処理対象のユーザ・グループは &ldquo;test&rdquo;, &ldquo;test&rdquo; を想定。</li>
</ul>


<h3>1. Ruby スクリプトの作成</h3>

<p>以下のような Ruby スクリプトを作成する。<br/>
（紹介用に受信したメールを解析してテキストファイルに保存するだけのプログラム）</p>

<figure class='code'><figcaption><span>get_mail.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#! /usr/local/bin/ruby</span>
</span><span class='line'><span class="c1"># coding: utf-8</span>
</span><span class='line'><span class="c1">#-------------------------------------------------</span>
</span><span class='line'><span class="c1"># Ruby script to get a mail via alias of postfix.</span>
</span><span class='line'><span class="c1">#-------------------------------------------------</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;mail&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">GetMail</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span>
</span><span class='line'>    <span class="n">dt</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m%d_%H%M%S%L&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@out_file</span> <span class="o">=</span> <span class="s2">&quot;/path/to/</span><span class="si">#{</span><span class="n">dt</span><span class="si">}</span><span class="s2">.txt&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">execute</span>
</span><span class='line'>    <span class="nb">open</span><span class="p">(</span><span class="vi">@out_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</span><span class='line'>      <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vg">$stdin</span><span class="o">.</span><span class="n">read</span><span class="p">)</span>
</span><span class='line'>      <span class="n">f</span><span class="o">.</span><span class="n">puts</span> <span class="s2">&quot;From:    </span><span class="si">#{</span><span class="n">mail</span><span class="o">.</span><span class="n">from</span><span class="o">.</span><span class="n">first</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="n">f</span><span class="o">.</span><span class="n">puts</span> <span class="s2">&quot;To:      </span><span class="si">#{</span><span class="n">mail</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">first</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="n">f</span><span class="o">.</span><span class="n">puts</span> <span class="s2">&quot;Date:    </span><span class="si">#{</span><span class="n">mail</span><span class="o">.</span><span class="n">date</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="n">f</span><span class="o">.</span><span class="n">puts</span> <span class="s2">&quot;Subject: </span><span class="si">#{</span><span class="n">mail</span><span class="o">.</span><span class="n">subject</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="n">f</span><span class="o">.</span><span class="n">puts</span> <span class="s2">&quot;Body:</span><span class="se">\n</span><span class="si">#{</span><span class="n">mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">decoded</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">charset</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>    <span class="vg">$stderr</span><span class="o">.</span><span class="n">puts</span> <span class="s2">&quot;[</span><span class="si">#{</span><span class="n">e</span><span class="o">.</span><span class="n">class</span><span class="si">}</span><span class="s2">] </span><span class="si">#{</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="n">e</span><span class="o">.</span><span class="n">backtrace</span><span class="o">.</span><span class="n">each</span><span class="p">{</span><span class="o">|</span><span class="n">trace</span><span class="o">|</span> <span class="vg">$stderr</span><span class="o">.</span><span class="n">puts</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="si">#{</span><span class="n">trace</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
</span><span class='line'>    <span class="nb">exit</span> <span class="mi">1</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="nb">exit</span> <span class="k">unless</span> <span class="vg">$0</span> <span class="o">==</span> <span class="bp">__FILE__</span>
</span><span class='line'><span class="no">GetMail</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">execute</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><a href="https://gist.github.com/komasaru/0cbfe02794efa4c1a09e" title="Gist - Ruby script to get a mail via alias of postfix.">Gist - Ruby script to get a mail via alias of postfix.</a></li>
</ul>


<h3>2. Ruby スクリプトの配置</h3>

<p>作成した Ruby スクリプトをサーバ上の適当な位置に配置する。<br/>
（今回、当方は処理を行いたいユーザの home ディレクトリ &ldquo;/home/test&rdquo; 直下に配置した（所有者 &ldquo;test&rdquo; で））</p>

<p>配置後、実行権限を付与する。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'># chmod +x get_mail.rb
</span></code></pre></td></tr></table></div></figure>


<h3>3. メール保存用ディレクトリの作成</h3>

<p>今回の処理で使用するディレクトリをサーバ上の適当な位置に作成する。<br/>
（今回、当方は処理を行いたいユーザの home ディレクトリ &ldquo;/home/test&rdquo; 配下に &ldquo;get_mail&rdquo; ディレクトリを作成した（所有者 &ldquo;test&rdquo; で））</p>

<h3>4. Postfix の aliases 設定</h3>

<figure class='code'><figcaption><span>/etc/aliases</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">test</span>:  :include:/home/test/alias_inc
</span></code></pre></td></tr></table></div></figure>


<p>ちなみに、処理を行う他に転送も行いたい場合は、以下のようにカンマで区切ればよい。</p>

<figure class='code'><figcaption><span>/etc/aliases</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">test</span>:  hoge, :include:/home/test/alias_inc
</span></code></pre></td></tr></table></div></figure>


<h3>5. include ファイル（実行コマンド）の作成</h3>

<figure class='code'><figcaption><span>/home/test/alias_inc</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&quot;| /home/test/get_mail.rb&quot;
</span></code></pre></td></tr></table></div></figure>


<p>そして、このファイルの所有者が &ldquo;test&rdquo; でなければ &ldquo;test&rdquo; にする。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'># chown test. /home/test/alias_inc
</span></code></pre></td></tr></table></div></figure>


<h3>6. Postfix 設定ファイル main.cf の編集</h3>

<p>&ldquo;/etc/aliases&rdquo; ファイル内で <code>:include:</code> を使用する際は、Postfix の設定ファイル &ldquo;main.cf&rdquo; に以下のように追記しなければならない。<br/>
（Postfix は、デフォルトでは <code>:include:</code> での &ldquo;|command&rdquo; への配送を認めていないため）</p>

<figure class='code'><figcaption><span>/etc/postfix/main.cf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">allow_mail_to_commands</span> <span class="o">=</span> <span class="nb">alias</span>,forward,include
</span></code></pre></td></tr></table></div></figure>


<h3>7. Postfix 設定のリロード</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'># systemctl reload postfix
</span></code></pre></td></tr></table></div></figure>


<h3>8. aliases の設定反映</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'># newaliases
</span></code></pre></td></tr></table></div></figure>


<h3>9. 動作確認</h3>

<p>実際に test ユーザ宛にメールを送信してみて、指定のディレクトリ配下に保存されること、内容が適切であることを確認する。</p>

<h3>10. その他</h3>

<p>上記の 4, 5, 6 でエイリアスを別ファイルに分けてインクルードしている。<br/>
これは、"/etc/aliases" 内で直接コマンドを指定すると作成されるファイルの所有者・グループが &ldquo;nobody:nogroup&rdquo; になってしまうのを防ぐためである。</p>

<h3>11. 参考サイト</h3>

<ul>
<li><a href="http://www.postfix-jp.info/trans-2.3/jhtml/aliases.5.html" title="Postfix manual - aliases(5)">Postfix manual - aliases(5)</a></li>
</ul>


<hr />

<p>当方は、Linux サーバに Twitter ツイート専用のユーザを作成し、そのユーザ宛に配送されたメール本文をツイートするように応用しています。</p>

<p>以上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[MariaDB - レプリケーション設定（GTID 使用）！]]></title>
    <link href="http://komasaru.github.io/blog/2015/07/18/mariadb-replication-by-gtid/"/>
    <updated>2015-07-18T00:20:00+09:00</updated>
    <id>http://komasaru.github.io/blog/2015/07/18/mariadb-replication-by-gtid</id>
    <content type="html"><![CDATA[<p>こんばんは。</p>

<p>従来からあるレプリケーションとは異なる GTID(Global Transaction ID) を使用したレプリケーション設定の記録です。</p>

<p>MySQL とは実装自体が異なるため、MySQL と若干設定の異なる部分もあります。</p>

<!--more-->


<h3>0. 前提条件</h3>

<ul>
<li>Master 側、Slave 側ともに MariaDB 10.0.20 を想定。</li>
<li>Master 側は既存のサーバ、Slave 側は今回新規に構築したばかりのサーバを想定。<br/>
（Slave 側も既存のサーバの場合は、 &ldquo;ibdata1&rdquo;, &ldquo;ib_logfile0&rdquo;, &ldquo;ib_logfile1&rdquo; ファイルを削除(DISCARD)する作業が必要かも）</li>
<li>レプリケーション用のユーザは &ldquo;repl&rdquo; を想定。</li>
<li>ストレージエンジンは InnoDB を想定。</li>
<li>GTID(Global Transaction ID) がどんなものであるかは、ここでは説明しない。</li>
<li>以下の説明で出現する設定ファイルは、環境によりパスやファイル名が異なるかもしれないので、適宜置き換えること。</li>
</ul>


<h3>1. [Master] 設定ファイルの編集</h3>

<p>MariaDB 設定ファイル &ldquo;/etc/mysql/conf.d/mariadb.cnf&rdquo; を編集する。</p>

<figure class='code'><figcaption><span>/etc/mysql/conf.d/mariadb.cnf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>server-id <span class="o">=</span> <span class="m">1</span>           <span class="c"># &lt;= ネットワーク内で重複しないよに設定</span>
</span><span class='line'>log-bin <span class="o">=</span> mariadb-bin   <span class="c"># &lt;= バイナリログを設定（名前は任意）</span>
</span><span class='line'><span class="nb">bind</span>-address <span class="o">=</span> 0.0.0.0  <span class="c"># &lt;= 変更（Slave 側からもアクセスできるようにする）</span>
</span><span class='line'>                        <span class="c">#    もしくは、`::`</span>
</span><span class='line'>                        <span class="c">#    もしくは、コメントアウト</span>
</span></code></pre></td></tr></table></div></figure>


<h3>2. [Master] MariaDB サーバの再起動</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'># systemctl restart mysql
</span></code></pre></td></tr></table></div></figure>


<h3>3. [Master] レプリケーション用ユーザの作成</h3>

<p>MariaDB サーバに root でログインし、レプリケーション用（Slave 側から Master 側にログインするための）ユーザを作成する。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt; GRANT REPLICATION SLAVE ON *.* TO repl@&#39;Slave 側のホスト名 or IP アドレス&#39; IDENTIFIED BY &#39;repl のパスワード&#39;;
</span><span class='line'>&gt; FLUSH PRIVILEGES;
</span></code></pre></td></tr></table></div></figure>


<h3>4. [Master] DB ダンプファイルの出力</h3>

<p>全データベースのダンプファイルを出力する。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'># mysqldump -u root -p --all-databases --single-transaction --master-data=2 &gt; master.sql
</span></code></pre></td></tr></table></div></figure>


<p><code>--master-data=2</code> は、ダンプファイルに <code>-- CHANGE MASTER TO MASTER_LOG_FILE=...</code> を出力するオプション。</p>

<h3>5. [Master] GTID の取得</h3>

<p>前項で取得したダンプファイルの <code>-- CHANGE MASTER TO MASTER_LOG_FILE=...</code> を確認し、バイナリログファイル名とポジションを控える。（ダンプファイルのサイズが大きい場合は、テキストエディタで開くのに注意！）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'># head -n 30 master.sql | grep MASTER_LOG_FILE
</span><span class='line'>-- CHANGE MASTER TO MASTER_LOG_FILE=&#39;mariadb-bin.000009&#39;, MASTER_LOG_POS=330;
</span></code></pre></td></tr></table></div></figure>


<p>そして、MariaDB サーバに root でログイン後に以下を実行して GTID ポジションを取得し、控えておく。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>+--------------------------------------------+
</span><span class='line'>| BINLOG_GTID_POS(&#39;mariadb-bin.000009&#39;, 330) |
</span><span class='line'>+--------------------------------------------+
</span><span class='line'>| 0-2-10521                                  |
</span><span class='line'>+--------------------------------------------+
</span><span class='line'>1 row in set (0.03 sec)
</span></code></pre></td></tr></table></div></figure>


<h3>6. [Slave] DB ダンプファイルのリストア</h3>

<p>Master 側で出力した DB ダンプファイルを何かしらの方法で Slave 側へ移動し、リストアする。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'># mysql -u root -p &lt; master.sql
</span></code></pre></td></tr></table></div></figure>


<h3>7. [Slave] 設定ファイルの編集</h3>

<p>MariaDB 設定ファイル &ldquo;/etc/mysql/conf.d/mariadb.cnf&rdquo; を編集する。</p>

<figure class='code'><figcaption><span>/etc/mysql/conf.d/mariadb.cnf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>server-id = 2          # &lt;= ネットワーク内で重複しないように設定
</span><span class='line'>log-bin = mariadb-bin  # &lt;= バイナリログを設定（名前は任意）
</span></code></pre></td></tr></table></div></figure>


<h3>8. [Slave] MariaDB サーバの再起動</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'># systemctl restart mysql
</span></code></pre></td></tr></table></div></figure>


<h3>9. [Slave] レプリケーションの設定</h3>

<p>MariaDB サーバに root でログインし、以下のように実行する。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="o">&gt;</span> <span class="k">SET</span> <span class="k">GLOBAL</span> <span class="n">gtid_slave_pos</span> <span class="o">=</span> <span class="s1">&#39;0-2-10521&#39;</span><span class="p">;</span>  <span class="o">#</span> <span class="o">&lt;=</span> <span class="mi">3</span> <span class="err">で取得した</span> <span class="n">GTID</span> <span class="err">を指定</span>
</span><span class='line'><span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="k">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">32</span> <span class="n">sec</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="o">&gt;</span> <span class="n">CHANGE</span> <span class="n">MASTER</span> <span class="k">TO</span>
</span><span class='line'>    <span class="o">-&gt;</span> <span class="n">master_host</span> <span class="o">=</span> <span class="s1">&#39;Master 側のホスト名 or IPアドレス&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="o">-&gt;</span> <span class="n">master_user</span> <span class="o">=</span> <span class="s1">&#39;repl&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="o">-&gt;</span> <span class="n">master_password</span> <span class="o">=</span> <span class="s1">&#39;repl のパスワード&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="o">-&gt;</span> <span class="n">master_use_gtid</span> <span class="o">=</span> <span class="n">slave_pos</span><span class="p">;</span>
</span><span class='line'><span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="k">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">23</span> <span class="n">sec</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>10. [Slave] レプリケーションの開始</h3>

<p>続けて、以下のように実行する。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt; START SLAVE;
</span><span class='line'>Query OK, 0 rows affected (0.18 sec)
</span></code></pre></td></tr></table></div></figure>


<p>ちなみに、レプリケーションを停止するには、以下のように実行する。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt; STOP SLAVE;
</span></code></pre></td></tr></table></div></figure>


<p>ステータスは以下で確認できる。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt; SHOW SLAVE STATUS\G
</span></code></pre></td></tr></table></div></figure>


<h3>11. 動作確認</h3>

<p>Master 側への INSERT, UPDATE, DELETE 等が Slave 側にも反映されることを確認する。</p>

<h3>12. レプリケーションの完全停止設定</h3>

<p>レプリケーションの完全に停止（一時的な停止でなく、機能そのものを削除）するには、 Slave 側で以下を実行後に MariaDB サーバを再起動すればよい。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt; STOP SLAVE;
</span><span class='line'>&gt; RESET SLAVE ALL;
</span></code></pre></td></tr></table></div></figure>


<p>（<code>RESET SLAVE</code> だと HOST, USER, PASSWORD はリセットされない）</p>

<p>ちなみに、MySQL の古いバージョンだと、以下を実行後に MariaDB サーバを再起動すればよい。（当方、未確認）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt; STOP SLAVE;
</span><span class='line'>&gt; RESET SLAVE;
</span><span class='line'>&gt; CHANGE MASTER TO MASTER_HOST=&#39;&#39;;
</span></code></pre></td></tr></table></div></figure>


<p>また、このレプリケーション停止設定をしなければ、 <code>STOP SLAVE</code> をしても MariaDB サーバ再起動時に Slave が開始されてしまう。</p>

<h3>13. 参考サイト</h3>

<ul>
<li><a href="https://mariadb.com/kb/en/mariadb/standard-replication/" title="Standard Replication - MariaDB Knowledge Base">Standard Replication - MariaDB Knowledge Base</a></li>
</ul>


<hr />

<p>GTID を使用したレプリケーションにはメリット・デメリットがあります。<br/>
よく理解した上で運用すると、サーバ運用が効率化されるのではないでしょうか。</p>

<p>以上。</p>
]]></content>
  </entry>
  
</feed>
