<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[mk-mode BLOG]]></title>
  <link href="http://komasaru.github.io/atom.xml" rel="self"/>
  <link href="http://komasaru.github.io/"/>
  <updated>2015-11-01T00:35:03+09:00</updated>
  <id>http://komasaru.github.io/</id>
  <author>
    <name><![CDATA[mk-mode.com]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[2015年10月 - OS・ブラウザ別アクセス状況！【自動集計】]]></title>
    <link href="http://komasaru.github.io/blog/2015/11/01/blog-access/"/>
    <updated>2015-11-01T00:20:00+09:00</updated>
    <id>http://komasaru.github.io/blog/2015/11/01/blog-access</id>
    <content type="html"><![CDATA[<p>こんばんは。</p>

<p>11月になりましたので、先月10月分の当ブログアクセス状況を公開します。</p>

<!--more-->


<h4>1. アクセスをOS別に集計</h4>

<table class="blog-access">
  <tr>
    <th>OS</th>
    <th>PageViews</th>
    <th>比率(%)</th>
  </tr>
  <tr>
    <td>Mac OS</td>
    <td class="blog-access-pv">30,161</td>
    <td class="blog-access-rate">59.5021</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td class="blog-access-pv">16,941</td>
    <td class="blog-access-rate">33.4215</td>
  </tr>
  <tr>
    <td>Linux</td>
    <td class="blog-access-pv">1,758</td>
    <td class="blog-access-rate">3.4682</td>
  </tr>
  <tr>
    <td>Ubuntu Linux</td>
    <td class="blog-access-pv">1,289</td>
    <td class="blog-access-rate">2.5430</td>
  </tr>
  <tr>
    <td>unknown</td>
    <td class="blog-access-pv">342</td>
    <td class="blog-access-rate">0.6747</td>
  </tr>
  <tr>
    <td>Fedora Linux</td>
    <td class="blog-access-pv">81</td>
    <td class="blog-access-rate">0.1598</td>
  </tr>
  <tr>
    <td>Android</td>
    <td class="blog-access-pv">50</td>
    <td class="blog-access-rate">0.0986</td>
  </tr>
  <tr>
    <td>FreeBSD</td>
    <td class="blog-access-pv">42</td>
    <td class="blog-access-rate">0.0829</td>
  </tr>
  <tr>
    <td>iPhone OS</td>
    <td class="blog-access-pv">7</td>
    <td class="blog-access-rate">0.0138</td>
  </tr>
  <tr>
    <td>CentOS Linux</td>
    <td class="blog-access-pv">5</td>
    <td class="blog-access-rate">0.0099</td>
  </tr>
  <tr>
    <td>Solaris</td>
    <td class="blog-access-pv">5</td>
    <td class="blog-access-rate">0.0099</td>
  </tr>
  <tr>
    <td>RedHat Linux</td>
    <td class="blog-access-pv">4</td>
    <td class="blog-access-rate">0.0079</td>
  </tr>
  <tr>
    <td>Debian GNU/Linux</td>
    <td class="blog-access-pv">2</td>
    <td class="blog-access-rate">0.0039</td>
  </tr>
  <tr>
    <td>OpenBSD</td>
    <td class="blog-access-pv">2</td>
    <td class="blog-access-rate">0.0039</td>
  </tr>
  <tr>
    <td class="blog-access-total-label">合　計</td>
    <td class="blog-access-pv">50,689</td>
    <td class="blog-access-rate">100.0000</td>
  </tr>
</table>


<h4>2. アクセスをOS・バージョン別に集計（上位20件）</h4>

<table class="blog-access">
  <tr>
    <th>OS</th>
    <th>Version</th>
    <th>PageViews</th>
    <th>比率(%)</th>
  </tr>
  <tr>
    <td>Mac OS</td>
    <td>X</td>
    <td class="blog-access-pv">30,158</td>
    <td class="blog-access-rate">59.4961</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>NT</td>
    <td class="blog-access-pv">14,314</td>
    <td class="blog-access-rate">28.2389</td>
  </tr>
  <tr>
    <td>Linux</td>
    <td>unknown</td>
    <td class="blog-access-pv">1,735</td>
    <td class="blog-access-rate">3.4228</td>
  </tr>
  <tr>
    <td>Ubuntu Linux</td>
    <td>unknown</td>
    <td class="blog-access-pv">1,269</td>
    <td class="blog-access-rate">2.5035</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>7</td>
    <td class="blog-access-pv">1,232</td>
    <td class="blog-access-rate">2.4305</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>7 64 bit</td>
    <td class="blog-access-pv">788</td>
    <td class="blog-access-rate">1.5546</td>
  </tr>
  <tr>
    <td>unknown</td>
    <td>unknown</td>
    <td class="blog-access-pv">342</td>
    <td class="blog-access-rate">0.6747</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>XP</td>
    <td class="blog-access-pv">324</td>
    <td class="blog-access-rate">0.6392</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>Vista</td>
    <td class="blog-access-pv">194</td>
    <td class="blog-access-rate">0.3827</td>
  </tr>
  <tr>
    <td>Fedora Linux</td>
    <td>unknown</td>
    <td class="blog-access-pv">77</td>
    <td class="blog-access-rate">0.1519</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>8 64 bit</td>
    <td class="blog-access-pv">55</td>
    <td class="blog-access-rate">0.1085</td>
  </tr>
  <tr>
    <td>FreeBSD</td>
    <td>unknown</td>
    <td class="blog-access-pv">42</td>
    <td class="blog-access-rate">0.0829</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>Server 2003</td>
    <td class="blog-access-pv">18</td>
    <td class="blog-access-rate">0.0355</td>
  </tr>
  <tr>
    <td>Linux</td>
    <td></td>
    <td class="blog-access-pv">13</td>
    <td class="blog-access-rate">0.0256</td>
  </tr>
  <tr>
    <td>Android</td>
    <td>4.0.4</td>
    <td class="blog-access-pv">12</td>
    <td class="blog-access-rate">0.0237</td>
  </tr>
  <tr>
    <td>Ubuntu Linux</td>
    <td></td>
    <td class="blog-access-pv">12</td>
    <td class="blog-access-rate">0.0237</td>
  </tr>
  <tr>
    <td>Linux</td>
    <td>64 bit</td>
    <td class="blog-access-pv">10</td>
    <td class="blog-access-rate">0.0197</td>
  </tr>
  <tr>
    <td>Android</td>
    <td>4.0.1</td>
    <td class="blog-access-pv">10</td>
    <td class="blog-access-rate">0.0197</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>2000</td>
    <td class="blog-access-pv">8</td>
    <td class="blog-access-rate">0.0158</td>
  </tr>
  <tr>
    <td>Android</td>
    <td>2.3.4</td>
    <td class="blog-access-pv">7</td>
    <td class="blog-access-rate">0.0138</td>
  </tr>
  <tr>
    <td class="blog-access-dot">:</td>
    <td class="blog-access-dot">:</td>
    <td class="blog-access-dot">:</td>
    <td class="blog-access-dot">:</td>
  </tr>
  <tr>
    <td class="blog-access-total-label">合　計</td>
    <td> </td>
    <td class="blog-access-pv">50,689</td>
    <td class="blog-access-rate">100.0000</td>
  </tr>
</table>


<h4>3. アクセスをブラウザ別に集計</h4>

<table class="blog-access">
  <tr>
    <th>ブラウザ</th>
    <th>PageViews</th>
    <th>比率(%)</th>
  </tr>
  <tr>
    <td>Safari</td>
    <td class="blog-access-pv">29,168</td>
    <td class="blog-access-rate">57.5431</td>
  </tr>
  <tr>
    <td>Mozilla Firefox</td>
    <td class="blog-access-pv">12,131</td>
    <td class="blog-access-rate">23.9322</td>
  </tr>
  <tr>
    <td>Mozilla</td>
    <td class="blog-access-pv">5,428</td>
    <td class="blog-access-rate">10.7084</td>
  </tr>
  <tr>
    <td>Internet Explorer</td>
    <td class="blog-access-pv">2,945</td>
    <td class="blog-access-rate">5.8099</td>
  </tr>
  <tr>
    <td>Debian IceWeasel</td>
    <td class="blog-access-pv">446</td>
    <td class="blog-access-rate">0.8799</td>
  </tr>
  <tr>
    <td>Opera</td>
    <td class="blog-access-pv">404</td>
    <td class="blog-access-rate">0.7970</td>
  </tr>
  <tr>
    <td>Netscape Navigator</td>
    <td class="blog-access-pv">74</td>
    <td class="blog-access-rate">0.1460</td>
  </tr>
  <tr>
    <td>Chrome</td>
    <td class="blog-access-pv">51</td>
    <td class="blog-access-rate">0.1006</td>
  </tr>
  <tr>
    <td>Epiphany</td>
    <td class="blog-access-pv">13</td>
    <td class="blog-access-rate">0.0256</td>
  </tr>
  <tr>
    <td>Mozilla SeaMonkey</td>
    <td class="blog-access-pv">8</td>
    <td class="blog-access-rate">0.0158</td>
  </tr>
  <tr>
    <td>Konqueror</td>
    <td class="blog-access-pv">7</td>
    <td class="blog-access-rate">0.0138</td>
  </tr>
  <tr>
    <td>iPhone</td>
    <td class="blog-access-pv">7</td>
    <td class="blog-access-rate">0.0138</td>
  </tr>
  <tr>
    <td>unknown</td>
    <td class="blog-access-pv">3</td>
    <td class="blog-access-rate">0.0059</td>
  </tr>
  <tr>
    <td>PHP</td>
    <td class="blog-access-pv">2</td>
    <td class="blog-access-rate">0.0039</td>
  </tr>
  <tr>
    <td>Namoroka</td>
    <td class="blog-access-pv">1</td>
    <td class="blog-access-rate">0.0020</td>
  </tr>
  <tr>
    <td>SRWare Iron</td>
    <td class="blog-access-pv">1</td>
    <td class="blog-access-rate">0.0020</td>
  </tr>
  <tr>
    <td class="blog-access-total-label">合　計</td>
    <td class="blog-access-pv">50,689</td>
    <td class="blog-access-rate">100.0000</td>
  </tr>
</table>


<h4>4. アクセスをブラウザ・バージョン別に集計（上位20件）</h4>

<table class="blog-access">
  <tr>
    <th>ブラウザ</th>
    <th>Version</th>
    <th>PageViews</th>
    <th>比率(%)</th>
  </tr>
  <tr>
    <td>Safari</td>
    <td>537.36</td>
    <td class="blog-access-pv">21,898</td>
    <td class="blog-access-rate">43.2007</td>
  </tr>
  <tr>
    <td>Mozilla Firefox</td>
    <td>41.0</td>
    <td class="blog-access-pv">8,646</td>
    <td class="blog-access-rate">17.0570</td>
  </tr>
  <tr>
    <td>Mozilla</td>
    <td>11.0</td>
    <td class="blog-access-pv">5,428</td>
    <td class="blog-access-rate">10.7084</td>
  </tr>
  <tr>
    <td>Safari</td>
    <td>9537.53</td>
    <td class="blog-access-pv">3,172</td>
    <td class="blog-access-rate">6.2578</td>
  </tr>
  <tr>
    <td>Mozilla Firefox</td>
    <td>38.0</td>
    <td class="blog-access-pv">1,166</td>
    <td class="blog-access-rate">2.3003</td>
  </tr>
  <tr>
    <td>Internet Explorer</td>
    <td>8.0</td>
    <td class="blog-access-pv">1,047</td>
    <td class="blog-access-rate">2.0655</td>
  </tr>
  <tr>
    <td>Mozilla Firefox</td>
    <td>40.0</td>
    <td class="blog-access-pv">976</td>
    <td class="blog-access-rate">1.9255</td>
  </tr>
  <tr>
    <td>Safari</td>
    <td>600.1.4</td>
    <td class="blog-access-pv">931</td>
    <td class="blog-access-rate">1.8367</td>
  </tr>
  <tr>
    <td>Safari</td>
    <td>601.1</td>
    <td class="blog-access-pv">919</td>
    <td class="blog-access-rate">1.8130</td>
  </tr>
  <tr>
    <td>Safari</td>
    <td>601.1.56</td>
    <td class="blog-access-pv">779</td>
    <td class="blog-access-rate">1.5368</td>
  </tr>
  <tr>
    <td>Internet Explorer</td>
    <td>10.0</td>
    <td class="blog-access-pv">718</td>
    <td class="blog-access-rate">1.4165</td>
  </tr>
  <tr>
    <td>Internet Explorer</td>
    <td>9.0</td>
    <td class="blog-access-pv">656</td>
    <td class="blog-access-rate">1.2942</td>
  </tr>
  <tr>
    <td>Internet Explorer</td>
    <td>7.0</td>
    <td class="blog-access-pv">497</td>
    <td class="blog-access-rate">0.9805</td>
  </tr>
  <tr>
    <td>Opera</td>
    <td>9.80</td>
    <td class="blog-access-pv">398</td>
    <td class="blog-access-rate">0.7852</td>
  </tr>
  <tr>
    <td>Safari</td>
    <td>534.30</td>
    <td class="blog-access-pv">321</td>
    <td class="blog-access-rate">0.6333</td>
  </tr>
  <tr>
    <td>Safari</td>
    <td>601.2.7</td>
    <td class="blog-access-pv">285</td>
    <td class="blog-access-rate">0.5623</td>
  </tr>
  <tr>
    <td>Debian IceWeasel</td>
    <td>38.3.0</td>
    <td class="blog-access-pv">284</td>
    <td class="blog-access-rate">0.5603</td>
  </tr>
  <tr>
    <td>Safari</td>
    <td>600.8.9</td>
    <td class="blog-access-pv">215</td>
    <td class="blog-access-rate">0.4242</td>
  </tr>
  <tr>
    <td>Mozilla Firefox</td>
    <td>31.0</td>
    <td class="blog-access-pv">196</td>
    <td class="blog-access-rate">0.3867</td>
  </tr>
  <tr>
    <td>Mozilla Firefox</td>
    <td>39.0</td>
    <td class="blog-access-pv">148</td>
    <td class="blog-access-rate">0.2920</td>
  </tr>
  <tr>
    <td class="blog-access-dot">:</td>
    <td class="blog-access-dot">:</td>
    <td class="blog-access-dot">:</td>
    <td class="blog-access-dot">:</td>
  </tr>
  <tr>
    <td class="blog-access-total-label">合　計</td>
    <td> </td>
    <td class="blog-access-pv">50,689</td>
    <td class="blog-access-rate">100.0000</td>
  </tr>
</table>


<hr />

<p>以上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[MariaDB(MySQL) - データのみを指定件数ずつ分割ダンプ出力！]]></title>
    <link href="http://komasaru.github.io/blog/2015/10/26/mariadb-dump-only-data-by-split/"/>
    <updated>2015-10-26T00:20:00+09:00</updated>
    <id>http://komasaru.github.io/blog/2015/10/26/mariadb-dump-only-data-by-split</id>
    <content type="html"><![CDATA[<p>こんばんは。</p>

<p>MariaDB(MySQL) の指定したデータベースを、テーブル別にデータのみを指定件数ずつ分割してダンプ出力する方法についてです。</p>

<!--more-->


<h3>0. 前提条件</h3>

<ul>
<li>Linux Mint 17.2(64bit) での作業を想定。</li>
<li>MariaDB 10.0.21 サーバでの作業を想定。（MySQL や他のバージョンでも同様（のはず））</li>
<li>Bash スクリプトを作成して実現させる。</li>
<li>出力されたダンプファイルはまとめて圧縮保存する。</li>
<li>必要であれば、「<a href="http://komasaru.github.io/2014/06/15/mysql-dump-only-schema-data-stored/" title="MySQL(MariaDB) - スキーマのみ、データのみ、ストアド・トリガーのみのダンプ！">MySQL(MariaDB) - スキーマのみ、データのみ、ストアド・トリガーのみのダンプ！</a>」も参考にしてください。</li>
<li>以下で紹介する Bash スクリプトでは、トランザクションの単位がテーブル・ループ単位となるため、<strong>データの整合性に注意</strong>。<br/>
（<strong>ダンプ出力時やリストア時に DB への挿入・更新・削除がないことが前提</strong>）</li>
</ul>


<h3>1. Bash スクリプトの作成</h3>

<p>以下は、当方がデータのみを分割ダンプ出力する際に使用している Bash スクリプトである。（解説はスクリプト内のコメントにて。 <code>(*)</code> はさらなる説明を後述）</p>

<figure class='code'><figcaption><span>db_dump_only_data_by_split.sh</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'>
</span><span class='line'><span class="c"># 定数定義</span>
</span><span class='line'><span class="nv">DB</span><span class="o">=</span>db_name                      <span class="c"># データベース・スキーマ名</span>
</span><span class='line'><span class="nv">USER</span><span class="o">=</span>user_name                  <span class="c"># ダンプ出力するユーザ名</span>
</span><span class='line'><span class="nv">PW</span><span class="o">=</span>user_password                <span class="c">#       〃      ユーザ名のパスワード</span>
</span><span class='line'><span class="nv">CMD</span><span class="o">=</span>/usr/bin/mysqldump          <span class="c"># mysqldump コマンドのフルパス</span>
</span><span class='line'><span class="nv">WK_DIR</span><span class="o">=</span>/path/to/backup_mysql    <span class="c"># 作業ディレクトリ</span>
</span><span class='line'><span class="nv">DMP_DIR</span><span class="o">=</span><span class="nv">$WK_DIR</span>/tabledatas_<span class="nv">$DB</span>  <span class="c"># ダンプファイル格納ディレクトリ</span>
</span><span class='line'><span class="nv">OPTS</span><span class="o">=</span><span class="s2">&quot;-t -Q -F --skip-lock-tables --skip-triggers --skip-dump-date --single-transaction&quot;</span>
</span><span class='line'>                                <span class="c"># mysqldump オプション(*)</span>
</span><span class='line'><span class="nv">DCNT</span><span class="o">=</span><span class="m">100000</span>                     <span class="c"># 分割するレコード件数</span>
</span><span class='line'>
</span><span class='line'><span class="c"># ダンプファイルクリア</span>
</span><span class='line'>rm -f <span class="nv">$DMP_DIR</span>/*
</span><span class='line'>
</span><span class='line'><span class="c"># DB 内に存在するテーブル毎にループ処理</span>
</span><span class='line'><span class="k">for</span> tbl in <span class="sb">`</span>mysql -u <span class="nv">$USER</span> -p<span class="nv">$PW</span> -N -s -e <span class="s2">&quot;show tables in $DB;&quot;</span><span class="sb">`</span><span class="p">;</span> <span class="k">do</span>
</span><span class='line'>  <span class="c"># テーブル内に存在するレコード件数(*)</span>
</span><span class='line'>  <span class="nv">rows</span><span class="o">=</span><span class="sb">`</span>mysql -u <span class="nv">$USER</span> -p<span class="nv">$PW</span> <span class="nv">$DB</span> -N -B -e <span class="s2">&quot;SELECT COUNT(*) FROM $tbl;&quot;</span><span class="sb">`</span>
</span><span class='line'>  <span class="nb">echo</span> <span class="s2">&quot;* $tbl [$rows records]&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># レコード件数から分割数を算出してループ処理</span>
</span><span class='line'>  <span class="k">for</span> <span class="o">((</span><span class="nv">i</span> <span class="o">=</span> 0<span class="p">;</span> i &lt;<span class="o">=</span> <span class="k">$((</span><span class="nv">$rows</span> <span class="o">/</span> <span class="nv">$DCNT</span><span class="k">))</span><span class="p">;</span> i++<span class="o">))</span>
</span><span class='line'>  <span class="k">do</span>
</span><span class='line'>    <span class="c"># 出力ダンプファイル名</span>
</span><span class='line'>    <span class="nv">fname</span><span class="o">=</span><span class="k">$(</span><span class="nb">printf</span> <span class="k">${</span><span class="nv">tbl</span><span class="k">}</span>_%02d <span class="nv">$i</span><span class="k">)</span>
</span><span class='line'>    <span class="c"># オフセット算出</span>
</span><span class='line'>    <span class="nv">offset</span><span class="o">=</span><span class="k">$((</span>i <span class="o">*</span> <span class="nv">$DCNT</span><span class="k">))</span>
</span><span class='line'>    <span class="nb">echo</span> <span class="s2">&quot;  $fname [OFFSET: $offset]&quot;</span>
</span><span class='line'>    <span class="c"># ダンプ出力(*)</span>
</span><span class='line'>    <span class="nv">$CMD</span> -u <span class="nv">$USER</span> -p<span class="nv">$PW</span> <span class="nv">$DB</span> <span class="nv">$tbl</span> <span class="nv">$OPTS</span> -w <span class="s2">&quot;true LIMIT $offset, $DCNT&quot;</span>&gt; <span class="nv">$DMP_DIR</span>/<span class="nv">$fname</span>.sql
</span><span class='line'>  <span class="k">done</span><span class="p">;</span>
</span><span class='line'><span class="k">done</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># タイムスタンプ付ファイル名で圧縮保存</span>
</span><span class='line'><span class="nb">cd</span> <span class="nv">$WK_DIR</span>
</span><span class='line'><span class="nv">dt</span><span class="o">=</span><span class="sb">`</span>date <span class="s1">&#39;+%Y%m%d_%H%M%S&#39;</span><span class="sb">`</span>
</span><span class='line'>tar zcvf <span class="k">${</span><span class="nv">DB</span><span class="k">}</span>_tabledata_<span class="nv">$dt</span>.tar.gz tabledatas_<span class="nv">$DB</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><a href="https://gist.github.com/komasaru/d9cae95bf4d30da5545b" title="Gist - Bash script to dump only records of MariaDB(MySQL) tables by split.">Gist - Bash script to dump only records of MariaDB(MySQL) tables by split.</a></li>
</ul>


<p>mysqldump オプション（上記の<code>OPTS</code>）について。（mysqldump のデフォルトで有効のオプション <code>--opt</code> とは別のもの）</p>

<ul>
<li><code>-t</code>(or <code>--no-create-info</code>) &hellip; テーブル作成（CREATE TABLE）文を出力しないオプション。</li>
<li><code>-Q</code>(or <code>--quote-names</code>) &hellip; データベース名、テーブル名、カラム名を <code>`</code> で囲むオプション（デフォルトで有効）。</li>
<li><code>-F</code>(or <code>--flush-logs</code>) &hellip; ダンプ開始前にログファイルをフラッシュするオプション。</li>
<li><code>--skip-lock-tables</code> &hellip; デフォルトで有効になる全テーブルをロックするオプション <code>--lock-tables</code> を無効にするオプション。</li>
<li><code>--skip-triggers</code> &hellip; trigger のダンプ出力を無効にするオプション。</li>
<li><code>--skip-dump-date</code> &hellip; ダンプ日時の出力を無効にするオプション。</li>
<li><code>--single-transaction</code> &hellip; データの整合性を保つためにダンプ処理をトランザクションで囲むオプション。</li>
<li>ちなみに、主キーでソートせずに LIMIT(OFFSET) 句を使用するとフルスキャンになってしまうからと、 <code>--order-by-primary</code> という主キーでソートするオプションを使用すると、 Syntax error が発生しまう。従って、今回は使用していない。<br/>
主キーでソートしたければ、 <code>-w</code> オプションの <code>LIMIT</code> 句の前に <code>ORDER BY primary_key_col</code> のように追加する。（但し、今回紹介のケースでは DB 内全テーブルの主キーが同じカラムである必要がある）</li>
</ul>


<p>レコード件数取得について。</p>

<ul>
<li>上記では <code>SELECT COUNT(*) ...</code> としているが、データベース内の全テーブルに同じカラム名で主キーが設定してあるのなら <code>SELECT COUNT(col_name) ...</code> とした方がよい。</li>
</ul>


<p><code>OPTS</code> 以外に追加している <code>-w</code>(or <code>--where</code>) オプションについて。（<strong>今回のポイント</strong>）</p>

<ul>
<li>本来 <code>-w</code> は抽出条件を指定するオプションだが、 WHERE 条件は <code>true</code>（もしくは <code>1</code>） でスルーして <code>LIMIT</code> 句を指定している。<br/>
（mysqldump に LIMIT(OFFSET) 句を指定するオプションが存在しないため）</li>
<li><code>-w "true LIMIT $offset, $DCNT"</code> は <code>-w "true LIMIT $DCNT OFFSET $offset"</code> としてもよい。</li>
<li>主キーやユニークインデックスが歯抜けでなく件数が正確に取得できるのであれば、 <code>-w</code> オプションで LIMIT 句や OFFSET 句を指定せずに普通に条件指定するようにしてもよいだろう。</li>
</ul>


<h3>2. Bash スクリプトの実行</h3>

<p>作業用ディレクトリやダンプファイル格納用サブディレクトリが存在することを確認し、実行権限を付与後に実行する。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ chmod +x db_dump_only_data_by_split.sh
</span><span class='line'>$ ./db_dump_only_data_by_split.sh
</span></code></pre></td></tr></table></div></figure>


<p>作業ディレクトリ内のダンプファイル格納用サブディレクトリにダンプファイルが出力され、作業ディレクトリ内にタイムスタンプ付圧縮ファイルが作成されるのを確認する。</p>

<p>また、 LIMIT 句を使用しているのでダンプ出力完了まで時間がかかることを覚悟すること。</p>

<h3>3. その他</h3>

<ul>
<li>データ量が多すぎるとダンプ出力に時間がかかる、ということに留意する。<br/>
<code>-w</code> オプションで LIMIT 句を使用するからと、フルスキャンを避けるために <code>--order-by-primary</code> オプションを使用したり、もしくは <code>-w</code> オプションで <code>ORDER BY</code> 句を指定しても、ダンプ出力が徐々に遅くなる。<br/>
<code>mysqldump</code> の <code>-w</code>(or <code>--where</code>) での LIMIT(OFFSET) 句指定はフルスキャンになってしまうのだろうか？（<code>mysqldump</code> を EXPLAIN で確認できればいいのですが。。。）</li>
<li>データ量が多すぎるとダンプ出力に時間がかかるため、結局当方は、データ量が多すぎる場合は、エクスポートは <code>SELECT INTO ... OUTFILE</code> で CSV 出力、インポートは <code>LOAD DATA INFILE</code> で CSV 取り込み、とすることにした。以下の過去記事を参照。

<ul>
<li><a href="http://komasaru.github.io/2011/08/31/31002049/" title="MySQL - SELECT結果をCSV出力！">MySQL - SELECT結果をCSV出力！</a></li>
<li><a href="http://komasaru.github.io/2013/06/08/mysql-import-from-csv/" title="MySQL - CSV データインポート！">MySQL - CSV データインポート！</a></li>
</ul>
</li>
</ul>


<h3>4. 参考サイト</h3>

<p>mysqldump の各種オプションや LIMIT 句の指定方法については以下のサイトを参照。</p>

<ul>
<li><a href="https://dev.mysql.com/doc/refman/5.6/en/mysqldump.html" title="MySQL :: MySQL 5.6 Reference Manual :: 4.5.4 mysqldump — A Database Backup Program">MySQL :: MySQL 5.6 Reference Manual :: 4.5.4 mysqldump — A Database Backup Program</a></li>
</ul>


<hr />

<p>結局、当方は今回紹介した方法を積極的には使用していませんが、こういうやり方もあるということを覚えておくと何かの際に役立つかもしれません。</p>

<p>以上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Linux - スワップ領域の作成！]]></title>
    <link href="http://komasaru.github.io/blog/2015/10/20/linux-create-swap-area/"/>
    <updated>2015-10-20T00:20:00+09:00</updated>
    <id>http://komasaru.github.io/blog/2015/10/20/linux-create-swap-area</id>
    <content type="html"><![CDATA[<p>こんばんは。</p>

<p>スワップ領域の容量が不足した際に追加で作成する方法についてです。</p>

<p>本来なら物理メモリを増設すべきでしょうが、それまでの緊急的な措置としてスワップファイルを作成してそれをスワップ領域に割り当てるのです。</p>

<!--more-->


<h3>0. 前提条件</h3>

<ul>
<li>CentOS 6.6(32bit) での作業を想定。（他のディストリビューションでも同じ）</li>
</ul>


<h3>1. スワップファイルの作成</h3>

<p>以下は、ブロックサイズ 1KB で 2GB(1024 x 1024 x 2ブロック) のスワップ領域用のファイルを作成する例。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'># dd if=/dev/zero of=/var/tmp/swap bs=1024 count=2097152
</span><span class='line'>2097152+0 records in
</span><span class='line'>2097152+0 records out
</span><span class='line'>2147483648 bytes (2.1 GB) copied, 74.8475 s, 28.7 MB/s
</span></code></pre></td></tr></table></div></figure>


<h3>2. スワップ領域の作成</h3>

<p>先ほど作成したスワップファイルをスワップ領域に割り当てる。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'># mkswap /var/tmp/swap
</span><span class='line'>mkswap: /var/tmp/swap: warning: don&#39;t erase bootbits sectors
</span><span class='line'>        on whole disk. Use -f to force.
</span><span class='line'>スワップ空間バージョン1を設定します、サイズ = 2097148 KiB
</span><span class='line'>ラベルはありません, UUID=1a802279-4f23-4466-8579-fa38a2cc4d5a
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>スワップ領域を作成する前にデバイスの不良ブロックのチェックを行いたい場合は、 <code>-c</code> オプションを使用する。<br/>
（不良ブロックを検出した場合は、その件数が出力される）</li>
<li>スワップファイルにラベルを指定する（ラベル指定でスワップ領域の有効化したい）場合は、 <code>-L</code> オプションで指定する。</li>
</ul>


<h3>3. スワップ領域の有効化</h3>

<p>先ほど作成したスワップ領域を有効化する。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'># swapon /var/tmp/swap
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>当然ながら、スワップファイルではなくパーティションを指定することも可能。</li>
<li>スワップファイル名でなくラベルで指定することも可能。</li>
<li>優先度を指定したければ、 <code>-p priority</code> で指定する。 <code>priority</code> は 0 〜 32767 の数値で、大きいほど優先度が高い。</li>
<li>同じ優先度のスワップ領域が複数ある場合、ページがラウンド・ロビン方式で配分される。</li>
</ul>


<h3>4. スワップ領域の確認</h3>

<p>スワップ領域の一覧を確認するには以下のようにする。（以下は一例）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'># swapon -s
</span><span class='line'>Filename                                Type            Size    Used    Priority
</span><span class='line'>/dev/sda2                               partition       2097148 766580  -1
</span><span class='line'>/var/tmp/swap                           file            2097148 0       -2
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>優先度を指定しない場合、自動で既存スワップ領域で最低の優先度に続く優先度になるのではなかろうか。</li>
</ul>


<h3>5. スワップ領域の削除</h3>

<p>スワップが不要になった場合は以下のようにして削除する。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'># swapoff /var/tmp/swap
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>当然ながら、スワップファイルではなくパーティションを指定することも可能。</li>
<li>スワップファイル名でなくラベルで指定することも可能。</li>
</ul>


<h3>6. スワップファイルの削除</h3>

<p>完全にスワップ領域が不要なら、スワップファイルも削除する。（単純なファイル削除）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'># rm -f /var/tmp/swap
</span></code></pre></td></tr></table></div></figure>


<h3>7. 自動マウント</h3>

<p>マシン起動時に自動でスワップ領域を有効化したい場合は、 &ldquo;/etc/fstab&rdquo; に以下のように追記する。</p>

<figure class='code'><figcaption><span>/etc/fstab</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>/var/tmp/swap         swap    swap    sw    0 0
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>1列目 &hellip; デバイス名・スワップファイル名</li>
<li>2列目 &hellip; マウントポイント（スワップ領域にはマウントポイントがないので <code>none</code> でもよい）</li>
<li>3列目 &hellip; ファイルシステム</li>
<li>4列目 &hellip; マウント時のオプション（<code>defaults</code> でもよい。優先度を指定するなら <code>sw,pri=X</code>（<code>X</code> は <code>0</code> 〜 <code>32767</code> の数値））</li>
<li>5列目 &hellip; ファイルシステムを dump する必要があるか否かの指定（<code>0</code> は dump の必要なし）</li>
<li>6列目 &hellip; システム起動時に fsck チェックを行うか否かの指定（<code>0</code> は fsck チェックを行わない）</li>
</ul>


<hr />

<p>これで取り急ぎのスワップ領域拡大ができますが、この間に物理メモリ増設について検討しましょう。</p>

<p>以上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Linux Mint - apt-get update で GPG 公開鍵エラー！]]></title>
    <link href="http://komasaru.github.io/blog/2015/10/14/linux-mint-apt-gpg-pubkey-error/"/>
    <updated>2015-10-14T00:20:00+09:00</updated>
    <id>http://komasaru.github.io/blog/2015/10/14/linux-mint-apt-gpg-pubkey-error</id>
    <content type="html"><![CDATA[<p>こんばんは。</p>

<p>Linux Mint で、いつしか Apt パッケージの一覧を更新しようとすると GPG 公開鍵エラーが発生するようになりました。</p>

<p>以下、現象・原因・対策についての備忘録です。</p>

<!--more-->


<h3>0. 前提条件</h3>

<ul>
<li>Linux Mint 17.2(64bit) を想定。</li>
</ul>


<h3>1. 現象</h3>

<p>Apt パッケージ一覧をアップデートした際に以下のようなエラーが発生する。（<code>W</code> なので分類としては「警告」でしょうが）<br/>
（以下は QGIS というパッケージの部分で発生した例で、実際のメッセージは１行）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ sudo apt-get update
</span><span class='line'>
</span><span class='line'>====&lt; 途中省略 &gt;====
</span><span class='line'>
</span><span class='line'>W: GPG エラー: http://qgis.org trusty InRelease:
</span><span class='line'>公開鍵を利用できないため、以下の署名は検証できませんでした: NO_PUBKEY 3FF5FFCAD71472C4
</span><span class='line'>
</span><span class='line'>====&lt; 以下省略 &gt;====
</span></code></pre></td></tr></table></div></figure>


<p>当然ながら、アップデートマネージャでも同じエラーが発生する。</p>

<h3>2. 原因</h3>

<p>メッセージのとおり、GPG 署名の検証に必要な公開鍵が存在しないため。</p>

<h3>3. 対策</h3>

<p>キーサーバに問い合わせればよい。（<code>--recv-keys</code> の値は、エラーメッセージ中 <code>NO_PUBKEY</code> の後ろの値）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 3FF5FFCAD71472C4
</span><span class='line'>Executing: gpg --ignore-time-conflict --no-options --no-default-keyring --homedir /tmp/tmp.Wv6W1dQY2n --no-auto-check-trustdb --trust-model always --keyring /etc/apt/trusted.gpg --primary-keyring /etc/apt/trusted.gpg --keyserver keyserver.ubuntu.com --recv-keys 3FF5FFCAD71472C4
</span><span class='line'>gpg: 鍵D71472C4をhkpからサーバーkeyserver.ubuntu.comに要求
</span><span class='line'>gpg: 鍵D71472C4: 公開鍵“QGIS Archive Automatic Signing Key (2015) &lt;qgis-developer@lists.osgeo.org&gt;”を読み込みました
</span><span class='line'>gpg: 処理数の合計: 1
</span><span class='line'>gpg:               読込み: 1  (RSA: 1)
</span></code></pre></td></tr></table></div></figure>


<p>再度 <code>apt-get update</code> でエラーが発生しないことを確認する。</p>

<hr />

<p>稀に遭遇するエラーなので備忘録として残しておいた次第です。</p>

<p>以上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Linux - メモリキャッシュのクリア！]]></title>
    <link href="http://komasaru.github.io/blog/2015/10/09/linux-release-memory-caches/"/>
    <updated>2015-10-09T00:20:00+09:00</updated>
    <id>http://komasaru.github.io/blog/2015/10/09/linux-release-memory-caches</id>
    <content type="html"><![CDATA[<p>こんばんは。</p>

<p>Linux でメモリキャッシュをクリアすることについての備忘録です。</p>

<!--more-->


<h3>0. 前提条件</h3>

<ul>
<li>Linux Kernel 2.6.16 以降であること。</li>
<li>当方は Linux Mint 17.2(64bit), 搭載メモリ:4GB の環境で動作確認。</li>
</ul>


<h3>1. キャッシュの削除方法</h3>

<p>以下のコマンドは、 root になって実行するか <code>sudo</code> を使用して実行する。</p>

<h4>1-1. ページキャッシュの解放</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'># sysctl -w vm.drop_caches=1
</span></code></pre></td></tr></table></div></figure>


<p>もしくは、</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'># echo 1 &gt; /proc/sys/vm/drop_caches
</span></code></pre></td></tr></table></div></figure>


<h4>1-2. Slab キャッシュの解放</h4>

<p>（Slab キャッシュとは、ディレクトリやファイルのメタデータ情報を格納する dentry や inode のこと）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'># sysctl -w vm.drop_caches=2
</span></code></pre></td></tr></table></div></figure>


<p>もしくは、</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'># echo 2 &gt; /proc/sys/vm/drop_caches
</span></code></pre></td></tr></table></div></figure>


<h4>1-3. ページキャッシュと Slab キャッシュの解放</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'># sysctl -w vm.drop_caches=3
</span></code></pre></td></tr></table></div></figure>


<p>もしくは、</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'># echo 3 &gt; /proc/sys/vm/drop_caches
</span></code></pre></td></tr></table></div></figure>


<h4>1-4. 初期状態について</h4>

<p>あらゆる Web サイト等で「初期状態に戻すには <code>0</code> を設定する」旨の紹介がされている。<br/>
しかし、 RedHat 系では機能するが Debian 系では機能しない。（<code>sysctl</code> も <code>echo</code> も）</p>

<p><code>vm.drop_caches</code> についての説明は <code>man proc</code> で確認できるが、 Debian 系も RedHat 系も <code>0</code> についての説明がされていない。</p>

<p>従って、初期状態には戻す必要はないという結論に至った。（あくまで、個人の判断）<br/>
（とは言え、 <code>cat /proc/sys/vm/drop_caches</code> の値が、マシンを再起動するまでずっと <code>0</code> 以外の状態でいることに疑問を感じる）</p>

<h3>2. 作業の実際</h3>

<p>実際の作業手順は以下のようになる。</p>

<ol>
<li>キャッシュクリア前のメモリ状態を確認。</li>
<li>バッファの内容をディスクに書き込む。</li>
<li>キャッシュをクリア。</li>
<li>キャッシュクリア後のメモリ状態を確認。</li>
</ol>


<p>以下は、ページキャッシュと Slab キャッシュを解放する例。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'># free
</span><span class='line'>             total       used       free     shared    buffers     cached
</span><span class='line'>Mem:       4047488    3887116     160372     155764     247452    1104336
</span><span class='line'>-/+ buffers/cache:    2535328    1512160
</span><span class='line'>Swap:      8000508     557132    7443376
</span><span class='line'>
</span><span class='line'># sync
</span><span class='line'>
</span><span class='line'># sysctl -w vm.drop_caches=3
</span><span class='line'>vm.drop_caches = 3
</span><span class='line'>
</span><span class='line'># free
</span><span class='line'>             total       used       free     shared    buffers     cached
</span><span class='line'>Mem:       4047488    2415508    1631980     155764       9856     324056
</span><span class='line'>-/+ buffers/cache:    2081596    1965892
</span><span class='line'>Swap:      8000508     557124    7443384
</span></code></pre></td></tr></table></div></figure>


<p>物理メモリの空き容量(Mem - free の値）が増えたことを確認する。</p>

<h3>3. 参考サイト</h3>

<ul>
<li><a href="http://linuxjm.osdn.jp/html/LDP_man-pages/man5/proc.5.html" title="Man page of PROC">Man page of PROC</a></li>
</ul>


<hr />

<p>物理メモリの空き容量の減りが気になったら試してみるといいでしょう。</p>

<p>以上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Linux - マルチコア CPU で高速圧縮！]]></title>
    <link href="http://komasaru.github.io/blog/2015/10/03/linux-archive-speed-up-on-multi-core-cpu/"/>
    <updated>2015-10-03T00:20:00+09:00</updated>
    <id>http://komasaru.github.io/blog/2015/10/03/linux-archive-speed-up-on-multi-core-cpu</id>
    <content type="html"><![CDATA[<p>こんばんは。</p>

<p>通常、 Linux の <code>tar</code> コマンドでファイル等の圧縮を行う場合、 CPU コアを１つしか使用しません。</p>

<p>２つ以上 CPU コアを搭載していることの多い昨今、 CPU コアを全て使用して圧縮を行うと時間の節約になります。</p>

<p>今回、圧縮・解凍をマルチコアで並列に処理してくれる <code>pigz</code> を使用してみました。</p>

<!--more-->


<h3>0.前提条件</h3>

<ul>
<li>Linux Mint 17.2(64bit) での作業を想定。</li>
<li>Intel Core2Duo CPU E8500 (3.16GHz x 2) での作業を想定。</li>
</ul>


<h3>1. pigz のインストール</h3>

<p>Apt パッケージを使用する（但し、最新版ではない可能性が高い）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ sudo apt-get install pigz
</span></code></pre></td></tr></table></div></figure>


<p>もしくは、最新版アーカイブを取得＆展開後、 <code>make</code> して適当な位置に配置してもよい。（但し、当方の環境ではビルドエラーになった）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ wget http://zlib.net/pigz/pigz-2.3.3.tar.gz
</span><span class='line'>$ tar zxvf pigz-2.3.3.tar.gz
</span><span class='line'>$ cd pigz-2.3.3
</span><span class='line'>$ make
</span><span class='line'>$ sudo mv ./pigz /usr/local/bin/pigz
</span><span class='line'>$ sudo mv ./unpigz /usr/local/bin/unpigz
</span></code></pre></td></tr></table></div></figure>


<h3>2. pigz インストールの確認</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ pigz --version
</span><span class='line'>pigz 2.3
</span></code></pre></td></tr></table></div></figure>


<h3>3. 圧縮</h3>

<p>比較のため、まず <code>tar</code> コマンドで圧縮してみる。<br/>
（圧縮対象は、サブディレクトリ：2層、ファイル数：121,653個、容量：約100MB の &ldquo;test&rdquo; という名称のディレクトリ）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ time tar zcf test.tar.gz test
</span><span class='line'>
</span><span class='line'>real    0m4.711s
</span><span class='line'>user    0m4.402s
</span><span class='line'>sys     0m0.938s
</span></code></pre></td></tr></table></div></figure>


<p>次に、 pigz 圧縮してみる。<br/>
ディレクトリを再帰的に圧縮できる <code>-r</code> もあるが、これはファイルそれぞれが圧縮されてしまうので、 <code>tar</code> コマンドで一旦ファイルをまとめてから <code>pigz</code> コマンドで圧縮する。また、デフォルトでは全てのプロセッサを使用するが、同時実行スレッド数を指定する <code>-p</code> オプション等もある。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ time tar c test | pigz &gt; test.tar.gz
</span><span class='line'>
</span><span class='line'>real    0m2.987s
</span><span class='line'>user    0m4.624s
</span><span class='line'>sys     0m0.682s
</span></code></pre></td></tr></table></div></figure>


<p>ちなみに、単純に１つのファイルを圧縮するだけなら <code>pigz -k test.tar.gz</code> でよい（<code>-k</code> は元のファイルを残すオプション）。</p>

<p>さらに、 <code>pigz</code> コマンドを <code>tar</code> コマンドのオプションで使用して圧縮してみる。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ time tar cf test.tar.gz test --use-compress-program=pigz
</span><span class='line'>
</span><span class='line'>real    0m2.970s
</span><span class='line'>user    0m4.542s
</span><span class='line'>sys     0m0.632s
</span></code></pre></td></tr></table></div></figure>


<h3>4. 解凍</h3>

<p>まず、単純に <code>tar</code> コマンドで圧縮したファイルを解凍してみる。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ time tar zxf test.tar.gz
</span><span class='line'>
</span><span class='line'>real    0m18.441s
</span><span class='line'>user    0m1.813s
</span><span class='line'>sys     0m3.022s
</span></code></pre></td></tr></table></div></figure>


<p>次に、 <code>pigz</code> で圧縮したファイルを <code>tar</code> コマンドで解凍してみる。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ time tar xf test.tar.gz --use-compress-program=pigz
</span><span class='line'>
</span><span class='line'>real    0m17.526s
</span><span class='line'>user    0m1.193s
</span><span class='line'>sys     0m3.310s
</span></code></pre></td></tr></table></div></figure>


<h3>5. 所感</h3>

<ul>
<li>コア数 2 の非力な環境でも約 2/3 の速度で圧縮することができたのだが、場合によっては pigz を使用する方が遅くなることもある。</li>
<li>今回、解凍についてはそれほど差が認められなかった。</li>
<li>当然、環境によって結果は異なるだろう。</li>
</ul>


<p>従って、当方は明らかに圧縮の高速化が見込める場合のみ pigz を使用することとした。</p>

<h3>6. 参考サイト</h3>

<ul>
<li><a href="http://zlib.net/pigz/" title="pigz - Parallel gzip">pigz - Parallel gzip</a></li>
</ul>


<hr />

<p>非力な環境では、それほど積極的に使用したいと思うようなコマンドでもありませんでした。</p>

<p>しかし、コアを複数使用して圧縮・解凍ができる、といういことを認識できたことに若干の喜びを感じた次第です。</p>

<p>以上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[2015年09月 - OS・ブラウザ別アクセス状況！【自動集計】]]></title>
    <link href="http://komasaru.github.io/blog/2015/10/01/blog-access/"/>
    <updated>2015-10-01T00:20:00+09:00</updated>
    <id>http://komasaru.github.io/blog/2015/10/01/blog-access</id>
    <content type="html"><![CDATA[<p>こんばんは。</p>

<p>10月になりましたので、先月09月分の当ブログアクセス状況を公開します。</p>

<!--more-->


<h4>1. アクセスをOS別に集計</h4>

<table class="blog-access">
  <tr>
    <th>OS</th>
    <th>PageViews</th>
    <th>比率(%)</th>
  </tr>
  <tr>
    <td>Mac OS</td>
    <td class="blog-access-pv">20,655</td>
    <td class="blog-access-rate">60.0838</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td class="blog-access-pv">11,463</td>
    <td class="blog-access-rate">33.3450</td>
  </tr>
  <tr>
    <td>Linux</td>
    <td class="blog-access-pv">1,063</td>
    <td class="blog-access-rate">3.0922</td>
  </tr>
  <tr>
    <td>Ubuntu Linux</td>
    <td class="blog-access-pv">887</td>
    <td class="blog-access-rate">2.5802</td>
  </tr>
  <tr>
    <td>unknown</td>
    <td class="blog-access-pv">198</td>
    <td class="blog-access-rate">0.5760</td>
  </tr>
  <tr>
    <td>Fedora Linux</td>
    <td class="blog-access-pv">43</td>
    <td class="blog-access-rate">0.1251</td>
  </tr>
  <tr>
    <td>Android</td>
    <td class="blog-access-pv">26</td>
    <td class="blog-access-rate">0.0756</td>
  </tr>
  <tr>
    <td>FreeBSD</td>
    <td class="blog-access-pv">17</td>
    <td class="blog-access-rate">0.0495</td>
  </tr>
  <tr>
    <td>RedHat Linux</td>
    <td class="blog-access-pv">12</td>
    <td class="blog-access-rate">0.0349</td>
  </tr>
  <tr>
    <td>iPhone OS</td>
    <td class="blog-access-pv">8</td>
    <td class="blog-access-rate">0.0233</td>
  </tr>
  <tr>
    <td>Solaris</td>
    <td class="blog-access-pv">2</td>
    <td class="blog-access-rate">0.0058</td>
  </tr>
  <tr>
    <td>Debian GNU/Linux</td>
    <td class="blog-access-pv">2</td>
    <td class="blog-access-rate">0.0058</td>
  </tr>
  <tr>
    <td>CentOS Linux</td>
    <td class="blog-access-pv">1</td>
    <td class="blog-access-rate">0.0029</td>
  </tr>
  <tr>
    <td class="blog-access-total-label">合　計</td>
    <td class="blog-access-pv">34,377</td>
    <td class="blog-access-rate">100.0000</td>
  </tr>
</table>


<h4>2. アクセスをOS・バージョン別に集計（上位20件）</h4>

<table class="blog-access">
  <tr>
    <th>OS</th>
    <th>Version</th>
    <th>PageViews</th>
    <th>比率(%)</th>
  </tr>
  <tr>
    <td>Mac OS</td>
    <td>X</td>
    <td class="blog-access-pv">20,650</td>
    <td class="blog-access-rate">60.0692</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>NT</td>
    <td class="blog-access-pv">9,477</td>
    <td class="blog-access-rate">27.5679</td>
  </tr>
  <tr>
    <td>Linux</td>
    <td>unknown</td>
    <td class="blog-access-pv">1,039</td>
    <td class="blog-access-rate">3.0224</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>7</td>
    <td class="blog-access-pv">951</td>
    <td class="blog-access-rate">2.7664</td>
  </tr>
  <tr>
    <td>Ubuntu Linux</td>
    <td>unknown</td>
    <td class="blog-access-pv">869</td>
    <td class="blog-access-rate">2.5279</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>7 64 bit</td>
    <td class="blog-access-pv">598</td>
    <td class="blog-access-rate">1.7395</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>XP</td>
    <td class="blog-access-pv">255</td>
    <td class="blog-access-rate">0.7418</td>
  </tr>
  <tr>
    <td>unknown</td>
    <td>unknown</td>
    <td class="blog-access-pv">197</td>
    <td class="blog-access-rate">0.5731</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>Vista</td>
    <td class="blog-access-pv">138</td>
    <td class="blog-access-rate">0.4014</td>
  </tr>
  <tr>
    <td>Fedora Linux</td>
    <td>unknown</td>
    <td class="blog-access-pv">41</td>
    <td class="blog-access-rate">0.1193</td>
  </tr>
  <tr>
    <td>FreeBSD</td>
    <td>unknown</td>
    <td class="blog-access-pv">17</td>
    <td class="blog-access-rate">0.0495</td>
  </tr>
  <tr>
    <td>Ubuntu Linux</td>
    <td></td>
    <td class="blog-access-pv">14</td>
    <td class="blog-access-rate">0.0407</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>Server 2003</td>
    <td class="blog-access-pv">14</td>
    <td class="blog-access-rate">0.0407</td>
  </tr>
  <tr>
    <td>Linux</td>
    <td>64 bit</td>
    <td class="blog-access-pv">13</td>
    <td class="blog-access-rate">0.0378</td>
  </tr>
  <tr>
    <td>Android</td>
    <td>2.3.4</td>
    <td class="blog-access-pv">12</td>
    <td class="blog-access-rate">0.0349</td>
  </tr>
  <tr>
    <td>Linux</td>
    <td></td>
    <td class="blog-access-pv">11</td>
    <td class="blog-access-rate">0.0320</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>8 64 bit</td>
    <td class="blog-access-pv">11</td>
    <td class="blog-access-rate">0.0320</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>2000</td>
    <td class="blog-access-pv">8</td>
    <td class="blog-access-rate">0.0233</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>Vista 64 bit</td>
    <td class="blog-access-pv">8</td>
    <td class="blog-access-rate">0.0233</td>
  </tr>
  <tr>
    <td>Android</td>
    <td>4.0.1</td>
    <td class="blog-access-pv">6</td>
    <td class="blog-access-rate">0.0175</td>
  </tr>
  <tr>
    <td class="blog-access-dot">:</td>
    <td class="blog-access-dot">:</td>
    <td class="blog-access-dot">:</td>
    <td class="blog-access-dot">:</td>
  </tr>
  <tr>
    <td class="blog-access-total-label">合　計</td>
    <td> </td>
    <td class="blog-access-pv">34,377</td>
    <td class="blog-access-rate">100.0000</td>
  </tr>
</table>


<h4>3. アクセスをブラウザ別に集計</h4>

<table class="blog-access">
  <tr>
    <th>ブラウザ</th>
    <th>PageViews</th>
    <th>比率(%)</th>
  </tr>
  <tr>
    <td>Safari</td>
    <td class="blog-access-pv">20,022</td>
    <td class="blog-access-rate">58.2424</td>
  </tr>
  <tr>
    <td>Mozilla Firefox</td>
    <td class="blog-access-pv">7,979</td>
    <td class="blog-access-rate">23.2103</td>
  </tr>
  <tr>
    <td>Mozilla</td>
    <td class="blog-access-pv">3,470</td>
    <td class="blog-access-rate">10.0940</td>
  </tr>
  <tr>
    <td>Internet Explorer</td>
    <td class="blog-access-pv">2,233</td>
    <td class="blog-access-rate">6.4956</td>
  </tr>
  <tr>
    <td>Debian IceWeasel</td>
    <td class="blog-access-pv">322</td>
    <td class="blog-access-rate">0.9367</td>
  </tr>
  <tr>
    <td>Opera</td>
    <td class="blog-access-pv">226</td>
    <td class="blog-access-rate">0.6574</td>
  </tr>
  <tr>
    <td>Netscape Navigator</td>
    <td class="blog-access-pv">45</td>
    <td class="blog-access-rate">0.1309</td>
  </tr>
  <tr>
    <td>Chrome</td>
    <td class="blog-access-pv">24</td>
    <td class="blog-access-rate">0.0698</td>
  </tr>
  <tr>
    <td>Konqueror</td>
    <td class="blog-access-pv">21</td>
    <td class="blog-access-rate">0.0611</td>
  </tr>
  <tr>
    <td>iPhone</td>
    <td class="blog-access-pv">7</td>
    <td class="blog-access-rate">0.0204</td>
  </tr>
  <tr>
    <td>Epiphany</td>
    <td class="blog-access-pv">7</td>
    <td class="blog-access-rate">0.0204</td>
  </tr>
  <tr>
    <td>unknown</td>
    <td class="blog-access-pv">6</td>
    <td class="blog-access-rate">0.0175</td>
  </tr>
  <tr>
    <td>Mozilla SeaMonkey</td>
    <td class="blog-access-pv">6</td>
    <td class="blog-access-rate">0.0175</td>
  </tr>
  <tr>
    <td>PHP</td>
    <td class="blog-access-pv">4</td>
    <td class="blog-access-rate">0.0116</td>
  </tr>
  <tr>
    <td>Chromium</td>
    <td class="blog-access-pv">3</td>
    <td class="blog-access-rate">0.0087</td>
  </tr>
  <tr>
    <td>iPod</td>
    <td class="blog-access-pv">1</td>
    <td class="blog-access-rate">0.0029</td>
  </tr>
  <tr>
    <td>SRWare Iron</td>
    <td class="blog-access-pv">1</td>
    <td class="blog-access-rate">0.0029</td>
  </tr>
  <tr>
    <td class="blog-access-total-label">合　計</td>
    <td class="blog-access-pv">34,377</td>
    <td class="blog-access-rate">100.0000</td>
  </tr>
</table>


<h4>4. アクセスをブラウザ・バージョン別に集計（上位20件）</h4>

<table class="blog-access">
  <tr>
    <th>ブラウザ</th>
    <th>Version</th>
    <th>PageViews</th>
    <th>比率(%)</th>
  </tr>
  <tr>
    <td>Safari</td>
    <td>537.36</td>
    <td class="blog-access-pv">15,193</td>
    <td class="blog-access-rate">44.1952</td>
  </tr>
  <tr>
    <td>Mozilla Firefox</td>
    <td>40.0</td>
    <td class="blog-access-pv">5,757</td>
    <td class="blog-access-rate">16.7467</td>
  </tr>
  <tr>
    <td>Mozilla</td>
    <td>11.0</td>
    <td class="blog-access-pv">3,465</td>
    <td class="blog-access-rate">10.0794</td>
  </tr>
  <tr>
    <td>Safari</td>
    <td>9537.53</td>
    <td class="blog-access-pv">2,367</td>
    <td class="blog-access-rate">6.8854</td>
  </tr>
  <tr>
    <td>Internet Explorer</td>
    <td>8.0</td>
    <td class="blog-access-pv">898</td>
    <td class="blog-access-rate">2.6122</td>
  </tr>
  <tr>
    <td>Safari</td>
    <td>600.1.4</td>
    <td class="blog-access-pv">860</td>
    <td class="blog-access-rate">2.5017</td>
  </tr>
  <tr>
    <td>Safari</td>
    <td>600.8.9</td>
    <td class="blog-access-pv">705</td>
    <td class="blog-access-rate">2.0508</td>
  </tr>
  <tr>
    <td>Mozilla Firefox</td>
    <td>38.0</td>
    <td class="blog-access-pv">686</td>
    <td class="blog-access-rate">1.9955</td>
  </tr>
  <tr>
    <td>Mozilla Firefox</td>
    <td>41.0</td>
    <td class="blog-access-pv">665</td>
    <td class="blog-access-rate">1.9344</td>
  </tr>
  <tr>
    <td>Internet Explorer</td>
    <td>9.0</td>
    <td class="blog-access-pv">585</td>
    <td class="blog-access-rate">1.7017</td>
  </tr>
  <tr>
    <td>Internet Explorer</td>
    <td>10.0</td>
    <td class="blog-access-pv">465</td>
    <td class="blog-access-rate">1.3526</td>
  </tr>
  <tr>
    <td>Internet Explorer</td>
    <td>7.0</td>
    <td class="blog-access-pv">282</td>
    <td class="blog-access-rate">0.8203</td>
  </tr>
  <tr>
    <td>Mozilla Firefox</td>
    <td>39.0</td>
    <td class="blog-access-pv">230</td>
    <td class="blog-access-rate">0.6691</td>
  </tr>
  <tr>
    <td>Opera</td>
    <td>9.80</td>
    <td class="blog-access-pv">218</td>
    <td class="blog-access-rate">0.6341</td>
  </tr>
  <tr>
    <td>Safari</td>
    <td>534.30</td>
    <td class="blog-access-pv">188</td>
    <td class="blog-access-rate">0.5469</td>
  </tr>
  <tr>
    <td>Debian IceWeasel</td>
    <td>38.2.1</td>
    <td class="blog-access-pv">182</td>
    <td class="blog-access-rate">0.5294</td>
  </tr>
  <tr>
    <td>Safari</td>
    <td>601.1</td>
    <td class="blog-access-pv">165</td>
    <td class="blog-access-rate">0.4800</td>
  </tr>
  <tr>
    <td>Safari</td>
    <td>537.85.17</td>
    <td class="blog-access-pv">111</td>
    <td class="blog-access-rate">0.3229</td>
  </tr>
  <tr>
    <td>Mozilla Firefox</td>
    <td>42.0</td>
    <td class="blog-access-pv">89</td>
    <td class="blog-access-rate">0.2589</td>
  </tr>
  <tr>
    <td>Safari</td>
    <td>600.7.12</td>
    <td class="blog-access-pv">88</td>
    <td class="blog-access-rate">0.2560</td>
  </tr>
  <tr>
    <td class="blog-access-dot">:</td>
    <td class="blog-access-dot">:</td>
    <td class="blog-access-dot">:</td>
    <td class="blog-access-dot">:</td>
  </tr>
  <tr>
    <td class="blog-access-total-label">合　計</td>
    <td> </td>
    <td class="blog-access-pv">34,377</td>
    <td class="blog-access-rate">100.0000</td>
  </tr>
</table>


<hr />

<p>以上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ruby - Nokogiri による XML 解析の速度検証！]]></title>
    <link href="http://komasaru.github.io/blog/2015/09/22/ruby-verify-xml-parsing-by-nokogiri/"/>
    <updated>2015-09-22T00:20:00+09:00</updated>
    <id>http://komasaru.github.io/blog/2015/09/22/ruby-verify-xml-parsing-by-nokogiri</id>
    <content type="html"><![CDATA[<p>こんばんは。</p>

<p>Ruby で HTML/XML パーサの Nokogiri を使用して XML を解析する際、名前空間(Namespace)が宣言されている場合は厳密に指定する必要があるものだと考えております。</p>

<p>しかし、実際は名前空間を指定せずに解析することも可能です。<br/>
（実際、 XML 内の名前空間を削除するメソッドも用意されています。しかし、そのメソッドは名前空間について理解していない人のためのものであり、一般的には使用すべきではありません）</p>

<p>今回は、各種方法で解析し、どの方法が高速であるかを検証してみました。</p>

<!--more-->


<h3>0. 前提条件</h3>

<ul>
<li>Ruby 2.2.3-p173 での作業を想定。</li>
<li>以下で紹介する検証結果は、使用する XML の構造等により若干異なることもあるかもしれない、ということに留意。</li>
</ul>


<h3>1. 検証に使用する XML ファイル</h3>

<p>以下のような XML を使用する。（実際の「気象庁防災情報 XML」通知用 Atom フィードを流用。情報の内容は24時間以内に <code>link</code> タグ内の URL にアクセスして得ることになっている）</p>

<figure class='code'><figcaption><span>test_nokogiri.xml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;feed</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.w3.org/2005/Atom&quot;</span> <span class="na">xml:lang=</span><span class="s">&quot;ja&quot;</span><span class="nt">&gt;</span>
</span><span class='line'><span class="nt">&lt;title&gt;</span>JMAXML publishing feed<span class="nt">&lt;/title&gt;</span>
</span><span class='line'><span class="nt">&lt;subtitle&gt;</span>this feed is published by JMA<span class="nt">&lt;/subtitle&gt;</span>
</span><span class='line'><span class="nt">&lt;updated&gt;</span>2015-08-27T17:28:02+09:00<span class="nt">&lt;/updated&gt;</span>
</span><span class='line'><span class="nt">&lt;id&gt;</span>urn:uuid:d38e0e80-12ba-3236-b10f-256b78a08995<span class="nt">&lt;/id&gt;</span>
</span><span class='line'><span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;http://www.jma.go.jp/&quot;</span> <span class="na">rel=</span><span class="s">&quot;related&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;http://xml.kishou.go.jp/feed/other.xml&quot;</span> <span class="na">rel=</span><span class="s">&quot;self&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;rights&gt;</span>Published by Japan Meteorological Agency<span class="nt">&lt;/rights&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;entry&gt;</span>
</span><span class='line'><span class="nt">&lt;title&gt;</span>地方海上警報<span class="nt">&lt;/title&gt;</span>
</span><span class='line'><span class="nt">&lt;id&gt;</span>urn:uuid:ac97395c-e388-33a9-922f-ab2a32e61bb1<span class="nt">&lt;/id&gt;</span>
</span><span class='line'><span class="nt">&lt;updated&gt;</span>2015-08-27T08:27:18Z<span class="nt">&lt;/updated&gt;</span>
</span><span class='line'><span class="nt">&lt;author&gt;&lt;name&gt;</span>新潟地方気象台<span class="nt">&lt;/name&gt;&lt;/author&gt;</span>
</span><span class='line'><span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;http://xml.kishou.go.jp/data/ac97395c-e388-33a9-922f-ab2a32e61bb1.xml&quot;</span> <span class="na">type=</span><span class="s">&quot;application/xml&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;content</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span><span class="nt">&gt;</span>【新潟海上気象】<span class="nt">&lt;/content&gt;</span>
</span><span class='line'><span class="nt">&lt;/entry&gt;</span>
</span><span class='line'><span class="nt">&lt;entry&gt;</span>
</span><span class='line'><span class="nt">&lt;title&gt;</span>地方海上警報<span class="nt">&lt;/title&gt;</span>
</span><span class='line'><span class="nt">&lt;id&gt;</span>urn:uuid:b42a06f2-a6f0-351a-a8c4-3619a847f66d<span class="nt">&lt;/id&gt;</span>
</span><span class='line'><span class="nt">&lt;updated&gt;</span>2015-08-27T08:27:02Z<span class="nt">&lt;/updated&gt;</span>
</span><span class='line'><span class="nt">&lt;author&gt;&lt;name&gt;</span>仙台管区気象台<span class="nt">&lt;/name&gt;&lt;/author&gt;</span>
</span><span class='line'><span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;http://xml.kishou.go.jp/data/b42a06f2-a6f0-351a-a8c4-3619a847f66d.xml&quot;</span> <span class="na">type=</span><span class="s">&quot;application/xml&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;content</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span><span class="nt">&gt;</span>【仙台海上気象】<span class="nt">&lt;/content&gt;</span>
</span><span class='line'><span class="nt">&lt;/entry&gt;</span>
</span><span class='line'><span class="nt">&lt;entry&gt;</span>
</span><span class='line'><span class="nt">&lt;title&gt;</span>紫外線観測データ<span class="nt">&lt;/title&gt;</span>
</span><span class='line'><span class="nt">&lt;id&gt;</span>urn:uuid:f27e93c8-ff97-376d-b3b0-5307d07e4a24<span class="nt">&lt;/id&gt;</span>
</span><span class='line'><span class="nt">&lt;updated&gt;</span>2015-08-27T08:27:10Z<span class="nt">&lt;/updated&gt;</span>
</span><span class='line'><span class="nt">&lt;author&gt;&lt;name&gt;</span>気象庁地球環境・海洋部<span class="nt">&lt;/name&gt;&lt;/author&gt;</span>
</span><span class='line'><span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;http://xml.kishou.go.jp/data/f27e93c8-ff97-376d-b3b0-5307d07e4a24.xml&quot;</span> <span class="na">type=</span><span class="s">&quot;application/xml&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;content</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span><span class="nt">&gt;</span>【紫外線観測データ】<span class="nt">&lt;/content&gt;</span>
</span><span class='line'><span class="nt">&lt;/entry&gt;</span>
</span><span class='line'><span class="nt">&lt;/feed&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>2. 検証用 Ruby スクリプトの作成</h3>

<ul>
<li>以下のスクリプト内で指定する名前空間は、 &ldquo;text_nokogiri.xml&rdquo; 内で宣言されているものと同じ。</li>
<li><code>entry</code> ノードをループし、各 <code>title</code> ノードのテキストを取得するだけの簡単な処理を 10,000 回繰り返す。</li>
<li>今回は７種類（スクリプト内コメント参照）の解析方法で検証する。</li>
<li>以下のスクリプト内の XPath での「Namespace 指定なし」とは、 Nokogiri での厳密な指定をしないという意味。</li>
</ul>


<figure class='code'><figcaption><span>test_nokogiri_xml.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#! /usr/local/bin/ruby</span>
</span><span class='line'><span class="c1"># coding: utf-8</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># Ruby script to verify the speed of xml parsing by Nokogiri.</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1">#++</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;benchmark&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;nokogiri&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">TestNokogiriXml</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span>
</span><span class='line'>    <span class="vi">@xml</span>  <span class="o">=</span> <span class="no">Nokogiri</span><span class="o">::</span><span class="no">XML</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;test_nokogiri.xml&quot;</span><span class="p">))</span>
</span><span class='line'>    <span class="vi">@secs</span> <span class="o">=</span> <span class="mi">10000</span>
</span><span class='line'>    <span class="vi">@ns</span>   <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;http://www.w3.org/2005/Atom&quot;</span><span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">exec</span>
</span><span class='line'>    <span class="c1"># 1. css メソッド(CSS セレクタ)による解析</span>
</span><span class='line'>    <span class="nb">printf</span><span class="p">(</span><span class="s2">&quot;CASE-1: %.4f secs.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">case_1</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># 2. search メソッド(CSS セレクタ)による解析</span>
</span><span class='line'>    <span class="nb">printf</span><span class="p">(</span><span class="s2">&quot;CASE-2: %.4f secs.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">case_2</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># 3. search メソッド(XPath, Namespace 指定なし)による解析</span>
</span><span class='line'>    <span class="nb">printf</span><span class="p">(</span><span class="s2">&quot;CASE-3: %.4f secs.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">case_3</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># 4. / メソッド(CSS セレクタ)による解析</span>
</span><span class='line'>    <span class="nb">printf</span><span class="p">(</span><span class="s2">&quot;CASE-4: %.4f secs.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">case_4</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># 5. / メソッド(XPath, Namespace 指定なし)による解析</span>
</span><span class='line'>    <span class="nb">printf</span><span class="p">(</span><span class="s2">&quot;CASE-5: %.4f secs.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">case_5</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># 6. xpath メソッド(XPath, Namespace 指定なし)による解析</span>
</span><span class='line'>    <span class="nb">printf</span><span class="p">(</span><span class="s2">&quot;CASE-6: %.4f secs.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">case_6</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># 7. xpath メソッド(XPath, Namespace 指定あり)による解析</span>
</span><span class='line'>    <span class="nb">printf</span><span class="p">(</span><span class="s2">&quot;CASE-7: %.4f secs.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">case_7</span><span class="p">)</span>
</span><span class='line'>  <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>    <span class="vg">$stderr</span><span class="o">.</span><span class="n">puts</span> <span class="s2">&quot;[</span><span class="si">#{</span><span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.</span><span class="si">#{</span><span class="n">__method__</span><span class="si">}</span><span class="s2">] </span><span class="si">#{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="n">e</span><span class="o">.</span><span class="n">backtrace</span><span class="o">.</span><span class="n">each</span><span class="p">{</span> <span class="o">|</span><span class="n">tr</span><span class="o">|</span> <span class="vg">$stderr</span><span class="o">.</span><span class="n">puts</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="si">#{</span><span class="n">tr</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span>
</span><span class='line'>    <span class="nb">exit</span> <span class="mi">1</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">case_1</span>
</span><span class='line'>    <span class="k">return</span> <span class="no">Benchmark</span><span class="o">.</span><span class="n">realtime</span> <span class="k">do</span>
</span><span class='line'>      <span class="vi">@secs</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>        <span class="vi">@xml</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s2">&quot;entry&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
</span><span class='line'>          <span class="n">title</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">text</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>    <span class="k">raise</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">case_2</span>
</span><span class='line'>    <span class="k">return</span> <span class="no">Benchmark</span><span class="o">.</span><span class="n">realtime</span> <span class="k">do</span>
</span><span class='line'>      <span class="vi">@secs</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>        <span class="vi">@xml</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;entry&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
</span><span class='line'>          <span class="n">title</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">text</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>    <span class="k">raise</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">case_3</span>
</span><span class='line'>    <span class="k">return</span> <span class="no">Benchmark</span><span class="o">.</span><span class="n">realtime</span> <span class="k">do</span>
</span><span class='line'>      <span class="vi">@secs</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>        <span class="vi">@xml</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;//xmlns:entry&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
</span><span class='line'>          <span class="n">title</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;./xmlns:title&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">text</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>    <span class="k">raise</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">case_4</span>
</span><span class='line'>    <span class="k">return</span> <span class="no">Benchmark</span><span class="o">.</span><span class="n">realtime</span> <span class="k">do</span>
</span><span class='line'>      <span class="vi">@secs</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>        <span class="p">(</span><span class="vi">@xml</span><span class="o">/</span><span class="s2">&quot;entry&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
</span><span class='line'>          <span class="n">title</span> <span class="o">=</span> <span class="p">(</span><span class="n">e</span><span class="o">/</span><span class="s2">&quot;title&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">text</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>        <span class="c1"># 以下でも同様。しかし、ごく少し遅い。</span>
</span><span class='line'>        <span class="c1">#(@xml/:entry).each do |e|</span>
</span><span class='line'>        <span class="c1">#  title = (e/:title).first.text</span>
</span><span class='line'>        <span class="c1">#end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>    <span class="k">raise</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">case_5</span>
</span><span class='line'>    <span class="k">return</span> <span class="no">Benchmark</span><span class="o">.</span><span class="n">realtime</span> <span class="k">do</span>
</span><span class='line'>      <span class="vi">@secs</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>        <span class="p">(</span><span class="vi">@xml</span><span class="o">/</span><span class="s2">&quot;//xmlns:entry&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
</span><span class='line'>          <span class="n">title</span> <span class="o">=</span> <span class="p">(</span><span class="n">e</span><span class="o">/</span><span class="s2">&quot;./xmlns:title&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">text</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>    <span class="k">raise</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">case_6</span>
</span><span class='line'>    <span class="k">return</span> <span class="no">Benchmark</span><span class="o">.</span><span class="n">realtime</span> <span class="k">do</span>
</span><span class='line'>      <span class="vi">@secs</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>        <span class="vi">@xml</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&quot;//xmlns:entry&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
</span><span class='line'>          <span class="n">title</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&quot;xmlns:title&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">text</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>    <span class="k">raise</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">case_7</span>
</span><span class='line'>    <span class="k">return</span> <span class="no">Benchmark</span><span class="o">.</span><span class="n">realtime</span> <span class="k">do</span>
</span><span class='line'>      <span class="vi">@secs</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>        <span class="vi">@xml</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&quot;//a:entry&quot;</span><span class="p">,</span> <span class="vi">@ns</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
</span><span class='line'>          <span class="n">title</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&quot;a:title&quot;</span><span class="p">,</span> <span class="vi">@ns</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">text</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>    <span class="k">raise</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">TestNokogiriXml</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">exec</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><a href="https://gist.github.com/komasaru/1f737b67baba38213570" title="Gist - Ruby script to verify the speed of xml parsing by Nokogiri. ">Gist - Ruby script to verify the speed of xml parsing by Nokogiri. </a></li>
</ul>


<h3>3. Ruby スクリプトの実行</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ ./test.rb
</span><span class='line'>CASE-1: 2.3432 secs.
</span><span class='line'>CASE-2: 2.4821 secs.
</span><span class='line'>CASE-3: 2.0588 secs.
</span><span class='line'>CASE-4: 2.4949 secs.
</span><span class='line'>CASE-5: 2.0672 secs.
</span><span class='line'>CASE-6: 1.7549 secs.
</span><span class='line'>CASE-7: 1.5359 secs.
</span></code></pre></td></tr></table></div></figure>


<h3>4. 検証結果について</h3>

<ul>
<li>何回か実行してみたが、全て同じような結果となった。</li>
<li><code>xpath</code> メソッドは <code>css</code>, <code>search</code>, <code>/</code> メソッドより高速に解析することができる。</li>
<li><code>xpath</code> メソッドで厳密に名前空間を指定した方が、指定せずに解析するより高速である。</li>
<li>要は、XML を解析する際は <code>xpath</code> メソッドで名前空間を指定しましょう、ということ。</li>
<li>今回の検証結果が全てという訳ではない（場合によっては「一概には言えない」ということがあるかもしれない）</li>
</ul>


<hr />

<p>当方、以前は CSS セレクタを使用して XML 解析を行なっていた時期もありましたが、現在は XPath で厳密に名前空間を指定して解析を行うようにしています。</p>

<p>以上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Postfix - メールキューの管理！]]></title>
    <link href="http://komasaru.github.io/blog/2015/09/17/postfix-management-of-mail-queue/"/>
    <updated>2015-09-17T00:20:00+09:00</updated>
    <id>http://komasaru.github.io/blog/2015/09/17/postfix-management-of-mail-queue</id>
    <content type="html"><![CDATA[<p>こんばんは。</p>

<p>SMTP サーバ Postfix でのメールキュー管理についての備忘録です。</p>

<!--more-->


<h3>0. 前提条件</h3>

<ul>
<li>Debian GNU/Linux 8.0(64bit) 上の Postfix 2.11.3-1,<br/>
CentOS 6.7(32bit) 上の Postfix 2.6.6.-2<br/>
での作業を想定。</li>
</ul>


<h3>1. 各種コマンド</h3>

<h4>1-1. メールキューの確認</h4>

<p>配送されずに溜まっているメールキューは &ldquo;/var/spool/postfix/deferred&rdquo; ディレクトリ内にある。<br/>
それらを確認するには以下のようにする。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ postqueue -p
</span><span class='line'>-Queue ID- --Size-- ----Arrival Time---- -Sender/Recipient-------
</span><span class='line'>AF70A2C009D*    1504 Sat Aug 22 23:57:39 hoge@xxxxxxxxxx.com
</span><span class='line'>                                         fuga@yyyyyyyyyy.com
</span><span class='line'>
</span><span class='line'>-- 2 Kbytes in 1 Request.
</span></code></pre></td></tr></table></div></figure>


<p>もしくは、</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ mailq
</span></code></pre></td></tr></table></div></figure>


<h4>1-2. メール内容の確認</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ postcat -q &lt;QueueID&gt;
</span></code></pre></td></tr></table></div></figure>


<h4>1-3. メールキュー配送の停止</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ postsuper -h &lt;QueueID&gt;|ALL
</span></code></pre></td></tr></table></div></figure>


<h4>1-4. メールキューの削除</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ postsuper -d &lt;QueueID&gt;|ALL
</span></code></pre></td></tr></table></div></figure>


<p>配送が遅れいているキュー全てを削除する場合は、</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ postsuper -d ALL deferred
</span></code></pre></td></tr></table></div></figure>


<h4>1-5. メールキューの再送</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ postsuper -r &lt;QueueID&gt;|ALL
</span></code></pre></td></tr></table></div></figure>


<p>もしくは、</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ postfix flush
</span></code></pre></td></tr></table></div></figure>


<p>もしくは、</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>postqueue -f
</span></code></pre></td></tr></table></div></figure>


<p>もしくは、</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>sendmail -q
</span></code></pre></td></tr></table></div></figure>


<hr />

<p>時々使用するコマンドなので、忘れたときのために記録しておいた次第です。</p>

<p>以上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[MariaDB(MySQL) - XML ダンプ出力から HTML テーブル定義書生成！]]></title>
    <link href="http://komasaru.github.io/blog/2015/09/12/mariadb-table-definition-from-xmldump-to-html/"/>
    <updated>2015-09-12T00:20:00+09:00</updated>
    <id>http://komasaru.github.io/blog/2015/09/12/mariadb-table-definition-from-xmldump-to-html</id>
    <content type="html"><![CDATA[<p>こんばんは。</p>

<p>MariaDB(MySQL) のテーブル定義書を HTML で生成する方法についての記録です。</p>

<p>実際には、スキーマ（テーブル定義）を XML 出力し、それに XSL テンプレートを適用します。</p>

<p>（テーブル定義を行なってからテーブルを作成するのが本来の手順でしょうが）</p>

<!--more-->


<h3>0. 前提条件</h3>

<ul>
<li>Linux Mint 17.2(64bit) での作業を想定。</li>
<li>MariaDB 10.0.21 サーバでの作業を想定。</li>
<li>HTML 生成に <code>xsltproc</code> コマンドを使用するので、未インストールならインストールしておく。</li>
</ul>


<h3>1. XML ダンプ出力</h3>

<p><code>mysqldump</code> コマンドを使用してスキーマ（テーブル定義）のみを XML フォーマットで出力する。<br/>
（以下は <code>test</code> というデータベースの <code>towns</code> というテーブルを &ldquo;test_towns.xml&rdquo; という XML ファイルに出力する例）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ mysqldump -u username -p --xml --no-data test towns &gt; test_towns.xml
</span></code></pre></td></tr></table></div></figure>


<p>参考までに、今回出力された XML ファイルの内容は以下のとおり。</p>

<figure class='code'><figcaption><span>text.xml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;mysqldump</span> <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><span class="nt">&gt;</span>
</span><span class='line'><span class="nt">&lt;database</span> <span class="na">name=</span><span class="s">&quot;test&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;table_structure</span> <span class="na">name=</span><span class="s">&quot;towns&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;field</span> <span class="na">Field=</span><span class="s">&quot;id&quot;</span> <span class="na">Type=</span><span class="s">&quot;int(11)&quot;</span> <span class="na">Null=</span><span class="s">&quot;NO&quot;</span> <span class="na">Key=</span><span class="s">&quot;PRI&quot;</span> <span class="na">Extra=</span><span class="s">&quot;auto_increment&quot;</span> <span class="na">Comment=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;field</span> <span class="na">Field=</span><span class="s">&quot;pref_code&quot;</span> <span class="na">Type=</span><span class="s">&quot;varchar(2)&quot;</span> <span class="na">Null=</span><span class="s">&quot;NO&quot;</span> <span class="na">Key=</span><span class="s">&quot;MUL&quot;</span> <span class="na">Default=</span><span class="s">&quot;&quot;</span> <span class="na">Extra=</span><span class="s">&quot;&quot;</span> <span class="na">Comment=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;field</span> <span class="na">Field=</span><span class="s">&quot;city_code&quot;</span> <span class="na">Type=</span><span class="s">&quot;varchar(5)&quot;</span> <span class="na">Null=</span><span class="s">&quot;NO&quot;</span> <span class="na">Key=</span><span class="s">&quot;MUL&quot;</span> <span class="na">Default=</span><span class="s">&quot;&quot;</span> <span class="na">Extra=</span><span class="s">&quot;&quot;</span> <span class="na">Comment=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;field</span> <span class="na">Field=</span><span class="s">&quot;town_code&quot;</span> <span class="na">Type=</span><span class="s">&quot;varchar(12)&quot;</span> <span class="na">Null=</span><span class="s">&quot;NO&quot;</span> <span class="na">Key=</span><span class="s">&quot;MUL&quot;</span> <span class="na">Default=</span><span class="s">&quot;&quot;</span> <span class="na">Extra=</span><span class="s">&quot;&quot;</span> <span class="na">Comment=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;field</span> <span class="na">Field=</span><span class="s">&quot;latitude&quot;</span> <span class="na">Type=</span><span class="s">&quot;double&quot;</span> <span class="na">Null=</span><span class="s">&quot;YES&quot;</span> <span class="na">Key=</span><span class="s">&quot;&quot;</span> <span class="na">Default=</span><span class="s">&quot;0&quot;</span> <span class="na">Extra=</span><span class="s">&quot;&quot;</span> <span class="na">Comment=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;field</span> <span class="na">Field=</span><span class="s">&quot;longitude&quot;</span> <span class="na">Type=</span><span class="s">&quot;double&quot;</span> <span class="na">Null=</span><span class="s">&quot;YES&quot;</span> <span class="na">Key=</span><span class="s">&quot;&quot;</span> <span class="na">Default=</span><span class="s">&quot;0&quot;</span> <span class="na">Extra=</span><span class="s">&quot;&quot;</span> <span class="na">Comment=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;field</span> <span class="na">Field=</span><span class="s">&quot;upd_datetime&quot;</span> <span class="na">Type=</span><span class="s">&quot;datetime&quot;</span> <span class="na">Null=</span><span class="s">&quot;YES&quot;</span> <span class="na">Key=</span><span class="s">&quot;&quot;</span> <span class="na">Default=</span><span class="s">&quot;0000-00-00 00:00:00&quot;</span> <span class="na">Extra=</span><span class="s">&quot;&quot;</span> <span class="na">Comment=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;key</span> <span class="na">Table=</span><span class="s">&quot;towns&quot;</span> <span class="na">Non_unique=</span><span class="s">&quot;0&quot;</span> <span class="na">Key_name=</span><span class="s">&quot;PRIMARY&quot;</span> <span class="na">Seq_in_index=</span><span class="s">&quot;1&quot;</span> <span class="na">Column_name=</span><span class="s">&quot;id&quot;</span> <span class="na">Collation=</span><span class="s">&quot;A&quot;</span> <span class="na">Cardinality=</span><span class="s">&quot;0&quot;</span> <span class="na">Null=</span><span class="s">&quot;&quot;</span> <span class="na">Index_type=</span><span class="s">&quot;BTREE&quot;</span> <span class="na">Comment=</span><span class="s">&quot;&quot;</span> <span class="na">Index_comment=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;key</span> <span class="na">Table=</span><span class="s">&quot;towns&quot;</span> <span class="na">Non_unique=</span><span class="s">&quot;1&quot;</span> <span class="na">Key_name=</span><span class="s">&quot;idx_1&quot;</span> <span class="na">Seq_in_index=</span><span class="s">&quot;1&quot;</span> <span class="na">Column_name=</span><span class="s">&quot;pref_code&quot;</span> <span class="na">Collation=</span><span class="s">&quot;A&quot;</span> <span class="na">Cardinality=</span><span class="s">&quot;0&quot;</span> <span class="na">Null=</span><span class="s">&quot;&quot;</span> <span class="na">Index_type=</span><span class="s">&quot;BTREE&quot;</span> <span class="na">Comment=</span><span class="s">&quot;&quot;</span> <span class="na">Index_comment=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;key</span> <span class="na">Table=</span><span class="s">&quot;towns&quot;</span> <span class="na">Non_unique=</span><span class="s">&quot;1&quot;</span> <span class="na">Key_name=</span><span class="s">&quot;idx_1&quot;</span> <span class="na">Seq_in_index=</span><span class="s">&quot;2&quot;</span> <span class="na">Column_name=</span><span class="s">&quot;city_code&quot;</span> <span class="na">Collation=</span><span class="s">&quot;A&quot;</span> <span class="na">Cardinality=</span><span class="s">&quot;0&quot;</span> <span class="na">Null=</span><span class="s">&quot;&quot;</span> <span class="na">Index_type=</span><span class="s">&quot;BTREE&quot;</span> <span class="na">Comment=</span><span class="s">&quot;&quot;</span> <span class="na">Index_comment=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;key</span> <span class="na">Table=</span><span class="s">&quot;towns&quot;</span> <span class="na">Non_unique=</span><span class="s">&quot;1&quot;</span> <span class="na">Key_name=</span><span class="s">&quot;idx_1&quot;</span> <span class="na">Seq_in_index=</span><span class="s">&quot;3&quot;</span> <span class="na">Column_name=</span><span class="s">&quot;town_code&quot;</span> <span class="na">Collation=</span><span class="s">&quot;A&quot;</span> <span class="na">Cardinality=</span><span class="s">&quot;0&quot;</span> <span class="na">Null=</span><span class="s">&quot;&quot;</span> <span class="na">Index_type=</span><span class="s">&quot;BTREE&quot;</span> <span class="na">Comment=</span><span class="s">&quot;&quot;</span> <span class="na">Index_comment=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;key</span> <span class="na">Table=</span><span class="s">&quot;towns&quot;</span> <span class="na">Non_unique=</span><span class="s">&quot;1&quot;</span> <span class="na">Key_name=</span><span class="s">&quot;idx_2&quot;</span> <span class="na">Seq_in_index=</span><span class="s">&quot;1&quot;</span> <span class="na">Column_name=</span><span class="s">&quot;city_code&quot;</span> <span class="na">Collation=</span><span class="s">&quot;A&quot;</span> <span class="na">Cardinality=</span><span class="s">&quot;0&quot;</span> <span class="na">Null=</span><span class="s">&quot;&quot;</span> <span class="na">Index_type=</span><span class="s">&quot;BTREE&quot;</span> <span class="na">Comment=</span><span class="s">&quot;&quot;</span> <span class="na">Index_comment=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;key</span> <span class="na">Table=</span><span class="s">&quot;towns&quot;</span> <span class="na">Non_unique=</span><span class="s">&quot;1&quot;</span> <span class="na">Key_name=</span><span class="s">&quot;idx_2&quot;</span> <span class="na">Seq_in_index=</span><span class="s">&quot;2&quot;</span> <span class="na">Column_name=</span><span class="s">&quot;town_code&quot;</span> <span class="na">Collation=</span><span class="s">&quot;A&quot;</span> <span class="na">Cardinality=</span><span class="s">&quot;0&quot;</span> <span class="na">Null=</span><span class="s">&quot;&quot;</span> <span class="na">Index_type=</span><span class="s">&quot;BTREE&quot;</span> <span class="na">Comment=</span><span class="s">&quot;&quot;</span> <span class="na">Index_comment=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;key</span> <span class="na">Table=</span><span class="s">&quot;towns&quot;</span> <span class="na">Non_unique=</span><span class="s">&quot;1&quot;</span> <span class="na">Key_name=</span><span class="s">&quot;idx_3&quot;</span> <span class="na">Seq_in_index=</span><span class="s">&quot;1&quot;</span> <span class="na">Column_name=</span><span class="s">&quot;town_code&quot;</span> <span class="na">Collation=</span><span class="s">&quot;A&quot;</span> <span class="na">Cardinality=</span><span class="s">&quot;0&quot;</span> <span class="na">Null=</span><span class="s">&quot;&quot;</span> <span class="na">Index_type=</span><span class="s">&quot;BTREE&quot;</span> <span class="na">Comment=</span><span class="s">&quot;&quot;</span> <span class="na">Index_comment=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;options</span> <span class="na">Name=</span><span class="s">&quot;towns&quot;</span> <span class="na">Engine=</span><span class="s">&quot;InnoDB&quot;</span> <span class="na">Version=</span><span class="s">&quot;10&quot;</span> <span class="na">Row_format=</span><span class="s">&quot;Compact&quot;</span> <span class="na">Rows=</span><span class="s">&quot;0&quot;</span> <span class="na">Avg_row_length=</span><span class="s">&quot;0&quot;</span> <span class="na">Data_length=</span><span class="s">&quot;16384&quot;</span> <span class="na">Max_data_length=</span><span class="s">&quot;0&quot;</span> <span class="na">Index_length=</span><span class="s">&quot;49152&quot;</span> <span class="na">Data_free=</span><span class="s">&quot;0&quot;</span> <span class="na">Auto_increment=</span><span class="s">&quot;1&quot;</span> <span class="na">Create_time=</span><span class="s">&quot;2015-08-18 14:06:07&quot;</span> <span class="na">Collation=</span><span class="s">&quot;utf8_general_ci&quot;</span> <span class="na">Create_options=</span><span class="s">&quot;&quot;</span> <span class="na">Comment=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/table_structure&gt;</span>
</span><span class='line'><span class="nt">&lt;/database&gt;</span>
</span><span class='line'><span class="nt">&lt;/mysqldump&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>ちなみに、今回使用しているテーブルの CREATE 文は以下のようになっている。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">towns</span><span class="o">`</span> <span class="p">(</span>
</span><span class='line'>  <span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">pref_code</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">city_code</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">town_code</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">latitude</span><span class="o">`</span> <span class="n">double</span> <span class="k">DEFAULT</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">longitude</span><span class="o">`</span> <span class="n">double</span> <span class="k">DEFAULT</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">upd_datetime</span><span class="o">`</span> <span class="n">datetime</span> <span class="k">DEFAULT</span> <span class="s1">&#39;0000-00-00 00:00:00&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">),</span>
</span><span class='line'>  <span class="k">KEY</span> <span class="o">`</span><span class="n">idx_1</span><span class="o">`</span> <span class="p">(</span><span class="o">`</span><span class="n">pref_code</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">city_code</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">town_code</span><span class="o">`</span><span class="p">),</span>
</span><span class='line'>  <span class="k">KEY</span> <span class="o">`</span><span class="n">idx_2</span><span class="o">`</span> <span class="p">(</span><span class="o">`</span><span class="n">city_code</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">town_code</span><span class="o">`</span><span class="p">),</span>
</span><span class='line'>  <span class="k">KEY</span> <span class="o">`</span><span class="n">idx_3</span><span class="o">`</span> <span class="p">(</span><span class="o">`</span><span class="n">town_code</span><span class="o">`</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>2. XSL テンプレートの作成</h3>

<p>以下のように XSL テンプレートを作成する。（あくまで一例。必要であれば適宜編集）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;xsl:stylesheet</span>
</span><span class='line'>  <span class="na">xmlns:xsl=</span><span class="s">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span>
</span><span class='line'>  <span class="na">version=</span><span class="s">&quot;1.0&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;xsl:output</span> <span class="na">method=</span><span class="s">&quot;html&quot;</span> <span class="na">encoding=</span><span class="s">&quot;utf-8&quot;</span> <span class="na">version=</span><span class="s">&quot;1.0&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;xsl:template</span> <span class="na">match=</span><span class="s">&quot;mysqldump&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;html&gt;</span>
</span><span class='line'>    <span class="nt">&lt;head&gt;</span>
</span><span class='line'>      <span class="nt">&lt;title&gt;</span>データベース・テーブル定義<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>      <span class="nt">&lt;style</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        h2 {
</span><span class='line'>          background-color: #8fbc8f;
</span><span class='line'>          padding:          5px;
</span><span class='line'>        }
</span><span class='line'>        h4 {
</span><span class='line'>          color:            #666;
</span><span class='line'>          margin-top:       5px;
</span><span class='line'>          margin-bottom:    5px;
</span><span class='line'>        }
</span><span class='line'>        table {
</span><span class='line'>          border-collapse:  separate;
</span><span class='line'>          border-spacing:   0px;
</span><span class='line'>          border-top:       1px solid #ccc;
</span><span class='line'>          border-left:      1px solid #ccc;
</span><span class='line'>          margin-bottom:    5px;
</span><span class='line'>        }
</span><span class='line'>        table th {
</span><span class='line'>          text-align:       left;
</span><span class='line'>          vertical-align:   top;
</span><span class='line'>          color:            #444;
</span><span class='line'>          background-color: #ccc;
</span><span class='line'>          border-top:       1px solid #fff;
</span><span class='line'>          border-left:      1px solid #fff;
</span><span class='line'>          border-right:     1px solid #ccc;
</span><span class='line'>          border-bottom:    1px solid #ccc;
</span><span class='line'>          padding:          4px;
</span><span class='line'>          white-space:      nowrap;
</span><span class='line'>        }
</span><span class='line'>        table td {
</span><span class='line'>          background-color: #fafafa;
</span><span class='line'>          border-right:     1px solid #ccc;
</span><span class='line'>          border-bottom:    1px solid #ccc;
</span><span class='line'>          padding:          4px;
</span><span class='line'>          white-space:      nowrap;
</span><span class='line'>        }
</span><span class='line'>        .tbl-db-name {
</span><span class='line'>          margin-bottom:    10px;
</span><span class='line'>        }
</span><span class='line'>        .th-db-title {
</span><span class='line'>          background-color: #bdb76b;
</span><span class='line'>          width:            200px;
</span><span class='line'>        }
</span><span class='line'>        .th-tbl-title {
</span><span class='line'>          width:            200px;
</span><span class='line'>        }
</span><span class='line'>        .td-name {
</span><span class='line'>          width:            200px;
</span><span class='line'>        }
</span><span class='line'>        .th-no {
</span><span class='line'>          width:            50px;
</span><span class='line'>          text-align:       right;
</span><span class='line'>        }
</span><span class='line'>        .th-field,
</span><span class='line'>        .th-type,
</span><span class='line'>        .th-extra,
</span><span class='line'>        .th-default,
</span><span class='line'>        .th-comment,
</span><span class='line'>        .th-keyname {
</span><span class='line'>          width:            200px;
</span><span class='line'>        }
</span><span class='line'>        .th-null,
</span><span class='line'>        .th-key {
</span><span class='line'>          width:            50px;
</span><span class='line'>        }
</span><span class='line'>        .th-columns {
</span><span class='line'>          width:            400px;
</span><span class='line'>        }
</span><span class='line'>        .th-nonunique {
</span><span class='line'>          width:            100px;
</span><span class='line'>        }
</span><span class='line'>        .td-no {
</span><span class='line'>          text-align:       right;
</span><span class='line'>        }
</span><span class='line'>      <span class="nt">&lt;/style&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/head&gt;</span>
</span><span class='line'>    <span class="nt">&lt;body&gt;</span>
</span><span class='line'>      <span class="nt">&lt;h2&gt;</span>データベース・テーブル定義書<span class="nt">&lt;/h2&gt;</span>
</span><span class='line'>      <span class="nt">&lt;xsl:apply-templates</span> <span class="na">select=</span><span class="s">&quot;database&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/body&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/html&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/xsl:template&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;xsl:template</span> <span class="na">match=</span><span class="s">&quot;database&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">&quot;tbl-db-name&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;tr&gt;</span>
</span><span class='line'>        <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-db-title&quot;</span><span class="nt">&gt;</span>データベース名<span class="nt">&lt;/th&gt;</span>
</span><span class='line'>        <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;td-name&quot;</span><span class="nt">&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&quot;@name&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/tr&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/table&gt;</span>
</span><span class='line'>    <span class="nt">&lt;xsl:apply-templates</span> <span class="na">select=</span><span class="s">&quot;table_structure&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/xsl:template&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;xsl:template</span> <span class="na">match=</span><span class="s">&quot;table_structure&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;table&gt;</span>
</span><span class='line'>      <span class="nt">&lt;tr&gt;</span>
</span><span class='line'>        <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-tbl-title&quot;</span><span class="nt">&gt;</span>テーブル名<span class="nt">&lt;/th&gt;</span>
</span><span class='line'>        <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;td-name&quot;</span><span class="nt">&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&quot;@name&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/tr&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/table&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;h4&gt;</span>カラム情報<span class="nt">&lt;/h4&gt;</span>
</span><span class='line'>    <span class="nt">&lt;table&gt;</span>
</span><span class='line'>      <span class="nt">&lt;thead&gt;</span>
</span><span class='line'>        <span class="nt">&lt;tr&gt;</span>
</span><span class='line'>          <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-no&quot;</span>     <span class="nt">&gt;</span>#<span class="nt">&lt;/th&gt;</span>
</span><span class='line'>          <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-field&quot;</span>  <span class="nt">&gt;</span>フィールド名<span class="nt">&lt;/th&gt;</span>
</span><span class='line'>          <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-type&quot;</span>   <span class="nt">&gt;</span>データ型<span class="nt">&lt;/th&gt;</span>
</span><span class='line'>          <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-null&quot;</span>   <span class="nt">&gt;</span>Null<span class="nt">&lt;/th&gt;</span>
</span><span class='line'>          <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-key&quot;</span>    <span class="nt">&gt;</span>キー<span class="nt">&lt;/th&gt;</span>
</span><span class='line'>          <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-extra&quot;</span>  <span class="nt">&gt;</span>Extra<span class="nt">&lt;/th&gt;</span>
</span><span class='line'>          <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-default&quot;</span><span class="nt">&gt;</span>デフォルト<span class="nt">&lt;/th&gt;</span>
</span><span class='line'>          <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-comment&quot;</span><span class="nt">&gt;</span>備考<span class="nt">&lt;/th&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/tr&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/thead&gt;</span>
</span><span class='line'>      <span class="nt">&lt;tbody&gt;</span>
</span><span class='line'>        <span class="nt">&lt;xsl:for-each</span> <span class="na">select=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;tr&gt;</span>
</span><span class='line'>          <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;td-no&quot;</span><span class="nt">&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&quot;position()&quot;</span><span class="nt">/&gt;&lt;/td&gt;</span>
</span><span class='line'>          <span class="nt">&lt;td&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&quot;@Field&quot;</span>   <span class="nt">/&gt;&lt;/td&gt;</span>
</span><span class='line'>          <span class="nt">&lt;td&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&quot;@Type&quot;</span>    <span class="nt">/&gt;&lt;/td&gt;</span>
</span><span class='line'>          <span class="nt">&lt;td&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&quot;@Null&quot;</span>    <span class="nt">/&gt;&lt;/td&gt;</span>
</span><span class='line'>          <span class="nt">&lt;td&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&quot;@Key&quot;</span>     <span class="nt">/&gt;&lt;/td&gt;</span>
</span><span class='line'>          <span class="nt">&lt;td&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&quot;@Extra&quot;</span>   <span class="nt">/&gt;&lt;/td&gt;</span>
</span><span class='line'>          <span class="nt">&lt;td&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&quot;@Default&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
</span><span class='line'>          <span class="nt">&lt;td&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&quot;@Comment&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/tr&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/xsl:for-each&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/tbody&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/table&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;h4&gt;</span>インデックス情報<span class="nt">&lt;/h4&gt;</span>
</span><span class='line'>    <span class="nt">&lt;table&gt;</span>
</span><span class='line'>      <span class="nt">&lt;thead&gt;</span>
</span><span class='line'>        <span class="nt">&lt;tr&gt;</span>
</span><span class='line'>          <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-keyname&quot;</span>  <span class="nt">&gt;</span>インデックス名<span class="nt">&lt;/th&gt;</span>
</span><span class='line'>          <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-columns&quot;</span>  <span class="nt">&gt;</span>カラムリスト<span class="nt">&lt;/th&gt;</span>
</span><span class='line'>          <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-nonunique&quot;</span><span class="nt">&gt;</span>ユニーク<span class="nt">&lt;/th&gt;</span>
</span><span class='line'>          <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-comment&quot;</span>  <span class="nt">&gt;</span>備考<span class="nt">&lt;/th&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/tr&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/thead&gt;</span>
</span><span class='line'>      <span class="nt">&lt;tbody&gt;</span>
</span><span class='line'>        <span class="nt">&lt;xsl:for-each</span> <span class="na">select=</span><span class="s">&quot;key&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>          <span class="nt">&lt;xsl:variable</span> <span class="na">name=</span><span class="s">&quot;key_name&quot;</span> <span class="na">select=</span><span class="s">&quot;@Key_name&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>          <span class="nt">&lt;xsl:if</span> <span class="na">test=</span><span class="s">&quot;not(preceding-sibling::key[@Key_name=$key_name])&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>          <span class="nt">&lt;tr&gt;</span>
</span><span class='line'>            <span class="nt">&lt;td&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&quot;$key_name&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
</span><span class='line'>            <span class="nt">&lt;td&gt;</span>
</span><span class='line'>              <span class="nt">&lt;xsl:for-each</span> <span class="na">select=</span><span class="s">&quot;../key[@Key_name=$key_name]&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>                <span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&quot;@Column_name&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>                <span class="nt">&lt;xsl:if</span> <span class="na">test=</span><span class="s">&quot;position()!=last()&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>                  <span class="nt">&lt;xsl:text&gt;</span>, <span class="nt">&lt;/xsl:text&gt;</span>
</span><span class='line'>                <span class="nt">&lt;/xsl:if&gt;</span>
</span><span class='line'>              <span class="nt">&lt;/xsl:for-each&gt;</span>
</span><span class='line'>            <span class="nt">&lt;/td&gt;</span>
</span><span class='line'>            <span class="nt">&lt;td&gt;</span>
</span><span class='line'>              <span class="nt">&lt;xsl:choose&gt;</span>
</span><span class='line'>                <span class="nt">&lt;xsl:when</span> <span class="na">test=</span><span class="s">&quot;@Non_unique=&#39;0&#39;&quot;</span><span class="nt">&gt;</span>1<span class="nt">&lt;/xsl:when&gt;</span>
</span><span class='line'>                <span class="nt">&lt;xsl:otherwise&gt;</span>0<span class="nt">&lt;/xsl:otherwise&gt;</span>
</span><span class='line'>              <span class="nt">&lt;/xsl:choose&gt;</span>
</span><span class='line'>            <span class="nt">&lt;/td&gt;</span>
</span><span class='line'>            <span class="nt">&lt;td&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&quot;@Comment&quot;</span>    <span class="nt">/&gt;&lt;/td&gt;</span>
</span><span class='line'>          <span class="nt">&lt;/tr&gt;</span>
</span><span class='line'>          <span class="nt">&lt;/xsl:if&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/xsl:for-each&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/tbody&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/table&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/xsl:template&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;xsl:template</span> <span class="na">name=</span><span class="s">&quot;no_increment&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;xsl:param</span> <span class="na">name=</span><span class="s">&quot;no&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&quot;$no + 1&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/xsl:template&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/xsl:stylesheet&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><a href="https://gist.github.com/komasaru/ecce393eb6056d4c92a7" title="Gist - XSL template to generate a HTML from a XML of MariaDB(MySQL)'s table definition.">Gist - XSL template to generate a HTML from a XML of MariaDB(MySQL)&rsquo;s table definition.</a></li>
</ul>


<h3>3. HTML の生成</h3>

<p><code>xsltproc</code> コマンドを使用して HTML を生成する。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ xsltproc --output test_towns.html table_definition.xsl test_towns.xml
</span></code></pre></td></tr></table></div></figure>


<h3>4. HTML の確認</h3>

<p>生成された HTML を確認してみる。</p>

<figure class='code'><figcaption><span>test_towns.html</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="cp">&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD HTML 4.0 Transitional//EN&quot; &quot;http://www.w3.org/TR/REC-html40/loose.dtd&quot;&gt;</span>
</span><span class='line'><span class="nt">&lt;html&gt;</span>
</span><span class='line'><span class="nt">&lt;head&gt;</span>
</span><span class='line'><span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;Content-Type&quot;</span> <span class="na">content=</span><span class="s">&quot;text/html; charset=utf-8&quot;</span><span class="nt">&gt;</span>
</span><span class='line'><span class="nt">&lt;title&gt;</span>データベース・テーブル定義<span class="nt">&lt;/title&gt;</span>
</span><span class='line'><span class="nt">&lt;style </span><span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">h2</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">background-color</span><span class="o">:</span> <span class="m">#8fbc8f</span><span class="p">;</span>
</span><span class='line'>          <span class="k">padding</span><span class="o">:</span>          <span class="m">5px</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nt">h4</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">color</span><span class="o">:</span>            <span class="m">#666</span><span class="p">;</span>
</span><span class='line'>          <span class="k">margin-top</span><span class="o">:</span>       <span class="m">5px</span><span class="p">;</span>
</span><span class='line'>          <span class="k">margin-bottom</span><span class="o">:</span>    <span class="m">5px</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nt">table</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">border-collapse</span><span class="o">:</span>  <span class="k">separate</span><span class="p">;</span>
</span><span class='line'>          <span class="k">border-spacing</span><span class="o">:</span>   <span class="m">0px</span><span class="p">;</span>
</span><span class='line'>          <span class="k">border-top</span><span class="o">:</span>       <span class="m">1px</span> <span class="k">solid</span> <span class="m">#ccc</span><span class="p">;</span>
</span><span class='line'>          <span class="k">border-left</span><span class="o">:</span>      <span class="m">1px</span> <span class="k">solid</span> <span class="m">#ccc</span><span class="p">;</span>
</span><span class='line'>          <span class="k">margin-bottom</span><span class="o">:</span>    <span class="m">5px</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nt">table</span> <span class="nt">th</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">text-align</span><span class="o">:</span>       <span class="k">left</span><span class="p">;</span>
</span><span class='line'>          <span class="k">vertical-align</span><span class="o">:</span>   <span class="k">top</span><span class="p">;</span>
</span><span class='line'>          <span class="k">color</span><span class="o">:</span>            <span class="m">#444</span><span class="p">;</span>
</span><span class='line'>          <span class="k">background-color</span><span class="o">:</span> <span class="m">#ccc</span><span class="p">;</span>
</span><span class='line'>          <span class="k">border-top</span><span class="o">:</span>       <span class="m">1px</span> <span class="k">solid</span> <span class="m">#fff</span><span class="p">;</span>
</span><span class='line'>          <span class="k">border-left</span><span class="o">:</span>      <span class="m">1px</span> <span class="k">solid</span> <span class="m">#fff</span><span class="p">;</span>
</span><span class='line'>          <span class="k">border-right</span><span class="o">:</span>     <span class="m">1px</span> <span class="k">solid</span> <span class="m">#ccc</span><span class="p">;</span>
</span><span class='line'>          <span class="k">border-bottom</span><span class="o">:</span>    <span class="m">1px</span> <span class="k">solid</span> <span class="m">#ccc</span><span class="p">;</span>
</span><span class='line'>          <span class="k">padding</span><span class="o">:</span>          <span class="m">4px</span><span class="p">;</span>
</span><span class='line'>          <span class="k">white-space</span><span class="o">:</span>      <span class="k">nowrap</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nt">table</span> <span class="nt">td</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">background-color</span><span class="o">:</span> <span class="m">#fafafa</span><span class="p">;</span>
</span><span class='line'>          <span class="k">border-right</span><span class="o">:</span>     <span class="m">1px</span> <span class="k">solid</span> <span class="m">#ccc</span><span class="p">;</span>
</span><span class='line'>          <span class="k">border-bottom</span><span class="o">:</span>    <span class="m">1px</span> <span class="k">solid</span> <span class="m">#ccc</span><span class="p">;</span>
</span><span class='line'>          <span class="k">padding</span><span class="o">:</span>          <span class="m">4px</span><span class="p">;</span>
</span><span class='line'>          <span class="k">white-space</span><span class="o">:</span>      <span class="k">nowrap</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nc">.tbl-db-name</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">margin-bottom</span><span class="o">:</span>    <span class="m">10px</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nc">.th-db-title</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">background-color</span><span class="o">:</span> <span class="m">#bdb76b</span><span class="p">;</span>
</span><span class='line'>          <span class="k">width</span><span class="o">:</span>            <span class="m">200px</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nc">.th-tbl-title</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">width</span><span class="o">:</span>            <span class="m">200px</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nc">.td-name</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">width</span><span class="o">:</span>            <span class="m">200px</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nc">.th-no</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">width</span><span class="o">:</span>            <span class="m">50px</span><span class="p">;</span>
</span><span class='line'>          <span class="k">text-align</span><span class="o">:</span>       <span class="k">right</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nc">.th-field</span><span class="o">,</span>
</span><span class='line'>        <span class="nc">.th-type</span><span class="o">,</span>
</span><span class='line'>        <span class="nc">.th-extra</span><span class="o">,</span>
</span><span class='line'>        <span class="nc">.th-default</span><span class="o">,</span>
</span><span class='line'>        <span class="nc">.th-comment</span><span class="o">,</span>
</span><span class='line'>        <span class="nc">.th-keyname</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">width</span><span class="o">:</span>            <span class="m">200px</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nc">.th-null</span><span class="o">,</span>
</span><span class='line'>        <span class="nc">.th-key</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">width</span><span class="o">:</span>            <span class="m">50px</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nc">.th-columns</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">width</span><span class="o">:</span>            <span class="m">400px</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nc">.th-nonunique</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">width</span><span class="o">:</span>            <span class="m">100px</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nc">.td-no</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">text-align</span><span class="o">:</span>       <span class="k">right</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="nt">&lt;/style&gt;</span>
</span><span class='line'><span class="nt">&lt;/head&gt;</span>
</span><span class='line'><span class="nt">&lt;body&gt;</span>
</span><span class='line'><span class="nt">&lt;h2&gt;</span>データベース・テーブル定義書<span class="nt">&lt;/h2&gt;</span>
</span><span class='line'><span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">&quot;tbl-db-name&quot;</span><span class="nt">&gt;&lt;tr&gt;</span>
</span><span class='line'><span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-db-title&quot;</span><span class="nt">&gt;</span>データベース名<span class="nt">&lt;/th&gt;</span>
</span><span class='line'><span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;td-name&quot;</span><span class="nt">&gt;</span>test<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;/tr&gt;&lt;/table&gt;</span>
</span><span class='line'><span class="nt">&lt;table&gt;&lt;tr&gt;</span>
</span><span class='line'><span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-tbl-title&quot;</span><span class="nt">&gt;</span>テーブル名<span class="nt">&lt;/th&gt;</span>
</span><span class='line'><span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;td-name&quot;</span><span class="nt">&gt;</span>towns<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;/tr&gt;&lt;/table&gt;</span>
</span><span class='line'><span class="nt">&lt;h4&gt;</span>カラム情報<span class="nt">&lt;/h4&gt;</span>
</span><span class='line'><span class="nt">&lt;table&gt;</span>
</span><span class='line'><span class="nt">&lt;thead&gt;&lt;tr&gt;</span>
</span><span class='line'><span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-no&quot;</span><span class="nt">&gt;</span>#<span class="nt">&lt;/th&gt;</span>
</span><span class='line'><span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-field&quot;</span><span class="nt">&gt;</span>フィールド名<span class="nt">&lt;/th&gt;</span>
</span><span class='line'><span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-type&quot;</span><span class="nt">&gt;</span>データ型<span class="nt">&lt;/th&gt;</span>
</span><span class='line'><span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-null&quot;</span><span class="nt">&gt;</span>Null<span class="nt">&lt;/th&gt;</span>
</span><span class='line'><span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-key&quot;</span><span class="nt">&gt;</span>キー<span class="nt">&lt;/th&gt;</span>
</span><span class='line'><span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-extra&quot;</span><span class="nt">&gt;</span>Extra<span class="nt">&lt;/th&gt;</span>
</span><span class='line'><span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-default&quot;</span><span class="nt">&gt;</span>デフォルト<span class="nt">&lt;/th&gt;</span>
</span><span class='line'><span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-comment&quot;</span><span class="nt">&gt;</span>備考<span class="nt">&lt;/th&gt;</span>
</span><span class='line'><span class="nt">&lt;/tr&gt;&lt;/thead&gt;</span>
</span><span class='line'><span class="nt">&lt;tbody&gt;</span>
</span><span class='line'><span class="nt">&lt;tr&gt;</span>
</span><span class='line'><span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;td-no&quot;</span><span class="nt">&gt;</span>1<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>id<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>int(11)<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>NO<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>PRI<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>auto_increment<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;/tr&gt;</span>
</span><span class='line'><span class="nt">&lt;tr&gt;</span>
</span><span class='line'><span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;td-no&quot;</span><span class="nt">&gt;</span>2<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>pref_code<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>varchar(2)<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>NO<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>MUL<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;/tr&gt;</span>
</span><span class='line'><span class="nt">&lt;tr&gt;</span>
</span><span class='line'><span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;td-no&quot;</span><span class="nt">&gt;</span>3<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>city_code<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>varchar(5)<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>NO<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>MUL<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;/tr&gt;</span>
</span><span class='line'><span class="nt">&lt;tr&gt;</span>
</span><span class='line'><span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;td-no&quot;</span><span class="nt">&gt;</span>4<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>town_code<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>varchar(12)<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>NO<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>MUL<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;/tr&gt;</span>
</span><span class='line'><span class="nt">&lt;tr&gt;</span>
</span><span class='line'><span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;td-no&quot;</span><span class="nt">&gt;</span>5<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>latitude<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>double<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>YES<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>0<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;/tr&gt;</span>
</span><span class='line'><span class="nt">&lt;tr&gt;</span>
</span><span class='line'><span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;td-no&quot;</span><span class="nt">&gt;</span>6<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>longitude<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>double<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>YES<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>0<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;/tr&gt;</span>
</span><span class='line'><span class="nt">&lt;tr&gt;</span>
</span><span class='line'><span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;td-no&quot;</span><span class="nt">&gt;</span>7<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>upd_datetime<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>datetime<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>YES<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>0000-00-00 00:00:00<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;/tr&gt;</span>
</span><span class='line'><span class="nt">&lt;/tbody&gt;</span>
</span><span class='line'><span class="nt">&lt;/table&gt;</span>
</span><span class='line'><span class="nt">&lt;h4&gt;</span>インデックス情報<span class="nt">&lt;/h4&gt;</span>
</span><span class='line'><span class="nt">&lt;table&gt;</span>
</span><span class='line'><span class="nt">&lt;thead&gt;&lt;tr&gt;</span>
</span><span class='line'><span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-keyname&quot;</span><span class="nt">&gt;</span>インデックス名<span class="nt">&lt;/th&gt;</span>
</span><span class='line'><span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-columns&quot;</span><span class="nt">&gt;</span>カラムリスト<span class="nt">&lt;/th&gt;</span>
</span><span class='line'><span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-nonunique&quot;</span><span class="nt">&gt;</span>ユニーク<span class="nt">&lt;/th&gt;</span>
</span><span class='line'><span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;th-comment&quot;</span><span class="nt">&gt;</span>備考<span class="nt">&lt;/th&gt;</span>
</span><span class='line'><span class="nt">&lt;/tr&gt;&lt;/thead&gt;</span>
</span><span class='line'><span class="nt">&lt;tbody&gt;</span>
</span><span class='line'><span class="nt">&lt;tr&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>PRIMARY<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>id<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>1<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;/tr&gt;</span>
</span><span class='line'><span class="nt">&lt;tr&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>idx_1<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>pref_code, city_code, town_code<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>0<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;/tr&gt;</span>
</span><span class='line'><span class="nt">&lt;tr&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>idx_2<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>city_code, town_code<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>0<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;/tr&gt;</span>
</span><span class='line'><span class="nt">&lt;tr&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>idx_3<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>town_code<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>0<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;/tr&gt;</span>
</span><span class='line'><span class="nt">&lt;/tbody&gt;</span>
</span><span class='line'><span class="nt">&lt;/table&gt;</span>
</span><span class='line'><span class="nt">&lt;/body&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>さらに、 HTML ファイルをブラウザで開いて確認してみる。</p>

<p><img src="http://komasaru.github.io/images/2015/09/12/TABLE_DEF_HTML.png" title="TABLE_DEF_HTML" alt="TABLE_DEF_HTML" /></p>

<hr />

<p>大量にテーブル定義書を生成したければシェル化するのもよいでしょう。</p>

<p>以上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Linux - XML に XSLT を適用して HTML 生成！]]></title>
    <link href="http://komasaru.github.io/blog/2015/09/07/linux-apply-xslt-to-xml-by-xsltproc/"/>
    <updated>2015-09-07T00:20:00+09:00</updated>
    <id>http://komasaru.github.io/blog/2015/09/07/linux-apply-xslt-to-xml-by-xsltproc</id>
    <content type="html"><![CDATA[<p>こんばんは。</p>

<p>以前、 Ruby で XML ファイルに XSL テンプレートを適用して HTML を生成する方法を紹介しました。</p>

<ul>
<li><a href="http://komasaru.github.io/2013/12/04/ruby-apply-xslt-to-xml/" title="Ruby - XML に XSLT を適用して HTML 生成！">Ruby - XML に XSLT を適用して HTML 生成！</a></li>
</ul>


<p>ただ、 Linux ディストリビューションによってはデフォルトで XML に XSL テンプレートを適用するコマンドがインストールされています。<br/>
わざわざ Ruby を使用しなくてもよいということです。</p>

<p>以下、その使用方法についての備忘録です。</p>

<!--more-->


<h3>0. 前提条件</h3>

<ul>
<li>Linux Mint 17.2(64bit) での作業を想定。</li>
<li>XML に XSL テンプレート適用して HTML ファイルを生成するのに <code>xsltproc</code> コマンドを使用する。</li>
</ul>


<h3>1. xsltproc コマンドのインストール</h3>

<p><code>xsltproc</code> コマンドが未インストールならインストールしておく。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ sudo apt-get install xsltproc
</span></code></pre></td></tr></table></div></figure>


<h3>2. XML ファイルの準備</h3>

<p>試験的に使用する XML ファイルを以下のように作成する。（あくまで一例）</p>

<figure class='code'><figcaption><span>test.xml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
</span><span class='line'><span class="cp">&lt;?xml-stylesheet type=&quot;text/xsl&quot; href=&quot;test.xsl&quot; ?&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;Office&gt;</span>
</span><span class='line'>  <span class="nt">&lt;People&gt;</span>
</span><span class='line'>    <span class="nt">&lt;Person&gt;</span>
</span><span class='line'>      <span class="nt">&lt;No&gt;</span>1234<span class="nt">&lt;/No&gt;</span>
</span><span class='line'>      <span class="nt">&lt;Name&gt;</span>Ruby 太郎<span class="nt">&lt;/Name&gt;</span>
</span><span class='line'>      <span class="nt">&lt;Birthday&gt;</span>1980-01-01<span class="nt">&lt;/Birthday&gt;</span>
</span><span class='line'>      <span class="nt">&lt;Age&gt;</span>33<span class="nt">&lt;/Age&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/Person&gt;</span>
</span><span class='line'>    <span class="nt">&lt;Person&gt;</span>
</span><span class='line'>      <span class="nt">&lt;No&gt;</span>2345<span class="nt">&lt;/No&gt;</span>
</span><span class='line'>      <span class="nt">&lt;Name&gt;</span>XML 二郎<span class="nt">&lt;/Name&gt;</span>
</span><span class='line'>      <span class="nt">&lt;Birthday&gt;</span>1985-04-15<span class="nt">&lt;/Birthday&gt;</span>
</span><span class='line'>      <span class="nt">&lt;Age&gt;</span>28<span class="nt">&lt;/Age&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/Person&gt;</span>
</span><span class='line'>    <span class="nt">&lt;Person&gt;</span>
</span><span class='line'>      <span class="nt">&lt;No&gt;</span>3456<span class="nt">&lt;/No&gt;</span>
</span><span class='line'>      <span class="nt">&lt;Name&gt;</span>XSL 花子<span class="nt">&lt;/Name&gt;</span>
</span><span class='line'>      <span class="nt">&lt;Birthday&gt;</span>1990-09-30<span class="nt">&lt;/Birthday&gt;</span>
</span><span class='line'>      <span class="nt">&lt;Age&gt;</span>23<span class="nt">&lt;/Age&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/Person&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/People&gt;</span>
</span><span class='line'><span class="nt">&lt;/Office&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>3. XSL テンプレートファイルの準備</h3>

<p>試験的に使用する XSL テンプレートファイルを以下のように作成する。（あくまで一例）</p>

<figure class='code'><figcaption><span>test.xsl</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;xsl:stylesheet</span> <span class="na">xmlns:xsl=</span><span class="s">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span> <span class="na">version=</span><span class="s">&quot;1.0&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>   <span class="nt">&lt;xsl:output</span> <span class="na">method=</span><span class="s">&quot;html&quot;</span> <span class="na">encoding=</span><span class="s">&quot;UTF-8&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;xsl:template</span> <span class="na">match=</span><span class="s">&quot;/&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;xsl:apply-templates/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/xsl:template&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;xsl:template</span> <span class="na">match=</span><span class="s">&quot;Office&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;ja&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;body&gt;</span>
</span><span class='line'>    <span class="nt">&lt;xsl:apply-templates/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/body&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/html&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/xsl:template&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;xsl:template</span> <span class="na">match=</span><span class="s">&quot;People&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;table&gt;</span>
</span><span class='line'>    <span class="nt">&lt;xsl:apply-templates/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/table&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/xsl:template&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;xsl:template</span> <span class="na">match=</span><span class="s">&quot;Person&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;tr&gt;</span>
</span><span class='line'>      <span class="nt">&lt;td&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&quot;No&quot;</span><span class="nt">/&gt;&lt;/td&gt;</span>
</span><span class='line'>      <span class="nt">&lt;td&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&quot;Name&quot;</span><span class="nt">/&gt;&lt;/td&gt;</span>
</span><span class='line'>      <span class="nt">&lt;td&gt;&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">&quot;Birthday&quot;</span><span class="nt">/&gt;&lt;/td&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/tr&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/xsl:template&gt;</span>
</span><span class='line'><span class="nt">&lt;/xsl:stylesheet&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>4. HTML ファイルの生成</h3>

<p>準備しておいた XML ファイルに XSL テンプレートを適用して HTML ファイルを生成する。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ xsltproc --output test.html test.xsl test.xml
</span></code></pre></td></tr></table></div></figure>


<p>※オプションは他にも多数あるので、 <code>xsltproc --help</code> や <code>man xsltproc</code> で確認する。</p>

<h3>5. HTML ファイルの確認</h3>

<p>&ldquo;test.html&rdquo; というファイルが作成されているはずなので、確認してみる。</p>

<figure class='code'><figcaption><span>test.html</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;ja&quot;</span><span class="nt">&gt;&lt;body&gt;</span>
</span><span class='line'>  <span class="nt">&lt;table&gt;</span>
</span><span class='line'>    <span class="nt">&lt;tr&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>1234<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>Ruby 太郎<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>1980-01-01<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;/tr&gt;</span>
</span><span class='line'>    <span class="nt">&lt;tr&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>2345<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>XML 二郎<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>1985-04-15<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;/tr&gt;</span>
</span><span class='line'>    <span class="nt">&lt;tr&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>3456<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>XSL 花子<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;td&gt;</span>1990-09-30<span class="nt">&lt;/td&gt;</span>
</span><span class='line'><span class="nt">&lt;/tr&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/table&gt;</span>
</span><span class='line'><span class="nt">&lt;/body&gt;&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>さらに、この HTML ファイルをブラウザで開いて確認してみる。</p>

<p><img src="http://komasaru.github.io/images/2015/09/07/XSLTPROC.png" title="XSLTPROC" alt="XSLTPROC" /></p>

<hr />

<p>単に XML ファイルに XSL テンプレートを適用して HTML ファイルを作成するだけなら、今回の方法が楽でいいかもしれませんね。</p>

<p>以上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[MariaDB(MySQL) - インデックス名一覧取得！]]></title>
    <link href="http://komasaru.github.io/blog/2015/09/03/mariadb-index-list/"/>
    <updated>2015-09-03T00:20:00+09:00</updated>
    <id>http://komasaru.github.io/blog/2015/09/03/mariadb-index-list</id>
    <content type="html"><![CDATA[<p>こんばんは。</p>

<p>MariaDB(MySQL) で作成済みのインデックスの名称を確認したい場合、 <code>SHOW INDEX FROM table_name</code> を使用することが多いと思います。</p>

<p>しかし、一度に多数のテーブルについて確認したい場合に、テーブル単位で <code>SHOW INDEX FROM table_name</code> を実行するのは大変面倒です。</p>

<p>以下で、指定データベース内の全テーブルに作成済みのインデックスを一覧表示する SQL 等を紹介します。</p>

<!--more-->


<h3>0. 前提条件</h3>

<ul>
<li>MariaDB 10.0.21 での作業を想定。（MySQL でも同様のはず）</li>
</ul>


<h3>1. SQL 作成</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'>  <span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="n">TABLE_SCHEMA</span><span class="p">,</span> <span class="k">TABLE_NAME</span><span class="p">,</span> <span class="n">INDEX_NAME</span>
</span><span class='line'>    <span class="k">FROM</span> <span class="n">information_schema</span><span class="p">.</span><span class="k">STATISTICS</span>
</span><span class='line'>   <span class="k">WHERE</span> <span class="n">TABLE_SCHEMA</span> <span class="o">=</span> <span class="s1">&#39;scheme_name&#39;</span> <span class="c1">-- &lt;= 対象のデータベース名</span>
</span><span class='line'>     <span class="k">AND</span> <span class="n">INDEX_NAME</span> <span class="o">&lt;&gt;</span> <span class="s1">&#39;PRIMARY&#39;</span>
</span><span class='line'><span class="k">ORDER</span> <span class="k">BY</span> <span class="n">TABLE_SCHEMA</span><span class="p">,</span> <span class="k">TABLE_NAME</span><span class="p">,</span> <span class="n">INDEX_NAME</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>ちなみに、インデックスに設定されているカラム名やその順番も確認したければ、以下のような SQL となる。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'>  <span class="k">SELECT</span> <span class="n">TABLE_SCHEMA</span><span class="p">,</span> <span class="k">TABLE_NAME</span><span class="p">,</span> <span class="n">INDEX_NAME</span><span class="p">,</span> <span class="k">COLUMN_NAME</span><span class="p">,</span> <span class="n">SEQ_IN_INDEX</span>
</span><span class='line'>    <span class="k">FROM</span> <span class="n">information_schema</span><span class="p">.</span><span class="k">STATISTICS</span>
</span><span class='line'>   <span class="k">WHERE</span> <span class="n">TABLE_SCHEMA</span> <span class="o">=</span> <span class="s1">&#39;scheme_name&#39;</span> <span class="c1">-- &lt;= 対象のデータベース名</span>
</span><span class='line'>     <span class="k">AND</span> <span class="n">INDEX_NAME</span> <span class="o">&lt;&gt;</span> <span class="s1">&#39;PRIMARY&#39;</span>
</span><span class='line'><span class="k">ORDER</span> <span class="k">BY</span> <span class="n">TABLE_SCHEMA</span><span class="p">,</span> <span class="k">TABLE_NAME</span><span class="p">,</span> <span class="n">INDEX_NAME</span><span class="p">,</span> <span class="n">SEQ_IN_INDEX</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>2. 応用</h3>

<p>参考までに、前項で紹介した SQL を利用して、データベース内の全テーブルの全インデックス（プライマリキーを除く）を削除するストアドプロシージャを作成する。<br/>
※当方が過去に必要に迫られて作成したストアドプロシージャで、実際はこのストアドプロシージャ実行後にインデックスを一括作成するストアドプロシージャも実行している。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">CREATE</span> <span class="k">DEFINER</span><span class="o">=`</span><span class="n">root</span><span class="o">`@`</span><span class="n">localhost</span><span class="o">`</span> <span class="k">PROCEDURE</span> <span class="o">`</span><span class="n">del_index_all</span><span class="o">`</span><span class="p">()</span>
</span><span class='line'><span class="k">BEGIN</span>
</span><span class='line'>    <span class="c1">-- 変数宣言</span>
</span><span class='line'>    <span class="k">DECLARE</span> <span class="n">v_tbl_name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">DECLARE</span> <span class="n">v_idx_name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">DECLARE</span> <span class="n">v_done</span> <span class="nb">INT</span> <span class="k">DEFAULT</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">-- カーソル宣言</span>
</span><span class='line'>    <span class="k">DECLARE</span> <span class="n">v_cur</span> <span class="k">CURSOR</span> <span class="k">FOR</span>
</span><span class='line'>        <span class="k">SELECT</span>
</span><span class='line'>            <span class="k">DISTINCT</span> <span class="k">TABLE_NAME</span><span class="p">,</span> <span class="n">INDEX_NAME</span>
</span><span class='line'>        <span class="k">FROM</span>
</span><span class='line'>            <span class="n">information_schema</span><span class="p">.</span><span class="k">STATISTICS</span>
</span><span class='line'>        <span class="k">WHERE</span>
</span><span class='line'>            <span class="n">TABLE_SCHEMA</span> <span class="o">=</span> <span class="s1">&#39;jmx&#39;</span>
</span><span class='line'>        <span class="k">AND</span> <span class="n">INDEX_NAME</span> <span class="o">&lt;&gt;</span> <span class="s1">&#39;PRIMARY&#39;</span>
</span><span class='line'>        <span class="k">ORDER</span> <span class="k">BY</span>
</span><span class='line'>            <span class="n">TABLE_SCHEMA</span><span class="p">,</span> <span class="k">TABLE_NAME</span><span class="p">,</span> <span class="n">INDEX_NAME</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">-- 終了ステータス宣言</span>
</span><span class='line'>    <span class="k">DECLARE</span> <span class="n">EXIT</span> <span class="k">HANDLER</span> <span class="k">FOR</span> <span class="k">NOT</span> <span class="k">FOUND</span> <span class="k">SET</span> <span class="n">v_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">-- カーソル OPEN</span>
</span><span class='line'>    <span class="k">OPEN</span> <span class="n">v_cur</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">-- LOOP 処理</span>
</span><span class='line'>    <span class="n">WHILE</span> <span class="n">v_done</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">DO</span>
</span><span class='line'>        <span class="c1">-- カーソル FETCH</span>
</span><span class='line'>        <span class="k">FETCH</span> <span class="n">v_cur</span> <span class="k">INTO</span> <span class="n">v_tbl_name</span><span class="p">,</span> <span class="n">v_idx_name</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">-- 動的 SQL 実行</span>
</span><span class='line'>        <span class="k">SET</span> <span class="o">@</span><span class="n">s</span> <span class="o">=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;ALTER TABLE &#39;</span><span class="p">,</span> <span class="n">v_tbl_name</span><span class="p">,</span> <span class="s1">&#39; DROP INDEX &#39;</span><span class="p">,</span> <span class="n">v_idx_name</span><span class="p">);</span>
</span><span class='line'>        <span class="k">PREPARE</span> <span class="n">stmt</span> <span class="k">FROM</span> <span class="o">@</span><span class="n">s</span><span class="p">;</span>
</span><span class='line'>        <span class="k">EXECUTE</span> <span class="n">stmt</span><span class="p">;</span>
</span><span class='line'>    <span class="k">END</span> <span class="n">WHILE</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">-- PREPARED STATEMENT 解放</span>
</span><span class='line'>    <span class="k">DEALLOCATE</span> <span class="k">PREPARE</span> <span class="n">stmt</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">-- カーソル CLOSE</span>
</span><span class='line'>    <span class="k">CLOSE</span> <span class="n">v_cur</span><span class="p">;</span>
</span><span class='line'><span class="k">END</span>
</span></code></pre></td></tr></table></div></figure>


<p>本当は、動的に SQL を実行する(PREPARED STATEMENT)部分を以下のようにしたかったが、 <code>?</code> は MariaDB のストアドではサポートされてない模様。（<a href="https://mariadb.com/kb/en/mariadb/prepare-statement/" title="PREPARE Statement - MariaDB Knowledge Base">参考</a>）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="c1">--  :</span>
</span><span class='line'><span class="c1">-- 省略</span>
</span><span class='line'><span class="c1">--  :</span>
</span><span class='line'>
</span><span class='line'><span class="k">SET</span> <span class="o">@</span><span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;ALTER TABLE ? DROP INDEX ?&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">PREPARE</span> <span class="n">stmt</span> <span class="k">FROM</span> <span class="o">@</span><span class="n">s</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">OPEN</span> <span class="n">v_cur</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">WHILE</span> <span class="n">v_done</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">DO</span>
</span><span class='line'>    <span class="k">FETCH</span> <span class="n">v_cur</span> <span class="k">INTO</span> <span class="n">v_tbl_name</span><span class="p">,</span> <span class="n">v_idx_name</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">SET</span> <span class="o">@</span><span class="n">tbl_name</span> <span class="o">=</span> <span class="n">v_tbl_name</span><span class="p">;</span>
</span><span class='line'>    <span class="k">SET</span> <span class="o">@</span><span class="n">idx_name</span> <span class="o">=</span> <span class="n">v_idx_name</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">EXECUTE</span> <span class="n">stmt</span> <span class="k">USING</span> <span class="o">@</span><span class="n">tbl_name</span><span class="p">,</span> <span class="o">@</span><span class="n">idx_name</span><span class="p">;</span>
</span><span class='line'><span class="k">END</span> <span class="n">WHILE</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">DEALLOCATE</span> <span class="k">PREPARE</span> <span class="n">stmt</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">CLOSE</span> <span class="n">v_cur</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<hr />

<p>普段はあまり使用する機会はありませんが、大量のテーブルを再設計する際には有益でしょう。</p>

<p>以上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[2015年08月 - OS・ブラウザ別アクセス状況！【自動集計】]]></title>
    <link href="http://komasaru.github.io/blog/2015/09/01/blog-access/"/>
    <updated>2015-09-01T00:20:00+09:00</updated>
    <id>http://komasaru.github.io/blog/2015/09/01/blog-access</id>
    <content type="html"><![CDATA[<p>こんばんは。</p>

<p>09月になりましたので、先月08月分の当ブログアクセス状況を公開します。</p>

<!--more-->


<h4>1. アクセスをOS別に集計</h4>

<table class="blog-access">
  <tr>
    <th>OS</th>
    <th>PageViews</th>
    <th>比率(%)</th>
  </tr>
  <tr>
    <td>Mac OS</td>
    <td class="blog-access-pv">16,753</td>
    <td class="blog-access-rate">58.5524</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td class="blog-access-pv">9,973</td>
    <td class="blog-access-rate">34.8560</td>
  </tr>
  <tr>
    <td>Linux</td>
    <td class="blog-access-pv">867</td>
    <td class="blog-access-rate">3.0302</td>
  </tr>
  <tr>
    <td>Ubuntu Linux</td>
    <td class="blog-access-pv">761</td>
    <td class="blog-access-rate">2.6597</td>
  </tr>
  <tr>
    <td>unknown</td>
    <td class="blog-access-pv">110</td>
    <td class="blog-access-rate">0.3845</td>
  </tr>
  <tr>
    <td>Fedora Linux</td>
    <td class="blog-access-pv">78</td>
    <td class="blog-access-rate">0.2726</td>
  </tr>
  <tr>
    <td>FreeBSD</td>
    <td class="blog-access-pv">37</td>
    <td class="blog-access-rate">0.1293</td>
  </tr>
  <tr>
    <td>Android</td>
    <td class="blog-access-pv">8</td>
    <td class="blog-access-rate">0.0280</td>
  </tr>
  <tr>
    <td>RedHat Linux</td>
    <td class="blog-access-pv">7</td>
    <td class="blog-access-rate">0.0245</td>
  </tr>
  <tr>
    <td>iPhone OS</td>
    <td class="blog-access-pv">6</td>
    <td class="blog-access-rate">0.0210</td>
  </tr>
  <tr>
    <td>Solaris</td>
    <td class="blog-access-pv">5</td>
    <td class="blog-access-rate">0.0175</td>
  </tr>
  <tr>
    <td>CentOS Linux</td>
    <td class="blog-access-pv">3</td>
    <td class="blog-access-rate">0.0105</td>
  </tr>
  <tr>
    <td>Debian GNU/Linux</td>
    <td class="blog-access-pv">3</td>
    <td class="blog-access-rate">0.0105</td>
  </tr>
  <tr>
    <td>NetBSD</td>
    <td class="blog-access-pv">1</td>
    <td class="blog-access-rate">0.0035</td>
  </tr>
  <tr>
    <td class="blog-access-total-label">合　計</td>
    <td class="blog-access-pv">28,612</td>
    <td class="blog-access-rate">100.0000</td>
  </tr>
</table>


<h4>2. アクセスをOS・バージョン別に集計（上位20件）</h4>

<table class="blog-access">
  <tr>
    <th>OS</th>
    <th>Version</th>
    <th>PageViews</th>
    <th>比率(%)</th>
  </tr>
  <tr>
    <td>Mac OS</td>
    <td>X</td>
    <td class="blog-access-pv">16,751</td>
    <td class="blog-access-rate">58.5454</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>NT</td>
    <td class="blog-access-pv">8,184</td>
    <td class="blog-access-rate">28.6034</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>7</td>
    <td class="blog-access-pv">883</td>
    <td class="blog-access-rate">3.0861</td>
  </tr>
  <tr>
    <td>Linux</td>
    <td>unknown</td>
    <td class="blog-access-pv">851</td>
    <td class="blog-access-rate">2.9743</td>
  </tr>
  <tr>
    <td>Ubuntu Linux</td>
    <td>unknown</td>
    <td class="blog-access-pv">758</td>
    <td class="blog-access-rate">2.6492</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>7 64 bit</td>
    <td class="blog-access-pv">462</td>
    <td class="blog-access-rate">1.6147</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>XP</td>
    <td class="blog-access-pv">280</td>
    <td class="blog-access-rate">0.9786</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>Vista</td>
    <td class="blog-access-pv">118</td>
    <td class="blog-access-rate">0.4124</td>
  </tr>
  <tr>
    <td>unknown</td>
    <td>unknown</td>
    <td class="blog-access-pv">110</td>
    <td class="blog-access-rate">0.3845</td>
  </tr>
  <tr>
    <td>Fedora Linux</td>
    <td>unknown</td>
    <td class="blog-access-pv">77</td>
    <td class="blog-access-rate">0.2691</td>
  </tr>
  <tr>
    <td>FreeBSD</td>
    <td>unknown</td>
    <td class="blog-access-pv">33</td>
    <td class="blog-access-rate">0.1153</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>8 64 bit</td>
    <td class="blog-access-pv">33</td>
    <td class="blog-access-rate">0.1153</td>
  </tr>
  <tr>
    <td>Linux</td>
    <td></td>
    <td class="blog-access-pv">10</td>
    <td class="blog-access-rate">0.0350</td>
  </tr>
  <tr>
    <td>Linux</td>
    <td>64 bit</td>
    <td class="blog-access-pv">6</td>
    <td class="blog-access-rate">0.0210</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>Vista 64 bit</td>
    <td class="blog-access-pv">6</td>
    <td class="blog-access-rate">0.0210</td>
  </tr>
  <tr>
    <td>Windows</td>
    <td>Server 2003</td>
    <td class="blog-access-pv">6</td>
    <td class="blog-access-rate">0.0210</td>
  </tr>
  <tr>
    <td>Solaris</td>
    <td>unknown</td>
    <td class="blog-access-pv">4</td>
    <td class="blog-access-rate">0.0140</td>
  </tr>
  <tr>
    <td>RedHat Linux</td>
    <td>3.6.24-3.el6 64 bit</td>
    <td class="blog-access-pv">4</td>
    <td class="blog-access-rate">0.0140</td>
  </tr>
  <tr>
    <td>FreeBSD</td>
    <td>64 bit</td>
    <td class="blog-access-pv">4</td>
    <td class="blog-access-rate">0.0140</td>
  </tr>
  <tr>
    <td>iPhone OS</td>
    <td>4_3_5</td>
    <td class="blog-access-pv">4</td>
    <td class="blog-access-rate">0.0140</td>
  </tr>
  <tr>
    <td class="blog-access-dot">:</td>
    <td class="blog-access-dot">:</td>
    <td class="blog-access-dot">:</td>
    <td class="blog-access-dot">:</td>
  </tr>
  <tr>
    <td class="blog-access-total-label">合　計</td>
    <td> </td>
    <td class="blog-access-pv">28,612</td>
    <td class="blog-access-rate">100.0000</td>
  </tr>
</table>


<h4>3. アクセスをブラウザ別に集計</h4>

<table class="blog-access">
  <tr>
    <th>ブラウザ</th>
    <th>PageViews</th>
    <th>比率(%)</th>
  </tr>
  <tr>
    <td>Safari</td>
    <td class="blog-access-pv">16,267</td>
    <td class="blog-access-rate">56.8538</td>
  </tr>
  <tr>
    <td>Mozilla Firefox</td>
    <td class="blog-access-pv">6,938</td>
    <td class="blog-access-rate">24.2486</td>
  </tr>
  <tr>
    <td>Mozilla</td>
    <td class="blog-access-pv">3,045</td>
    <td class="blog-access-rate">10.6424</td>
  </tr>
  <tr>
    <td>Internet Explorer</td>
    <td class="blog-access-pv">1,943</td>
    <td class="blog-access-rate">6.7909</td>
  </tr>
  <tr>
    <td>Debian IceWeasel</td>
    <td class="blog-access-pv">226</td>
    <td class="blog-access-rate">0.7899</td>
  </tr>
  <tr>
    <td>Opera</td>
    <td class="blog-access-pv">97</td>
    <td class="blog-access-rate">0.3390</td>
  </tr>
  <tr>
    <td>Netscape Navigator</td>
    <td class="blog-access-pv">46</td>
    <td class="blog-access-rate">0.1608</td>
  </tr>
  <tr>
    <td>Chrome</td>
    <td class="blog-access-pv">16</td>
    <td class="blog-access-rate">0.0559</td>
  </tr>
  <tr>
    <td>Mozilla SeaMonkey</td>
    <td class="blog-access-pv">9</td>
    <td class="blog-access-rate">0.0315</td>
  </tr>
  <tr>
    <td>Epiphany</td>
    <td class="blog-access-pv">7</td>
    <td class="blog-access-rate">0.0245</td>
  </tr>
  <tr>
    <td>Unknown</td>
    <td class="blog-access-pv">5</td>
    <td class="blog-access-rate">0.0175</td>
  </tr>
  <tr>
    <td>iPod</td>
    <td class="blog-access-pv">4</td>
    <td class="blog-access-rate">0.0140</td>
  </tr>
  <tr>
    <td>PHP</td>
    <td class="blog-access-pv">2</td>
    <td class="blog-access-rate">0.0070</td>
  </tr>
  <tr>
    <td>Konqueror</td>
    <td class="blog-access-pv">2</td>
    <td class="blog-access-rate">0.0070</td>
  </tr>
  <tr>
    <td>iPhone</td>
    <td class="blog-access-pv">2</td>
    <td class="blog-access-rate">0.0070</td>
  </tr>
  <tr>
    <td>Chromium</td>
    <td class="blog-access-pv">1</td>
    <td class="blog-access-rate">0.0035</td>
  </tr>
  <tr>
    <td>Sleipnir</td>
    <td class="blog-access-pv">1</td>
    <td class="blog-access-rate">0.0035</td>
  </tr>
  <tr>
    <td>SRWare Iron</td>
    <td class="blog-access-pv">1</td>
    <td class="blog-access-rate">0.0035</td>
  </tr>
  <tr>
    <td class="blog-access-total-label">合　計</td>
    <td class="blog-access-pv">28,612</td>
    <td class="blog-access-rate">100.0000</td>
  </tr>
</table>


<h4>4. アクセスをブラウザ・バージョン別に集計（上位20件）</h4>

<table class="blog-access">
  <tr>
    <th>ブラウザ</th>
    <th>Version</th>
    <th>PageViews</th>
    <th>比率(%)</th>
  </tr>
  <tr>
    <td>Safari</td>
    <td>537.36</td>
    <td class="blog-access-pv">12,364</td>
    <td class="blog-access-rate">43.2126</td>
  </tr>
  <tr>
    <td>Mozilla Firefox</td>
    <td>39.0</td>
    <td class="blog-access-pv">4,251</td>
    <td class="blog-access-rate">14.8574</td>
  </tr>
  <tr>
    <td>Mozilla</td>
    <td>11.0</td>
    <td class="blog-access-pv">3,043</td>
    <td class="blog-access-rate">10.6354</td>
  </tr>
  <tr>
    <td>Safari</td>
    <td>9537.53</td>
    <td class="blog-access-pv">1,927</td>
    <td class="blog-access-rate">6.7349</td>
  </tr>
  <tr>
    <td>Mozilla Firefox</td>
    <td>40.0</td>
    <td class="blog-access-pv">1,318</td>
    <td class="blog-access-rate">4.6065</td>
  </tr>
  <tr>
    <td>Safari</td>
    <td>600.1.4</td>
    <td class="blog-access-pv">804</td>
    <td class="blog-access-rate">2.8100</td>
  </tr>
  <tr>
    <td>Internet Explorer</td>
    <td>8.0</td>
    <td class="blog-access-pv">796</td>
    <td class="blog-access-rate">2.7820</td>
  </tr>
  <tr>
    <td>Safari</td>
    <td>600.7.12</td>
    <td class="blog-access-pv">587</td>
    <td class="blog-access-rate">2.0516</td>
  </tr>
  <tr>
    <td>Mozilla Firefox</td>
    <td>38.0</td>
    <td class="blog-access-pv">558</td>
    <td class="blog-access-rate">1.9502</td>
  </tr>
  <tr>
    <td>Internet Explorer</td>
    <td>10.0</td>
    <td class="blog-access-pv">447</td>
    <td class="blog-access-rate">1.5623</td>
  </tr>
  <tr>
    <td>Internet Explorer</td>
    <td>9.0</td>
    <td class="blog-access-pv">443</td>
    <td class="blog-access-rate">1.5483</td>
  </tr>
  <tr>
    <td>Internet Explorer</td>
    <td>7.0</td>
    <td class="blog-access-pv">256</td>
    <td class="blog-access-rate">0.8947</td>
  </tr>
  <tr>
    <td>Mozilla Firefox</td>
    <td>31.0</td>
    <td class="blog-access-pv">225</td>
    <td class="blog-access-rate">0.7864</td>
  </tr>
  <tr>
    <td>Safari</td>
    <td>534.30</td>
    <td class="blog-access-pv">176</td>
    <td class="blog-access-rate">0.6151</td>
  </tr>
  <tr>
    <td>Mozilla Firefox</td>
    <td>41.0</td>
    <td class="blog-access-pv">127</td>
    <td class="blog-access-rate">0.4439</td>
  </tr>
  <tr>
    <td>Debian IceWeasel</td>
    <td>31.8.0</td>
    <td class="blog-access-pv">105</td>
    <td class="blog-access-rate">0.3670</td>
  </tr>
  <tr>
    <td>Opera</td>
    <td>9.80</td>
    <td class="blog-access-pv">97</td>
    <td class="blog-access-rate">0.3390</td>
  </tr>
  <tr>
    <td>Mozilla Firefox</td>
    <td>37.0</td>
    <td class="blog-access-pv">71</td>
    <td class="blog-access-rate">0.2481</td>
  </tr>
  <tr>
    <td>Safari</td>
    <td>537.85.16</td>
    <td class="blog-access-pv">71</td>
    <td class="blog-access-rate">0.2481</td>
  </tr>
  <tr>
    <td>Safari</td>
    <td>600.8.9</td>
    <td class="blog-access-pv">58</td>
    <td class="blog-access-rate">0.2027</td>
  </tr>
  <tr>
    <td class="blog-access-dot">:</td>
    <td class="blog-access-dot">:</td>
    <td class="blog-access-dot">:</td>
    <td class="blog-access-dot">:</td>
  </tr>
  <tr>
    <td class="blog-access-total-label">合　計</td>
    <td> </td>
    <td class="blog-access-pv">28,612</td>
    <td class="blog-access-rate">100.0000</td>
  </tr>
</table>


<hr />

<p>以上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ruby - dRuby でジョブキューサーバ構築！]]></title>
    <link href="http://komasaru.github.io/blog/2015/08/29/ruby-job-queue-server-construction-by-druby/"/>
    <updated>2015-08-29T00:20:00+09:00</updated>
    <id>http://komasaru.github.io/blog/2015/08/29/ruby-job-queue-server-construction-by-druby</id>
    <content type="html"><![CDATA[<p>こんばんは。</p>

<p>前回に引き続き、Ruby の分散オブジェクトプログラミングするためのライブラリ dRuby についての内容です。</p>

<p>今回は、 dRuby を利用してジョブキューサーバ＆クライアントを構築してみました。</p>

<p>要は、キューに順次プッシュした内容をクライアント側から順次ポップする仕組みのことです。</p>

<!--more-->


<h3>0. 前提条件</h3>

<ul>
<li>Linux Mint 17.2(64bit) での作業を想定。</li>
<li>Ruby 2.2.3-p173 での作業を想定。</li>
<li>本来は複数のマシンで実行することが多いと思うが、今回は１つのマシンでテストする。</li>
<li>dRuby の簡単な使用例は「<a href="http://komasaru.github.io/2015/08/25/ruby-distributed-processing-by-druby" title="Ruby - dRuby で分散処理！">Ruby - dRuby で分散処理！</a>」を参照。</li>
</ul>


<h3>1. サーバ側スクリプトの作成例</h3>

<p>Queue オブジェクトを生成して待ち受けるのみの簡単なスクリプト。</p>

<figure class='code'><figcaption><span>queue_server.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/local/bin/ruby</span>
</span><span class='line'><span class="c1"># codeing: utf-8</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;drb/drb&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">q</span> <span class="o">=</span> <span class="no">Queue</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="no">DRb</span><span class="o">.</span><span class="n">start_service</span><span class="p">(</span><span class="s2">&quot;druby://localhost:8787&quot;</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="ss">safe_level</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="no">DRb</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">join</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>start_service</code> の <code>safe_level</code> を <code>1</code> に設定しているのは、 <code>instance_eval</code> による危険性を防ぐための処置。</li>
</ul>


<h3>2. クライアント側 Pop スクリプトの作成例</h3>

<p>キューサーバから順次ポップして5秒後にコンソール出力するのみの簡単なスクリプト。（キューに溜め込まれるデータは時刻文字列を想定している）</p>

<figure class='code'><figcaption><span>pop_client.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/local/bin/ruby</span>
</span><span class='line'><span class="c1"># coding: utf-8</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;drb/drb&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">obj</span> <span class="o">=</span> <span class="no">DRbObject</span><span class="o">.</span><span class="n">new_with_uri</span><span class="p">(</span><span class="s2">&quot;druby://localhost:8787&quot;</span><span class="p">)</span>
</span><span class='line'><span class="kp">loop</span> <span class="k">do</span> <span class="o">|</span><span class="n">a</span><span class="o">|</span>
</span><span class='line'>  <span class="n">tm</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">pop</span>
</span><span class='line'>  <span class="nb">sleep</span> <span class="mi">5</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Received at </span><span class="si">#{</span><span class="n">tm</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>3. クライアント側 Push スクリプトの作成例</h3>

<p>キューサーバへ現在時刻の文字列をプッシュするのみの簡単なスクリプト。</p>

<figure class='code'><figcaption><span>push_client.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#! /usr/local/bin/ruby</span>
</span><span class='line'><span class="c1"># coding: utf-8</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;drb/drb&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">obj</span> <span class="o">=</span> <span class="no">DRbObject</span><span class="o">.</span><span class="n">new_with_uri</span><span class="p">(</span><span class="s2">&quot;druby://localhost:8787&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">tm</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-%d %H:%M:%S&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">obj</span><span class="o">.</span><span class="n">push</span> <span class="n">tm</span>
</span><span class='line'><span class="nb">puts</span> <span class="s2">&quot;Sended at </span><span class="si">#{</span><span class="n">tm</span><span class="si">}</span><span class="s2">.&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>4. 動作確認</h3>

<p>まず、１つ目の端末を立ち上げて、サーバ側スクリプトを実行する。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ ./queue_server.rb
</span></code></pre></td></tr></table></div></figure>


<p>次に、２つ目の端末を立ち上げて、クライアント側 Pop スクリプトを実行する。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ ./pop_client.rb
</span></code></pre></td></tr></table></div></figure>


<p>最後に、３つ目の端末を立ち上げて、クライアント側 Push スクリプトを何度も連続して実行してみる。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ ./push_client.rb
</span><span class='line'>Sended at 2015-07-28 23:34:02.
</span><span class='line'>$ ./push_client.rb
</span><span class='line'>Sended at 2015-07-28 23:34:03.
</span><span class='line'>$ ./push_client.rb
</span><span class='line'>Sended at 2015-07-28 23:34:03.
</span><span class='line'>$ ./push_client.rb
</span><span class='line'>Sended at 2015-07-28 23:34:04.
</span><span class='line'>$ ./push_client.rb
</span><span class='line'>Sended at 2015-07-28 23:34:04.
</span></code></pre></td></tr></table></div></figure>


<p>すると、２つ目の Pop クライアントの端末に５秒間隔で出力がなされるはずである。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ ./pop_client.rb
</span><span class='line'>Received at 2015-07-28 23:34:02.
</span><span class='line'>Received at 2015-07-28 23:34:03.
</span><span class='line'>Received at 2015-07-28 23:34:03.
</span><span class='line'>Received at 2015-07-28 23:34:04.
</span><span class='line'>Received at 2015-07-28 23:34:04.
</span></code></pre></td></tr></table></div></figure>


<h3>5. 注意</h3>

<ul>
<li>dRuby で構築したサーバをインターネットで外部に公開すべきではない。</li>
<li>ローカルで使用する際もセキュリティ面に注意する。</li>
</ul>


<h3>6. 参考サイト</h3>

<ul>
<li><a href="http://docs.ruby-lang.org/ja/2.2.0/library/drb.html" title="library drb(Ruby2.2.0)">library drb(Ruby2.2.0)</a></li>
</ul>


<hr />

<p>当方、一度に並列で処理をされては困るような場合に、この仕組みを応用して順次処理を行うようにしています。<br/>
（インターネット上からデータが配信されたら処理を行うようなシステムの場合に、データが集中的に配信されてもマシンに負荷をかけないようにするため）</p>

<p>以上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ruby - dRuby で分散処理！]]></title>
    <link href="http://komasaru.github.io/blog/2015/08/25/ruby-distributed-processing-by-druby/"/>
    <updated>2015-08-25T00:20:00+09:00</updated>
    <id>http://komasaru.github.io/blog/2015/08/25/ruby-distributed-processing-by-druby</id>
    <content type="html"><![CDATA[<p>こんばんは。</p>

<p>dRuby とは、 Ruby で分散オブジェクトプログラミングするためのライブラリです。</p>

<!--more-->


<h3>0. 前提条件</h3>

<ul>
<li>Linux Mint 17.2(64bit) での作業を想定。</li>
<li>Ruby 2.2.3-p173 での作業を想定。</li>
<li>本来は複数のマシンで実行することが多いと思うが、今回は１つのマシンでテストする。</li>
<li>特に別途インストールの必要なライブラリ等はない。</li>
</ul>


<h3>1. サーバ側スクリプトの作成例</h3>

<p>日付・時刻の文字列を返すだけの簡単な例。</p>

<figure class='code'><figcaption><span>druby_server.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/local/bin/ruby</span>
</span><span class='line'><span class="c1"># coding: utf-8</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;drb/drb&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 通信を待ち受ける URI</span>
</span><span class='line'><span class="no">URI</span><span class="o">=</span><span class="s2">&quot;druby://localhost:8787&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">DrubyServer</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">get_cur_time</span>
</span><span class='line'>    <span class="n">cur_time</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y年%m月%d日 %H時%M分%S秒&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;ただいま </span><span class="si">#{</span><span class="n">cur_time</span><span class="si">}</span><span class="s2"> です。&quot;</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="n">msg</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">msg</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># リクエストを受け付けるオブジェクト</span>
</span><span class='line'><span class="n">obj</span> <span class="o">=</span> <span class="no">DrubyServer</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="c1"># サーバの起動</span>
</span><span class='line'><span class="no">DRb</span><span class="o">.</span><span class="n">start_service</span><span class="p">(</span><span class="no">URI</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="ss">safe_level</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="c1"># DRb スレッド終了の待ち受け</span>
</span><span class='line'><span class="no">DRb</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">join</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>start_service</code> の <code>safe_level</code> を <code>1</code> に設定しているのは、 <code>instance_eval</code> による危険性を防ぐための処置。</li>
</ul>


<h3>2. クライアント側スクリプトの作成例</h3>

<p>サーバのメソットを呼び出す簡単な例。</p>

<figure class='code'><figcaption><span>druby_client.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/local/bin/ruby</span>
</span><span class='line'><span class="c1"># coding: utf-8</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;drb/drb&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 接続先 URI</span>
</span><span class='line'><span class="no">URI</span><span class="o">=</span><span class="s2">&quot;druby://localhost:8787&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># リモートオブジェクトの取得</span>
</span><span class='line'><span class="n">obj</span> <span class="o">=</span> <span class="no">DRbObject</span><span class="o">.</span><span class="n">new_with_uri</span><span class="p">(</span><span class="no">URI</span><span class="p">)</span>
</span><span class='line'><span class="c1"># リモートメソッドの呼び出し</span>
</span><span class='line'><span class="nb">puts</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_cur_time</span>
</span></code></pre></td></tr></table></div></figure>


<h3>3. 動作確認</h3>

<p>まず、１つ目の端末を立ち上げて、サーバ側スクリプトを実行する。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ ./druby_server.rb
</span></code></pre></td></tr></table></div></figure>


<p>そして、もう１つ端末を立ち上げて、クライアント側スクリプトを実行する。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ ./druby_client.rb
</span><span class='line'>ただいま 2015年07月22日 24時31分16秒 です。
</span><span class='line'>$ ./druby_client.rb
</span><span class='line'>ただいま 2015年07月22日 24時32分30秒 です。
</span></code></pre></td></tr></table></div></figure>


<p>クライアント側スクリプトを実行する度にサーバ側で処理した結果が出力されるはずである。<br/>
また、この時サーバ側の端末にも同じ出力がされるはずである。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ ./druby_server.rb
</span><span class='line'>ただいま 2015年07月22日 24時31分16秒 です。
</span><span class='line'>ただいま 2015年07月22日 24時32分30秒 です。
</span></code></pre></td></tr></table></div></figure>


<h3>4. 注意</h3>

<ul>
<li>dRuby で構築したサーバをインターネットで外部に公開すべきではない。</li>
<li>ローカルで使用する際もセキュリティ面に注意する。</li>
</ul>


<h3>5. 参考サイト</h3>

<ul>
<li><a href="http://docs.ruby-lang.org/ja/2.2.0/library/drb.html" title="library drb (Ruby 2.2.0)">library drb (Ruby 2.2.0)</a></li>
</ul>


<hr />

<p>この dRuby による分散処理をいろいろ応用できそうです。</p>

<p>実際、目論んでいることもありますし。</p>

<p>以上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[MariaDB 10.0.x - Mroonga プラグインの有効化！]]></title>
    <link href="http://komasaru.github.io/blog/2015/08/21/mariadb-mroonga-installation/"/>
    <updated>2015-08-21T00:20:00+09:00</updated>
    <id>http://komasaru.github.io/blog/2015/08/21/mariadb-mroonga-installation</id>
    <content type="html"><![CDATA[<p>こんばんは。</p>

<p>全文検索エンジン Groonga をベースとした MySQL のストレージエンジン Mroonga を MariaDB で使用する方法についての簡単な記録です。</p>

<p>MariaDB 10.0.x では Mroonga のプラグインがバンドルされているので、 Mroonga を別途インストールする必要はありません。<br/>
プラグインを有効にすればすぐに使用できるようになります。（但し、バンドルされている Mroonga はバージョンが少し古いようなので、最新バージョンを使用したければ別途インストールする必要があります）</p>

<p>（Groonga, Mroonga については不勉強で疎いため、乱文ご容赦ください）</p>

<!--more-->


<h3>0. 前提条件</h3>

<ul>
<li>MariaDB 10.0.21 (on Linux Mint 17.2) での作業を想定。</li>
</ul>


<h3>1. プラグインの有効化</h3>

<p>以下の SQL を実行して、プラグインを有効にする。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt; INSTALL PLUGIN Mroonga SONAME &#39;ha_mroonga.so&#39;;
</span><span class='line'>&gt; CREATE FUNCTION last_insert_grn_id RETURNS INTEGER SONAME &#39;ha_mroonga.so&#39;;
</span><span class='line'>&gt; CREATE FUNCTION mroonga_snippet RETURNS STRING SONAME &#39;ha_mroonga.so&#39;;
</span><span class='line'>&gt; CREATE FUNCTION mroonga_command RETURNS STRING SONAME &#39;ha_mroonga.so&#39;;
</span><span class='line'>&gt; CREATE FUNCTION mroonga_escape RETURNS STRING SONAME &#39;ha_mroonga.so&#39;;
</span></code></pre></td></tr></table></div></figure>


<h3>2. プラグイン有効化の確認</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt; SHOW ENGINES;
</span><span class='line'>+--------------------+---------+----------------------------------------------------------------------------+--------------+------+------------+
</span><span class='line'>| Engine             | Support | Comment                                                                    | Transactions | XA   | Savepoints |
</span><span class='line'>+--------------------+---------+----------------------------------------------------------------------------+--------------+------+------------+
</span><span class='line'>| MEMORY             | YES     | Hash based, stored in memory, useful for temporary tables                  | NO           | NO   | NO         |
</span><span class='line'>| CSV                | YES     | CSV storage engine                                                         | NO           | NO   | NO         |
</span><span class='line'>| PERFORMANCE_SCHEMA | YES     | Performance Schema                                                         | NO           | NO   | NO         |
</span><span class='line'>| BLACKHOLE          | YES     | /dev/null storage engine (anything you write to it disappears)             | NO           | NO   | NO         |
</span><span class='line'>| MyISAM             | YES     | MyISAM storage engine                                                      | NO           | NO   | NO         |
</span><span class='line'>| MRG_MyISAM         | YES     | Collection of identical MyISAM tables                                      | NO           | NO   | NO         |
</span><span class='line'>| Mroonga            | YES     | CJK-ready fulltext search, column store                                    | NO           | NO   | NO         |
</span><span class='line'>| FEDERATED          | YES     | FederatedX pluggable storage engine                                        | YES          | NO   | YES        |
</span><span class='line'>| InnoDB             | DEFAULT | Percona-XtraDB, Supports transactions, row-level locking, and foreign keys | YES          | YES  | YES        |
</span><span class='line'>| Aria               | YES     | Crash-safe tables with MyISAM heritage                                     | NO           | NO   | NO         |
</span><span class='line'>| ARCHIVE            | YES     | Archive storage engine                                                     | NO           | NO   | NO         |
</span><span class='line'>+--------------------+---------+----------------------------------------------------------------------------+--------------+------+------------+
</span><span class='line'>11 rows in set (0.00 sec)
</span></code></pre></td></tr></table></div></figure>


<h3>3. テーブルの作成方法</h3>

<p>以下は、ストレージモードでテーブルを作成する場合で、 <code>col_name_2</code> に全文検索インデックスを張る例（トークナイザはデフォルトの &ldquo;TokenBigram"）。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt; CREATE TABLE table_name(
</span><span class='line'>&gt;   id INT PRIMARY KEY AUTO_INCREMENT,
</span><span class='line'>&gt;   col_name_1 VARCHAR(255),
</span><span class='line'>&gt;   col_name_2 VARCHAR(255),
</span><span class='line'>&gt;   FULLTEXT INDEX (col_name_2)
</span><span class='line'>&gt; ) ENGINE = Mroonga DEFAULT CHARSET utf8;
</span></code></pre></td></tr></table></div></figure>


<p>以下は、ラッパーモード（元のストレージエンジンは InnoDB）でテーブルを作成する場合で、 <code>col_name_2</code> に全文検索インデックスを張る例（トークナイザはデフォルトの &ldquo;TokenBigram"）。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt; CREATE TABLE table_name (
</span><span class='line'>&gt;   id INT PRIMARY KEY AUTO_INCREMENT,
</span><span class='line'>&gt;   col_name_1 VARCHAR(255),
</span><span class='line'>&gt;   col_name_2 VARCHAR(255),
</span><span class='line'>&gt;   FULLTEXT INDEX (col_name_2)
</span><span class='line'>&gt; ) ENGINE = Mroonga COMMENT = &#39;engine &quot;InnoDB&quot;&#39; DEFAULT CHARSET utf8;
</span></code></pre></td></tr></table></div></figure>


<p>※但し、 MariaDB では <code>FULLTEXT INDEX</code> で設定しても <code>FULLTEXT KEY</code> で登録される。</p>

<p>ちなみに、テーブルデフォルトのトークナイザを MeCab に変更したい場合は以下のようにする。（設定ファイルで指定することも可能）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt; ) ENGINE = Mroonga COMMENT=&#39;default_tokenizer &quot;TokenMecab&quot;&#39; DEFAULT CHARSET utf8;
</span></code></pre></td></tr></table></div></figure>


<p>FULLTEXT INDEX のパーサのみ変更したい場合は以下のようにする。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt;   FULLTEXT INDEX (col_name_2) COMMENT=&#39;parser &quot;TokenMecab&quot;&#39;
</span></code></pre></td></tr></table></div></figure>


<h3>4. 検索例</h3>

<p>以下は、テーブル table_name の col_name_2 に「松江」を含み「出雲」を含まないレコードを検索する例。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="o">*</span><span class="p">,</span> <span class="k">MATCH</span> <span class="p">(</span><span class="n">col_name_2</span><span class="p">)</span> <span class="n">AGAINST</span><span class="p">(</span><span class="ss">&quot;+松江 -出雲&quot;</span> <span class="k">IN</span> <span class="nb">BOOLEAN</span> <span class="k">MODE</span><span class="p">)</span>
</span><span class='line'><span class="o">&gt;</span>   <span class="k">FROM</span> <span class="k">table_name</span>
</span><span class='line'><span class="o">&gt;</span>  <span class="k">WHERE</span> <span class="k">MATCH</span> <span class="p">(</span><span class="n">col_name_2</span><span class="p">)</span> <span class="n">AGAINST</span><span class="p">(</span><span class="ss">&quot;+松江 -出雲&quot;</span> <span class="k">IN</span> <span class="nb">BOOLEAN</span> <span class="k">MODE</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>SELECT</code> 句内の <code>MATCH ... AGAINST ...</code> は、検索スコア。</li>
<li><code>IN BOOLEAN MODE</code> は、マッチ率の概念を省いて、単純にかつ機械的に検索するモード。</li>
</ul>


<p>ちなみに、当方で 30 万件ほどレコードのあるテーブルで同様に検索してみた結果、 <code>WHERE</code> 句を</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">WHERE</span> <span class="n">col_name_2</span> <span class="k">LIKE</span> <span class="s1">&#39;%松江%&#39;</span> <span class="k">AND</span> <span class="n">col_name_2</span> <span class="k">NOT</span> <span class="k">LIKE</span> <span class="s1">&#39;%出雲%&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>にして検索するより約 100 倍高速に検索できました。さらに、レコード約 1,300 万件では 約 500 倍高速に検索できました。<br/>
（テーブルレイアウト、レコード数等にもよるでしょうが）</p>

<h3>5. 参考サイト</h3>

<ul>
<li><a href="http://mroonga.org/ja/" title="Mroonga - MySQLで高速全文検索">Mroonga - MySQLで高速全文検索</a></li>
</ul>


<p>中でも、Mroonga プラグインの有効については以下を参照。</p>

<ul>
<li><a href="http://mroonga.org/ja/blog/2015/04/29/release.html" title="Mroonga - Mroonga 5.02リリース！">Mroonga - Mroonga 5.02リリース！</a></li>
</ul>


<hr />

<p>検索の高速化を図るには必須の機能でしょう。</p>

<p>当方も InnoDB で構築している既存の DB の高速化を図ってみたいところです。</p>

<p>以上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ruby - Rroonga で全文検索！]]></title>
    <link href="http://komasaru.github.io/blog/2015/08/17/ruby-rroonga-fulltext-searching/"/>
    <updated>2015-08-17T00:20:00+09:00</updated>
    <id>http://komasaru.github.io/blog/2015/08/17/ruby-rroonga-fulltext-searching</id>
    <content type="html"><![CDATA[<p>こんばんは。</p>

<p>Ruby でカラムストア機能付き全文検索エンジン Groonga の機能を容易に使用できる Rroonga を使用してみました。</p>

<!--more-->


<h3>0. 前提条件</h3>

<ul>
<li>Linux Mint 17.2(64bit) での作業を想定。</li>
<li>Ruby 2.2.2-p95 での作業を想定。</li>
<li>カラムストア機能付き全文検索エンジン Groonga がインストール済みであること。</li>
</ul>


<h3>1. Rroonga のインストール</h3>

<p>以下のようにしてインストールする。<br/>
（ちなみ、 Groonga 未インストールなら、ここでインストールされるはず。（当方 Groonga インストール済みなので、未確認））</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ sudo gem install rroonga
</span></code></pre></td></tr></table></div></figure>


<h3>2. データベースの作成</h3>

<p>簡単な都道府県名データベースを作成してみる。</p>

<p>取り急ぎ対話形式で作業を行いたいので、 pry(or irb) に入る。（プロンプトを簡易表示。 <code>groonga</code> を <code>require</code> して）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ pry --simple-prompt -r groonga
</span></code></pre></td></tr></table></div></figure>


<p>まず、エンコーディングの設定を行う。（今回は Linux なので UTF-8 に設定）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt;&gt; Groonga::Context.default_options = {:encoding =&gt; :utf8}
</span><span class='line'>=&gt; {:encoding=&gt;:utf8}
</span></code></pre></td></tr></table></div></figure>


<p>そして、データベースを作成する。（データベースファイル名を指定）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt;&gt; Groonga::Database.create(:path =&gt; &quot;/path/to/prefs.db&quot;)
</span><span class='line'>=&gt; #&lt;Groonga::Database id: &lt;nil&gt;, name: (anonymous), path: &lt;/path/to/prefs.db&gt;, domain: (nil), range: (nil), flags: &lt;&gt;&gt;
</span></code></pre></td></tr></table></div></figure>


<h3>3. テーブルの作成</h3>

<p>都道府県名テーブルを作成してみる。（テーブル名、テーブルタイプを指定）<br/>
（テーブルタイプには <code>hash</code>, <code>patricia_trie</code>, <code>double_array_trie</code>, <code>array</code> が指定可能）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt;&gt; Groonga::Schema.create_table(&quot;Prefs&quot;, :type =&gt; :hash) do |tbl|
</span><span class='line'> |   tbl.text(&quot;pref_name&quot;)
</span><span class='line'> | end
</span><span class='line'>=&gt; [#&lt;Groonga::Schema::TableDefinition:0x007f9fe62cef60
</span><span class='line'>  @definitions=
</span><span class='line'>   [#&lt;Groonga::Schema::ColumnDefinition:0x007f9fe62ce1f0
</span><span class='line'>     @name=&quot;pref_name&quot;,
</span><span class='line'>     @options={:persistent=&gt;true, :named_path=&gt;nil},
</span><span class='line'>     @type=&quot;Text&quot;&gt;],
</span><span class='line'>  @name=&quot;Prefs&quot;,
</span><span class='line'>  @options=
</span><span class='line'>   {:context=&gt;
</span><span class='line'>     #&lt;Groonga::Context encoding: &lt;:utf8&gt;, database: &lt;#&lt;Groonga::Database id: &lt;nil&gt;, name: (anonymous), path: &lt;/path/to/prefs.db&gt;, domain: (nil), range: (nil), flags: &lt;&gt;&gt;&gt;&gt;,
</span><span class='line'>    :type=&gt;:hash},
</span><span class='line'>  @table_type=Groonga::Hash&gt;]
</span></code></pre></td></tr></table></div></figure>


<p>テーブルが作成されたか確認してみる。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt;&gt; prefs = Groonga[&quot;Prefs&quot;]
</span><span class='line'>=&gt; #&lt;Groonga::Hash id: &lt;256&gt;, name: &lt;Prefs&gt;, path: &lt;/path/to/prefs.db.0000100&gt;, domain: &lt;ShortText&gt;, range: (nil), flags: &lt;&gt;, size: &lt;0&gt;, encoding: &lt;:utf8&gt;, default_tokenizer: (nil), token_filters: [], normalizer: (nil)&gt;
</span><span class='line'>&gt;&gt; prefs.size
</span><span class='line'>=&gt; 0
</span></code></pre></td></tr></table></div></figure>


<h3>4. レコードの追加</h3>

<p>以下のようにして、テーブルにレコードを追加していく。（47都道府県分。別途作成しておいた配列をループさせて登録するのがよいだろう）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt;&gt; prefs.add(&quot;Hokkaido&quot;, :pref_name =&gt; &quot;北海道&quot;)
</span><span class='line'>=&gt; #&lt;Groonga::Record:0x007f9fe69e4480 ..., attributes: {&quot;_id&quot;=&gt;1, &quot;_key&quot;=&gt;&quot;Hokkaido&quot;, &quot;pref_name&quot;=&gt;&quot;北海道&quot;}&gt;
</span></code></pre></td></tr></table></div></figure>


<p>以下のような方法で追加することも可能。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt;&gt; prefs.add(&quot;Aomoriken&quot;)
</span><span class='line'>=&gt; #&lt;Groonga::Record:0x007f9fe6755020 ..., attributes: {&quot;_id&quot;=&gt;3, &quot;_key&quot;=&gt;&quot;Aomoriken&quot;, &quot;pref_name&quot;=&gt;nil}&gt;
</span><span class='line'>&gt;&gt; prefs[&quot;Aomoriken&quot;].pref_name = &quot;青森県&quot;
</span><span class='line'>=&gt; &quot;青森県&quot;
</span></code></pre></td></tr></table></div></figure>


<p>ちなみに、削除するには以下のようにする。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt;&gt; prefs.delete(&quot;Aomoriken&quot;)
</span><span class='line'>=&gt; nil
</span></code></pre></td></tr></table></div></figure>


<h3>5. レコードの参照</h3>

<p>登録したレコードを参照してみる。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt;&gt; prefs[&quot;Shimaneken&quot;]
</span><span class='line'>=&gt; #&lt;Groonga::Record:0x007f9fe671a1f0 ..., attributes: {&quot;_id&quot;=&gt;32, &quot;_key&quot;=&gt;&quot;Shimaneken&quot;, &quot;pref_name&quot;=&gt;&quot;島根県&quot;}&gt;
</span><span class='line'>
</span><span class='line'>&gt;&gt; prefs[&quot;Shimaneken&quot;].id
</span><span class='line'>=&gt; 32
</span><span class='line'>
</span><span class='line'>&gt;&gt; prefs[&quot;Shimaneken&quot;].key
</span><span class='line'>=&gt; &quot;Shimaneken&quot;
</span><span class='line'>
</span><span class='line'>&gt;&gt; prefs[&quot;Shimaneken&quot;].pref_name
</span><span class='line'>=&gt; &quot;島根県&quot;
</span><span class='line'>
</span><span class='line'>&gt;&gt; prefs.size
</span><span class='line'>=&gt; 47
</span></code></pre></td></tr></table></div></figure>


<h3>6. 全文検索用語彙テーブルの作成</h3>

<p>全文検索用語彙テーブルを作成する。（以下は、テーブルタイプを PatriciaTrie に、ノーマライザを大文字小文字の区別をしない NormalizerAuto に、デフォルトトークナイザを N-gram の一種バイグラムに設定する例）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt;&gt; Groonga::Schema.create_table(&quot;Terms&quot;,
</span><span class='line'> |   :type =&gt; :patricia_trie,
</span><span class='line'> |   :normalizer =&gt; :NormalizerAuto,
</span><span class='line'> | :default_tokenizer =&gt; &quot;TokenBigram&quot;)
</span><span class='line'>=&gt; [#&lt;Groonga::Schema::TableDefinition:0x007f9fe6bb9cb0
</span><span class='line'>  @definitions=[],
</span><span class='line'>  @name=&quot;Terms&quot;,
</span><span class='line'>  @options=
</span><span class='line'>   {:context=&gt;
</span><span class='line'>     #&lt;Groonga::Context encoding: &lt;:utf8&gt;, database: &lt;#&lt;Groonga::Database id: &lt;nil&gt;, name: (anonymous), path: &lt;/path/to/prefs.db&gt;, domain: (nil), range: (nil), flags: &lt;&gt;&gt;&gt;&gt;,
</span><span class='line'>    :type=&gt;:patricia_trie,
</span><span class='line'>    :normalizer=&gt;:NormalizerAuto,
</span><span class='line'>    :default_tokenizer=&gt;&quot;TokenBigram&quot;},
</span><span class='line'>  @table_type=Groonga::PatriciaTrie&gt;]
</span></code></pre></td></tr></table></div></figure>


<h3>7. 全文検索用語彙テーブルのインデックス定義</h3>

<p>今回は都道府県名ローマ字で検索してみることにする。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt;&gt; Groonga::Schema.change_table(&quot;Terms&quot;) do |tbl|
</span><span class='line'> |   tbl.index(&quot;Prefs.pref_name&quot;)
</span><span class='line'> | end
</span><span class='line'>=&gt; [#&lt;Groonga::Schema::TableDefinition:0x007f9fe6a823d8
</span><span class='line'>  @definitions=
</span><span class='line'>   [#&lt;Groonga::Schema::IndexColumnDefinition:0x007f9fe6a81d48
</span><span class='line'>     @name=nil,
</span><span class='line'>     @options={:persistent=&gt;true, :named_path=&gt;nil},
</span><span class='line'>     @target_columns=[&quot;pref_name&quot;],
</span><span class='line'>     @target_table=&quot;Prefs&quot;&gt;],
</span><span class='line'>  @name=&quot;Terms&quot;,
</span><span class='line'>  @options=
</span><span class='line'>   {:context=&gt;
</span><span class='line'>     #&lt;Groonga::Context encoding: &lt;:utf8&gt;, database: &lt;#&lt;Groonga::Database id: &lt;nil&gt;, name: (anonymous), path: &lt;/path/to/prefs.db&gt;, domain: (nil), range: (nil), flags: &lt;&gt;&gt;&gt;&gt;,
</span><span class='line'>    :change=&gt;true},
</span><span class='line'>  @table_type=Groonga::Array&gt;]
</span></code></pre></td></tr></table></div></figure>


<h3>8. 検索の確認</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt;&gt; prefs_shimane = prefs.select { |rec| rec.pref_name =~ &quot;島根県&quot; }    =&gt; #&lt;Groonga::Hash id: &lt;2147483655&gt;, name: (anonymous), path: (temporary), domain: &lt;Prefs&gt;, range: (nil), flags: &lt;WITH_SUBREC&gt;, size: &lt;1&gt;, encoding: &lt;:utf8&gt;, default_tokenizer: (nil), token_filters: [], normalizer: (nil)&gt;
</span><span class='line'>
</span><span class='line'>&gt;&gt; prefs_shimane.size
</span><span class='line'>=&gt; 1
</span><span class='line'>
</span><span class='line'>&gt;&gt; prefs_shimane.collect { |rec| rec.key.key }
</span><span class='line'>=&gt; [&quot;Shimaneken&quot;]
</span><span class='line'>
</span><span class='line'>&gt;&gt; prefs_shimane.collect { |rec| rec[&quot;_key&quot;] }
</span><span class='line'>=&gt; [&quot;Shimaneken&quot;]
</span></code></pre></td></tr></table></div></figure>


<h3>9. 参考サイト</h3>

<ul>
<li><a href="http://groonga.org/ja/" title="Groonga - カラムストア機能付き全文検索エンジン">Groonga - カラムストア機能付き全文検索エンジン</a></li>
<li><a href="http://ranguba.org/ja/" title="RubyでGroonga使って全文検索 - ラングバ">RubyでGroonga使って全文検索 - ラングバ</a></li>
</ul>


<hr />

<p>その他の詳細な使用方法は実際に Ruby コーディングしながら覚えることになるでしょう。</p>

<p>以上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ruby - gnuplot でグラフ描画！]]></title>
    <link href="http://komasaru.github.io/blog/2015/08/13/ruby-graph-drawing-by-gnuplot/"/>
    <updated>2015-08-13T00:20:00+09:00</updated>
    <id>http://komasaru.github.io/blog/2015/08/13/ruby-graph-drawing-by-gnuplot</id>
    <content type="html"><![CDATA[<p>こんばんは。</p>

<p>Ruby で容易にグラフを描画できる RubyGems ライブラリ gnuplot を使用してみました。</p>

<p>RubyGems ライブラリ gnuplot は、2次元や3次元のグラフを描画するためのコマンドラインツール Gnuplot を Ruby で使用できるようにラップしたものです。</p>

<!--more-->


<h3>0. 前提条件</h3>

<ul>
<li>Linux Mint 17.1(64bit) 一般ユーザでの作業を想定。</li>
<li>Ruby 2.2.2-p95 での作業を想定。</li>
<li>Gnuplot インストール済みであること。（<a href="http://komasaru.github.io/2015/07/30/linux-mint-installation-gnuplot/" title="Linux Mint - Gnuplot でグラフ描画！">Linux Mint - Gnuplot でグラフ描画！</a>）</li>
</ul>


<h3>1. RubyGems パッケージのインストール</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ sudo gem install gnuplot
</span></code></pre></td></tr></table></div></figure>


<h3>2. 動作確認</h3>

<h4>2-1. 作成例・１</h4>

<p>単純な<script type="math/tex">sin</script>曲線・<script type="math/tex">cos</script>曲線を描画する例。</p>

<figure class='code'><figcaption><span>gnuplot_1.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#! /usr/local/bin/ruby</span>
</span><span class='line'><span class="c1">#-----------------------------------------------</span>
</span><span class='line'><span class="c1"># Ruby script to draw a graph by gnuplot.(Ex.1)</span>
</span><span class='line'><span class="c1">#-----------------------------------------------</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;gnuplot&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">Gnuplot</span><span class="o">.</span><span class="n">open</span> <span class="k">do</span> <span class="o">|</span><span class="n">gp</span><span class="o">|</span>
</span><span class='line'>  <span class="no">Gnuplot</span><span class="o">::</span><span class="no">Plot</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">gp</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">plot</span><span class="o">|</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">xrange</span> <span class="s2">&quot;[-10:10]&quot;</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">title</span>  <span class="s2">&quot;作成例１&quot;</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">xlabel</span> <span class="s2">&quot;x&quot;</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">ylabel</span> <span class="s2">&quot;y&quot;</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">grid</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="no">Gnuplot</span><span class="o">::</span><span class="no">DataSet</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;sin(x)&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">ds</span><span class="o">|</span>
</span><span class='line'>      <span class="n">ds</span><span class="o">.</span><span class="n">with</span>      <span class="o">=</span> <span class="s2">&quot;lines&quot;</span>
</span><span class='line'>      <span class="n">ds</span><span class="o">.</span><span class="n">linewidth</span> <span class="o">=</span> <span class="mi">2</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="no">Gnuplot</span><span class="o">::</span><span class="no">DataSet</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;cos(x)&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">ds</span><span class="o">|</span>
</span><span class='line'>      <span class="n">ds</span><span class="o">.</span><span class="n">with</span>      <span class="o">=</span> <span class="s2">&quot;lines&quot;</span>
</span><span class='line'>      <span class="n">ds</span><span class="o">.</span><span class="n">linewidth</span> <span class="o">=</span> <span class="mi">2</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><a href="https://gist.github.com/komasaru/18575f0245952cae7d02" title="Gist - Ruby script to draw a graph by gnuplot.(Ex.1)">Gist - Ruby script to draw a graph by gnuplot.(Ex.1)</a></li>
</ul>


<p>そして、実行権限を付与して実行。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ sudo chmod +x gnuplot_1.rb
</span><span class='line'>
</span><span class='line'>$ ./gnuplot_1.rb
</span></code></pre></td></tr></table></div></figure>


<p>Gnuplot ウィンドウが開き、グラフが描画される。</p>

<p><img src="http://komasaru.github.io/images/2015/08/13/GNUPLOT_1.png" title="GNUPLOT_1" alt="GNUPLOT_1" /></p>

<p>但し、環境によってはこのウィンドウを閉じようとしてもうまく閉じれないかもしれない。（termnal が &ldquo;wxt&rdquo; の場合。 terminal が &ldquo;x11&rdquo; 等なら閉じれるが、日本語は使用できない）<br/>
ちなみに、本家の gnuplot では、この問題は &ldquo;Close&rdquo; を &ldquo;exit&rdquo; でなく &ldquo;exit gnuplot&rdquo; にバインドすれば解決するようだが、今回の RubyGems ライブラリでは通用しない模様。（試行してみた結果）</p>

<h4>2-2. 作成例・２</h4>

<script type="math/tex">y=x^3 - 2x + 2 \ (x={-2.0,-1.9,\cdots,1.9,2.0})</script>


<p>のグラフを PNG ファイルに描画・出力する例。</p>

<figure class='code'><figcaption><span>gnuplot_2.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#! /usr/local/bin/ruby</span>
</span><span class='line'><span class="c1">#-----------------------------------------------</span>
</span><span class='line'><span class="c1"># Ruby script to draw a graph by gnuplot.(Ex.2)</span>
</span><span class='line'><span class="c1">#-----------------------------------------------</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;gnuplot&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">Gnuplot</span><span class="o">.</span><span class="n">open</span> <span class="k">do</span> <span class="o">|</span><span class="n">gp</span><span class="o">|</span>
</span><span class='line'>  <span class="no">Gnuplot</span><span class="o">::</span><span class="no">Plot</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">gp</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">plot</span><span class="o">|</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">terminal</span> <span class="s2">&quot;png enhanced font &#39;IPA P ゴシック&#39; fontscale 1.2&quot;</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">output</span>   <span class="s2">&quot;gnuplot_2.png&quot;</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">title</span>    <span class="s2">&quot;作成例２&quot;</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">xlabel</span>   <span class="s2">&quot;x&quot;</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">ylabel</span>   <span class="s2">&quot;y=x^3-2x+2&quot;</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">grid</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="o">.</span><span class="n">.</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span> <span class="p">{</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span><span class="o">.</span><span class="n">to_f</span> <span class="o">/</span> <span class="mi">10</span><span class="o">.</span><span class="mi">0</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">collect</span> <span class="p">{</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">v</span> <span class="o">+</span> <span class="mi">2</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="no">Gnuplot</span><span class="o">::</span><span class="no">DataSet</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">]</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">ds</span><span class="o">|</span>
</span><span class='line'>      <span class="n">ds</span><span class="o">.</span><span class="n">with</span>      <span class="o">=</span> <span class="s2">&quot;linespoints&quot;</span>  <span class="c1"># 点のみなら &quot;points&quot;</span>
</span><span class='line'>      <span class="n">ds</span><span class="o">.</span><span class="n">linewidth</span> <span class="o">=</span> <span class="mi">2</span>
</span><span class='line'>      <span class="n">ds</span><span class="o">.</span><span class="n">linecolor</span> <span class="o">=</span> <span class="mi">3</span>
</span><span class='line'>      <span class="n">ds</span><span class="o">.</span><span class="n">notitle</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><a href="https://gist.github.com/komasaru/27e65a70d4681dd73370" title="Gist - Ruby script to draw a graph by gnuplot.(Ex.2)">Gist - Ruby script to draw a graph by gnuplot.(Ex.2)</a></li>
</ul>


<p>そして、実行権限を付与して実行。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ sudo chmod +x gnuplot_2.rb
</span><span class='line'>
</span><span class='line'>$ ./gnuplot_2.rb
</span></code></pre></td></tr></table></div></figure>


<p>&ldquo;gnuplot_2.png&rdquo; というファイルが出力される。</p>

<p><img src="http://komasaru.github.io/images/2015/08/13/GNUPLOT_2.png" title="GNUPLOT_2" alt="GNUPLOT_2" /></p>

<h4>2-3. 作成例・３</h4>

<script type="math/tex">z=sin(x)cos(x)</script>


<p>の三次元グラフを PNG ファイルに描画・出力する例。</p>

<figure class='code'><figcaption><span>gnuplot_3.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#! /usr/local/bin/ruby</span>
</span><span class='line'><span class="c1">#-----------------------------------------------</span>
</span><span class='line'><span class="c1"># Ruby script to draw a graph by gnuplot.(Ex.3)</span>
</span><span class='line'><span class="c1">#-----------------------------------------------</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;gnuplot&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">Gnuplot</span><span class="o">.</span><span class="n">open</span> <span class="k">do</span> <span class="o">|</span><span class="n">gp</span><span class="o">|</span>
</span><span class='line'>  <span class="no">Gnuplot</span><span class="o">::</span><span class="no">SPlot</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">gp</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">plot</span><span class="o">|</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">terminal</span> <span class="s2">&quot;png enhanced font &#39;IPA P ゴシック&#39; fontscale 1.2&quot;</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">output</span>   <span class="s2">&quot;gnuplot_3.png&quot;</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">set</span>      <span class="s2">&quot;object 1 rect from screen 0,0 to screen 1,1 fc rgb &#39;#D0D0E0&#39; fillstyle solid 1.0 behind&quot;</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">title</span>    <span class="s2">&quot;作成例３&quot;</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">xrange</span>   <span class="s2">&quot;[-10:10]&quot;</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">yrange</span>   <span class="s2">&quot;[-10:10]&quot;</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">xlabel</span>   <span class="s2">&quot;x&quot;</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">ylabel</span>   <span class="s2">&quot;y&quot;</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">zlabel</span>   <span class="s2">&quot;z&quot;</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">pm3d</span>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">grid</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">plot</span><span class="o">.</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="no">Gnuplot</span><span class="o">::</span><span class="no">DataSet</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;sin(x)*cos(y)&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">ds</span><span class="o">|</span>
</span><span class='line'>      <span class="n">ds</span><span class="o">.</span><span class="n">with</span>      <span class="o">=</span> <span class="s2">&quot;lines&quot;</span>
</span><span class='line'>      <span class="n">ds</span><span class="o">.</span><span class="n">linecolor</span> <span class="o">=</span> <span class="mi">6</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><a href="https://gist.github.com/komasaru/1395add506fd9a1a4bd6" title="Gist - Ruby script to draw a graph by gnuplot.(Ex.3)">Gist - Ruby script to draw a graph by gnuplot.(Ex.3)</a></li>
</ul>


<p>そして、実行権限を付与して実行。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ sudo chmod +x gnuplot_3.rb
</span><span class='line'>
</span><span class='line'>$ ./gnuplot_3.rb
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://komasaru.github.io/images/2015/08/13/GNUPLOT_3.png" title="GNUPLOT_3" alt="GNUPLOT_3" /></p>

<h3>参考サイト</h3>

<ul>
<li><a href="http://www.gnuplot.info/" title="gnuplot">gnuplot</a></li>
<li><a href="https://rubygems.org/gems/gnuplot" title="gnuplot - RubyGems.org - your community gem host">gnuplot - RubyGems.org - your community gem host</a></li>
</ul>


<hr />

<p>Ruby で処理した得た数値をグラフ化することが多い場合は重宝するでしょう。</p>

<p>以上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Linux Mint - Groonga インストール（by ソースビルド）！]]></title>
    <link href="http://komasaru.github.io/blog/2015/08/09/linux-mint-groonga-installation-by-src/"/>
    <updated>2015-08-09T00:20:00+09:00</updated>
    <id>http://komasaru.github.io/blog/2015/08/09/linux-mint-groonga-installation-by-src</id>
    <content type="html"><![CDATA[<p>こんばんは。</p>

<p>オープンソースのカラムストア機能付き全文検索エンジン <a href="http://groonga.org/ja/" title="Groonga - カラムストア機能付き全文検索エンジン">Groonga</a> を、ソースをビルドしてインストールする方法についての記録です。（最後に簡単な使用例も紹介）</p>

<!--more-->


<h3>0. 前提条件</h3>

<ul>
<li>Linux Mint 17.2(64bit) での作業を想定。</li>
<li>当記事執筆時点で最新の Groonga 5.0.5 をインストールする。</li>
<li>トークナイザは、デフォルトの N-gram 方式ではなく形態素解析器 MeCab を使用することを想定。</li>
<li>ここでは、全文検索がどういうものかという説明はしない。</li>
<li>以下の説明内で出力するデータは、可読性を考慮して整形している。</li>
</ul>


<h3>1. 依存パッケージのインストール</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ sudo apt-get -y install wget tar build-essential \
</span><span class='line'>&gt; zlib1g-dev liblzo2-dev libmsgpack-dev \
</span><span class='line'>&gt; libzmq-dev libevent-dev libmecab-dev
</span></code></pre></td></tr></table></div></figure>


<h3>2. アーカーブソースの取得</h3>

<p>アーカイブファイルをダウンロード後、展開する。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ wget http://packages.groonga.org/source/groonga/groonga-5.0.5.tar.gz
</span><span class='line'>$ tar zxvf groonga-5.0.5.tar.gz
</span></code></pre></td></tr></table></div></figure>


<h3>3. ビルド＆インストール</h3>

<p><code>configure</code>, <code>make</code>, <code>make install</code> する。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ cd groonga-5.0.5
</span><span class='line'>$ ./configure
</span><span class='line'>$ make -j$(grep &#39;^processor&#39; /proc/cpuinfo | wc -l)
</span><span class='line'>$ sudo make install
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>make</code> の <code>-j$(grep '^processor' /proc/cpuinfo | wc -l)</code> の部分はプロセッサ数が明確なら <code>-j4</code> のように指定してもよいし、速度を気にしないのなら単に <code>make</code> のみでもよい。</li>
<li><code>configure</code> オプションについては <a href="http://groonga.org/ja/docs/install/others.html#source-configure">configure</a> を参照。</li>
</ul>


<p>そして、インストールされたかバージョンを表示して確認してみる。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ groonga --version
</span><span class='line'>groonga 5.0.5 [linux-gnu,x86_64,utf8,match-escalation-threshold=0,nfkc,mecab,msgpack,onigmo,zlib,epoll]
</span><span class='line'>
</span><span class='line'>configure options: &lt;&gt;
</span></code></pre></td></tr></table></div></figure>


<h3>4. 動作確認</h3>

<p>簡単に動作確認してみる。（パスは適宜変更）<br/>
以下は、都道府県名のローマ字表記を <code>_key</code>、都道府県名の漢字表記を <code>name</code> として登録する例。（簡易都道府県名データベース）</p>

<h4>4-1. データベースの作成</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ mkdir ~/groonga-db
</span><span class='line'>$ groonga -n ~/groonga-db/test.db
</span></code></pre></td></tr></table></div></figure>


<p>データベース作成後は自動で対話モードに入るが、手動で対話モードへ入るには以下のようにする。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ groonga ~/groonga-db/test.db
</span></code></pre></td></tr></table></div></figure>


<h4>4-2. テーブルの作成</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt; table_create --name Prefs --flags TABLE_HASH_KEY --key_type ShortText
</span><span class='line'>[
</span><span class='line'>  [0,1436411689.75983,0.0292973518371582],
</span><span class='line'>  true
</span><span class='line'>]
</span></code></pre></td></tr></table></div></figure>


<h4>4-3. テーブルの表示</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt; select --table Prefs
</span><span class='line'>[
</span><span class='line'>  [0,1436411701.50367,0.000922203063964844],
</span><span class='line'>  [
</span><span class='line'>    [
</span><span class='line'>      [0],
</span><span class='line'>      [
</span><span class='line'>        [&quot;_id&quot;,&quot;UInt32&quot;],
</span><span class='line'>        [&quot;_key&quot;,&quot;ShortText&quot;]
</span><span class='line'>      ]
</span><span class='line'>    ]
</span><span class='line'>  ]
</span><span class='line'>]
</span></code></pre></td></tr></table></div></figure>


<h4>4-4. カラムの作成</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt; column_create --table Prefs --name name --type ShortText
</span><span class='line'>[
</span><span class='line'>  [0,1436411764.36768,0.0517301559448242],
</span><span class='line'>  true
</span><span class='line'>]
</span><span class='line'>
</span><span class='line'>&gt; select --table Prefs
</span><span class='line'>[
</span><span class='line'>  [0,1436411783.16738,0.000133037567138672],
</span><span class='line'>  [
</span><span class='line'>    [
</span><span class='line'>      [0],
</span><span class='line'>      [
</span><span class='line'>        [&quot;_id&quot;,&quot;UInt32&quot;],
</span><span class='line'>        [&quot;_key&quot;,&quot;ShortText&quot;],
</span><span class='line'>        [&quot;name&quot;,&quot;ShortText&quot;]
</span><span class='line'>      ]
</span><span class='line'>    ]
</span><span class='line'>  ]
</span><span class='line'>]
</span></code></pre></td></tr></table></div></figure>


<h4>4-5. データのロード</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt; load --table Prefs
</span><span class='line'>[
</span><span class='line'>  {&quot;_key&quot;:&quot;Hokkaido&quot;,&quot;name&quot;:&quot;北海道&quot;},
</span><span class='line'>  {&quot;_key&quot;:&quot;Aomoriken&quot;,&quot;name&quot;:&quot;青森県&quot;},
</span><span class='line'>           :
</span><span class='line'>  ====&lt; 途中省略 &gt;====
</span><span class='line'>           :
</span><span class='line'>  {&quot;_key&quot;:&quot;Kagoshimaken&quot;,&quot;name&quot;:&quot;鹿児島県&quot;},
</span><span class='line'>  {&quot;_key&quot;:&quot;Okinawaken&quot;,&quot;name&quot;:&quot;沖縄県&quot;},
</span><span class='line'>]
</span></code></pre></td></tr></table></div></figure>


<p>もしくは、以下のようにコマンドラインから JSON 形式で作成したファイルを取り込んでもよい。</p>

<figure class='code'><figcaption><span>load.grn</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>load --table Prefs
</span><span class='line'>[
</span><span class='line'>  {&quot;_key&quot;:&quot;Hokkaido&quot;,&quot;name&quot;:&quot;北海道&quot;},
</span><span class='line'>  {&quot;_key&quot;:&quot;Aomoriken&quot;,&quot;name&quot;:&quot;青森県&quot;},
</span><span class='line'>           :
</span><span class='line'>  ====&lt; 途中省略 &gt;====
</span><span class='line'>           :
</span><span class='line'>  {&quot;_key&quot;:&quot;Kagoshimaken&quot;,&quot;name&quot;:&quot;鹿児島県&quot;},
</span><span class='line'>  {&quot;_key&quot;:&quot;Okinawaken&quot;,&quot;name&quot;:&quot;沖縄県&quot;},
</span><span class='line'>]
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ groonga ~/groonga-db/test.db &lt; load.grn
</span><span class='line'>[[0,1436415458.66362,0.00340938568115234],47]
</span></code></pre></td></tr></table></div></figure>


<h4>4-6. レコードの取得</h4>

<figure class='code'><figcaption><span>"全レコードを取得（但し、先頭10件）"</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>select --table Prefs
</span><span class='line'>[
</span><span class='line'>  [0,1436415521.50463,0.00343823432922363],
</span><span class='line'>  [
</span><span class='line'>    [
</span><span class='line'>      [47],
</span><span class='line'>      [
</span><span class='line'>        [&quot;_id&quot;,&quot;UInt32&quot;],
</span><span class='line'>        [&quot;_key&quot;,&quot;ShortText&quot;],
</span><span class='line'>        [&quot;name&quot;,&quot;ShortText&quot;]
</span><span class='line'>      ],
</span><span class='line'>      [1,&quot;Hokkaido&quot;,&quot;北海道&quot;],
</span><span class='line'>      [2,&quot;Aomoriken&quot;,&quot;青森県&quot;],
</span><span class='line'>      [3,&quot;Iwateken&quot;,&quot;岩手県&quot;],
</span><span class='line'>      [4,&quot;Miyagiken&quot;,&quot;宮城県&quot;],
</span><span class='line'>      [5,&quot;Akitaken&quot;,&quot;秋田県&quot;],
</span><span class='line'>      [6,&quot;Yamagataken&quot;,&quot;山形県&quot;],
</span><span class='line'>      [7,&quot;Fukushimaken&quot;,&quot;福島県&quot;],
</span><span class='line'>      [8,&quot;Ibarakiken&quot;,&quot;茨城県&quot;],
</span><span class='line'>      [9,&quot;Tochigiken&quot;,&quot;栃木県&quot;],
</span><span class='line'>      [10,&quot;Gunmaken&quot;,&quot;群馬県&quot;]
</span><span class='line'>    ]
</span><span class='line'>  ]
</span><span class='line'>]
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>"ID が 32 のレコードを取得"</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt; select --table Prefs --query _id:32
</span><span class='line'>[
</span><span class='line'>  [0,1436415572.03281,0.0471560955047607],
</span><span class='line'>  [
</span><span class='line'>    [
</span><span class='line'>      [1],
</span><span class='line'>      [
</span><span class='line'>        [&quot;_id&quot;,&quot;UInt32&quot;],
</span><span class='line'>        [&quot;_key&quot;,&quot;ShortText&quot;],
</span><span class='line'>        [&quot;name&quot;,&quot;ShortText&quot;]
</span><span class='line'>      ],
</span><span class='line'>      [32,&quot;Shimaneken&quot;,&quot;島根県&quot;]
</span><span class='line'>    ]
</span><span class='line'>  ]
</span><span class='line'>]
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>"KEY が shimaneken のレコードを取得"</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt; select --table Prefs --query &#39;_key:&quot;Shimaneken&quot;&#39;
</span><span class='line'>[
</span><span class='line'>  [0,1436415572.03281,0.0471560955047607],
</span><span class='line'>  [
</span><span class='line'>    [
</span><span class='line'>      [1],
</span><span class='line'>      [
</span><span class='line'>        [&quot;_id&quot;,&quot;UInt32&quot;],
</span><span class='line'>        [&quot;_key&quot;,&quot;ShortText&quot;],
</span><span class='line'>        [&quot;name&quot;,&quot;ShortText&quot;]
</span><span class='line'>      ],
</span><span class='line'>      [32,&quot;Shimaneken&quot;,&quot;島根県&quot;]
</span><span class='line'>    ]
</span><span class='line'>  ]
</span></code></pre></td></tr></table></div></figure>


<h4>4-7. 全文検索用の語彙表の作成</h4>

<p>高速な全文検索を実現するためには転置インデックスが必要であるので、転置インデックスとして使用するテーブルを作成する。（トークナイザとして MeCab を使用する）</p>

<p>辞書テーブルの作成は以下のようにする。</p>

<figure class='code'><figcaption><span>辞書テーブルの作成</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt; table_create --name Terms --flags TABLE_PAT_KEY|KEY_NORMALIZE --key_type ShortText --default_tokenizer TokenMecab
</span><span class='line'>[[0,1436416480.43314,0.0687055587768555],true]
</span></code></pre></td></tr></table></div></figure>


<p>辞書テーブルへのカラムの作成は以下のようにする。</p>

<figure class='code'><figcaption><span>辞書テーブルへのカラムの作成</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt; column_create --table Terms --name pref_name --flags COLUMN_INDEX|WITH_POSITION --type Prefs --source name
</span><span class='line'>[[0,1436416570.78517,0.964933156967163],true]
</span></code></pre></td></tr></table></div></figure>


<p>辞書テーブルの確認は以下のようにする。</p>

<figure class='code'><figcaption><span>辞書テーブルの確認</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt; select --table Terms
</span><span class='line'>[
</span><span class='line'>  [0,1436416592.4811,0.000155210494995117],
</span><span class='line'>  [
</span><span class='line'>    [
</span><span class='line'>      [50],
</span><span class='line'>      [
</span><span class='line'>        [&quot;_id&quot;,&quot;UInt32&quot;],
</span><span class='line'>        [&quot;_key&quot;,&quot;ShortText&quot;],
</span><span class='line'>        [&quot;pref_name&quot;,&quot;UInt32&quot;]
</span><span class='line'>      ],
</span><span class='line'>      [1,&quot;三重&quot;,1],
</span><span class='line'>      [2,&quot;京都&quot;,1],
</span><span class='line'>      [3,&quot;佐賀&quot;,1],
</span><span class='line'>      [4,&quot;兵庫&quot;,1],
</span><span class='line'>      [5,&quot;北海道&quot;,1],
</span><span class='line'>      [6,&quot;千葉&quot;,1],
</span><span class='line'>      [7,&quot;和歌山&quot;,1],
</span><span class='line'>      [8,&quot;埼玉&quot;,1],
</span><span class='line'>      [9,&quot;大分&quot;,1],
</span><span class='line'>      [10,&quot;大阪&quot;,1]
</span><span class='line'>    ]
</span><span class='line'>  ]
</span><span class='line'>]
</span></code></pre></td></tr></table></div></figure>


<p>テーブルの検索は以下のようにする。</p>

<figure class='code'><figcaption><span>テーブルの検索</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt; select --table Prefs --query name:@府
</span><span class='line'>[
</span><span class='line'>  [0,1436416671.28152,0.000936269760131836],
</span><span class='line'>  [
</span><span class='line'>    [
</span><span class='line'>      [2],
</span><span class='line'>      [
</span><span class='line'>        [&quot;_id&quot;,&quot;UInt32&quot;],
</span><span class='line'>        [&quot;_key&quot;,&quot;ShortText&quot;],
</span><span class='line'>        [&quot;name&quot;,&quot;ShortText&quot;]
</span><span class='line'>      ],
</span><span class='line'>      [26,&quot;Kyotofu&quot;,&quot;京都府&quot;],
</span><span class='line'>      [27,&quot;Osakafu&quot;,&quot;大阪府&quot;]
</span><span class='line'>    ]
</span><span class='line'>  ]
</span><span class='line'>]
</span></code></pre></td></tr></table></div></figure>


<h4>4-8. 対話モードの終了</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&gt; quit
</span></code></pre></td></tr></table></div></figure>


<h3>5. 参考サイト</h3>

<ul>
<li><a href="http://groonga.org/ja/" title="Groonga - カラムストア機能付き全文検索エンジン">Groonga - カラムストア機能付き全文検索エンジン</a></li>
</ul>


<hr />

<p>慣れないうちは Groonga を単体で扱うのは若干面倒に感じます。</p>

<p>当方は、Rroonga（Groonga の機能を Ruby から利用するためのライブラリ）や Mroonga（Groonga をベースとした MySQL のストレージエンジン）を使用することも考えています。</p>

<p>以上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[tmux - Window, Pane, Session 自動保存プラグイン！]]></title>
    <link href="http://komasaru.github.io/blog/2015/08/06/tmux-automatic-session-preservation/"/>
    <updated>2015-08-06T00:20:00+09:00</updated>
    <id>http://komasaru.github.io/blog/2015/08/06/tmux-automatic-session-preservation</id>
    <content type="html"><![CDATA[<p>こんばんは。</p>

<p>ターミナルマルチプレクサ（仮想端末マネージャ） tmux の Window, Pane, Session 等を保存（自動保存）するプラグインをインストールする方法についての記録です。</p>

<p>Window, Pane, Session 等を保存するプラグインは tmux-resurrect で、それを自動化するプラグインは tmux-continuum です。<br/>
また、プラグインの管理には tpm(Tmux Plugin Manager)を使用します。<br/>
（以前は tmux-resurrect を自動化するプラグインは tmux-resurrect-auto でしたが、現在は tmux-continuum に改名されています。tmux-resurrect-auto も使用できますが）</p>

<!--more-->


<h3>0. 前提条件</h3>

<ul>
<li>Linux Mint 17.2(64bit) での作業を想定。</li>
<li>tmux 2.1 での作業を想定。</li>
<li>Git がインストール済みであること。</li>
<li>tpm(Tmux Plugin Manager) で tmux プラグインを管理することを想定。<br/>
（tpm を使用せず手動でインストールすることも可能）</li>
</ul>


<h3>1. tpm のインストール</h3>

<p>tmux プラグインの管理に tpm(Tmux Plugin Manager) を使用するのでインストールする。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
</span></code></pre></td></tr></table></div></figure>


<h3>2. tmux.conf の編集</h3>

<p>&ldquo;~/.tmux.conf&rdquo; に以下の記述を追記する。</p>

<figure class='code'><figcaption><span>~/.tmux.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">set</span>-option -g @tpm_plugins <span class="s1">&#39;  \</span>
</span><span class='line'><span class="s1">  tmux-plugins/tpm            \</span>
</span><span class='line'><span class="s1">  tmux-plugins/tmux-resurrect \</span>
</span><span class='line'><span class="s1">  tmux-plugins/tmux-continuum \</span>
</span><span class='line'><span class="s1">&#39;</span>
</span><span class='line'><span class="nb">set</span>-option -g @continuum-save-interval <span class="s1">&#39;60&#39;</span>
</span><span class='line'><span class="nb">set</span>-option -g @resurrect-processes <span class="s1">&#39;ssh -p 9999 hoge&#39;</span>
</span><span class='line'><span class="nb">set</span>-option -g @resurrect-strategy-vim <span class="s1">&#39;session&#39;</span>
</span><span class='line'>
</span><span class='line'>run-shell <span class="s1">&#39;~/.tmux/plugins/tpm/tpm&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>set-option</code> は <code>set</code> で代用可。</li>
<li><code>set-option -g @continuum-save-interval</code> でセッションを自動保存する間隔を指定する。<br/>
 非指定時のデフォルトは <code>15</code> 分。 <code>0</code> で自動保存の無効化。</li>
<li><code>set-option -g @resurrect-processes</code> で保存したいセッションを指定する。<br/>
（上記の例は &ldquo;hoge&rdquo; ホストへポート 9999 で SSH 接続したセッションを保存する例）</li>
<li><code>set-option -g @resurrect-strategy-vim 'session'</code> で Vim のセッションを保存する。</li>
</ul>


<h3>3. プラグインのインストール</h3>

<p>tmux 上で Prefix 押下後に <code>I</code> を押下する。（<code>i</code> ではなく <code>I</code>）</p>

<h3>4. 動作確認</h3>

<p>Prefix + CTRL-s で Window, Pane, Session 等の状態を保存、Prefix + CTLR-r でWindow, Pane, Session 等の状態を復元できるので、「保存→マシン再行動→復元」と試してみる。</p>

<p>tmux-continuum はデフォルトでは 60 分間隔で状態を保存するようなので、その辺りの動作も確認しておく。</p>

<p>ちなみに、状態は &ldquo;~/.tmux/resurrect&rdquo; ディレクトリ配下にテキストファイルで保存される。</p>

<hr />

<p>これで、マシンを起動する度に Window, Pane, Session 等を手動で復元する手間が省けます。</p>

<p>以上。</p>
]]></content>
  </entry>
  
</feed>
